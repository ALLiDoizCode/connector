# Docker Compose configuration for 5-peer Agent Society containers
# Each container runs: BLS (Business Logic Server) + Nostr Relay + Bootstrap Service
#
# This file extends the 5-peer ILP network with Nostr-based peer discovery
# and SPSP handshakes via ILP-gated relay.
#
# Architecture per peer:
#   - ILP Connector (from docker-compose-5-peer-multihop.yml)
#   - Agent Society (this file):
#     - BLS: HTTP server for /handle-payment (port 31XX)
#     - Relay: WebSocket Nostr relay (port 71XX)
#     - Bootstrap: Connects to known peers, publishes ILP info
#
# Prerequisites:
#   - docker-compose-5-peer-multihop.yml must be running
#   - Agent Society image built from ../agent-society/docker/Dockerfile
#   - Nostr keypairs generated (see deploy script)
#
# Usage:
#   Build image: cd ../agent-society && docker build -f docker/Dockerfile -t agent-society .
#   Start: docker-compose -f docker-compose-5-peer-nostr-spsp.yml up -d
#   Logs:  docker-compose -f docker-compose-5-peer-nostr-spsp.yml logs -f
#   Stop:  docker-compose -f docker-compose-5-peer-nostr-spsp.yml down
#
# Or use the deployment script with --with-nostr-spsp flag:
#   ./scripts/deploy-5-peer-multihop.sh --with-nostr-spsp

version: '3.8'

services:
  # ===========================================================================
  # Agent Society 1 - Bootstrap Node
  # ===========================================================================
  # Role: First peer in the network, acts as bootstrap node for others.
  # Has no known peers - other peers bootstrap by connecting to this relay.
  agent-society-1:
    image: agent-society
    container_name: agent-society-1
    environment:
      NODE_ID: peer1
      # Nostr identity (64-char hex secret key)
      NOSTR_SECRET_KEY: ${PEER1_NOSTR_SECRET_KEY}
      # ILP configuration
      ILP_ADDRESS: g.peer1
      BTP_ENDPOINT: ws://peer1:3000
      # Server ports
      BLS_PORT: "3100"
      WS_PORT: "7100"
      # Connector Admin API (for adding peers/routes)
      CONNECTOR_ADMIN_URL: http://peer1:8081
      # Bootstrap configuration - empty for bootstrap node
      KNOWN_PEERS: "[]"
      # Asset configuration
      ASSET_CODE: USD
      ASSET_SCALE: "6"
      # Pricing
      BASE_PRICE_PER_BYTE: "10"
    ports:
      - "3110:3100"  # BLS HTTP port
      - "7110:7100"  # Nostr relay WebSocket port
    networks:
      - agent-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:3100/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ===========================================================================
  # Agent Society 2 - Bootstraps with Peer1
  # ===========================================================================
  agent-society-2:
    image: agent-society
    container_name: agent-society-2
    environment:
      NODE_ID: peer2
      NOSTR_SECRET_KEY: ${PEER2_NOSTR_SECRET_KEY}
      ILP_ADDRESS: g.peer2
      BTP_ENDPOINT: ws://peer2:3001
      BLS_PORT: "3100"
      WS_PORT: "7100"
      CONNECTOR_ADMIN_URL: http://peer2:8081
      # Bootstrap with peer1
      KNOWN_PEERS: |
        [{"pubkey": "${PEER1_NOSTR_PUBKEY}", "relayUrl": "ws://agent-society-1:7100", "btpEndpoint": "ws://peer1:3000"}]
      ASSET_CODE: USD
      ASSET_SCALE: "6"
      BASE_PRICE_PER_BYTE: "10"
    ports:
      - "3111:3100"
      - "7111:7100"
    networks:
      - agent-network
    depends_on:
      - agent-society-1
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:3100/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ===========================================================================
  # Agent Society 3 - Bootstraps with Peer1
  # ===========================================================================
  agent-society-3:
    image: agent-society
    container_name: agent-society-3
    environment:
      NODE_ID: peer3
      NOSTR_SECRET_KEY: ${PEER3_NOSTR_SECRET_KEY}
      ILP_ADDRESS: g.peer3
      BTP_ENDPOINT: ws://peer3:3002
      BLS_PORT: "3100"
      WS_PORT: "7100"
      CONNECTOR_ADMIN_URL: http://peer3:8081
      KNOWN_PEERS: |
        [{"pubkey": "${PEER1_NOSTR_PUBKEY}", "relayUrl": "ws://agent-society-1:7100", "btpEndpoint": "ws://peer1:3000"}]
      ASSET_CODE: USD
      ASSET_SCALE: "6"
      BASE_PRICE_PER_BYTE: "10"
    ports:
      - "3112:3100"
      - "7112:7100"
    networks:
      - agent-network
    depends_on:
      - agent-society-1
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:3100/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ===========================================================================
  # Agent Society 4 - Bootstraps with Peer1
  # ===========================================================================
  agent-society-4:
    image: agent-society
    container_name: agent-society-4
    environment:
      NODE_ID: peer4
      NOSTR_SECRET_KEY: ${PEER4_NOSTR_SECRET_KEY}
      ILP_ADDRESS: g.peer4
      BTP_ENDPOINT: ws://peer4:3003
      BLS_PORT: "3100"
      WS_PORT: "7100"
      CONNECTOR_ADMIN_URL: http://peer4:8081
      KNOWN_PEERS: |
        [{"pubkey": "${PEER1_NOSTR_PUBKEY}", "relayUrl": "ws://agent-society-1:7100", "btpEndpoint": "ws://peer1:3000"}]
      ASSET_CODE: USD
      ASSET_SCALE: "6"
      BASE_PRICE_PER_BYTE: "10"
    ports:
      - "3113:3100"
      - "7113:7100"
    networks:
      - agent-network
    depends_on:
      - agent-society-1
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:3100/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ===========================================================================
  # Agent Society 5 - Bootstraps with Peer1
  # ===========================================================================
  agent-society-5:
    image: agent-society
    container_name: agent-society-5
    environment:
      NODE_ID: peer5
      NOSTR_SECRET_KEY: ${PEER5_NOSTR_SECRET_KEY}
      ILP_ADDRESS: g.peer5
      BTP_ENDPOINT: ws://peer5:3004
      BLS_PORT: "3100"
      WS_PORT: "7100"
      CONNECTOR_ADMIN_URL: http://peer5:8081
      KNOWN_PEERS: |
        [{"pubkey": "${PEER1_NOSTR_PUBKEY}", "relayUrl": "ws://agent-society-1:7100", "btpEndpoint": "ws://peer1:3000"}]
      ASSET_CODE: USD
      ASSET_SCALE: "6"
      BASE_PRICE_PER_BYTE: "10"
    ports:
      - "3114:3100"
      - "7114:7100"
    networks:
      - agent-network
    depends_on:
      - agent-society-1
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:3100/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

# Use the same network as the ILP connectors
networks:
  agent-network:
    external: true
    name: agent-runtime_agent-network

# ===========================================================================
# Port Mappings Summary
# ===========================================================================
# Agent Society containers expose:
#   - BLS (HTTP): 3110-3114 (internal: 3100)
#   - Relay (WS): 7110-7114 (internal: 7100)
#
# ILP Connector ports (from docker-compose-5-peer-multihop.yml):
#   - BTP: 3000-3004
#   - Health: 9080-9084
#   - Explorer: 5173-5177
#   - Admin API: 8181-8185
#
# ===========================================================================
# Environment Variables Required
# ===========================================================================
# These must be set in .env or exported:
#   - PEER1_NOSTR_SECRET_KEY: 64-char hex Nostr secret key for peer1
#   - PEER2_NOSTR_SECRET_KEY: 64-char hex Nostr secret key for peer2
#   - PEER3_NOSTR_SECRET_KEY: 64-char hex Nostr secret key for peer3
#   - PEER4_NOSTR_SECRET_KEY: 64-char hex Nostr secret key for peer4
#   - PEER5_NOSTR_SECRET_KEY: 64-char hex Nostr secret key for peer5
#   - PEER1_NOSTR_PUBKEY: Derived pubkey for peer1 (used by others for bootstrap)
#
# Generate keys with: node -e "const {generateSecretKey, getPublicKey} = require('nostr-tools/pure'); const sk = generateSecretKey(); console.log('SECRET_KEY=' + Buffer.from(sk).toString('hex')); console.log('PUBKEY=' + getPublicKey(sk));"
#
# ===========================================================================
# Bootstrap Flow
# ===========================================================================
# 1. agent-society-1 starts as bootstrap node (no known peers)
#    - Publishes its kind:10032 (ILP Peer Info) to local relay
#    - Starts SPSP server listening for requests
#
# 2. agent-society-2..5 start and bootstrap with peer1:
#    - Connect to agent-society-1's relay (ws://agent-society-1:7100)
#    - Query for peer1's kind:10032 event
#    - Perform direct SPSP handshake (free, not ILP-routed)
#    - Add peer1 to their connector's routing table
#    - Publish their own kind:10032 to peer1's relay
#
# 3. After bootstrap, peers discover each other via peer1's relay:
#    - Query peer1's relay for other peers' kind:10032 events
#    - SPSP handshakes with discovered peers go through ILP (paid)
#
# ===========================================================================
# Testing ILP-Gated SPSP
# ===========================================================================
# After deployment, test ILP-gated SPSP handshake:
#   1. peer2 sends SPSP request (kind:23194) to peer5
#   2. Request is TOON-encoded and sent as ILP PREPARE
#   3. Routes: peer2 → peer1 → peer3 → peer4 → peer5
#   4. peer5's BLS decodes, generates SPSP params
#   5. Response (kind:23195) returned in ILP FULFILL data
#   6. peer2 decrypts response, has SPSP params for peer5
