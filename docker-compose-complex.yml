# Docker Compose configuration for complex 8-node hierarchical ILP network
# Topology: 2 Hubs + 6 Spokes (hierarchical structure)
#
#  Hub-1 ↔ Hub-2 (inter-hub link)
#    ↓       ↓
# Spoke-1x  Spoke-2x
#
# Hub-1 cluster: spoke-1a, spoke-1b, spoke-1c
# Hub-2 cluster: spoke-2a, spoke-2b, spoke-2c

version: '3.8'

services:
  hub-1:
    image: ilp-connector
    container_name: hub-1
    environment:
      CONFIG_FILE: /app/config.yaml
      NODE_ID: hub-1
      LOG_LEVEL: info
      HEALTH_CHECK_PORT: 8080
      DASHBOARD_TELEMETRY_URL: ws://dashboard:9000
      # BTP Server Authentication - Environment variables for incoming connections
      BTP_PEER_HUB_2_SECRET: secret-hub1-to-hub2
      BTP_PEER_SPOKE_1A_SECRET: secret-spoke1a-to-hub1
      BTP_PEER_SPOKE_1B_SECRET: secret-spoke1b-to-hub1
      BTP_PEER_SPOKE_1C_SECRET: secret-spoke1c-to-hub1
      # Test client authentication for send-packet tool
      BTP_PEER_SEND_PACKET_CLIENT_SECRET: test-token
    volumes:
      - ./examples/complex-8-node/hub-1.yaml:/app/config.yaml:ro
    ports:
      - "3000:3000"
      - "9080:8080"
    networks:
      - ilp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  hub-2:
    image: ilp-connector
    container_name: hub-2
    environment:
      CONFIG_FILE: /app/config.yaml
      NODE_ID: hub-2
      LOG_LEVEL: info
      HEALTH_CHECK_PORT: 8080
      DASHBOARD_TELEMETRY_URL: ws://dashboard:9000
      # BTP Server Authentication - Environment variables for incoming connections
      BTP_PEER_HUB_1_SECRET: secret-hub1-to-hub2
      BTP_PEER_SPOKE_2A_SECRET: secret-spoke2a-to-hub2
      BTP_PEER_SPOKE_2B_SECRET: secret-spoke2b-to-hub2
      BTP_PEER_SPOKE_2C_SECRET: secret-spoke2c-to-hub2
    volumes:
      - ./examples/complex-8-node/hub-2.yaml:/app/config.yaml:ro
    ports:
      - "3001:3001"
      - "9081:8080"
    networks:
      - ilp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  spoke-1a:
    image: ilp-connector
    container_name: spoke-1a
    environment:
      CONFIG_FILE: /app/config.yaml
      NODE_ID: spoke-1a
      LOG_LEVEL: info
      HEALTH_CHECK_PORT: 8080
      DASHBOARD_TELEMETRY_URL: ws://dashboard:9000
    volumes:
      - ./examples/complex-8-node/spoke-1a.yaml:/app/config.yaml:ro
    ports:
      - "3002:3002"
      - "9082:8080"
    networks:
      - ilp-network
    depends_on:
      - hub-1
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  spoke-1b:
    image: ilp-connector
    container_name: spoke-1b
    environment:
      CONFIG_FILE: /app/config.yaml
      NODE_ID: spoke-1b
      LOG_LEVEL: info
      HEALTH_CHECK_PORT: 8080
      DASHBOARD_TELEMETRY_URL: ws://dashboard:9000
    volumes:
      - ./examples/complex-8-node/spoke-1b.yaml:/app/config.yaml:ro
    ports:
      - "3003:3003"
      - "9083:8080"
    networks:
      - ilp-network
    depends_on:
      - hub-1
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  spoke-1c:
    image: ilp-connector
    container_name: spoke-1c
    environment:
      CONFIG_FILE: /app/config.yaml
      NODE_ID: spoke-1c
      LOG_LEVEL: info
      HEALTH_CHECK_PORT: 8080
      DASHBOARD_TELEMETRY_URL: ws://dashboard:9000
    volumes:
      - ./examples/complex-8-node/spoke-1c.yaml:/app/config.yaml:ro
    ports:
      - "3004:3004"
      - "9084:8080"
    networks:
      - ilp-network
    depends_on:
      - hub-1
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  spoke-2a:
    image: ilp-connector
    container_name: spoke-2a
    environment:
      CONFIG_FILE: /app/config.yaml
      NODE_ID: spoke-2a
      LOG_LEVEL: info
      HEALTH_CHECK_PORT: 8080
      DASHBOARD_TELEMETRY_URL: ws://dashboard:9000
    volumes:
      - ./examples/complex-8-node/spoke-2a.yaml:/app/config.yaml:ro
    ports:
      - "3005:3005"
      - "9085:8080"
    networks:
      - ilp-network
    depends_on:
      - hub-2
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  spoke-2b:
    image: ilp-connector
    container_name: spoke-2b
    environment:
      CONFIG_FILE: /app/config.yaml
      NODE_ID: spoke-2b
      LOG_LEVEL: info
      HEALTH_CHECK_PORT: 8080
      DASHBOARD_TELEMETRY_URL: ws://dashboard:9000
    volumes:
      - ./examples/complex-8-node/spoke-2b.yaml:/app/config.yaml:ro
    ports:
      - "3006:3006"
      - "9086:8080"
    networks:
      - ilp-network
    depends_on:
      - hub-2
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  spoke-2c:
    image: ilp-connector
    container_name: spoke-2c
    environment:
      CONFIG_FILE: /app/config.yaml
      NODE_ID: spoke-2c
      LOG_LEVEL: info
      HEALTH_CHECK_PORT: 8080
      DASHBOARD_TELEMETRY_URL: ws://dashboard:9000
    volumes:
      - ./examples/complex-8-node/spoke-2c.yaml:/app/config.yaml:ro
    ports:
      - "3007:3007"
      - "9087:8080"
    networks:
      - ilp-network
    depends_on:
      - hub-2
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  dashboard:
    build:
      context: .
      dockerfile: packages/dashboard/Dockerfile
    container_name: ilp-dashboard
    environment:
      TELEMETRY_WS_PORT: 9000
      LOG_LEVEL: info
    ports:
      - "8080:8080"
      - "9000:9000"
    networks:
      - ilp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  ilp-network:
    driver: bridge
