# Docker Compose configuration for 3-node linear ILP network
# Topology: Connector A → Connector B → Connector C
#
# This configuration deploys a simple linear chain of 3 ILP connectors:
# - connector-a: Entry point (port 3000)
# - connector-b: Transit node (port 3001)
# - connector-c: Exit node (port 3002)
#
# Usage:
#   Start: docker-compose up -d
#   Logs:  docker-compose logs -f
#   Stop:  docker-compose down
#
# Prerequisites:
#   1. Build the connector image: docker build -t ilp-connector .
#   2. Docker Engine 20.10+ and Docker Compose 2.x installed
#
# Configuration:
#   Each connector loads its configuration from a YAML file mounted as a volume.
#   Configuration files are in the examples/ directory:
#   - examples/linear-3-nodes-a.yaml
#   - examples/linear-3-nodes-b.yaml
#   - examples/linear-3-nodes-c.yaml
#
#   To customize topology, edit the YAML files or create new ones.

version: '3.8'

services:
  # TigerBeetle - Distributed accounting database for settlement layer
  #
  # TigerBeetle provides high-performance, ACID-compliant accounting for tracking
  # settlement balances between ILP connector peers. It uses double-entry bookkeeping
  # with microsecond-level latency for recording transfers and querying balances.
  #
  # Architecture:
  #   - Single-node deployment for development (1 replica)
  #   - Multi-replica configuration (3-5 replicas) recommended for production
  #   - Quorum-based consensus requires majority of replicas healthy
  #
  # Data Persistence:
  #   - Data stored in Docker volume: tigerbeetle-data
  #   - Volume persists across container restarts
  #   - Cluster ID is immutable after initialization
  #
  # Network Access:
  #   - Internal port: 3000 (binary TCP protocol)
  #   - NOT exposed to host (Docker network access only)
  #   - Connectors access via hostname: tigerbeetle:3000
  #
  # Health Check:
  #   - TCP socket check (TigerBeetle has no HTTP endpoint)
  #   - Uses netcat to verify port 3000 is accepting connections
  #
  # Security:
  #   - Requires --security-opt seccomp=unconfined for I/O operations
  #   - Network isolation via Docker bridge network
  #   - No authentication (relies on network-level access control)
  tigerbeetle:
    image: ghcr.io/tigerbeetle/tigerbeetle:latest
    container_name: tigerbeetle
    security_opt:
      - seccomp=unconfined  # Required for TigerBeetle I/O operations
    environment:
      TIGERBEETLE_CLUSTER_ID: ${TIGERBEETLE_CLUSTER_ID:-0}
      TIGERBEETLE_REPLICA_COUNT: ${TIGERBEETLE_REPLICA_COUNT:-1}
      TIGERBEETLE_DATA_DIR: ${TIGERBEETLE_DATA_DIR:-/data}
    volumes:
      - tigerbeetle-data:/data
      - ./scripts/init-tigerbeetle.sh:/init-tigerbeetle.sh:ro
    # Note: Port 3000 is internal-only, not exposed to host for security
    # Connectors access TigerBeetle via Docker network: tigerbeetle:3000
    networks:
      - ilp-network
    restart: unless-stopped
    # TigerBeetle uses custom binary protocol over TCP, no HTTP endpoint available
    # Health check uses netcat to verify TCP port 3000 accepts connections
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 3000 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    entrypoint: ["/init-tigerbeetle.sh"]

  # Connector A - Entry node
  connector-a:
    image: ilp-connector
    container_name: connector-a
    environment:
      CONFIG_FILE: /app/config.yaml
      NODE_ID: connector-a
      LOG_LEVEL: info
      HEALTH_CHECK_PORT: 8080
      DASHBOARD_TELEMETRY_URL: ws://dashboard:9000
      BTP_PEER_CONNECTOR_B_SECRET: secret-a-to-b
      BTP_PEER_SEND_PACKET_CLIENT_SECRET: test-token
    volumes:
      - ./examples/linear-3-nodes-a.yaml:/app/config.yaml:ro
    ports:
      - "3000:3000"  # BTP server port
      - "9080:8080"  # Health check HTTP port
    networks:
      - ilp-network
    depends_on:
      tigerbeetle:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Connector B - Transit node (middle)
  connector-b:
    image: ilp-connector
    container_name: connector-b
    environment:
      CONFIG_FILE: /app/config.yaml
      NODE_ID: connector-b
      LOG_LEVEL: info
      HEALTH_CHECK_PORT: 8080
      DASHBOARD_TELEMETRY_URL: ws://dashboard:9000
    volumes:
      - ./examples/linear-3-nodes-b.yaml:/app/config.yaml:ro
    ports:
      - "3001:3001"  # BTP server port
      - "9081:8080"  # Health check HTTP port
    networks:
      - ilp-network
    depends_on:
      tigerbeetle:
        condition: service_healthy
      connector-a:
        condition: service_started
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Connector C - Exit node
  connector-c:
    image: ilp-connector
    container_name: connector-c
    environment:
      CONFIG_FILE: /app/config.yaml
      NODE_ID: connector-c
      LOG_LEVEL: info
      HEALTH_CHECK_PORT: 8080
      DASHBOARD_TELEMETRY_URL: ws://dashboard:9000
      BTP_PEER_CONNECTOR_B_SECRET: secret-b-to-c
    volumes:
      - ./examples/linear-3-nodes-c.yaml:/app/config.yaml:ro
    ports:
      - "3002:3002"  # BTP server port
      - "9082:8080"  # Health check HTTP port
    networks:
      - ilp-network
    depends_on:
      tigerbeetle:
        condition: service_healthy
      connector-b:
        condition: service_started
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Dashboard - Network visualization UI and telemetry server
  dashboard:
    build:
      context: .
      dockerfile: packages/dashboard/Dockerfile
    container_name: ilp-dashboard
    environment:
      TELEMETRY_WS_PORT: 9000
      LOG_LEVEL: info
    ports:
      - "8080:8080"  # Dashboard HTTP port
      - "9000:9000"  # Telemetry WebSocket port
    networks:
      - ilp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  ilp-network:
    driver: bridge

# Named volumes for persistent data
volumes:
  # TigerBeetle data volume for settlement accounting database
  # Persists cluster data across container restarts
  # WARNING: Do not delete this volume or cluster data will be lost
  tigerbeetle-data:
    driver: local
