# Docker Compose configuration for hub-and-spoke ILP network
# Topology: Hub-and-Spoke - Central hub with 3 spoke connectors
#
#         Spoke-1
#             ↓
#       ← Hub (center) →
#      ↙           ↘
#  Spoke-2       Spoke-3
#
# All spokes connect to the central hub. All inter-spoke traffic flows through the hub.
#
# This configuration deploys a hub-and-spoke topology with 4 ILP connectors:
# - connector-hub: Central hub (port 3000) - accepts incoming connections
# - spoke-1: Spoke connector 1 (port 3001) - connects to hub
# - spoke-2: Spoke connector 2 (port 3002) - connects to hub
# - spoke-3: Spoke connector 3 (port 3003) - connects to hub
#
# In a hub-and-spoke topology:
# - Hub acts as central relay point for all traffic
# - Spokes only connect to the hub (not to each other)
# - Multi-hop routing: Spoke1 → Hub → Spoke2
# - Simpler configuration than full mesh (scales to O(n) connections)
# - Single point of failure (hub)
#
# Usage:
#   Start: docker-compose -f docker-compose-hub-spoke.yml up -d
#   Logs:  docker-compose -f docker-compose-hub-spoke.yml logs -f
#   Stop:  docker-compose -f docker-compose-hub-spoke.yml down
#
# Prerequisites:
#   1. Build the connector image: docker build -t ilp-connector -f packages/connector/Dockerfile .
#   2. Build the dashboard image: docker build -t ilp-dashboard -f packages/dashboard/Dockerfile .
#   3. Docker Engine 20.10+ and Docker Compose 2.x installed
#
# Configuration:
#   Each connector loads its configuration from a YAML file mounted as a volume.
#   Configuration files are in the examples/ directory:
#   - examples/hub-spoke-hub.yaml
#   - examples/hub-spoke-spoke1.yaml
#   - examples/hub-spoke-spoke2.yaml
#   - examples/hub-spoke-spoke3.yaml
#
#   To customize topology, edit the YAML files or create new ones.

version: '3.8'

services:
  # Hub Connector - Central relay point for spoke connectors
  # The hub must start first as spokes initiate BTP connections to it
  connector-hub:
    image: ilp-connector
    container_name: connector-hub
    environment:
      CONFIG_FILE: /app/config.yaml
      NODE_ID: connector-hub
      LOG_LEVEL: info
      HEALTH_CHECK_PORT: 8080
      # BTP Server Authentication - Environment variables for incoming spoke connections
      BTP_PEER_SPOKE_1_SECRET: secret-spoke1-to-hub
      BTP_PEER_SPOKE_2_SECRET: secret-spoke2-to-hub
      BTP_PEER_SPOKE_3_SECRET: secret-spoke3-to-hub
      # Test client authentication for send-packet tool
      BTP_PEER_SEND_PACKET_CLIENT_SECRET: test-token
    volumes:
      - ./examples/hub-spoke-hub.yaml:/app/config.yaml:ro
    ports:
      - "3000:3000"  # BTP server port
      - "9080:8080"  # Health check HTTP port
    networks:
      - ilp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Spoke-1 - First spoke connector
  # Depends on hub being available for BTP connection
  spoke-1:
    image: ilp-connector
    container_name: spoke-1
    environment:
      CONFIG_FILE: /app/config.yaml
      NODE_ID: spoke-1
      LOG_LEVEL: info
      HEALTH_CHECK_PORT: 8080
      # Test client authentication for send-packet tool
      BTP_PEER_SEND_PACKET_CLIENT_SECRET: test-token
    volumes:
      - ./examples/hub-spoke-spoke1.yaml:/app/config.yaml:ro
    ports:
      - "3001:3001"  # BTP server port
      - "9081:8080"  # Health check HTTP port
    networks:
      - ilp-network
    depends_on:
      - connector-hub
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Spoke-2 - Second spoke connector
  # Depends on hub being available for BTP connection
  spoke-2:
    image: ilp-connector
    container_name: spoke-2
    environment:
      CONFIG_FILE: /app/config.yaml
      NODE_ID: spoke-2
      LOG_LEVEL: info
      HEALTH_CHECK_PORT: 8080
    volumes:
      - ./examples/hub-spoke-spoke2.yaml:/app/config.yaml:ro
    ports:
      - "3002:3002"  # BTP server port
      - "9082:8080"  # Health check HTTP port
    networks:
      - ilp-network
    depends_on:
      - connector-hub
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Spoke-3 - Third spoke connector
  # Depends on hub being available for BTP connection
  spoke-3:
    image: ilp-connector
    container_name: spoke-3
    environment:
      CONFIG_FILE: /app/config.yaml
      NODE_ID: spoke-3
      LOG_LEVEL: info
      HEALTH_CHECK_PORT: 8080
    volumes:
      - ./examples/hub-spoke-spoke3.yaml:/app/config.yaml:ro
    ports:
      - "3003:3003"  # BTP server port
      - "9083:8080"  # Health check HTTP port
    networks:
      - ilp-network
    depends_on:
      - connector-hub
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Dashboard (REMOVED - see DASHBOARD-DEFERRED.md)
  # Visualization deferred to future standalone project.

networks:
  ilp-network:
    driver: bridge
