# Docker Compose configuration for 5-peer multi-hop ILP network
# Topology: Peer1 → Peer2 → Peer3 → Peer4 → Peer5
#
# This configuration deploys a linear chain of 5 production ILP connectors
# with unique ILP addresses for multi-hop packet routing verification.
#
# Components:
# - TigerBeetle: High-performance accounting database for balance tracking
# - Peer1-5: ILP connectors with EVM settlement support
#
# Each peer is funded from the base treasury wallet using m2m token signing and verification.
#
# Prerequisites:
# - Docker and Docker Compose installed
# - Built connector image: docker build -t agent-runtime .
# - TigerBeetle cluster is automatically initialized on first deployment
#
# Usage:
#   Start: docker-compose -f docker-compose-5-peer-multihop.yml up -d --build
#   Logs:  docker-compose -f docker-compose-5-peer-multihop.yml logs -f
#   Stop:  docker-compose -f docker-compose-5-peer-multihop.yml down
#
# Or use the deployment script:
#   ./scripts/deploy-5-peer-multihop.sh

version: '3.8'

services:
  # ===========================================================================
  # TigerBeetle - High-Performance Accounting Database
  # ===========================================================================
  # Role: Tracks peer account balances and settlement state in real-time
  # Protocol: Binary protocol over TCP (not HTTP)
  # Initialization: Data file must be initialized before first start (see deployment script)
  tigerbeetle-5peer:
    image: ghcr.io/tigerbeetle/tigerbeetle:0.16.68
    container_name: tigerbeetle-5peer
    command: start --addresses=0.0.0.0:3000 /data/0_0.tigerbeetle
    security_opt:
      - seccomp=unconfined
    cap_add:
      - IPC_LOCK
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - /tmp/m2m-tigerbeetle:/data
    networks:
      - agent-network
    restart: unless-stopped
    # TigerBeetle healthcheck: The minimal image has no shell/nc, so we disable
    # the healthcheck and rely on start_period + depends_on: service_started
    # TigerBeetle logs "listening on 0.0.0.0:3000" when ready
    healthcheck:
      disable: true
    # TigerBeetle allocates ~3GB during replica init, must have sufficient memory
    mem_limit: 4g
    cpus: '1.0'

  # Peer 1 - Entry node (receives external packets)
  peer1:
    image: agent-runtime
    container_name: peer1
    environment:
      CONFIG_FILE: /app/config.yaml
      NODE_ID: peer1
      ILP_ADDRESS: g.peer1
      LOG_LEVEL: info
      HEALTH_CHECK_PORT: 8080
      EXPLORER_PORT: 5173
      # Admin API configuration (for dynamic peer/route management)
      ADMIN_API_ENABLED: "true"
      ADMIN_API_PORT: 8081
      ADMIN_API_KEY: ${ADMIN_API_KEY:-}
      # TigerBeetle accounting configuration
      TIGERBEETLE_CLUSTER_ID: "0"
      TIGERBEETLE_REPLICAS: tigerbeetle-5peer:3000
      # BTP peer authentication secrets
      BTP_PEER_PEER2_SECRET: secret-peer1-to-peer2
      BTP_PEER_SEND_PACKET_CLIENT_SECRET: test-token
      # Environment and settlement configuration
      ENVIRONMENT: ${ENVIRONMENT:-staging}
      SETTLEMENT_PREFERENCE: evm
      SETTLEMENT_ENABLED: ${SETTLEMENT_ENABLED:-true}
      SETTLEMENT_THRESHOLD: ${SETTLEMENT_THRESHOLD:-1000000}
      INITIAL_DEPOSIT_MULTIPLIER: ${INITIAL_DEPOSIT_MULTIPLIER:-1}
      SETTLEMENT_POLLING_INTERVAL: ${SETTLEMENT_POLLING_INTERVAL:-30000}
      TIGERBEETLE_OPERATION_TIMEOUT: ${TIGERBEETLE_OPERATION_TIMEOUT:-15000}
      BTP_SEND_TIMEOUT_MS: ${BTP_SEND_TIMEOUT_MS:-10000}
      BASE_L2_RPC_URL: ${BASE_L2_RPC_URL:-https://sepolia.base.org}
      TREASURY_EVM_PRIVATE_KEY: ${PEER1_PRIVATE_KEY}
      TOKEN_NETWORK_REGISTRY: ${TOKEN_NETWORK_REGISTRY}
      M2M_TOKEN_ADDRESS: ${M2M_TOKEN_ADDRESS}
      # Peer Ethereum addresses for payment channels
      PEER1_EVM_ADDRESS: ${PEER1_EVM_ADDRESS}
      PEER2_EVM_ADDRESS: ${PEER2_EVM_ADDRESS}
      PEER3_EVM_ADDRESS: ${PEER3_EVM_ADDRESS}
      PEER4_EVM_ADDRESS: ${PEER4_EVM_ADDRESS}
      PEER5_EVM_ADDRESS: ${PEER5_EVM_ADDRESS}
    volumes:
      - ./examples/multihop-peer1.yaml:/app/config.yaml:ro
    ports:
      - "3000:3000"  # BTP server port
      - "9080:8080"  # Health check HTTP port
      - "5173:5173"  # Explorer UI
      - "8181:8081"  # Admin API (internal network access recommended)
    networks:
      - agent-network
    depends_on:
      tigerbeetle-5peer:
        condition: service_started
    restart: unless-stopped
    # Enable io_uring for TigerBeetle client
    security_opt:
      - seccomp=unconfined
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Peer 2 - Transit node 1
  peer2:
    image: agent-runtime
    container_name: peer2
    environment:
      CONFIG_FILE: /app/config.yaml
      NODE_ID: peer2
      ILP_ADDRESS: g.peer2
      LOG_LEVEL: info
      HEALTH_CHECK_PORT: 8080
      EXPLORER_PORT: 5174
      # Admin API configuration (for dynamic peer/route management)
      ADMIN_API_ENABLED: "true"
      ADMIN_API_PORT: 8081
      ADMIN_API_KEY: ${ADMIN_API_KEY:-}
      # TigerBeetle accounting configuration
      TIGERBEETLE_CLUSTER_ID: "0"
      TIGERBEETLE_REPLICAS: tigerbeetle-5peer:3000
      # BTP peer authentication secrets
      BTP_PEER_PEER1_SECRET: secret-peer1-to-peer2
      BTP_PEER_PEER3_SECRET: secret-peer2-to-peer3
      # Settlement configuration - Peer2 uses both EVM and XRP
      ENVIRONMENT: ${ENVIRONMENT:-staging}
      SETTLEMENT_PREFERENCE: both
      SETTLEMENT_ENABLED: ${SETTLEMENT_ENABLED:-true}
      SETTLEMENT_THRESHOLD: ${SETTLEMENT_THRESHOLD:-1000000}
      INITIAL_DEPOSIT_MULTIPLIER: ${INITIAL_DEPOSIT_MULTIPLIER:-1}
      SETTLEMENT_POLLING_INTERVAL: ${SETTLEMENT_POLLING_INTERVAL:-30000}
      TIGERBEETLE_OPERATION_TIMEOUT: ${TIGERBEETLE_OPERATION_TIMEOUT:-15000}
      BTP_SEND_TIMEOUT_MS: ${BTP_SEND_TIMEOUT_MS:-10000}
      # EVM (Base Sepolia) - for Peer1 connection
      BASE_L2_RPC_URL: ${BASE_L2_RPC_URL:-https://sepolia.base.org}
      TREASURY_EVM_PRIVATE_KEY: ${PEER2_PRIVATE_KEY}
      TOKEN_NETWORK_REGISTRY: ${TOKEN_NETWORK_REGISTRY}
      M2M_TOKEN_ADDRESS: ${M2M_TOKEN_ADDRESS}
      # XRP Ledger - for Peer3 connection
      XRPL_WSS_URL: ${XRPL_WSS_URL:-wss://s.altnet.rippletest.net:51233}
      XRP_SEED: ${XRP_SEED}
      # Peer Ethereum addresses for payment channels
      PEER1_EVM_ADDRESS: ${PEER1_EVM_ADDRESS}
      PEER2_EVM_ADDRESS: ${PEER2_EVM_ADDRESS}
      PEER3_EVM_ADDRESS: ${PEER3_EVM_ADDRESS}
      PEER4_EVM_ADDRESS: ${PEER4_EVM_ADDRESS}
      PEER5_EVM_ADDRESS: ${PEER5_EVM_ADDRESS}
    volumes:
      - ./examples/multihop-peer2.yaml:/app/config.yaml:ro
    ports:
      - "3001:3001"  # BTP server port
      - "9081:8080"  # Health check HTTP port
      - "5174:5174"  # Explorer UI
      - "8182:8081"  # Admin API (internal network access recommended)
    networks:
      - agent-network
    depends_on:
      tigerbeetle-5peer:
        condition: service_started
      peer1:
        condition: service_started
    restart: unless-stopped
    # Enable io_uring for TigerBeetle client
    security_opt:
      - seccomp=unconfined
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Peer 3 - Transit node 2 (middle)
  peer3:
    image: agent-runtime
    container_name: peer3
    environment:
      CONFIG_FILE: /app/config.yaml
      NODE_ID: peer3
      ILP_ADDRESS: g.peer3
      LOG_LEVEL: info
      HEALTH_CHECK_PORT: 8080
      EXPLORER_PORT: 5175
      # Admin API configuration (for dynamic peer/route management)
      ADMIN_API_ENABLED: "true"
      ADMIN_API_PORT: 8081
      ADMIN_API_KEY: ${ADMIN_API_KEY:-}
      # TigerBeetle accounting configuration
      TIGERBEETLE_CLUSTER_ID: "0"
      TIGERBEETLE_REPLICAS: tigerbeetle-5peer:3000
      # BTP peer authentication secrets
      BTP_PEER_PEER2_SECRET: secret-peer2-to-peer3
      BTP_PEER_PEER4_SECRET: secret-peer3-to-peer4
      # Settlement configuration - Peer3 uses both XRP and Aptos
      ENVIRONMENT: ${ENVIRONMENT:-staging}
      SETTLEMENT_PREFERENCE: both
      SETTLEMENT_ENABLED: ${SETTLEMENT_ENABLED:-true}
      SETTLEMENT_THRESHOLD: ${SETTLEMENT_THRESHOLD:-1000000}
      INITIAL_DEPOSIT_MULTIPLIER: ${INITIAL_DEPOSIT_MULTIPLIER:-1}
      SETTLEMENT_POLLING_INTERVAL: ${SETTLEMENT_POLLING_INTERVAL:-30000}
      TIGERBEETLE_OPERATION_TIMEOUT: ${TIGERBEETLE_OPERATION_TIMEOUT:-15000}
      BTP_SEND_TIMEOUT_MS: ${BTP_SEND_TIMEOUT_MS:-10000}
      # XRP Ledger - for Peer2 connection
      XRPL_WSS_URL: ${XRPL_WSS_URL:-wss://s.altnet.rippletest.net:51233}
      XRP_SEED: ${PEER3_XRP_SEED}
      XRP_ADDRESS: ${PEER3_XRP_ADDRESS}
      # Aptos - for Peer4 connection
      APTOS_NODE_URL: ${APTOS_NODE_URL:-https://fullnode.testnet.aptoslabs.com/v1}
      APTOS_PRIVATE_KEY: ${PEER3_APTOS_PRIVATE_KEY}
      APTOS_ADDRESS: ${PEER3_APTOS_ADDRESS}
      APTOS_MODULE_ADDRESS: ${APTOS_MODULE_ADDRESS}
      # EVM required for initialization (even though Peer3 uses XRP/Aptos)
      BASE_L2_RPC_URL: ${BASE_L2_RPC_URL:-https://sepolia.base.org}
      TREASURY_EVM_PRIVATE_KEY: ${PEER3_PRIVATE_KEY}
      TOKEN_NETWORK_REGISTRY: ${TOKEN_NETWORK_REGISTRY}
      M2M_TOKEN_ADDRESS: ${M2M_TOKEN_ADDRESS}
    volumes:
      - ./examples/multihop-peer3.yaml:/app/config.yaml:ro
    ports:
      - "3002:3002"  # BTP server port
      - "9082:8080"  # Health check HTTP port
      - "5175:5175"  # Explorer UI
      - "8183:8081"  # Admin API (internal network access recommended)
    networks:
      - agent-network
    depends_on:
      tigerbeetle-5peer:
        condition: service_started
      peer2:
        condition: service_started
    restart: unless-stopped
    # Enable io_uring for TigerBeetle client
    security_opt:
      - seccomp=unconfined
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Peer 4 - Transit node 3
  peer4:
    image: agent-runtime
    container_name: peer4
    environment:
      CONFIG_FILE: /app/config.yaml
      NODE_ID: peer4
      ILP_ADDRESS: g.peer4
      LOG_LEVEL: info
      HEALTH_CHECK_PORT: 8080
      EXPLORER_PORT: 5176
      # Admin API configuration (for dynamic peer/route management)
      ADMIN_API_ENABLED: "true"
      ADMIN_API_PORT: 8081
      ADMIN_API_KEY: ${ADMIN_API_KEY:-}
      # TigerBeetle accounting configuration
      TIGERBEETLE_CLUSTER_ID: "0"
      TIGERBEETLE_REPLICAS: tigerbeetle-5peer:3000
      # BTP peer authentication secrets
      BTP_PEER_PEER3_SECRET: secret-peer3-to-peer4
      BTP_PEER_PEER5_SECRET: secret-peer4-to-peer5
      # Settlement configuration - Peer4 uses both Aptos and EVM
      ENVIRONMENT: ${ENVIRONMENT:-staging}
      SETTLEMENT_PREFERENCE: both
      SETTLEMENT_ENABLED: ${SETTLEMENT_ENABLED:-true}
      SETTLEMENT_THRESHOLD: ${SETTLEMENT_THRESHOLD:-1000000}
      INITIAL_DEPOSIT_MULTIPLIER: ${INITIAL_DEPOSIT_MULTIPLIER:-1}
      SETTLEMENT_POLLING_INTERVAL: ${SETTLEMENT_POLLING_INTERVAL:-30000}
      TIGERBEETLE_OPERATION_TIMEOUT: ${TIGERBEETLE_OPERATION_TIMEOUT:-15000}
      BTP_SEND_TIMEOUT_MS: ${BTP_SEND_TIMEOUT_MS:-10000}
      # Aptos - for Peer3 connection
      APTOS_NODE_URL: ${APTOS_NODE_URL:-https://fullnode.testnet.aptoslabs.com/v1}
      APTOS_PRIVATE_KEY: ${PEER4_APTOS_PRIVATE_KEY}
      APTOS_ADDRESS: ${PEER4_APTOS_ADDRESS}
      APTOS_MODULE_ADDRESS: ${APTOS_MODULE_ADDRESS}
      # EVM (Base Sepolia) - for Peer5 connection
      BASE_L2_RPC_URL: ${BASE_L2_RPC_URL:-https://sepolia.base.org}
      TREASURY_EVM_PRIVATE_KEY: ${PEER4_PRIVATE_KEY}
      TOKEN_NETWORK_REGISTRY: ${TOKEN_NETWORK_REGISTRY}
      M2M_TOKEN_ADDRESS: ${M2M_TOKEN_ADDRESS}
      # Peer Ethereum addresses for payment channels
      PEER1_EVM_ADDRESS: ${PEER1_EVM_ADDRESS}
      PEER2_EVM_ADDRESS: ${PEER2_EVM_ADDRESS}
      PEER3_EVM_ADDRESS: ${PEER3_EVM_ADDRESS}
      PEER4_EVM_ADDRESS: ${PEER4_EVM_ADDRESS}
      PEER5_EVM_ADDRESS: ${PEER5_EVM_ADDRESS}
    volumes:
      - ./examples/multihop-peer4.yaml:/app/config.yaml:ro
    ports:
      - "3003:3003"  # BTP server port
      - "9083:8080"  # Health check HTTP port
      - "5176:5176"  # Explorer UI
      - "8184:8081"  # Admin API (internal network access recommended)
    networks:
      - agent-network
    depends_on:
      tigerbeetle-5peer:
        condition: service_started
      peer3:
        condition: service_started
    restart: unless-stopped
    # Enable io_uring for TigerBeetle client
    security_opt:
      - seccomp=unconfined
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Peer 5 - Exit node (destination)
  peer5:
    image: agent-runtime
    container_name: peer5
    environment:
      CONFIG_FILE: /app/config.yaml
      NODE_ID: peer5
      ILP_ADDRESS: g.peer5
      LOG_LEVEL: info
      HEALTH_CHECK_PORT: 8080
      EXPLORER_PORT: 5177
      # Admin API configuration (for dynamic peer/route management)
      ADMIN_API_ENABLED: "true"
      ADMIN_API_PORT: 8081
      ADMIN_API_KEY: ${ADMIN_API_KEY:-}
      # TigerBeetle accounting configuration
      TIGERBEETLE_CLUSTER_ID: "0"
      TIGERBEETLE_REPLICAS: tigerbeetle-5peer:3000
      # BTP peer authentication secrets
      BTP_PEER_PEER4_SECRET: secret-peer4-to-peer5
      # Settlement configuration
      ENVIRONMENT: ${ENVIRONMENT:-staging}
      SETTLEMENT_PREFERENCE: evm
      SETTLEMENT_ENABLED: ${SETTLEMENT_ENABLED:-true}
      SETTLEMENT_THRESHOLD: ${SETTLEMENT_THRESHOLD:-1000000}
      INITIAL_DEPOSIT_MULTIPLIER: ${INITIAL_DEPOSIT_MULTIPLIER:-1}
      SETTLEMENT_POLLING_INTERVAL: ${SETTLEMENT_POLLING_INTERVAL:-30000}
      TIGERBEETLE_OPERATION_TIMEOUT: ${TIGERBEETLE_OPERATION_TIMEOUT:-15000}
      BTP_SEND_TIMEOUT_MS: ${BTP_SEND_TIMEOUT_MS:-10000}
      BASE_L2_RPC_URL: ${BASE_L2_RPC_URL:-https://sepolia.base.org}
      TREASURY_EVM_PRIVATE_KEY: ${PEER5_PRIVATE_KEY}
      TOKEN_NETWORK_REGISTRY: ${TOKEN_NETWORK_REGISTRY}
      M2M_TOKEN_ADDRESS: ${M2M_TOKEN_ADDRESS}
      # Peer Ethereum addresses for payment channels
      PEER1_EVM_ADDRESS: ${PEER1_EVM_ADDRESS}
      PEER2_EVM_ADDRESS: ${PEER2_EVM_ADDRESS}
      PEER3_EVM_ADDRESS: ${PEER3_EVM_ADDRESS}
      PEER4_EVM_ADDRESS: ${PEER4_EVM_ADDRESS}
      PEER5_EVM_ADDRESS: ${PEER5_EVM_ADDRESS}
    volumes:
      - ./examples/multihop-peer5.yaml:/app/config.yaml:ro
    ports:
      - "3004:3004"  # BTP server port
      - "9084:8080"  # Health check HTTP port
      - "5177:5177"  # Explorer UI
      - "8185:8081"  # Admin API (internal network access recommended)
    networks:
      - agent-network
    depends_on:
      tigerbeetle-5peer:
        condition: service_started
      peer4:
        condition: service_started
    restart: unless-stopped
    # Enable io_uring for TigerBeetle client
    security_opt:
      - seccomp=unconfined
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Anvil removed - using Base Sepolia public testnet
  # To use local Anvil instead, uncomment and set BASE_L2_RPC_URL=http://anvil:8545
  # anvil:
  #   image: ghcr.io/foundry-rs/foundry:latest
  #   container_name: anvil
  #   command: anvil --host 0.0.0.0 --port 8545
  #   ports:
  #     - "8545:8545"
  #   networks:
  #     - agent-network

networks:
  agent-network:
    driver: bridge

# ===========================================================================
# Volumes - Persistent Data Storage
# ===========================================================================
# Note: TigerBeetle now uses bind mount (./data/tigerbeetle) instead of named volume
# for OrbStack compatibility on macOS (OrbStack's named volume implementation causes
# fstatat syscall failures in TigerBeetle's open_data_file function)
# volumes:
#   tigerbeetle-5peer-data:
#     driver: local

# Note: All peers now have settlement enabled with payment channels
# Configuration loaded from .env:
# - TOKEN_NETWORK_REGISTRY
# - M2M_TOKEN_ADDRESS
# - SETTLEMENT_ENABLED=true
# - SETTLEMENT_THRESHOLD=1000000
#
# ===========================================================================
# Admin API - Dynamic Peer/Route Management
# ===========================================================================
# Each peer exposes an Admin API for runtime configuration:
#   - Peer1: http://localhost:8181/admin  (internal: peer1:8081)
#   - Peer2: http://localhost:8182/admin  (internal: peer2:8081)
#   - Peer3: http://localhost:8183/admin  (internal: peer3:8081)
#   - Peer4: http://localhost:8184/admin  (internal: peer4:8081)
#   - Peer5: http://localhost:8185/admin  (internal: peer5:8081)
#
# Example - Add a new peer dynamically:
#   curl -X POST http://localhost:8181/admin/peers \
#     -H "Content-Type: application/json" \
#     -d '{"id": "agent-alice", "url": "ws://agent-alice:3000", "authToken": "secret", "routes": [{"prefix": "g.agent.alice"}]}'
#
# Optional API key authentication:
#   Set ADMIN_API_KEY in .env file
#   Include header: -H "X-Api-Key: your-key"
#
# Security: Admin API is intended for internal network access only.
# The port mappings (8181-8185) can be removed for production to restrict
# access to only containers within the Docker network.
