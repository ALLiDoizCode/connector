# Unified Docker Compose — Full 3-Layer Agent Network (16 Services)
#
# Architecture (per peer):
#   Layer 1: agent-society  — BLS (Business Logic Server) + Nostr relay + bootstrap
#   Layer 2: agent-runtime  — Thin bidirectional ILP middleware (packet forwarder)
#   Layer 3: peer (connector) — ILP connector with TigerBeetle accounting + settlement
#
# Services (16 total):
#   1x TigerBeetle       — High-performance accounting database
#   5x agent-society-{1..5} — BLS + Nostr relay (handles negotiation, events, AI)
#   5x agent-runtime-{1..5} — Bidirectional middleware (ILP packet forwarding)
#   5x peer{1..5}           — ILP connectors (routing, accounting, settlement)
#
# Startup Dependency Chain:
#   tigerbeetle (service_started) + agent-society-{N} (service_healthy)
#     -> peer{N} (service_healthy)
#       -> agent-runtime-{N} (service_healthy)  [needs BTP to peer + BLS to agent-society]
#
# Port Mappings (host:internal):
#   BTP (connector):     3000-3004 : 3000-3004
#   Health (connector):  9080-9084 : 8080
#   Admin (connector):   8181-8185 : 8081
#   BLS (agent-society): 3110-3114 : 3100
#   Relay (agent-society): 7110-7114 : 7100
#   Middleware (agent-runtime): 3200-3204 : 3100
#
# Prerequisites — Build Docker images before running:
#   1. Connector:  docker build -t agent-runtime .
#   2. Middleware:  docker build -t agent-runtime-core -f packages/agent-runtime/Dockerfile .
#   3. BLS:        docker build -t agent-society <agent-society-repo-path>
#
# Usage:
#   Start: docker compose -f docker-compose-unified.yml --env-file .env.peers up -d
#   Logs:  docker compose -f docker-compose-unified.yml logs -f
#   Stop:  docker compose -f docker-compose-unified.yml down

services:
  # ===========================================================================
  # TigerBeetle - High-Performance Accounting Database
  # ===========================================================================
  # Role: Tracks peer account balances and settlement state in real-time
  # Protocol: Binary protocol over TCP (not HTTP)
  tigerbeetle:
    image: ghcr.io/tigerbeetle/tigerbeetle:0.16.68
    container_name: tigerbeetle-unified
    command: start --addresses=0.0.0.0:3000 /data/0_0.tigerbeetle
    security_opt:
      - seccomp=unconfined
    cap_add:
      - IPC_LOCK
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - /tmp/m2m-tigerbeetle:/data
    networks:
      - agent-network
    restart: unless-stopped
    healthcheck:
      disable: true
    mem_limit: 4g
    cpus: '1.0'

  # ===========================================================================
  # Layer 1: Agent Society (BLS + Nostr Relay + Bootstrap)
  # ===========================================================================

  # Agent Society 1 - Bootstrap Node
  agent-society-1:
    image: agent-society
    container_name: agent-society-1
    environment:
      NODE_ID: agent-society-1
      NOSTR_SECRET_KEY: ${PEER1_NOSTR_SECRET_KEY}
      ILP_ADDRESS: g.peer1
      BTP_ENDPOINT: ws://peer1:3000
      CONNECTOR_ADMIN_URL: http://peer1:8081
      AGENT_RUNTIME_URL: http://agent-runtime-1:3100
      BLS_PORT: "3100"
      WS_PORT: "7100"
      ASSET_CODE: USD
      ASSET_SCALE: "6"
      BASE_PRICE_PER_BYTE: "10"
      SPSP_MIN_PRICE: "0"
      SUPPORTED_CHAINS: "evm:base:8453"
      SETTLEMENT_ADDRESS_EVM_BASE: ${PEER1_EVM_ADDRESS}
      PREFERRED_TOKEN_EVM_BASE: ${AGENT_TOKEN_ADDRESS}
      TOKEN_NETWORK_EVM_BASE: ${TOKEN_NETWORK_ADDRESS}
      SETTLEMENT_TIMEOUT: "86400"
      INITIAL_DEPOSIT: "1000000"
      KNOWN_PEERS: "[]"
    ports:
      - "3110:3100"  # BLS HTTP
      - "7110:7100"  # Nostr relay WebSocket
    networks:
      - agent-network
    depends_on:
      tigerbeetle:
        condition: service_started
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:3100/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Agent Society 2 - Bootstraps with Peer1
  agent-society-2:
    image: agent-society
    container_name: agent-society-2
    environment:
      NODE_ID: agent-society-2
      NOSTR_SECRET_KEY: ${PEER2_NOSTR_SECRET_KEY}
      ILP_ADDRESS: g.peer2
      BTP_ENDPOINT: ws://peer2:3001
      CONNECTOR_ADMIN_URL: http://peer2:8081
      AGENT_RUNTIME_URL: http://agent-runtime-2:3100
      BLS_PORT: "3100"
      WS_PORT: "7100"
      ASSET_CODE: USD
      ASSET_SCALE: "6"
      BASE_PRICE_PER_BYTE: "10"
      SUPPORTED_CHAINS: "evm:base:8453"
      SETTLEMENT_ADDRESS_EVM_BASE: ${PEER2_EVM_ADDRESS}
      PREFERRED_TOKEN_EVM_BASE: ${AGENT_TOKEN_ADDRESS}
      TOKEN_NETWORK_EVM_BASE: ${TOKEN_NETWORK_ADDRESS}
      SETTLEMENT_TIMEOUT: "86400"
      INITIAL_DEPOSIT: "1000000"
      KNOWN_PEERS: |
        [{"pubkey": "${PEER1_NOSTR_PUBKEY}", "relayUrl": "ws://agent-society-1:7100", "btpEndpoint": "ws://peer1:3000"}]
    ports:
      - "3111:3100"  # BLS HTTP
      - "7111:7100"  # Nostr relay WebSocket
    networks:
      - agent-network
    depends_on:
      tigerbeetle:
        condition: service_started
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:3100/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Agent Society 3 - Bootstraps with Peer1
  agent-society-3:
    image: agent-society
    container_name: agent-society-3
    environment:
      NODE_ID: agent-society-3
      NOSTR_SECRET_KEY: ${PEER3_NOSTR_SECRET_KEY}
      ILP_ADDRESS: g.peer3
      BTP_ENDPOINT: ws://peer3:3002
      CONNECTOR_ADMIN_URL: http://peer3:8081
      AGENT_RUNTIME_URL: http://agent-runtime-3:3100
      BLS_PORT: "3100"
      WS_PORT: "7100"
      ASSET_CODE: USD
      ASSET_SCALE: "6"
      BASE_PRICE_PER_BYTE: "10"
      SUPPORTED_CHAINS: "evm:base:8453"
      SETTLEMENT_ADDRESS_EVM_BASE: ${PEER3_EVM_ADDRESS}
      PREFERRED_TOKEN_EVM_BASE: ${AGENT_TOKEN_ADDRESS}
      TOKEN_NETWORK_EVM_BASE: ${TOKEN_NETWORK_ADDRESS}
      SETTLEMENT_TIMEOUT: "86400"
      INITIAL_DEPOSIT: "1000000"
      KNOWN_PEERS: |
        [{"pubkey": "${PEER1_NOSTR_PUBKEY}", "relayUrl": "ws://agent-society-1:7100", "btpEndpoint": "ws://peer1:3000"}]
    ports:
      - "3112:3100"  # BLS HTTP
      - "7112:7100"  # Nostr relay WebSocket
    networks:
      - agent-network
    depends_on:
      tigerbeetle:
        condition: service_started
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:3100/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Agent Society 4 - Bootstraps with Peer1
  agent-society-4:
    image: agent-society
    container_name: agent-society-4
    environment:
      NODE_ID: agent-society-4
      NOSTR_SECRET_KEY: ${PEER4_NOSTR_SECRET_KEY}
      ILP_ADDRESS: g.peer4
      BTP_ENDPOINT: ws://peer4:3003
      CONNECTOR_ADMIN_URL: http://peer4:8081
      AGENT_RUNTIME_URL: http://agent-runtime-4:3100
      BLS_PORT: "3100"
      WS_PORT: "7100"
      ASSET_CODE: USD
      ASSET_SCALE: "6"
      BASE_PRICE_PER_BYTE: "10"
      SUPPORTED_CHAINS: "evm:base:8453"
      SETTLEMENT_ADDRESS_EVM_BASE: ${PEER4_EVM_ADDRESS}
      PREFERRED_TOKEN_EVM_BASE: ${AGENT_TOKEN_ADDRESS}
      TOKEN_NETWORK_EVM_BASE: ${TOKEN_NETWORK_ADDRESS}
      SETTLEMENT_TIMEOUT: "86400"
      INITIAL_DEPOSIT: "1000000"
      KNOWN_PEERS: |
        [{"pubkey": "${PEER1_NOSTR_PUBKEY}", "relayUrl": "ws://agent-society-1:7100", "btpEndpoint": "ws://peer1:3000"}]
    ports:
      - "3113:3100"  # BLS HTTP
      - "7113:7100"  # Nostr relay WebSocket
    networks:
      - agent-network
    depends_on:
      tigerbeetle:
        condition: service_started
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:3100/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Agent Society 5 - Bootstraps with Peer1
  agent-society-5:
    image: agent-society
    container_name: agent-society-5
    environment:
      NODE_ID: agent-society-5
      NOSTR_SECRET_KEY: ${PEER5_NOSTR_SECRET_KEY}
      ILP_ADDRESS: g.peer5
      BTP_ENDPOINT: ws://peer5:3004
      CONNECTOR_ADMIN_URL: http://peer5:8081
      AGENT_RUNTIME_URL: http://agent-runtime-5:3100
      BLS_PORT: "3100"
      WS_PORT: "7100"
      ASSET_CODE: USD
      ASSET_SCALE: "6"
      BASE_PRICE_PER_BYTE: "10"
      SUPPORTED_CHAINS: "evm:base:8453"
      SETTLEMENT_ADDRESS_EVM_BASE: ${PEER5_EVM_ADDRESS}
      PREFERRED_TOKEN_EVM_BASE: ${AGENT_TOKEN_ADDRESS}
      TOKEN_NETWORK_EVM_BASE: ${TOKEN_NETWORK_ADDRESS}
      SETTLEMENT_TIMEOUT: "86400"
      INITIAL_DEPOSIT: "1000000"
      KNOWN_PEERS: |
        [{"pubkey": "${PEER1_NOSTR_PUBKEY}", "relayUrl": "ws://agent-society-1:7100", "btpEndpoint": "ws://peer1:3000"}]
    ports:
      - "3114:3100"  # BLS HTTP
      - "7114:7100"  # Nostr relay WebSocket
    networks:
      - agent-network
    depends_on:
      tigerbeetle:
        condition: service_started
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:3100/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ===========================================================================
  # Layer 2: Agent Runtime (Bidirectional ILP Middleware)
  # ===========================================================================

  # Agent Runtime 1 - Middleware for Peer1
  agent-runtime-1:
    image: agent-runtime-core
    container_name: agent-runtime-1
    environment:
      PORT: "3100"
      BASE_ADDRESS: g.peer1
      BUSINESS_LOGIC_URL: http://agent-society-1:3100
      CONNECTOR_BTP_URL: ws://peer1:3000
      CONNECTOR_BTP_AUTH_TOKEN: test-token
      CONNECTOR_BTP_MAX_RETRIES: "20"
      CONNECTOR_BTP_PACKET_TIMEOUT_MS: "30000"
      LOG_LEVEL: info
      NODE_ID: agent-runtime-1
    ports:
      - "3200:3100"  # Middleware HTTP
    networks:
      - agent-network
    depends_on:
      agent-society-1:
        condition: service_healthy
      peer1:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3100/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Agent Runtime 2 - Middleware for Peer2
  agent-runtime-2:
    image: agent-runtime-core
    container_name: agent-runtime-2
    environment:
      PORT: "3100"
      BASE_ADDRESS: g.peer2
      BUSINESS_LOGIC_URL: http://agent-society-2:3100
      CONNECTOR_BTP_URL: ws://peer2:3001
      CONNECTOR_BTP_AUTH_TOKEN: test-token
      CONNECTOR_BTP_MAX_RETRIES: "20"
      CONNECTOR_BTP_PACKET_TIMEOUT_MS: "30000"
      LOG_LEVEL: info
      NODE_ID: agent-runtime-2
    ports:
      - "3201:3100"  # Middleware HTTP
    networks:
      - agent-network
    depends_on:
      agent-society-2:
        condition: service_healthy
      peer2:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3100/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Agent Runtime 3 - Middleware for Peer3
  agent-runtime-3:
    image: agent-runtime-core
    container_name: agent-runtime-3
    environment:
      PORT: "3100"
      BASE_ADDRESS: g.peer3
      BUSINESS_LOGIC_URL: http://agent-society-3:3100
      CONNECTOR_BTP_URL: ws://peer3:3002
      CONNECTOR_BTP_AUTH_TOKEN: test-token
      CONNECTOR_BTP_MAX_RETRIES: "20"
      CONNECTOR_BTP_PACKET_TIMEOUT_MS: "30000"
      LOG_LEVEL: info
      NODE_ID: agent-runtime-3
    ports:
      - "3202:3100"  # Middleware HTTP
    networks:
      - agent-network
    depends_on:
      agent-society-3:
        condition: service_healthy
      peer3:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3100/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Agent Runtime 4 - Middleware for Peer4
  agent-runtime-4:
    image: agent-runtime-core
    container_name: agent-runtime-4
    environment:
      PORT: "3100"
      BASE_ADDRESS: g.peer4
      BUSINESS_LOGIC_URL: http://agent-society-4:3100
      CONNECTOR_BTP_URL: ws://peer4:3003
      CONNECTOR_BTP_AUTH_TOKEN: test-token
      CONNECTOR_BTP_MAX_RETRIES: "20"
      CONNECTOR_BTP_PACKET_TIMEOUT_MS: "30000"
      LOG_LEVEL: info
      NODE_ID: agent-runtime-4
    ports:
      - "3203:3100"  # Middleware HTTP
    networks:
      - agent-network
    depends_on:
      agent-society-4:
        condition: service_healthy
      peer4:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3100/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Agent Runtime 5 - Middleware for Peer5
  agent-runtime-5:
    image: agent-runtime-core
    container_name: agent-runtime-5
    environment:
      PORT: "3100"
      BASE_ADDRESS: g.peer5
      BUSINESS_LOGIC_URL: http://agent-society-5:3100
      CONNECTOR_BTP_URL: ws://peer5:3004
      CONNECTOR_BTP_AUTH_TOKEN: test-token
      CONNECTOR_BTP_MAX_RETRIES: "20"
      CONNECTOR_BTP_PACKET_TIMEOUT_MS: "30000"
      LOG_LEVEL: info
      NODE_ID: agent-runtime-5
    ports:
      - "3204:3100"  # Middleware HTTP
    networks:
      - agent-network
    depends_on:
      agent-society-5:
        condition: service_healthy
      peer5:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3100/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ===========================================================================
  # Layer 3: ILP Connectors (Routing, Accounting, Settlement)
  # ===========================================================================

  # Peer 1 - Entry node
  peer1:
    image: agent-runtime
    container_name: peer1
    environment:
      CONFIG_FILE: /app/config.yaml
      NODE_ID: peer1
      ILP_ADDRESS: g.peer1
      LOG_LEVEL: info
      HEALTH_CHECK_PORT: 8080
      EXPLORER_PORT: 5173
      # Admin API
      ADMIN_API_ENABLED: "true"
      ADMIN_API_PORT: 8081
      ADMIN_API_KEY: ${ADMIN_API_KEY:-}
      # Local delivery to agent-runtime middleware
      LOCAL_DELIVERY_ENABLED: "true"
      LOCAL_DELIVERY_URL: http://agent-runtime-1:3100
      # TigerBeetle accounting
      TIGERBEETLE_CLUSTER_ID: "0"
      TIGERBEETLE_REPLICAS: tigerbeetle:3000
      TIGERBEETLE_OPERATION_TIMEOUT: "15000"
      SETTLEMENT_POLLING_INTERVAL: "120000"
      BTP_SEND_TIMEOUT_MS: "30000"
      # BTP peer authentication
      BTP_PEER_PEER2_SECRET: secret-peer1-to-peer2
      BTP_PEER_AGENT_RUNTIME_SECRET: test-token
      # Settlement
      ENVIRONMENT: ${ENVIRONMENT:-staging}
      INITIAL_DEPOSIT_MULTIPLIER: ${INITIAL_DEPOSIT_MULTIPLIER:-1}
      SETTLEMENT_PREFERENCE: evm
      SETTLEMENT_ENABLED: ${SETTLEMENT_ENABLED:-true}
      SETTLEMENT_THRESHOLD: ${SETTLEMENT_THRESHOLD:-1000000}
      BASE_L2_RPC_URL: ${BASE_L2_RPC_URL:-https://sepolia.base.org}
      TREASURY_EVM_PRIVATE_KEY: ${PEER1_PRIVATE_KEY}
      TOKEN_NETWORK_REGISTRY: ${TOKEN_NETWORK_REGISTRY}
      M2M_TOKEN_ADDRESS: ${M2M_TOKEN_ADDRESS}
      PEER1_EVM_ADDRESS: ${PEER1_EVM_ADDRESS}
      PEER2_EVM_ADDRESS: ${PEER2_EVM_ADDRESS}
      PEER3_EVM_ADDRESS: ${PEER3_EVM_ADDRESS}
      PEER4_EVM_ADDRESS: ${PEER4_EVM_ADDRESS}
      PEER5_EVM_ADDRESS: ${PEER5_EVM_ADDRESS}
    volumes:
      - ./examples/multihop-peer1.yaml:/app/config.yaml:ro
    ports:
      - "3000:3000"  # BTP server
      - "9080:8080"  # Health check
      - "8181:8081"  # Admin API
    networks:
      - agent-network
    depends_on:
      tigerbeetle:
        condition: service_started
    restart: unless-stopped
    security_opt:
      - seccomp=unconfined
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Peer 2 - Transit node 1
  peer2:
    image: agent-runtime
    container_name: peer2
    environment:
      CONFIG_FILE: /app/config.yaml
      NODE_ID: peer2
      ILP_ADDRESS: g.peer2
      LOG_LEVEL: info
      HEALTH_CHECK_PORT: 8080
      # Explorer port must not conflict with btpServerPort (3001)
      EXPLORER_PORT: 5174
      # Admin API
      ADMIN_API_ENABLED: "true"
      ADMIN_API_PORT: 8081
      ADMIN_API_KEY: ${ADMIN_API_KEY:-}
      # Local delivery to agent-runtime middleware
      LOCAL_DELIVERY_ENABLED: "true"
      LOCAL_DELIVERY_URL: http://agent-runtime-2:3100
      # TigerBeetle accounting
      TIGERBEETLE_CLUSTER_ID: "0"
      TIGERBEETLE_REPLICAS: tigerbeetle:3000
      TIGERBEETLE_OPERATION_TIMEOUT: "15000"
      SETTLEMENT_POLLING_INTERVAL: "120000"
      BTP_SEND_TIMEOUT_MS: "30000"
      # BTP peer authentication
      BTP_PEER_PEER1_SECRET: secret-peer1-to-peer2
      BTP_PEER_PEER3_SECRET: secret-peer2-to-peer3
      BTP_PEER_AGENT_RUNTIME_SECRET: test-token
      # Settlement
      ENVIRONMENT: ${ENVIRONMENT:-staging}
      INITIAL_DEPOSIT_MULTIPLIER: ${INITIAL_DEPOSIT_MULTIPLIER:-1}
      SETTLEMENT_PREFERENCE: both
      SETTLEMENT_ENABLED: ${SETTLEMENT_ENABLED:-true}
      SETTLEMENT_THRESHOLD: ${SETTLEMENT_THRESHOLD:-1000000}
      BASE_L2_RPC_URL: ${BASE_L2_RPC_URL:-https://sepolia.base.org}
      TREASURY_EVM_PRIVATE_KEY: ${PEER2_PRIVATE_KEY}
      TOKEN_NETWORK_REGISTRY: ${TOKEN_NETWORK_REGISTRY}
      M2M_TOKEN_ADDRESS: ${M2M_TOKEN_ADDRESS}
      XRPL_WSS_URL: ${XRPL_WSS_URL:-wss://s.altnet.rippletest.net:51233}
      XRP_SEED: ${XRP_SEED}
      PEER1_EVM_ADDRESS: ${PEER1_EVM_ADDRESS}
      PEER2_EVM_ADDRESS: ${PEER2_EVM_ADDRESS}
      PEER3_EVM_ADDRESS: ${PEER3_EVM_ADDRESS}
      PEER4_EVM_ADDRESS: ${PEER4_EVM_ADDRESS}
      PEER5_EVM_ADDRESS: ${PEER5_EVM_ADDRESS}
    volumes:
      - ./examples/multihop-peer2.yaml:/app/config.yaml:ro
    ports:
      - "3001:3001"  # BTP server
      - "9081:8080"  # Health check
      - "8182:8081"  # Admin API
    networks:
      - agent-network
    depends_on:
      tigerbeetle:
        condition: service_started
    restart: unless-stopped
    security_opt:
      - seccomp=unconfined
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Peer 3 - Transit node 2 (middle)
  peer3:
    image: agent-runtime
    container_name: peer3
    environment:
      CONFIG_FILE: /app/config.yaml
      NODE_ID: peer3
      ILP_ADDRESS: g.peer3
      LOG_LEVEL: info
      HEALTH_CHECK_PORT: 8080
      EXPLORER_PORT: 5175
      # Admin API
      ADMIN_API_ENABLED: "true"
      ADMIN_API_PORT: 8081
      ADMIN_API_KEY: ${ADMIN_API_KEY:-}
      # Local delivery to agent-runtime middleware
      LOCAL_DELIVERY_ENABLED: "true"
      LOCAL_DELIVERY_URL: http://agent-runtime-3:3100
      # TigerBeetle accounting
      TIGERBEETLE_CLUSTER_ID: "0"
      TIGERBEETLE_REPLICAS: tigerbeetle:3000
      TIGERBEETLE_OPERATION_TIMEOUT: "15000"
      SETTLEMENT_POLLING_INTERVAL: "120000"
      BTP_SEND_TIMEOUT_MS: "30000"
      # BTP peer authentication
      BTP_PEER_PEER2_SECRET: secret-peer2-to-peer3
      BTP_PEER_PEER4_SECRET: secret-peer3-to-peer4
      BTP_PEER_AGENT_RUNTIME_SECRET: test-token
      # Settlement
      ENVIRONMENT: ${ENVIRONMENT:-staging}
      INITIAL_DEPOSIT_MULTIPLIER: ${INITIAL_DEPOSIT_MULTIPLIER:-1}
      SETTLEMENT_PREFERENCE: both
      SETTLEMENT_ENABLED: ${SETTLEMENT_ENABLED:-true}
      SETTLEMENT_THRESHOLD: ${SETTLEMENT_THRESHOLD:-1000000}
      XRPL_WSS_URL: ${XRPL_WSS_URL:-wss://s.altnet.rippletest.net:51233}
      XRP_SEED: ${PEER3_XRP_SEED}
      XRP_ADDRESS: ${PEER3_XRP_ADDRESS}
      APTOS_NODE_URL: ${APTOS_NODE_URL:-https://fullnode.testnet.aptoslabs.com/v1}
      APTOS_PRIVATE_KEY: ${PEER3_APTOS_PRIVATE_KEY}
      APTOS_ADDRESS: ${PEER3_APTOS_ADDRESS}
      APTOS_MODULE_ADDRESS: ${APTOS_MODULE_ADDRESS}
      BASE_L2_RPC_URL: ${BASE_L2_RPC_URL:-https://sepolia.base.org}
      TREASURY_EVM_PRIVATE_KEY: ${PEER3_PRIVATE_KEY}
      TOKEN_NETWORK_REGISTRY: ${TOKEN_NETWORK_REGISTRY}
      M2M_TOKEN_ADDRESS: ${M2M_TOKEN_ADDRESS}
    volumes:
      - ./examples/multihop-peer3.yaml:/app/config.yaml:ro
    ports:
      - "3002:3002"  # BTP server
      - "9082:8080"  # Health check
      - "8183:8081"  # Admin API
    networks:
      - agent-network
    depends_on:
      tigerbeetle:
        condition: service_started
    restart: unless-stopped
    security_opt:
      - seccomp=unconfined
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Peer 4 - Transit node 3
  peer4:
    image: agent-runtime
    container_name: peer4
    environment:
      CONFIG_FILE: /app/config.yaml
      NODE_ID: peer4
      ILP_ADDRESS: g.peer4
      LOG_LEVEL: info
      HEALTH_CHECK_PORT: 8080
      EXPLORER_PORT: 5176
      # Admin API
      ADMIN_API_ENABLED: "true"
      ADMIN_API_PORT: 8081
      ADMIN_API_KEY: ${ADMIN_API_KEY:-}
      # Local delivery to agent-runtime middleware
      LOCAL_DELIVERY_ENABLED: "true"
      LOCAL_DELIVERY_URL: http://agent-runtime-4:3100
      # TigerBeetle accounting
      TIGERBEETLE_CLUSTER_ID: "0"
      TIGERBEETLE_REPLICAS: tigerbeetle:3000
      TIGERBEETLE_OPERATION_TIMEOUT: "15000"
      SETTLEMENT_POLLING_INTERVAL: "120000"
      BTP_SEND_TIMEOUT_MS: "30000"
      # BTP peer authentication
      BTP_PEER_PEER3_SECRET: secret-peer3-to-peer4
      BTP_PEER_PEER5_SECRET: secret-peer4-to-peer5
      BTP_PEER_AGENT_RUNTIME_SECRET: test-token
      # Settlement
      ENVIRONMENT: ${ENVIRONMENT:-staging}
      INITIAL_DEPOSIT_MULTIPLIER: ${INITIAL_DEPOSIT_MULTIPLIER:-1}
      SETTLEMENT_PREFERENCE: both
      SETTLEMENT_ENABLED: ${SETTLEMENT_ENABLED:-true}
      SETTLEMENT_THRESHOLD: ${SETTLEMENT_THRESHOLD:-1000000}
      APTOS_NODE_URL: ${APTOS_NODE_URL:-https://fullnode.testnet.aptoslabs.com/v1}
      APTOS_PRIVATE_KEY: ${PEER4_APTOS_PRIVATE_KEY}
      APTOS_ADDRESS: ${PEER4_APTOS_ADDRESS}
      APTOS_MODULE_ADDRESS: ${APTOS_MODULE_ADDRESS}
      BASE_L2_RPC_URL: ${BASE_L2_RPC_URL:-https://sepolia.base.org}
      TREASURY_EVM_PRIVATE_KEY: ${PEER4_PRIVATE_KEY}
      TOKEN_NETWORK_REGISTRY: ${TOKEN_NETWORK_REGISTRY}
      M2M_TOKEN_ADDRESS: ${M2M_TOKEN_ADDRESS}
      PEER1_EVM_ADDRESS: ${PEER1_EVM_ADDRESS}
      PEER2_EVM_ADDRESS: ${PEER2_EVM_ADDRESS}
      PEER3_EVM_ADDRESS: ${PEER3_EVM_ADDRESS}
      PEER4_EVM_ADDRESS: ${PEER4_EVM_ADDRESS}
      PEER5_EVM_ADDRESS: ${PEER5_EVM_ADDRESS}
    volumes:
      - ./examples/multihop-peer4.yaml:/app/config.yaml:ro
    ports:
      - "3003:3003"  # BTP server
      - "9083:8080"  # Health check
      - "8184:8081"  # Admin API
    networks:
      - agent-network
    depends_on:
      tigerbeetle:
        condition: service_started
    restart: unless-stopped
    security_opt:
      - seccomp=unconfined
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Peer 5 - Exit node (destination)
  peer5:
    image: agent-runtime
    container_name: peer5
    environment:
      CONFIG_FILE: /app/config.yaml
      NODE_ID: peer5
      ILP_ADDRESS: g.peer5
      LOG_LEVEL: info
      HEALTH_CHECK_PORT: 8080
      EXPLORER_PORT: 5177
      # Admin API
      ADMIN_API_ENABLED: "true"
      ADMIN_API_PORT: 8081
      ADMIN_API_KEY: ${ADMIN_API_KEY:-}
      # Local delivery to agent-runtime middleware
      LOCAL_DELIVERY_ENABLED: "true"
      LOCAL_DELIVERY_URL: http://agent-runtime-5:3100
      # TigerBeetle accounting
      TIGERBEETLE_CLUSTER_ID: "0"
      TIGERBEETLE_REPLICAS: tigerbeetle:3000
      TIGERBEETLE_OPERATION_TIMEOUT: "15000"
      SETTLEMENT_POLLING_INTERVAL: "120000"
      BTP_SEND_TIMEOUT_MS: "30000"
      # BTP peer authentication
      BTP_PEER_PEER4_SECRET: secret-peer4-to-peer5
      BTP_PEER_AGENT_RUNTIME_SECRET: test-token
      # Settlement
      ENVIRONMENT: ${ENVIRONMENT:-staging}
      INITIAL_DEPOSIT_MULTIPLIER: ${INITIAL_DEPOSIT_MULTIPLIER:-1}
      SETTLEMENT_PREFERENCE: evm
      SETTLEMENT_ENABLED: ${SETTLEMENT_ENABLED:-true}
      SETTLEMENT_THRESHOLD: ${SETTLEMENT_THRESHOLD:-1000000}
      BASE_L2_RPC_URL: ${BASE_L2_RPC_URL:-https://sepolia.base.org}
      TREASURY_EVM_PRIVATE_KEY: ${PEER5_PRIVATE_KEY}
      TOKEN_NETWORK_REGISTRY: ${TOKEN_NETWORK_REGISTRY}
      M2M_TOKEN_ADDRESS: ${M2M_TOKEN_ADDRESS}
      PEER1_EVM_ADDRESS: ${PEER1_EVM_ADDRESS}
      PEER2_EVM_ADDRESS: ${PEER2_EVM_ADDRESS}
      PEER3_EVM_ADDRESS: ${PEER3_EVM_ADDRESS}
      PEER4_EVM_ADDRESS: ${PEER4_EVM_ADDRESS}
      PEER5_EVM_ADDRESS: ${PEER5_EVM_ADDRESS}
    volumes:
      - ./examples/multihop-peer5.yaml:/app/config.yaml:ro
    ports:
      - "3004:3004"  # BTP server
      - "9084:8080"  # Health check
      - "8185:8081"  # Admin API
    networks:
      - agent-network
    depends_on:
      tigerbeetle:
        condition: service_started
    restart: unless-stopped
    security_opt:
      - seccomp=unconfined
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

networks:
  agent-network:
    driver: bridge

# ===========================================================================
# Port Mappings Summary
# ===========================================================================
# BTP (connector):           3000-3004 (host) -> 3000-3004 (internal)
# Health (connector):        9080-9084 (host) -> 8080 (internal)
# Admin API (connector):     8181-8185 (host) -> 8081 (internal)
# BLS HTTP (agent-society):  3110-3114 (host) -> 3100 (internal)
# Relay WS (agent-society):  7110-7114 (host) -> 7100 (internal)
# Middleware (agent-runtime): 3200-3204 (host) -> 3100 (internal)
#
# ===========================================================================
# Admin API Endpoints
# ===========================================================================
#   Peer1: http://localhost:8181/admin  (internal: peer1:8081)
#   Peer2: http://localhost:8182/admin  (internal: peer2:8081)
#   Peer3: http://localhost:8183/admin  (internal: peer3:8081)
#   Peer4: http://localhost:8184/admin  (internal: peer4:8081)
#   Peer5: http://localhost:8185/admin  (internal: peer5:8081)
