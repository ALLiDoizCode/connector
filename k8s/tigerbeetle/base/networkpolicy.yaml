# TigerBeetle NetworkPolicy
# Restricts network access to TigerBeetle pods:
#   - Allow inter-replica communication (consensus)
#   - Allow access from m2m namespace (connectors)
#   - Deny all other ingress
#
# IMPORTANT: Requires a CNI that supports NetworkPolicy (Calico, Cilium, etc.)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: tigerbeetle
  namespace: tigerbeetle
  labels:
    app.kubernetes.io/name: tigerbeetle
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: tigerbeetle
  policyTypes:
    - Ingress
  ingress:
    # Allow inter-replica communication for consensus
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: tigerbeetle
      ports:
        - protocol: TCP
          port: 3000

    # Allow access from m2m connector namespace
    # Adjust namespace label as needed for your deployment
    - from:
        - namespaceSelector:
            matchLabels:
              app.kubernetes.io/part-of: m2m
      ports:
        - protocol: TCP
          port: 3000

    # Allow access from pods with specific label (alternative to namespace)
    - from:
        - podSelector:
            matchLabels:
              tigerbeetle-client: "true"
          namespaceSelector: {}  # Any namespace with matching pod label
      ports:
        - protocol: TCP
          port: 3000
