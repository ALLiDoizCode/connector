# TigerBeetle StatefulSet
# Deploys a 3-replica TigerBeetle cluster with:
#   - Stable network identities for consensus
#   - Persistent storage per replica
#   - Init container for first-time data file formatting
#   - Pod anti-affinity to spread across nodes
#
# Replica addresses (used for consensus):
#   tigerbeetle-0.tigerbeetle-headless.tigerbeetle.svc.cluster.local:3000
#   tigerbeetle-1.tigerbeetle-headless.tigerbeetle.svc.cluster.local:3000
#   tigerbeetle-2.tigerbeetle-headless.tigerbeetle.svc.cluster.local:3000
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: tigerbeetle
  namespace: tigerbeetle
  labels:
    app.kubernetes.io/name: tigerbeetle
    app.kubernetes.io/component: accounting-database
spec:
  serviceName: tigerbeetle-headless
  replicas: 3
  podManagementPolicy: Parallel  # Start all pods simultaneously for cluster formation
  selector:
    matchLabels:
      app.kubernetes.io/name: tigerbeetle
  template:
    metadata:
      labels:
        app.kubernetes.io/name: tigerbeetle
        app.kubernetes.io/component: accounting-database
    spec:
      # Spread replicas across different nodes for fault tolerance
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchLabels:
                  app.kubernetes.io/name: tigerbeetle
              topologyKey: kubernetes.io/hostname

      # Don't restart pods too quickly - TigerBeetle needs time for consensus
      terminationGracePeriodSeconds: 60

      # Security context for TigerBeetle's io_uring requirements
      securityContext:
        fsGroup: 1000

      initContainers:
        # Format the data file on first startup
        # This runs once per pod when the PVC is empty
        - name: format
          image: ghcr.io/tigerbeetle/tigerbeetle:0.16.68
          command:
            - /bin/sh
            - -c
            - |
              set -e

              # Extract replica index from hostname (tigerbeetle-0 -> 0)
              REPLICA_ID=${HOSTNAME##*-}
              CLUSTER_ID=${TIGERBEETLE_CLUSTER_ID:-0}
              DATA_FILE="/data/${CLUSTER_ID}_${REPLICA_ID}.tigerbeetle"

              if [ -f "$DATA_FILE" ]; then
                echo "Data file exists: $DATA_FILE - skipping format"
              else
                echo "Formatting TigerBeetle replica $REPLICA_ID in cluster $CLUSTER_ID"
                /tigerbeetle format \
                  --cluster="$CLUSTER_ID" \
                  --replica="$REPLICA_ID" \
                  --replica-count=3 \
                  "$DATA_FILE"
                echo "Format complete: $DATA_FILE"
              fi
          env:
            - name: TIGERBEETLE_CLUSTER_ID
              value: "0"
          volumeMounts:
            - name: data
              mountPath: /data
          securityContext:
            capabilities:
              add:
                - IPC_LOCK
          resources:
            requests:
              memory: "4Gi"
              cpu: "500m"
            limits:
              memory: "4Gi"
              cpu: "1000m"

      containers:
        - name: tigerbeetle
          image: ghcr.io/tigerbeetle/tigerbeetle:0.16.68
          command:
            - /bin/sh
            - -c
            - |
              set -e

              # Extract replica index from hostname
              REPLICA_ID=${HOSTNAME##*-}
              CLUSTER_ID=${TIGERBEETLE_CLUSTER_ID:-0}
              DATA_FILE="/data/${CLUSTER_ID}_${REPLICA_ID}.tigerbeetle"

              # Build addresses string for all replicas
              # Format: replica0:3000,replica1:3000,replica2:3000
              ADDRESSES="tigerbeetle-0.tigerbeetle-headless.tigerbeetle.svc.cluster.local:3000"
              ADDRESSES="${ADDRESSES},tigerbeetle-1.tigerbeetle-headless.tigerbeetle.svc.cluster.local:3000"
              ADDRESSES="${ADDRESSES},tigerbeetle-2.tigerbeetle-headless.tigerbeetle.svc.cluster.local:3000"

              echo "Starting TigerBeetle replica $REPLICA_ID"
              echo "Cluster addresses: $ADDRESSES"
              echo "Data file: $DATA_FILE"

              exec /tigerbeetle start \
                --addresses="$ADDRESSES" \
                "$DATA_FILE"
          env:
            - name: TIGERBEETLE_CLUSTER_ID
              value: "0"
          ports:
            - name: tigerbeetle
              containerPort: 3000
              protocol: TCP
          volumeMounts:
            - name: data
              mountPath: /data

          # Security context for io_uring and direct I/O
          securityContext:
            capabilities:
              add:
                - IPC_LOCK

          # Resource allocation
          # TigerBeetle uses ~3GB during init, ~1GB steady state
          resources:
            requests:
              memory: "4Gi"
              cpu: "500m"
            limits:
              memory: "4Gi"
              cpu: "1000m"

          # Startup probe - allow time for cluster formation
          # TigerBeetle needs all replicas to establish quorum
          startupProbe:
            tcpSocket:
              port: 3000
            initialDelaySeconds: 10
            periodSeconds: 5
            failureThreshold: 30  # 10 + (5 * 30) = 160 seconds max startup

          # Liveness probe - restart if unhealthy
          livenessProbe:
            tcpSocket:
              port: 3000
            initialDelaySeconds: 10
            periodSeconds: 10
            failureThreshold: 3

          # Readiness probe - remove from service if not ready
          readinessProbe:
            tcpSocket:
              port: 3000
            initialDelaySeconds: 5
            periodSeconds: 5
            failureThreshold: 3

  # Persistent Volume Claim template
  # Each replica gets its own PVC for data durability
  volumeClaimTemplates:
    - metadata:
        name: data
        labels:
          app.kubernetes.io/name: tigerbeetle
      spec:
        accessModes:
          - ReadWriteOnce
        # Use default storage class, or specify one:
        # storageClassName: fast-ssd
        resources:
          requests:
            # TigerBeetle data file is fixed size based on account/transfer capacity
            # Default: ~700MB, can grow with configuration
            # Allocate extra space for safety
            storage: 10Gi
