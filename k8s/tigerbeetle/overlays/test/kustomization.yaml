# Test overlay for single-node Kubernetes (OrbStack, minikube, Docker Desktop)
# Uses single replica mode - suitable for local testing only, NOT production!
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../base

patches:
  # Single replica for local testing
  - patch: |
      - op: replace
        path: /spec/replicas
        value: 1
      # Remove anti-affinity for single node
      - op: remove
        path: /spec/template/spec/affinity
      # Fix command to use single replica addressing
      - op: replace
        path: /spec/template/spec/initContainers/0/command
        value:
          - /bin/sh
          - -c
          - |
            set -e
            REPLICA_ID=0
            CLUSTER_ID=${TIGERBEETLE_CLUSTER_ID:-0}
            DATA_FILE="/data/${CLUSTER_ID}_${REPLICA_ID}.tigerbeetle"
            if [ -f "$DATA_FILE" ]; then
              echo "Data file exists: $DATA_FILE - skipping format"
            else
              echo "Formatting TigerBeetle single replica"
              /tigerbeetle format \
                --cluster="$CLUSTER_ID" \
                --replica=0 \
                --replica-count=1 \
                "$DATA_FILE"
              echo "Format complete"
            fi
      # Single replica start command (local address only)
      - op: replace
        path: /spec/template/spec/containers/0/command
        value:
          - /bin/sh
          - -c
          - |
            set -e
            CLUSTER_ID=${TIGERBEETLE_CLUSTER_ID:-0}
            DATA_FILE="/data/${CLUSTER_ID}_0.tigerbeetle"
            echo "Starting TigerBeetle single replica"
            exec /tigerbeetle start --addresses=0.0.0.0:3000 "$DATA_FILE"
      # Reduce resources for local testing
      - op: replace
        path: /spec/template/spec/initContainers/0/resources
        value:
          requests:
            memory: "1Gi"
            cpu: "100m"
          limits:
            memory: "4Gi"
            cpu: "500m"
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "512Mi"
            cpu: "100m"
          limits:
            memory: "4Gi"
            cpu: "1000m"
    target:
      kind: StatefulSet
      name: tigerbeetle

  # Adjust PDB for single replica (allow 0 disruptions)
  - patch: |
      - op: replace
        path: /spec/minAvailable
        value: 0
    target:
      kind: PodDisruptionBudget
      name: tigerbeetle
