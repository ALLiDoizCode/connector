# Docker Compose configuration for Agent Runtime deployment
#
# This configuration demonstrates how to deploy the Agent Runtime
# with a connector and a custom business logic container.
#
# Architecture:
#   Connector → Agent Runtime → Business Logic
#
# The connector forwards local delivery packets to the agent runtime,
# which handles SPSP/STREAM protocols and calls the business logic
# container for payment decisions.
#
# Usage:
#   Build:  docker build -t ilp-connector .
#           docker build -t agent-runtime -f packages/agent-runtime/Dockerfile .
#   Start:  docker-compose -f docker-compose-agent-runtime.yml up -d
#   Logs:   docker-compose -f docker-compose-agent-runtime.yml logs -f
#   Stop:   docker-compose -f docker-compose-agent-runtime.yml down

version: '3.8'

services:
  # TigerBeetle - Settlement accounting database
  tigerbeetle:
    image: ghcr.io/tigerbeetle/tigerbeetle:latest
    container_name: tigerbeetle
    security_opt:
      - seccomp=unconfined
    environment:
      TIGERBEETLE_CLUSTER_ID: ${TIGERBEETLE_CLUSTER_ID:-0}
      TIGERBEETLE_REPLICA_COUNT: ${TIGERBEETLE_REPLICA_COUNT:-1}
      TIGERBEETLE_DATA_DIR: ${TIGERBEETLE_DATA_DIR:-/data}
    volumes:
      - tigerbeetle-data:/data
      - ./scripts/init-tigerbeetle.sh:/init-tigerbeetle.sh:ro
    networks:
      - ilp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 3000 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    entrypoint: ["/init-tigerbeetle.sh"]

  # Connector - ILP connector with local delivery to agent runtime
  connector:
    image: ilp-connector
    container_name: connector
    environment:
      CONFIG_FILE: /app/config.yaml
      NODE_ID: connector
      LOG_LEVEL: info
      HEALTH_CHECK_PORT: 8080
      # Enable local delivery forwarding to agent runtime
      LOCAL_DELIVERY_ENABLED: "true"
      LOCAL_DELIVERY_URL: http://agent-runtime:3100
      LOCAL_DELIVERY_TIMEOUT: "30000"
    volumes:
      - ./examples/agent-runtime-connector.yaml:/app/config.yaml:ro
    ports:
      - "3000:3000"   # BTP server port
      - "8080:8080"   # Health check HTTP port
      - "3001:3001"   # Explorer UI port
    networks:
      - ilp-network
    depends_on:
      tigerbeetle:
        condition: service_healthy
      agent-runtime:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Agent Runtime - Handles SPSP/STREAM protocols
  agent-runtime:
    image: agent-runtime
    container_name: agent-runtime
    environment:
      PORT: "3100"
      # ILP address prefix - packets to g.connector.agent.* are handled here
      BASE_ADDRESS: g.connector.agent
      # Business logic container URL
      BUSINESS_LOGIC_URL: http://business-logic:8080
      BUSINESS_LOGIC_TIMEOUT: "5000"
      # Enable SPSP endpoint for payment setup
      SPSP_ENABLED: "true"
      # Session TTL (1 hour)
      SESSION_TTL_MS: "3600000"
      LOG_LEVEL: info
      NODE_ID: agent-runtime
    ports:
      - "3100:3100"   # Agent runtime HTTP port (SPSP + packet handling)
    networks:
      - ilp-network
    depends_on:
      business-logic:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3100/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Business Logic - User's custom payment handler
  # Replace this with your own business logic container
  business-logic:
    image: node:22-alpine
    container_name: business-logic
    working_dir: /app
    environment:
      PORT: "8080"
    volumes:
      - ./examples/business-logic-example:/app:ro
    command: ["node", "server.js"]
    ports:
      - "8081:8080"   # Business logic HTTP port
    networks:
      - ilp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

networks:
  ilp-network:
    driver: bridge

volumes:
  tigerbeetle-data:
    driver: local
