# Story 20.4: Fix IlpSendResponse Field Name and Make Peer Registration Idempotent

**Epic:** 20 - Bidirectional Agent-Runtime Middleware
**Story Number:** 20.4
**Status:** Done
**Priority:** P0 (Critical — Bootstrap Broken)

## Story

**As a** BLS developer,
**I want** the `POST /ilp/send` response to use `accepted` instead of `fulfilled` and `POST /admin/peers` to handle re-registration gracefully,
**so that** agent-society can parse ILP send results correctly and update peer settlement config without 409 errors during bootstrap.

## Acceptance Criteria

1. `POST /ilp/send` response uses `accepted: true` on FULFILL and `accepted: false` on REJECT (Gap 2)
2. `IlpSendResponse` interface updated: `fulfilled` field renamed to `accepted`
3. Backward compatibility: response also includes `fulfilled` field with same value as `accepted` (dual-field for transition period)
4. `POST /admin/peers` returns 200 (not 409) when re-registering an existing peer with updated fields (Gap 3)
5. Re-registration merges settlement config: new `settlement` fields overwrite existing, omitted fields are preserved
6. Re-registration merges routes: new routes are added to existing routing table entries
7. Re-registration response includes `updated: true` field to distinguish from initial creation (201)
8. `PUT /admin/peers/:peerId` endpoint added for explicit peer updates (Gap 12)
9. PUT returns 404 if peerId does not exist
10. PUT accepts partial updates: settlement-only, routes-only, or both
11. EVM channel opening path in `POST /admin/channels` looks up `settlementPeers.get(peerId)?.evmAddress` as fallback when `peerAddress` not in request (Gap 9)
12. Unit tests for `accepted` field in ILP send response
13. Unit tests for idempotent POST /admin/peers (create, update, verify merged config)
14. Unit tests for PUT /admin/peers/:peerId (update, 404 on unknown)
15. All existing tests continue to pass

## Tasks / Subtasks

- [x] Task 1: Rename `fulfilled` to `accepted` in IlpSendResponse (AC: 1, 2, 3)
  - [x] Update `IlpSendResponse` interface in `packages/agent-runtime/src/types/index.ts` — add `accepted: boolean`, keep `fulfilled?: boolean` as deprecated
  - [x] Update `ilp-send-handler.ts` lines 200, 211 — set both `accepted` and `fulfilled` fields in response
  - [x] Update `ilp-send-handler.test.ts` — verify `accepted` field present in all response assertions
  - [x] Verify TypeScript compilation succeeds

- [x] Task 2: Make POST /admin/peers idempotent (AC: 4, 5, 6, 7)
  - [x] Modify `packages/connector/src/http/admin-api.ts` lines 332-340 — replace 409 response with update logic
  - [x] On duplicate: skip BTP client update — `BtpClientManager` has no `updatePeer()` method, and the BTP connection (URL/authToken) does not change on re-registration. Only settlement config and routes need merging.
  - [x] On duplicate: merge `settlement` config into existing `settlementPeers` entry (spread existing, overwrite with new)
  - [x] On duplicate: add new routes to routing table via `routingTable.addRoute(prefix, peerId, priority)` (don't remove existing routes)
  - [x] Return `{ success: true, peer: {...}, updated: true }` with status 200 for updates
  - [x] Return `{ success: true, peer: {...}, created: true }` with status 201 for new peers (existing behavior)

- [x] Task 3: Add PUT /admin/peers/:peerId endpoint (AC: 8, 9, 10)
  - [x] Add `router.put('/peers/:peerId', ...)` handler in `admin-api.ts`
  - [x] Validate peerId exists in `btpClientManager.getPeerIds()`
  - [x] Return 404 with `{ error: 'Not found', message: 'Peer not found' }` if unknown
  - [x] Accept partial body: `{ settlement?: AdminSettlementConfig, routes?: Route[] }`
  - [x] If `settlement` provided, merge into `settlementPeers` map
  - [x] If `routes` provided, add to routing table via `routingTable.addRoute(route.prefix, peerId, route.priority ?? 0)`
  - [x] Return `{ success: true, peerId, updated: true }`

- [x] Task 4: Enhance EVM channel opening to use settlementPeers fallback (AC: 11)
  - [x] In `POST /admin/channels` EVM path (lines 770-800), after deriving tokenId and before the existing channel check:
    - [x] Look up `const peerConfig = settlementPeers?.get(body.peerId)`
    - [x] Resolve address: `const peerAddress = body.peerAddress || peerConfig?.evmAddress`
    - [x] Return 400 if neither source provides an address: `{ error: 'Bad request', message: 'Peer EVM address must be provided in request or peer registration' }`
    - [x] Pass resolved `peerAddress` into `channelManager.ensureChannelExists()` options (Story 21.4 adds `peerAddress` to `ChannelOpenOptions` and `OpenChannelRequest`)
    - [x] Log which source the peer address came from (request vs. registration)

- [x] Task 5: Write unit tests (AC: 12, 13, 14, 15)
  - [x] Update `packages/agent-runtime/src/http/ilp-send-handler.test.ts` — add/update tests for `accepted` field:
    - [x] `should return accepted: true on FULFILL response`
    - [x] `should return accepted: false on REJECT response`
    - [x] `should include deprecated fulfilled field matching accepted value`
  - [x] Create `packages/connector/src/http/admin-api-peers.test.ts` for peer registration tests (follows existing pattern: `admin-api-channels.test.ts`, `admin-api-settlement.test.ts`):
    - [x] `POST /admin/peers — should create new peer and return 201 with created: true`
    - [x] `POST /admin/peers — should return 200 with updated: true on re-registration`
    - [x] `POST /admin/peers — should merge settlement config on re-registration (new fields overwrite, omitted preserved)`
    - [x] `POST /admin/peers — should add new routes on re-registration without removing existing`
    - [x] `POST /admin/peers — should not update BTP connection on re-registration`
    - [x] `PUT /admin/peers/:peerId — should update settlement config and return 200`
    - [x] `PUT /admin/peers/:peerId — should return 404 for unknown peerId`
    - [x] `PUT /admin/peers/:peerId — should accept partial update (routes only)`
    - [x] `PUT /admin/peers/:peerId — should accept partial update (settlement only)`
  - [x] Verify all existing tests pass with `npm test`

## Dev Notes

### Gap Context

This story addresses 4 integration gaps identified in `INTEGRATION-GAPS.md`:

- **Gap 2 (P0):** `IlpSendResponse` uses `fulfilled` but agent-society checks `if (!ilpResult.accepted)`. Since `accepted` is undefined, the condition `!undefined` is truthy, causing all SPSP handshakes to fail.
- **Gap 3 (P0):** `POST /admin/peers` returns 409 on duplicate. Agent-society's `BootstrapService.ts` calls `addPeer()` twice: once for routing (line 347) and again with settlement config after SPSP (line 440). The second call fails.
- **Gap 9 (P2):** Settlement fields stored via `POST /admin/peers` are never used by EVM channel opening. Only XRP path looks up `settlementPeers`.
- **Gap 12 (P2):** No PUT/PATCH endpoint exists for updating peer registration.

### Key File Locations

| Action     | File                                                       | Lines                                                          |
| ---------- | ---------------------------------------------------------- | -------------------------------------------------------------- |
| **Modify** | `packages/agent-runtime/src/types/index.ts`                | 188-199 (IlpSendResponse interface)                            |
| **Modify** | `packages/agent-runtime/src/http/ilp-send-handler.ts`      | 199-221 (response mapping)                                     |
| **Modify** | `packages/agent-runtime/src/http/ilp-send-handler.test.ts` | Response assertions                                            |
| **Modify** | `packages/connector/src/http/admin-api.ts`                 | 332-340 (409 check), 770-800 (EVM channel)                     |
| **Create** | `packages/connector/src/http/admin-api-peers.test.ts`      | New test file for peer registration/update                     |
| **Ref**    | `packages/connector/src/http/admin-api-channels.test.ts`   | Existing test pattern to follow                                |
| **Ref**    | `packages/connector/src/btp/btp-client-manager.ts`         | BtpClientManager API (no updatePeer — addPeer/removePeer only) |
| **Ref**    | `packages/connector/src/routing/routing-table.ts`          | RoutingTable.addRoute(prefix, nextHop, priority)               |

### Current Code (Response Mapping)

```typescript
// ilp-send-handler.ts lines 199-212 — CURRENT
const fulfillResponse: IlpSendResponse = {
  fulfilled: true,
  fulfillment: response.fulfillment.toString('base64'),
  data: response.data.length > 0 ? response.data.toString('base64') : undefined,
};
```

```typescript
// ilp-send-handler.ts — AFTER FIX
const fulfillResponse: IlpSendResponse = {
  accepted: true,
  fulfilled: true, // backward compat, deprecated
  fulfillment: response.fulfillment.toString('base64'),
  data: response.data.length > 0 ? response.data.toString('base64') : undefined,
};
```

### Current Code (409 Check)

```typescript
// admin-api.ts lines 332-340 — CURRENT
const existingPeers = btpClientManager.getPeerIds();
if (existingPeers.includes(body.id)) {
  res.status(409).json({
    error: 'Conflict',
    message: `Peer with id '${body.id}' already exists`,
  });
  return;
}
```

### Current Code (EVM Channel Opening)

```typescript
// admin-api.ts lines 770-800 — CURRENT (EVM path, no settlementPeers lookup)
if (chainPrefix === 'evm') {
  const tokenId = body.token ?? 'AGENT';

  const existing = channelManager.getChannelForPeer(body.peerId, tokenId);
  if (existing && existing.status !== 'closed') {
    res.status(409).json({
      error: 'Conflict',
      message: `Channel already exists for peer ${body.peerId} with token ${tokenId} on chain ${body.chain}`,
    });
    return;
  }

  const channelId = await channelManager.ensureChannelExists(body.peerId, tokenId, {
    initialDeposit: BigInt(body.initialDeposit),
    settlementTimeout: body.settlementTimeout,
    chain: body.chain,
  });
  // ...
}
```

```typescript
// admin-api.ts lines 801-820 — XRP path (already has settlementPeers lookup)
const peerConfig = settlementPeers?.get(body.peerId);
if (!peerConfig?.xrpAddress) {
  res.status(400).json({ error: 'Bad request', message: 'Peer has no XRP address configured' });
  return;
}
```

Note: The XRP path already looks up `settlementPeers` for the peer address. Task 4 adds the same pattern to the EVM path.

### Story 21.4 Cross-Reference

Story 21.4 ("Channel Opening Integration Fixes") adds `peerAddress?: string` to `OpenChannelRequest` and `ChannelOpenOptions`. This story's Task 4 adds the **fallback** to `settlementPeers` for when `peerAddress` is not in the request. The resolution order is:

1. `body.peerAddress` (explicit, provided by BLS — added by Story 21.4)
2. `settlementPeers.get(peerId)?.evmAddress` (fallback from prior peer registration — added by this story)
3. Return 400 if neither is available

This ensures EVM channels can be opened whether the BLS provides the address directly in the channel request or registered it earlier via `POST /admin/peers`.

### Agent-Society Consumer Code

```typescript
// BootstrapService.ts:410
if (!ilpResult.accepted) { /* error branch always taken because accepted is undefined */ }

// BootstrapService.ts:347 — first peer registration (routing only)
await this.connectorClient.addPeer({ id: peerId, url: btpUrl, authToken: token });

// BootstrapService.ts:440 — second registration (with settlement)
await this.connectorClient.addPeer({ id: peerId, url: btpUrl, authToken: token, settlement: {...} });
```

### BtpClientManager API (packages/connector/src/btp/btp-client-manager.ts)

`BtpClientManager` does **not** have an `updatePeer()` method. Available methods:

- `addPeer(peer: Peer): Promise<void>` — add peer and establish BTP connection
- `removePeer(peerId: string): Promise<void>` — remove peer and disconnect
- `getPeerIds(): string[]` — list all peer IDs
- `getClientForPeer(peerId: string): BTPClient | undefined` — get BTP client
- `isConnected(peerId: string): boolean` — check connection status

**Implication for Task 2:** On re-registration, do NOT attempt to update the BTP connection. The BTP URL and authToken are set at initial `addPeer()` and don't change. Only merge `settlement` config (via `settlementPeers` Map) and `routes` (via `routingTable.addRoute()`).

### RoutingTable API (packages/connector/src/routing/routing-table.ts)

- `addRoute(prefix: ILPAddress, nextHop: string, priority: number = 0): void` — add or replace a route
- `removeRoute(prefix: string): void` — remove a route
- `getAllRoutes(): RoutingTableEntry[]` — export all routes

Re-adding a route with the same prefix replaces it (no duplicates). Use `addRoute()` for both new routes and updates.

### Technical Constraints

- TypeScript strict mode — no `any` types
- Pino logger only — no `console.log`
- kebab-case files, PascalCase classes
- Buffer for binary data
- All async functions must handle errors with try-catch

### Testing

**Framework:** Jest 29.7.x with ts-jest
**Convention:** Co-located `*.test.ts` next to source
**Coverage:** >80% line coverage for new/modified handler code
**Pattern:** AAA (Arrange, Act, Assert) with descriptive names
**Mock Strategy:** Fresh mock instances in `beforeEach()`, cleanup in `afterEach()`

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6

### File List

| Action       | File                                                       |
| ------------ | ---------------------------------------------------------- |
| **Modified** | `packages/agent-runtime/src/types/index.ts`                |
| **Modified** | `packages/agent-runtime/src/http/ilp-send-handler.ts`      |
| **Modified** | `packages/agent-runtime/src/http/ilp-send-handler.test.ts` |
| **Modified** | `packages/connector/src/http/admin-api.ts`                 |
| **Modified** | `packages/connector/src/http/admin-api-channels.test.ts`   |
| **Modified** | `packages/connector/src/settlement/channel-manager.ts`     |
| **Created**  | `packages/connector/src/http/admin-api-peers.test.ts`      |

### Debug Log References

None

### Completion Notes

- All 5 tasks completed successfully
- IlpSendResponse now uses `accepted` as primary field with `fulfilled` kept for backward compatibility
- POST /admin/peers is idempotent — re-registration merges settlement config and adds routes without re-creating BTP connection
- PUT /admin/peers/:peerId added for explicit peer updates with 404 handling
- EVM channel opening resolves peer address from request `peerAddress` field or `settlementPeers` fallback
- `validateSettlementConfig()` extracted as reusable helper (used by both POST and PUT handlers)
- `peerAddress` field added to `OpenChannelRequest` and `ChannelOpenOptions` interfaces
- 49 new/updated tests pass (39 ilp-send-handler + 10 admin-api-peers)
- Full test suite: 124 suites passed, 2436 tests passed; 2 pre-existing performance flakes (cpu-profile, wallet-derivation timing)

## Change Log

| Date       | Version | Description                                                                                                                                                                                                                                                     | Author      |
| ---------- | ------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------- |
| 2026-02-09 | 1.0     | Initial story draft from INTEGRATION-GAPS.md (Gaps 2, 3, 9, 12)                                                                                                                                                                                                 | Sarah (PO)  |
| 2026-02-09 | 1.1     | Validation fixes: clarify BtpClientManager has no updatePeer(), specify test file paths (admin-api-peers.test.ts), add detailed test scenarios, add EVM channel current code snippet, add Story 21.4 cross-reference, add routingTable.addRoute() API reference | Validation  |
| 2026-02-09 | 2.0     | Implementation complete — all 5 tasks done, tests passing                                                                                                                                                                                                       | James (Dev) |

## QA Results

### Review Date: 2026-02-09

### Reviewed By: Quinn (Test Architect)

### Risk Assessment

- **Auth/payment/security files touched:** Yes (settlement config, peer registration, channel opening)
- **Diff size:** ~484 lines (close to 500 threshold)
- **Acceptance criteria count:** 15 (>5 → deep review)
- **Review depth:** Deep (auto-escalated due to payment/settlement code and high AC count)

### Code Quality Assessment

Implementation quality is **high**. The code is well-structured, follows existing patterns, and addresses all four integration gaps (2, 3, 9, 12) effectively.

**Strengths:**

- Clean extraction of `validateSettlementConfig()` as a reusable helper — eliminates 80+ lines of duplicated inline validation from POST handler, shared by POST and PUT
- Idempotent POST /admin/peers correctly preserves BTP connection state (no re-add) while allowing settlement and route updates
- Backward-compatible `fulfilled` field alongside new `accepted` field in `IlpSendResponse`
- EVM channel opening address resolution follows a clear priority chain: explicit request → settlementPeers fallback → 400 error
- Test coverage is thorough with 10 peer tests and 39 ilp-send-handler tests

**Minor observations (no action needed):**

- `ChannelOpenOptions.peerAddress` is added but not consumed by `ChannelManager.openChannelForPeer()` — this is by design, as Story 21.4 AC 5 explicitly owns the `ChannelManager` plumbing
- Settlement config merge in POST handler (lines 437-439) uses `Record<string, unknown>` cast for dynamic key assignment — this is acceptable given TypeScript's limitations with generic object spread of partial updates

### Refactoring Performed

No refactoring performed. The developer's implementation is clean and well-structured. The `validateSettlementConfig()` extraction was already done during development (noted in completion notes).

### Requirements Traceability

| AC# | Description                                              | Test Coverage                                                                                                                               | Status |
| --- | -------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------- | ------ |
| 1   | `accepted: true` on FULFILL, `accepted: false` on REJECT | `ilp-send-handler.test.ts:284-319` — "should return accepted: true on FULFILL response", "should return accepted: false on REJECT response" | ✓      |
| 2   | `IlpSendResponse` interface updated                      | `types/index.ts:190-203` — `accepted: boolean` as primary, `fulfilled?: boolean` as deprecated                                              | ✓      |
| 3   | Backward compatibility dual-field                        | `ilp-send-handler.test.ts:322-351` — "should include deprecated fulfilled field matching accepted value" (verifies both FULFILL and REJECT) | ✓      |
| 4   | POST /admin/peers returns 200 on re-registration         | `admin-api-peers.test.ts:98-111` — "should return 200 with updated: true on re-registration"                                                | ✓      |
| 5   | Re-registration merges settlement config                 | `admin-api-peers.test.ts:113-156` — verifies new fields overwrite, omitted fields preserved (chainId, initialDeposit)                       | ✓      |
| 6   | Re-registration merges routes                            | `admin-api-peers.test.ts:158-185` — verifies addRoute called for new route, removeRoute never called                                        | ✓      |
| 7   | Re-registration response includes `updated: true`        | `admin-api-peers.test.ts:109` — `expect(res.body.updated).toBe(true)`                                                                       | ✓      |
| 8   | PUT /admin/peers/:peerId endpoint added                  | `admin-api.ts:575-696` — full PUT handler with validation                                                                                   | ✓      |
| 9   | PUT returns 404 if peerId not found                      | `admin-api-peers.test.ts:224-234` — "should return 404 for unknown peerId"                                                                  | ✓      |
| 10  | PUT accepts partial updates                              | `admin-api-peers.test.ts:236-263` — routes-only and settlement-only tests                                                                   | ✓      |
| 11  | EVM channel opening fallback to settlementPeers          | `admin-api.ts:854-863` — looks up `settlementPeers?.get(body.peerId)?.evmAddress`, returns 400 if neither source                            | ✓      |
| 12  | Unit tests for accepted field                            | `ilp-send-handler.test.ts:284-351` — 3 dedicated tests (FULFILL, REJECT, deprecated field parity)                                           | ✓      |
| 13  | Unit tests for idempotent POST                           | `admin-api-peers.test.ts:88-201` — 5 tests covering create, update, merge, routes, BTP skip                                                 | ✓      |
| 14  | Unit tests for PUT endpoint                              | `admin-api-peers.test.ts:204-297` — 5 tests covering update, 404, partial routes, partial settlement, merge                                 | ✓      |
| 15  | All existing tests pass                                  | Verified: 4 connector HTTP suites (202 tests), agent-runtime ILP handler (39 tests) — all pass                                              | ✓      |

### Compliance Check

- Coding Standards: ✓ kebab-case files, PascalCase interfaces, Pino logger (no console.log), TypeScript strict mode, proper async error handling
- Project Structure: ✓ Co-located tests (`admin-api-peers.test.ts` next to `admin-api.ts`), follows existing test file pattern (`admin-api-channels.test.ts`, `admin-api-settlement.test.ts`)
- Testing Strategy: ✓ AAA pattern, fresh mocks in `beforeEach()`, cleanup in `afterEach()`, `>80%` coverage for new handler code
- All ACs Met: ✓ All 15 acceptance criteria verified with test coverage

### Improvements Checklist

- [x] `IlpSendResponse` uses `accepted` as primary field (AC 1, 2)
- [x] Backward-compatible `fulfilled` field included (AC 3)
- [x] POST /admin/peers idempotent — re-registration returns 200 (AC 4)
- [x] Settlement config merge preserves existing fields (AC 5)
- [x] Routes merged via addRoute without removing existing (AC 6)
- [x] PUT /admin/peers/:peerId with 404 and partial update support (AC 8, 9, 10)
- [x] EVM channel opening uses settlementPeers fallback (AC 11)
- [x] `validateSettlementConfig()` extracted as reusable helper
- [x] All 49 new/updated tests pass
- [ ] Story 21.4 should wire `options.peerAddress` through `ChannelManager.openChannelForPeer()` to `PaymentChannelSDK.openChannel()` (cross-story dependency, not a blocker for 20.4)

### Security Review

- **Settlement config validation:** All address formats validated (EVM 42-char hex, XRP r-prefixed 25-35 chars, Aptos 66-char hex) before storage. `validateSettlementConfig()` is reused by both POST and PUT handlers — single validation path reduces risk of inconsistency.
- **No injection risks:** Request body is typed and validated before use. ILP address validation via `isValidILPAddress()`. No dynamic SQL/eval.
- **Internal-only API:** Admin API is designed for internal Docker network access with optional API key auth. No new external exposure.
- **No credentials in responses:** Peer responses include `id`, `url`, `connected` status — no authToken leakage.

### Performance Considerations

- POST /admin/peers new peer creation has a 1-second `setTimeout` (line 483) before checking connection status. This is acceptable for new peer registration (one-time operation) but adds latency. Not a concern for re-registration (200 path skips the delay).
- Settlement config merge uses `Object.entries()` iteration which is fine for small config objects.

### Files Modified During Review

No files were modified during this review.

### Gate Status

Gate: PASS → docs/qa/gates/20.4-fix-ilpsendresponse-field-name-and-make-peer-registration-idempotent.yml
Risk profile: N/A (no risk-profile task run)
NFR assessment: N/A (no separate NFR assessment)

### Recommended Status

✓ Ready for Done — All 15 acceptance criteria met with comprehensive test coverage. No blocking issues found. The `ChannelOpenOptions.peerAddress` plumbing through `ChannelManager` is explicitly deferred to Story 21.4.
