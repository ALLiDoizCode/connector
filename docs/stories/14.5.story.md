<!-- Powered by BMAD™ Core -->

# Story 14.5: Production Connector Aptos Settlement

## Status

Done

## Story

**As a** connector operator running in production,
**I want** the production connector to open and settle Aptos payment channels with peers,
**So that** APT token settlements work end-to-end alongside existing EVM and XRP settlement flows.

## Acceptance Criteria

1. Connector startup initializes `AptosChannelSDK` when `APTOS_ENABLED=true` and required env vars are set
2. `UnifiedSettlementExecutor` routes `APT` token settlements to `AptosChannelSDK`
3. Aptos channel auto-refresh runs in production (30-second default interval)
4. Settlement telemetry events emitted for Aptos operations (`APTOS_CHANNEL_OPENED`, `APTOS_CLAIM_SIGNED`, `APTOS_SETTLEMENT_COMPLETED`, `APTOS_SETTLEMENT_FAILED`)
5. Graceful shutdown stops Aptos auto-refresh and cleans up resources
6. Integration test verifies Aptos settlement flow with testnet (optional manual verification)
7. `APTOS_SETTLEMENT_ENABLED=false` feature flag disables Aptos settlement without crashing

## Tasks / Subtasks

**Task Execution Strategy:** This story wires the existing `AptosChannelSDK` (Story 13.4) and `UnifiedSettlementExecutor` (already updated in Story 13.5) into the production connector startup flow. The SDK and executor integration already exists - this story focuses on connector initialization, lifecycle management, and production readiness.

- [x] Task 1: Add Aptos Environment Variable Validation
  - [x] Follow existing SDK factory pattern: `createAptosChannelSDKFromEnv()` already reads env vars directly
  - [x] Add validation helper in `packages/connector/src/config/aptos-env-validator.ts`:

    ```typescript
    export function validateAptosEnvironment(logger: Logger): AptosEnvValidation {
      const enabled = process.env.APTOS_ENABLED === 'true';
      if (!enabled) return { enabled: false, valid: true };

      const required = [
        'APTOS_NODE_URL',
        'APTOS_PRIVATE_KEY',
        'APTOS_ACCOUNT_ADDRESS',
        'APTOS_CLAIM_PRIVATE_KEY',
        'APTOS_MODULE_ADDRESS',
      ];
      const missing = required.filter((v) => !process.env[v]);

      if (missing.length > 0) {
        logger.warn({ missing }, 'APTOS_ENABLED=true but required vars missing');
        return { enabled: true, valid: false, missing };
      }
      return { enabled: true, valid: true };
    }
    ```

  - [x] Environment variables (read by existing `createAptosChannelSDKFromEnv`):
    ```
    APTOS_ENABLED=true|false (default: false)
    APTOS_NODE_URL=https://fullnode.testnet.aptoslabs.com/v1
    APTOS_PRIVATE_KEY=<hex-encoded ed25519 private key>
    APTOS_ACCOUNT_ADDRESS=<0x-prefixed address>
    APTOS_CLAIM_PRIVATE_KEY=<hex for claim signing>
    APTOS_MODULE_ADDRESS=<0x-prefixed module address>
    APTOS_SETTLEMENT_ENABLED=true|false (default: true)
    APTOS_CHANNEL_REFRESH_INTERVAL_MS=30000 (optional)
    APTOS_DEFAULT_SETTLE_DELAY=86400 (optional)
    ```
  - [x] Log warning if APTOS_ENABLED=true but required vars missing (continue without Aptos)
  - [Source: architecture/tech-stack.md, packages/connector/src/settlement/aptos-channel-sdk.ts:764-787]

- [x] Task 2: Initialize AptosChannelSDK in Connector Startup
  - [x] Update `packages/connector/src/core/connector-node.ts` or main entry point
  - [x] Create SDK conditionally when APTOS_ENABLED=true:
    ```typescript
    let aptosChannelSDK: IAptosChannelSDK | null = null;
    if (process.env.APTOS_ENABLED === 'true') {
      aptosChannelSDK = createAptosChannelSDKFromEnv(logger);
      aptosChannelSDK.startAutoRefresh();
      logger.info('AptosChannelSDK initialized with auto-refresh');
    }
    ```
  - [x] Pass SDK to `UnifiedSettlementExecutor` constructor
  - [x] Handle initialization errors gracefully (log error, continue without Aptos)
  - [Source: packages/connector/src/settlement/aptos-channel-sdk.ts:764-787]

- [x] Task 3: Add Graceful Shutdown for Aptos SDK
  - [x] Add cleanup in `ConnectorNode.stop()` method (line 369):
    ```typescript
    async stop(): Promise<void> {
      // Add before existing cleanup logic:
      if (this._aptosChannelSDK) {
        this._aptosChannelSDK.stopAutoRefresh();
        this._logger.info({ event: 'aptos_sdk_stopped' }, 'AptosChannelSDK auto-refresh stopped');
      }
      // ... existing shutdown logic (explorer, event store, BTP, health server)
    }
    ```
  - [x] SIGTERM/SIGINT handlers already exist in `packages/connector/src/index.ts` entry point - verify they call `connectorNode.stop()`
  - [x] Test: Verify no dangling intervals after stop (use `--detectOpenHandles`)
  - [Source: packages/connector/src/core/connector-node.ts:369-419, architecture/test-strategy-and-standards.md#incomplete-test-cleanup]

- [x] Task 4: Update Peer Configuration for Aptos Settlement
  - [x] Verify `PeerConfig` interface includes `aptosAddress` and `aptosPubkey` fields (already exists in types.ts)
  - [x] Update peer configuration examples in documentation
  - [x] Add example peer config for tri-chain settlement:
    ```yaml
    peers:
      - peerId: peer-alice
        address: g.alice
        settlementPreference: any
        settlementTokens: ['USDC', 'XRP', 'APT']
        evmAddress: '0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb'
        xrpAddress: 'rN7n7otQDd6FczFgLdlqtyMVrn3HMfXEEW'
        aptosAddress: '0x1234567890abcdef...'
        aptosPubkey: 'abcd1234567890abcdef...'
    ```
  - [Source: packages/connector/src/settlement/types.ts:218-279]

- [x] Task 5: Verify UnifiedSettlementExecutor Aptos Integration
  - [x] Confirm `UnifiedSettlementExecutor` constructor accepts `aptosChannelSDK: IAptosChannelSDK | null`
  - [x] Confirm `handleSettlement()` routes APT token to `settleViaAptos()`
  - [x] Confirm telemetry events are emitted (APTOS_CHANNEL_OPENED, APTOS_CLAIM_SIGNED, etc.)
  - [x] Confirm feature flag `APTOS_SETTLEMENT_ENABLED=false` throws `SettlementDisabledError`
  - [x] No code changes expected - verification only
  - [Source: packages/connector/src/settlement/unified-settlement-executor.ts:114-197]

- [x] Task 6: Add Unit Tests for Connector Aptos Initialization
  - [x] Create validation test: `packages/connector/src/config/aptos-env-validator.test.ts`
  - [x] Create connector init test: `packages/connector/src/core/connector-node.aptos.test.ts`
  - [x] Test: SDK not created when APTOS_ENABLED=false (default)
  - [x] Test: SDK created and auto-refresh started when APTOS_ENABLED=true with all required vars
  - [x] Test: Warning logged when APTOS_ENABLED=true but missing required vars
  - [x] Test: `stop()` calls `stopAutoRefresh()` (no dangling intervals)
  - [x] Test: Feature flag APTOS_SETTLEMENT_ENABLED=false disables settlement routing (verify via `SettlementDisabledError`)
  - [x] Mock `createAptosChannelSDKFromEnv` to avoid real network calls
  - [x] Import `SettlementDisabledError` from `packages/connector/src/settlement/unified-settlement-executor.ts`
  - [Source: architecture/test-strategy-and-standards.md#unit-tests]

- [x] Task 7: Add Integration Test for Aptos Settlement Flow
  - [x] Create test file: `packages/connector/test/integration/connector-aptos-settlement.test.ts`
  - [x] Test: Full settlement flow with testnet (requires NETWORK_MODE=testnet)
  - [x] Steps:
    1. Initialize connector with Aptos enabled
    2. Emit SETTLEMENT_REQUIRED event for APT token
    3. Verify AptosChannelSDK.openChannel() called
    4. Verify AptosChannelSDK.signClaim() called
    5. Verify telemetry events emitted
  - [x] Use `describeIfInfra()` pattern to skip if testnet unavailable
  - [x] Note: May be manual verification due to testnet rate limits
  - [Source: architecture/test-strategy-and-standards.md#integration-tests]

- [x] Task 8: Update Documentation
  - [x] Update `docs/guides/local-blockchain-development.md`:
    - Add Aptos environment variables section
    - Document APTOS_ENABLED and related variables
  - [x] Update `README.md` or deployment docs:
    - Document production Aptos configuration
    - Add example .env for tri-chain settlement
  - [x] Add troubleshooting section for common Aptos errors

## Dev Notes

### Story Context

This is Story 14.5 in Epic 14: Public Testnet Integration. This is the final story in the epic, completing production-ready tri-chain settlement support.

**Epic 14 Context:**

- **Story 14.1** (Done): Add Agent Server Aptos HTTP Endpoints
- **Story 14.2** (Done): Add Test Runner Aptos Phases
- **Story 14.3** (Done): Add Public Testnet Configuration
- **Story 14.4** (Done): Update Test Infrastructure for Testnets
- **Story 14.5 (this story)**: Production Connector Aptos Settlement

**Dependencies:**

- Epic 13 (Done): Aptos Payment Channel Move modules and TypeScript SDK
- Story 13.4: AptosChannelSDK implementation
- Story 13.5: UnifiedSettlementExecutor Aptos routing

### Previous Story Insights

From Story 14.4 (Dev Agent Record):

- Testnet mode (`NETWORK_MODE=testnet`) is now the recommended approach for ARM64
- Pre-deployed contract addresses are passed via environment variables
- Shell script exports URLs before running docker-compose
- XRP testnet faucet has rate limiting (2s sleep between requests)

### Architecture Context

The `AptosChannelSDK` is already fully implemented in `packages/connector/src/settlement/aptos-channel-sdk.ts`. It provides:

- `openChannel()` - Create payment channel with initial deposit
- `deposit()` - Add funds to existing channel
- `signClaim()` / `verifyClaim()` - Off-chain claim operations
- `submitClaim()` - On-chain claim submission
- `requestClose()` / `finalizeClose()` - Two-phase channel closure
- `getChannelState()` - Query on-chain state
- `startAutoRefresh()` / `stopAutoRefresh()` - Periodic state refresh

The `UnifiedSettlementExecutor` in `packages/connector/src/settlement/unified-settlement-executor.ts` already:

- Accepts `aptosChannelSDK: IAptosChannelSDK | null` in constructor (line 72)
- Routes APT token to `settleViaAptos()` method (line 155-170)
- Checks `isAptosEnabled()` feature flag (line 114-116)
- Emits telemetry events:
  - `APTOS_CHANNEL_OPENED` (line 422-428) - when new channel opened
  - `APTOS_CLAIM_SIGNED` (line 346-352) - when claim signed
  - `APTOS_SETTLEMENT_COMPLETED` (line 355-361) - on success
  - `APTOS_SETTLEMENT_FAILED` (line 366-372) - on error
- Exports `SettlementDisabledError` class for feature flag testing

### Data Models

**PeerConfig (settlement/types.ts:218-279):**

```typescript
interface PeerConfig {
  peerId: string;
  address: string; // ILP address
  settlementPreference: 'evm' | 'xrp' | 'aptos' | 'any' | 'both';
  settlementTokens: string[];
  evmAddress?: string;
  xrpAddress?: string;
  aptosAddress?: string; // 0x-prefixed 64-char hex
  aptosPubkey?: string; // 64-char hex ed25519 public key
}
```

**AptosChannelState (aptos-channel-sdk.ts:27-82):**

```typescript
interface AptosChannelState {
  channelOwner: string; // Channel identifier
  destination: string; // Aptos destination address
  destinationPubkey: string; // ed25519 public key
  deposited: bigint; // Octas deposited
  claimed: bigint; // Octas claimed
  nonce: number; // Highest claim nonce
  settleDelay: number; // Settlement delay seconds
  closeRequestedAt: number; // Close timestamp (0 if open)
  status: 'open' | 'closing' | 'closed';
}
```

### File Locations

**Files to Create:**

- `packages/connector/src/config/aptos-env-validator.ts` - Aptos environment validation (Task 1)
- `packages/connector/src/config/aptos-env-validator.test.ts` - Validation unit tests (Task 6)
- `packages/connector/src/core/connector-node.aptos.test.ts` - Connector Aptos init tests (Task 6)
- `packages/connector/test/integration/aptos-settlement.test.ts` - Integration test (Task 7)

**Files to Modify:**

- `packages/connector/src/core/connector-node.ts` - Add SDK initialization and shutdown (Tasks 2-3)
- `docs/guides/local-blockchain-development.md` - Add Aptos configuration docs (Task 8)

**Existing Files (reference only):**

- `packages/connector/src/settlement/aptos-channel-sdk.ts` - AptosChannelSDK + `createAptosChannelSDKFromEnv()`
- `packages/connector/src/settlement/unified-settlement-executor.ts` - Settlement routing + `SettlementDisabledError`
- `packages/connector/src/settlement/types.ts:218-279` - PeerConfig interface
- `packages/connector/src/index.ts` - Entry point with SIGTERM/SIGINT handlers

### Environment Variables Reference

**Required when APTOS_ENABLED=true:**
| Variable | Description | Example |
|----------|-------------|---------|
| `APTOS_ENABLED` | Enable Aptos settlement | `true` |
| `APTOS_NODE_URL` | Aptos fullnode URL | `https://fullnode.testnet.aptoslabs.com/v1` |
| `APTOS_PRIVATE_KEY` | Account private key (hex) | `0x...` |
| `APTOS_ACCOUNT_ADDRESS` | Account address | `0x...` |
| `APTOS_CLAIM_PRIVATE_KEY` | Claim signing private key | `0x...` |
| `APTOS_MODULE_ADDRESS` | Payment channel module address | `0x...` |

**Optional:**
| Variable | Description | Default |
|----------|-------------|---------|
| `APTOS_SETTLEMENT_ENABLED` | Feature flag to disable settlement | `true` |
| `APTOS_CHANNEL_REFRESH_INTERVAL_MS` | Auto-refresh interval | `30000` |
| `APTOS_DEFAULT_SETTLE_DELAY` | Default settle delay (seconds) | `86400` |

### Technical Constraints

- Aptos SDK requires ed25519 private key (not secp256k1)
- Testnet faucet rate limits may affect integration tests
- Octas precision: 1 APT = 100,000,000 octas (8 decimal places)
- Module address must match deployed payment_channel Move module
- Settlement delay minimum: 3600 seconds (1 hour) for production

### Testing Strategy

**Unit Tests (Task 6):**

- Mock `createAptosChannelSDKFromEnv` to avoid network calls
- Test environment variable parsing and validation
- Test SDK lifecycle (init, auto-refresh, shutdown)
- Follow AAA pattern (Arrange, Act, Assert)

**Integration Tests (Task 7):**

- Requires `NETWORK_MODE=testnet` and Aptos testnet connectivity
- Use `describeIfInfra()` to skip when infrastructure unavailable
- Testnet rate limit mitigation: Add 2s sleep between faucet requests (per Story 14.4 pattern)
- May need manual verification due to testnet rate limits
- Verify telemetry events emitted correctly

**Test Timeouts:**

- Unit tests: 50ms default (single async operation)
- Integration tests: 30000ms+ (testnet transactions)

[Source: architecture/test-strategy-and-standards.md]

### Relevant Source Tree

```
packages/connector/
├── src/
│   ├── config/
│   │   ├── config-loader.ts              # YAML config loading (reference only)
│   │   ├── environment-validator.ts      # Existing env validation (reference)
│   │   ├── aptos-env-validator.ts        # Create (Task 1)
│   │   └── aptos-env-validator.test.ts   # Create (Task 6)
│   ├── core/
│   │   ├── connector-node.ts             # Add SDK init/shutdown (Tasks 2-3)
│   │   └── connector-node.aptos.test.ts  # Create (Task 6)
│   └── settlement/
│       ├── aptos-channel-sdk.ts          # Existing SDK with createAptosChannelSDKFromEnv()
│       ├── unified-settlement-executor.ts # Existing executor, exports SettlementDisabledError
│       └── types.ts                       # PeerConfig interface (lines 218-279)
└── test/
    └── integration/
        └── aptos-settlement.test.ts      # Create (Task 7)
```

## Dev Agent Record

### Agent Model Used

claude-opus-4-5-20251101

### File List

**Created:**

- `packages/connector/src/config/aptos-env-validator.ts` - Aptos environment variable validation
- `packages/connector/src/config/aptos-env-validator.test.ts` - Unit tests for env validator
- `packages/connector/src/core/connector-node.aptos.test.ts` - Unit tests for connector Aptos init
- `packages/connector/test/integration/connector-aptos-settlement.test.ts` - Integration tests for settlement flow

**Modified:**

- `packages/connector/src/config/index.ts` - Export validateAptosEnvironment
- `packages/connector/src/core/connector-node.ts` - Add SDK init, shutdown, and getter
- `docs/guides/local-blockchain-development.md` - Add Aptos connector settlement variables section
- `README.md` - Update to tri-chain settlement with Aptos example config

### Debug Log References

N/A - No debug issues encountered.

### Completion Notes

- All 8 tasks completed successfully
- 31 tests pass covering env validation, connector init/shutdown, and settlement flow
- Linting passes with 0 errors (3 warnings in unrelated files)
- Documentation updated with comprehensive Aptos configuration guide
- The UnifiedSettlementExecutor already had full Aptos support from Story 13.5
- PeerConfig interface already included aptosAddress and aptosPubkey from Story 13.5
- Tri-chain settlement (EVM, XRP, Aptos) now fully wired into production connector

## QA Results

### Review Date: 2026-01-31

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Implementation quality is excellent. The code follows established patterns from prior settlement integrations (EVM/XRP), properly validates environment variables before SDK initialization, implements graceful degradation when Aptos is misconfigured, and includes comprehensive test coverage across unit and integration layers. The production connector now fully supports tri-chain settlement (EVM, XRP, Aptos).

### Refactoring Performed

No refactoring required. The implementation is clean and well-structured.

### Compliance Check

- Coding Standards: [x] Pino logger used throughout, no console.log, proper naming conventions
- Project Structure: [x] Co-located tests (`*.test.ts`), kebab-case filenames, proper module exports
- Testing Strategy: [x] 31 tests across 3 test files; unit tests mock dependencies, integration tests verify flow
- All ACs Met: [x] All 7 acceptance criteria verified

### Improvements Checklist

All items complete - no outstanding issues:

- [x] Environment variable validation with helpful warnings (AC 1)
- [x] SDK initialization during connector startup (AC 1)
- [x] UnifiedSettlementExecutor routes APT to settleViaAptos (AC 2, verified via existing Story 13.5)
- [x] Auto-refresh started on init, stopped on shutdown (AC 3, AC 5)
- [x] Telemetry events emitted for all 4 event types (AC 4, verified in payment-channel-telemetry.ts)
- [x] Graceful shutdown stops SDK (AC 5)
- [x] Integration test verifies settlement flow (AC 6)
- [x] Feature flag APTOS_SETTLEMENT_ENABLED=false throws SettlementDisabledError (AC 7)
- [x] Documentation updated in local-blockchain-development.md and README.md (AC 8)

### Security Review

No security concerns found:

- Private keys are read from environment variables (not hardcoded)
- SDK initialization errors are caught and logged without exposing sensitive details
- Feature flag allows disabling Aptos settlement at runtime

### Performance Considerations

No performance issues:

- Auto-refresh defaults to 30-second interval (configurable via APTOS_CHANNEL_REFRESH_INTERVAL_MS)
- SDK creation is lazy (only when APTOS_ENABLED=true and all vars present)
- Graceful shutdown prevents lingering intervals (verified via Jest --detectOpenHandles pattern)

### Files Modified During Review

None - no code changes required.

### Gate Status

Gate: PASS -> docs/qa/gates/28.5-production-connector-aptos-settlement.yml
Risk profile: Low - follows established patterns from Epic 13/28
NFR assessment: All PASS

### Recommended Status

[x Ready for Done]
(Story owner decides final status)

## Change Log

| Date       | Version | Description                                                                                                                                                                                          | Author                 |
| ---------- | ------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------- |
| 2026-01-31 | 1.4     | QA Review complete - PASS                                                                                                                                                                            | Quinn (Test Architect) |
| 2026-01-31 | 1.3     | Implementation complete - all tasks done                                                                                                                                                             | Dev Agent              |
| 2026-01-31 | 1.2     | Story approved for implementation                                                                                                                                                                    | SM                     |
| 2026-01-31 | 1.1     | Validation fixes: clarified env var approach (follow SDK factory pattern), fixed `stop()` method name, updated test file locations, fixed source tree paths, added SettlementDisabledError reference | SM/Validator           |
| 2026-01-31 | 1.0     | Initial story draft for production Aptos settlement                                                                                                                                                  | PM/Analyst             |
