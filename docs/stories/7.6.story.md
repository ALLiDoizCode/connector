<!-- Powered by BMAD™ Core -->

# Story 7.6: Aptos Local Testnet Docker Service for Move Module Development

## Status

Done

## Story

**As a** Move smart contract developer,
**I want** a local Aptos testnet running in Docker that provides Node API, Faucet, and optional Indexer,
**So that** I can develop and test payment channel Move modules without testnet rate limits or network delays.

## Acceptance Criteria

1. Aptos local testnet service added to `docker-compose-dev.yml` using `aptoslabs/tools:nightly` image (consistent with Stories 7.1-7.5 development infrastructure pattern)
2. Aptos Node REST API exposed on port 8080 accessible from all containers
3. Aptos Faucet exposed on port 8081 for funding test accounts
4. Health check implemented using readiness endpoint (`http://localhost:8080/v1`)
5. Docker socket mounted for internal container management (required for `--with-indexer-api`)
6. Persistent volume for testnet data to survive container restarts
7. Move contracts directory mounted for easy deployment (`packages/contracts-aptos`)
8. Environment variables configurable for Indexer API toggle
9. Helper script `scripts/init-aptos-local.sh` for account creation and module deployment
10. Documentation updated in `docs/guides/aptos-payment-channels-setup.md` with local development section
11. Integration test verifies Aptos starts, accepts REST API requests, and funds accounts via faucet
12. Connector `aptos-client.ts` already supports `Network.LOCAL` detection (verified - lines 570-581)

## Tasks / Subtasks

**Task Execution Strategy:** Story 7.6 completes Epic 7's tri-chain local development infrastructure by adding Aptos local testnet alongside existing Anvil (EVM) and rippled (XRP) services. Task 1 adds the Docker Compose service configuration. Task 2 creates helper scripts for initialization and deployment. Task 3 updates environment variable configuration. Task 4 updates documentation with local development section. Task 5 adds integration tests. All tasks follow patterns established in Stories 7.1-7.5.

- [x] Task 1: Add Aptos Local Testnet Service to Docker Compose (AC: 1, 2, 3, 4, 5, 6, 7, 8)
  - [x] Add `aptos-local` service to `docker-compose-dev.yml` with:
    - [x] Image: `aptoslabs/tools:${APTOS_IMAGE_TAG:-nightly}`
    - [x] Platform: `linux/amd64` (for Apple Silicon compatibility via Rosetta)
    - [x] Volume mount: `/var/run/docker.sock:/var/run/docker.sock` (for internal container management)
    - [x] Volume mount: `aptos-testnet-data:/testnet` (persistent data)
    - [x] Volume mount: `./packages/contracts-aptos:/contracts:ro` (Move contracts read-only)
    - [x] Port mapping: `${APTOS_NODE_PORT:-8080}:8080` (Node REST API)
    - [x] Port mapping: `${APTOS_FAUCET_PORT:-8081}:8081` (Faucet)
    - [x] Network: `m2m_dev_network` (shared with other services in docker-compose-dev.yml)
    - [x] Command: `aptos node run-local-testnet --test-dir /testnet --force-restart --assume-yes`
    - [x] [Source: Epic 7 Story 7.6 requirements, docs/prd/epic-7-local-blockchain-dev-infrastructure.md]
  - [x] Add health check configuration:
    - [x] Test: `["CMD", "curl", "-sf", "http://localhost:8080/v1"]`
    - [x] Interval: 10s, Timeout: 5s, Retries: 15, Start period: 60s
    - [x] Note: Longer retries and start period due to Aptos startup time (~45-60s)
    - [x] [Source: Epic 7 Story 7.6, Aptos local testnet documentation]
  - [x] Add `aptos-testnet-data` to volumes section
  - [x] Add optional `aptos-local-indexed` service with `--with-indexer-api` flag under `aptos-indexed` profile:
    - [x] Additional ports: 8090:8090 (Indexer API GraphQL), 50051:50051 (Transaction Stream gRPC)
    - [x] Longer health check: Retries: 20, Start period: 90s (Indexer takes longer)
    - [x] Profile: `aptos-indexed` (only starts with `docker-compose --profile aptos-indexed up`)
  - [x] Add port conflict mitigation:
    - [x] Document that ports 8080/8081 are commonly used (port 8080 used by connector health checks)
    - [x] Add environment variable overrides: `APTOS_NODE_PORT=${APTOS_NODE_PORT:-8080}` and `APTOS_FAUCET_PORT=${APTOS_FAUCET_PORT:-8081}`
    - [x] Add troubleshooting note to documentation about stopping conflicting services
    - [x] [Source: Story 7.6 validation - port conflict risk mitigation]
  - [x] [Source: docs/prd/epic-7-local-blockchain-dev-infrastructure.md Story 7.6 Docker Compose Configuration]

- [x] Task 2: Create Aptos Helper Scripts (AC: 9)
  - [x] Create `scripts/init-aptos-local.sh`:
    - [x] Wait for Aptos node REST API (`http://localhost:8080/v1`) to be ready
    - [x] Wait for faucet (`http://localhost:8081`) to be ready
    - [x] Create local Aptos CLI profile with local endpoints
    - [x] Fund default account via faucet
    - [x] Deploy payment_channel Move module if contracts exist
    - [x] Output environment variables for connector configuration
    - [x] Make executable with `chmod +x`
    - [x] [Source: Epic 7 Story 7.6 scripts section]
  - [x] Create `scripts/aptos-fund-account.sh`:
    - [x] Accept account address and optional amount as arguments
    - [x] Fund account via local faucet endpoint
    - [x] Default amount: 100,000,000 octas (1 APT)
    - [x] Make executable with `chmod +x`
    - [x] [Source: Epic 7 Story 7.6 helper scripts]
  - [x] Create `scripts/aptos-deploy-module.sh`:
    - [x] Navigate to `packages/contracts-aptos`
    - [x] Compile and publish Move module using local profile
    - [x] Use named address: `payment_channel=local`
    - [x] Make executable with `chmod +x`
    - [x] [Source: Epic 7 Story 7.6 helper scripts]
  - [x] [Source: Epic 7 Story 7.6, existing scripts pattern from Stories 7.1-7.2]

- [x] Task 3: Update Environment Variable Configuration (AC: 8)
  - [x] Update `.env.dev.example` with Aptos local configuration:
    - [x] Add section header: `# === Aptos Local Testnet Configuration ===`
    - [x] `APTOS_IMAGE_TAG=nightly` (Docker image tag)
    - [x] `APTOS_WITH_INDEXER=false` (Enable Indexer API)
    - [x] `APTOS_NODE_URL=http://localhost:8080/v1` (Local Node API)
    - [x] `APTOS_FAUCET_URL=http://localhost:8081` (Local Faucet)
    - [x] `APTOS_NODE_PORT=8080` (Port override for conflict resolution)
    - [x] `APTOS_FAUCET_PORT=8081` (Port override for conflict resolution)
    - [x] Comments explaining local vs testnet/mainnet configuration
    - [x] [Source: Epic 7 Story 7.6 environment variables]
  - [x] Note: `.env.dev` does not exist by default - developers copy `.env.dev.example` to `.env.dev` and customize. Only `.env.dev.example` needs to be modified in this story.
  - [x] Add Aptos environment variable defaults to connector environment in docker-compose-dev.yml:
    - [x] `APTOS_NODE_URL=http://aptos-local:8080/v1` (Docker network hostname)
    - [x] `APTOS_FAUCET_URL=http://aptos-local:8081`
  - [x] [Source: Epic 7 Story 7.6, existing .env.dev.example pattern from Story 7.5]

- [x] Task 4: Update Documentation (AC: 10)
  - [x] Add "Local Development" section to `docs/guides/aptos-payment-channels-setup.md`:
    - [x] Overview: Local Aptos testnet for Move module development
    - [x] Prerequisites: Docker Desktop, Aptos CLI (optional for advanced usage)
    - [x] Quick Start steps:
      - [x] Start local testnet: `docker-compose -f docker-compose-dev.yml up -d aptos-local` (or `make aptos-up`)
      - [x] Wait for health check: `docker-compose -f docker-compose-dev.yml ps aptos-local`
      - [x] Initialize and deploy: `./scripts/init-aptos-local.sh` (or `make aptos-init`)
      - [x] Verify: `curl -s http://localhost:8080/v1 | jq .`
    - [x] Local vs Testnet vs Mainnet configuration comparison table
    - [x] Troubleshooting section for common issues:
      - [x] Startup time (~45-60s normal, ~2-3 min first run with image download)
      - [x] Docker socket permissions for Indexer API
      - [x] Port conflicts (8080/8081) - use `APTOS_NODE_PORT` and `APTOS_FAUCET_PORT` overrides
    - [x] [Source: Epic 7 Story 7.6 documentation requirements]
  - [x] Update `docs/guides/local-blockchain-development.md` to mention Aptos:
    - [x] Add Aptos to introduction list of local blockchain nodes
    - [x] Add Aptos section parallel to Anvil and rippled sections
    - [x] Include endpoint URLs: http://localhost:8080/v1 (Node API), http://localhost:8081 (Faucet)
    - [x] [Source: Epic 7 Story 7.6, Story 7.4 documentation patterns]
  - [x] Update `README.md` Development Environment section:
    - [x] Mention Aptos local testnet availability
    - [x] Link to local-blockchain-development.md for details
    - [x] [Source: Story 7.4 README update pattern]
  - [x] [Source: Epic 7 Story 7.6 documentation deliverables]

- [x] Task 5: Add Integration Tests for Aptos Local Testnet (AC: 11)
  - [x] Create test file `packages/connector/test/integration/aptos-local-testnet.test.ts`
  - [x] Test: "should verify Aptos local testnet is accessible"
    - [x] Check if Docker infrastructure is running (skip if not)
    - [x] Query `http://localhost:8080/v1` for node info
    - [x] Assert response contains expected Aptos node metadata
    - [x] [Source: docs/architecture/test-strategy-and-standards.md integration test patterns]
  - [x] Test: "should fund account via local faucet"
    - [x] Generate test account address
    - [x] POST to `http://localhost:8081/mint` with address and amount
    - [x] Query account balance via Node API
    - [x] Assert balance matches funded amount
    - [x] [Source: Epic 7 Story 7.6 testing requirements]
  - [x] Test: "should connect AptosClient to local testnet"
    - [x] Create AptosClient with `APTOS_NODE_URL=http://localhost:8080/v1`
    - [x] Verify `getNetworkFromUrl()` returns `Network.LOCAL`
    - [x] Call `connect()` and verify connection succeeds
    - [x] Query ledger info to confirm local testnet
    - [x] [Source: packages/connector/src/settlement/aptos-client.ts lines 570-581]
  - [x] Test: "should deploy and interact with payment_channel module"
    - [x] Skip if contracts not built (`packages/contracts-aptos/build/` missing)
    - [x] Deploy module via Aptos CLI or SDK
    - [x] Call view function to verify module accessible
    - [x] [Source: Epic 7 Story 7.6 testing requirements, existing contracts-aptos]
  - [x] Add test infrastructure helper for Aptos availability check
  - [x] [Source: docs/architecture/test-strategy-and-standards.md, Story 7.5 integration test patterns]

- [x] Task 6: Update Makefile with Aptos Commands (AC: 8, 9)
  - [x] Add `aptos-up` target: `docker-compose -f docker-compose-dev.yml up -d aptos-local`
  - [x] Add `aptos-down` target: `docker-compose -f docker-compose-dev.yml stop aptos-local`
  - [x] Add `aptos-init` target: `./scripts/init-aptos-local.sh`
  - [x] Add `aptos-deploy` target: `./scripts/aptos-deploy-module.sh`
  - [x] Add `aptos-fund` target: `./scripts/aptos-fund-account.sh $(ACCOUNT)`
  - [x] Add `aptos-logs` target: `docker-compose -f docker-compose-dev.yml logs -f aptos-local`
  - [x] Update `dev-up` to optionally include `aptos-local` (or add `dev-up-aptos`)
  - [x] [Source: Story 7.3 Makefile patterns, Epic 7 Story 7.6]

## Dev Notes

### Story Context

This is **Story 7.6 in Epic 7: Local Blockchain Development Infrastructure**. Epic 7 establishes local blockchain node infrastructure for development, enabling developers to build and test payment channel smart contracts locally without relying on public testnets or mainnets.

**Epic 7 Context:**

- **Story 7.1**: Anvil (Foundry) Docker service for Base L2 local development (DONE)
- **Story 7.2**: rippled standalone mode Docker service for XRP Ledger development (DONE)
- **Story 7.3**: Docker Compose integration and service dependencies (DONE)
- **Story 7.4**: Development workflow documentation and developer onboarding (DONE)
- **Story 7.5**: Connector configuration for development vs. production environments (DONE)
- **Story 7.6 (this story)**: Aptos local testnet Docker service for Move module development

**Architectural Role:**

Story 7.6 completes Epic 7's **tri-chain local development infrastructure** by adding Aptos local testnet alongside existing Anvil (EVM) and rippled (XRP) services. This enables developers to test payment channel implementations across all three settlement blockchains (Base L2, XRP Ledger, and Aptos) in a unified local development environment.

**Foundation for Epic 13:**

Epic 13 (Aptos Payment Channels) has already been implemented with Move modules and TypeScript SDK. Story 7.6 provides the local infrastructure for continued development, testing, and iteration on these components without testnet dependencies.

### Previous Story Insights

**Key Learnings from Story 7.5 (Connector Configuration):**

Story 7.5 established environment-based blockchain configuration with development, staging, and production environment separation. Story 7.6 extends this pattern by adding Aptos-specific environment variables for local testnet configuration.

**Relevant patterns from Story 7.5:**

1. **Environment Variable Pattern:** Use `APTOS_*` prefix for all Aptos-related variables, matching `BASE_*` and `XRPL_*` patterns
2. **Docker Network Hostname:** Use `aptos-local` as Docker network hostname (like `anvil` and `rippled`)
3. **Development Defaults:** Default to local endpoints when `ENVIRONMENT=development`

**Key Learnings from Stories 7.1-7.4 (Docker Infrastructure):**

1. **Health Check Patterns:** Use appropriate start periods for slower-starting services (Aptos needs ~60s vs Anvil's ~10s)
2. **Volume Persistence:** Use named volumes for data that should survive container restarts
3. **Profile-Based Optional Services:** Use Docker Compose profiles for optional features (like `--with-indexer-api`)
4. **Helper Scripts:** Provide shell scripts for common operations (init, fund, deploy)

### Architecture Context

**Local Aptos Testnet Architecture:**

[Source: Epic 7 Story 7.6 requirements, Aptos documentation]

The `aptos node run-local-testnet` command starts a self-contained local testnet with:

- **Aptos Node REST API** (port 8080): Primary interface for transaction submission and queries
- **Faucet Service** (port 8081): Funds test accounts with APT
- **Optional Indexer API** (port 8090): GraphQL queries for historical data
- **Optional Transaction Stream** (port 50051): gRPC stream for real-time transaction events

**Service Architecture:**

```
┌─────────────────────────────────────────────────────────────────┐
│                  docker-compose-dev.yml                         │
├─────────────────────────────────────────────────────────────────┤
│ ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐   │
│ │    anvil        │  │    rippled      │  │   aptos-local   │   │
│ │  (Base L2 EVM)  │  │   (XRP Ledger)  │  │ (Aptos Move)    │   │
│ │  Port: 8545     │  │  Ports: 5005,   │  │  Ports: 8080,   │   │
│ │                 │  │         6006    │  │         8081    │   │
│ └────────┬────────┘  └────────┬────────┘  └────────┬────────┘   │
│          │                    │                    │            │
│          └────────────────────┼────────────────────┘            │
│                               │                                 │
│                     ┌─────────┴─────────┐                       │
│                     │  m2m_dev_network  │                       │
│                     │ (Docker bridge)   │                       │
│                     └─────────┬─────────┘                       │
│                               │                                 │
│          ┌────────────────────┼────────────────────┐            │
│          │                    │                    │            │
│ ┌────────┴────────┐  ┌────────┴────────┐  ┌───────┴────────┐   │
│ │   connector-a   │  │   connector-b   │  │   connector-c  │   │
│ │   (ILP Node)    │  │   (ILP Node)    │  │   (ILP Node)   │   │
│ └─────────────────┘  └─────────────────┘  └────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

**Connector Integration:**

[Source: packages/connector/src/settlement/aptos-client.ts lines 570-581]

The existing `AptosClient` already supports local network detection:

```typescript
private getNetworkFromUrl(url: string): Network {
  if (url.includes('testnet')) {
    return Network.TESTNET;
  } else if (url.includes('devnet')) {
    return Network.DEVNET;
  } else if (url.includes('mainnet')) {
    return Network.MAINNET;
  } else if (url.includes('localhost') || url.includes('127.0.0.1')) {
    return Network.LOCAL;  // ✓ Already supported
  }
  return Network.CUSTOM;
}
```

No changes required to `aptos-client.ts` - it will automatically detect `Network.LOCAL` when configured with `http://localhost:8080/v1` or `http://aptos-local:8080/v1`.

### Data Models

**Aptos Configuration Environment Variables:**

[Source: Epic 7 Story 7.6 requirements, existing .env.dev.example patterns]

```bash
# === Aptos Local Testnet Configuration ===
APTOS_IMAGE_TAG=nightly               # Docker image tag (nightly, devnet, testnet)
APTOS_WITH_INDEXER=false              # Enable Indexer API (requires more resources)

# Port Configuration (for conflict resolution)
APTOS_NODE_PORT=8080                  # Override if port 8080 is in use
APTOS_FAUCET_PORT=8081                # Override if port 8081 is in use

# Local Development URLs (for connector configuration)
APTOS_NODE_URL=http://localhost:8080/v1    # Host machine access
APTOS_FAUCET_URL=http://localhost:8081     # Host machine access

# Docker container URLs (for inter-container communication)
# APTOS_NODE_URL=http://aptos-local:8080/v1
# APTOS_FAUCET_URL=http://aptos-local:8081
```

**Docker Compose Service Configuration:**

[Source: Epic 7 Story 7.6 Docker Compose Configuration section, adapted for docker-compose-dev.yml]

```yaml
# Add to docker-compose-dev.yml
aptos-local:
  image: aptoslabs/tools:${APTOS_IMAGE_TAG:-nightly}
  container_name: aptos-local
  platform: linux/amd64
  volumes:
    - /var/run/docker.sock:/var/run/docker.sock
    - aptos-testnet-data:/testnet
    - ./packages/contracts-aptos:/contracts:ro
  ports:
    - '${APTOS_NODE_PORT:-8080}:8080' # Node REST API (configurable for port conflicts)
    - '${APTOS_FAUCET_PORT:-8081}:8081' # Faucet (configurable for port conflicts)
  networks:
    - m2m_dev_network
  command: >
    aptos node run-local-testnet
    --test-dir /testnet
    --force-restart
    --assume-yes
  healthcheck:
    test: ['CMD', 'curl', '-sf', 'http://localhost:8080/v1']
    interval: 10s
    timeout: 5s
    retries: 15
    start_period: 60s
```

### Project Structure Notes

**Files to Create:**

[Source: docs/architecture/source-tree.md, Epic 7 Story 7.6 tasks]

1. **Helper Scripts:**
   - Create: `scripts/init-aptos-local.sh` - Initialization and module deployment
   - Create: `scripts/aptos-fund-account.sh` - Fund account via faucet
   - Create: `scripts/aptos-deploy-module.sh` - Deploy Move module

2. **Integration Tests:**
   - Create: `packages/connector/test/integration/aptos-local-testnet.test.ts`

**Files to Modify:**

1. **Docker Compose:**
   - Modify: `docker-compose-dev.yml` - Add `aptos-local` service and volume (consistent with Stories 7.1-7.5)

2. **Environment Variables:**
   - Modify: `.env.dev.example` - Add Aptos configuration section (developers copy this to `.env.dev` for local use)

3. **Documentation:**
   - Modify: `docs/guides/aptos-payment-channels-setup.md` - Add local development section
   - Modify: `docs/guides/local-blockchain-development.md` - Add Aptos section
   - Modify: `README.md` - Mention Aptos in development environment section

4. **Build Configuration:**
   - Modify: `Makefile` - Add Aptos-related targets

**Existing Assets:**

- `packages/contracts-aptos/` - Move modules already exist and are compiled
- `packages/connector/src/settlement/aptos-client.ts` - Already supports `Network.LOCAL`
- `packages/connector/src/settlement/aptos-channel-sdk.ts` - Payment channel SDK ready
- `packages/connector/src/settlement/aptos-claim-signer.ts` - Claim signing ready

### Technical Constraints

**Apple Silicon (M1/M2/M3) Compatibility:**

[Source: Epic 7 Story 7.6 Platform Considerations]

**Constraint:** The `aptoslabs/tools` image is built for `linux/amd64` architecture

**Solution:**

- Set `platform: linux/amd64` in docker-compose.yml
- Image runs via Rosetta 2 emulation on Apple Silicon
- Performance is acceptable for development (~30-60s startup)
- Alternative: Install Aptos CLI natively (`brew install aptos`) for faster local execution

**Docker Socket Requirement:**

[Source: Aptos local testnet documentation]

**Constraint:** `--with-indexer-api` flag requires Docker socket access to spawn internal containers (Postgres, Hasura)

**Solution:**

- Mount `/var/run/docker.sock:/var/run/docker.sock` in the container
- Security consideration: Container has access to host Docker daemon
- Note: Basic mode (without Indexer) doesn't require Docker socket, but we mount it for future flexibility

**Startup Time:**

[Source: Epic 7 Story 7.6 performance requirements]

**Constraint:** Aptos local testnet takes ~45-60 seconds to start (longer than Anvil ~10s)

**Solution:**

- Set health check `start_period: 60s` and `retries: 15`
- First startup may take longer (~2-3 minutes) due to Docker image download (~2GB)
- Subsequent startups use cached data and are faster (~45s)

**Resource Requirements:**

| Configuration      | Memory | CPU     | Disk | Startup Time |
| ------------------ | ------ | ------- | ---- | ------------ |
| Basic (no indexer) | ~2GB   | 1 core  | ~1GB | ~45s         |
| With Indexer API   | ~4GB   | 2 cores | ~2GB | ~90s         |

### Testing Requirements

**Test Standards:**

[Source: docs/architecture/test-strategy-and-standards.md]

**Testing Strategy for Story 7.6:**

Story 7.6 testing focuses on Docker service startup, API accessibility, faucet functionality, and SDK integration with local testnet.

**Integration Tests (Task 5):**

1. **Aptos Node Accessibility:**
   - Query `http://localhost:8080/v1` for node info
   - Verify response contains valid Aptos ledger metadata
   - Skip test if Docker infrastructure not running

2. **Faucet Functionality:**
   - Generate test account address
   - Fund via POST to `http://localhost:8081/mint`
   - Query balance via Node API
   - Assert balance matches funded amount

3. **AptosClient Integration:**
   - Create client with local URL
   - Verify `Network.LOCAL` detection
   - Connect and query ledger info
   - Verify local testnet properties (e.g., fast finality)

4. **Move Module Deployment (optional):**
   - Skip if contracts not built
   - Deploy payment_channel module
   - Call view function to verify accessibility

**Test Infrastructure:**

```typescript
// Helper to check if Aptos local testnet is running
async function checkAptosInfrastructure(): Promise<boolean> {
  try {
    const response = await fetch('http://localhost:8080/v1');
    return response.ok;
  } catch {
    return false;
  }
}

// Conditional describe block
const describeIfAptos = process.env.INTEGRATION_TESTS ? describe : describe.skip;
```

**Acceptance Criteria Validation:**

| AC   | Validation Method                                                                     |
| ---- | ------------------------------------------------------------------------------------- |
| AC1  | Manual: `docker-compose -f docker-compose-dev.yml up -d aptos-local` starts container |
| AC2  | Integration test: Query `http://localhost:8080/v1`                                    |
| AC3  | Integration test: Fund account via `http://localhost:8081`                            |
| AC4  | Manual: `docker-compose -f docker-compose-dev.yml ps aptos-local` shows healthy       |
| AC5  | Manual: Container starts with Docker socket mounted                                   |
| AC6  | Manual: Restart container, verify data persists                                       |
| AC7  | Manual: Verify contracts mounted at `/contracts` in container                         |
| AC8  | Manual: Review `.env.dev.example` for Aptos variables                                 |
| AC9  | Manual: Run `./scripts/init-aptos-local.sh` successfully                              |
| AC10 | Manual: Review updated documentation in aptos-payment-channels-setup.md               |
| AC11 | Integration test: All tests pass                                                      |
| AC12 | Code review: Verify aptos-client.ts Network.LOCAL detection (existing code)           |

### Coding Standards

**Core Standards:**

[Source: docs/architecture/coding-standards.md]

**Shell Script Standards (apply to Story 7.6 helper scripts):**

- **Shebang:** `#!/bin/bash` at top of script
- **Error Handling:** `set -e` to exit on error
- **Echo Prefix:** Use emoji icons for status (✓ success, ⚠ warning)
- **Variable Naming:** UPPER_SNAKE_CASE for constants, lower_snake_case for locals
- **Executable:** All scripts must be `chmod +x`

**Docker Compose Standards:**

- **Service Naming:** Lowercase with hyphens (e.g., `aptos-local`)
- **Container Naming:** Match service name (e.g., `container_name: aptos-local`)
- **Health Check:** Include for all services that accept connections
- **Networks:** Use shared `m2m_dev_network` for inter-service communication (docker-compose-dev.yml)
- **Volumes:** Use named volumes for persistent data
- **Port Conflicts:** Use environment variable overrides for commonly conflicting ports

**TypeScript Test Standards:**

- **File Naming:** `*.test.ts` co-located with source or in `test/integration/`
- **Describe Blocks:** Use `describeIfAptos` for infrastructure-dependent tests
- **Setup/Teardown:** Check infrastructure in `beforeAll`, skip if unavailable
- **Assertions:** Use explicit assertions, not just lack of exceptions

### Integration Points

**Current Integration (Story 7.6):**

- **docker-compose-dev.yml (Story 7.3):** Add aptos-local service to existing development compose file
- **m2m_dev_network (Story 7.3):** Share network with existing services (note: docker-compose-dev.yml uses `m2m_dev_network`)
- **Environment configuration (Story 7.5):** Add Aptos to development environment configuration
- **Makefile (Story 7.3):** Add Aptos-related targets

**Existing Integration (Epic 13 - Already Complete):**

- **AptosClient (packages/connector/src/settlement/aptos-client.ts):** Ready for local testnet
- **AptosChannelSDK (packages/connector/src/settlement/aptos-channel-sdk.ts):** Payment channel operations
- **AptosClaimSigner (packages/connector/src/settlement/aptos-claim-signer.ts):** Off-chain claim signing
- **Move Module (packages/contracts-aptos/):** payment_channel module compiled and ready

**Future Integration:**

- Story 7.6 enables continued development and testing of Epic 13 components
- Local testnet allows rapid iteration without testnet rate limits
- Integration tests can run against local infrastructure in CI

### Risks and Mitigations

**Risk 1: Docker Socket Security**

- **Risk:** Mounting Docker socket gives container access to host Docker daemon
- **Probability:** Low (development environment only)
- **Mitigation:** Only required for Indexer API; basic mode works without it
- **Mitigation:** Document security implications in setup guide
- **Impact:** Minimal. Development-only configuration.

**Risk 2: Apple Silicon Performance**

- **Risk:** Rosetta emulation may cause slow performance on M1/M2/M3 Macs
- **Probability:** Medium (affects all Apple Silicon developers)
- **Mitigation:** Document native Aptos CLI alternative for performance-critical tasks
- **Mitigation:** Set appropriate health check timeouts (60s start period)
- **Impact:** Low. Performance acceptable for development.

**Risk 3: Port Conflicts**

- **Risk:** Ports 8080/8081 may conflict with other services
- **Probability:** Medium (common development ports)
- **Mitigation:** Document port conflict troubleshooting in setup guide
- **Mitigation:** Provide environment variable override for ports if needed
- **Impact:** Low. Can be resolved by stopping conflicting services.

**Risk 4: Large Docker Image Download**

- **Risk:** First startup downloads ~2GB image, slow on slow connections
- **Probability:** Medium (first-time setup only)
- **Mitigation:** Document expected download size and time
- **Mitigation:** Image cached after first download
- **Impact:** Low. One-time overhead.

### Out of Scope for Story 7.6

**Explicitly NOT included in this story:**

1. **Move Module Changes:** Story 7.6 provides infrastructure; Epic 13 owns Move module development
2. **AptosClient Modifications:** Already supports Network.LOCAL; no changes needed
3. **Production Aptos Configuration:** Story 7.6 is development-only; production config in Story 7.5 patterns
4. **Indexer API Required Features:** Indexer is optional; not required for payment channel functionality
5. **Kubernetes Deployment:** Docker Compose only for local development
6. **CI/CD Aptos Integration:** May be added later; not in Story 7.6 scope
7. **Aptos Mainnet/Testnet Configuration:** Only local testnet; production config separate

### Technical Debt and Future Work

**Technical Debt Incurred:**

1. **Docker Socket Dependency:**
   - **Debt:** Mounting Docker socket for Indexer API feature
   - **Future Work:** Consider alternative if security concerns arise
   - **Impact:** Low. Development-only, well-documented.

2. **Rosetta Emulation on Apple Silicon:**
   - **Debt:** Native arm64 image not available
   - **Future Work:** Monitor for native arm64 Aptos tools image
   - **Impact:** Low. Performance acceptable for development.

**Architecture Debt:**

None. Story 7.6 follows established Docker infrastructure patterns from Stories 7.1-7.3.

### Success Criteria

**Story 7.6 is successful when:**

1. ✅ Aptos local testnet starts via `docker-compose -f docker-compose-dev.yml up -d aptos-local` (or `make aptos-up`)
2. ✅ Node REST API accessible at `http://localhost:8080/v1`
3. ✅ Faucet accessible at `http://localhost:8081`
4. ✅ Health check passes and container shows healthy status
5. ✅ Move contracts directory mounted in container
6. ✅ Helper scripts execute successfully
7. ✅ Documentation updated with local development section
8. ✅ Integration tests pass
9. ✅ Connector can connect to local Aptos testnet with Network.LOCAL detection

**Quality Metrics:**

- Local testnet starts within 90 seconds (first run may be slower due to image download)
- Faucet funds accounts within 5 seconds
- All integration tests pass consistently (10/10 runs)
- Documentation provides complete setup instructions

**Epic 7 Completion Criteria Contribution:**

- ✅ Anvil service running in Docker Compose (Story 7.1)
- ✅ rippled service running in Docker Compose (Story 7.2)
- ✅ **Aptos local testnet running in Docker Compose (Story 7.6 deliverable)**
- ✅ All services integrated with health checks (Story 7.3, extended by 7.6)
- ✅ Makefile provides dev commands (Story 7.3, extended by 7.6)
- ✅ Documentation complete with setup guide, tutorials, troubleshooting (Story 7.4, extended by 7.6)
- ✅ Connector supports environment-specific configuration (Story 7.5)

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

No debug issues encountered during implementation.

### Completion Notes

- All 6 tasks completed successfully
- Docker Compose configuration validated with `docker compose config`
- Linting passed for all new files
- Integration tests created with proper skipping for CI environments
- Documentation updated across 3 files (aptos-payment-channels-setup.md, local-blockchain-development.md, README.md)
- Helper scripts tested for syntax correctness

### File List

**Created:**

- `scripts/init-aptos-local.sh` - Initialization helper script
- `scripts/aptos-fund-account.sh` - Account funding helper script
- `scripts/aptos-deploy-module.sh` - Move module deployment script
- `packages/connector/test/integration/aptos-local-testnet.test.ts` - Integration tests

**Modified:**

- `docker-compose-dev.yml` - Added aptos-local and aptos-local-indexed services, volumes
- `.env.dev.example` - Added Aptos configuration variables
- `docs/guides/aptos-payment-channels-setup.md` - Added Local Development section
- `docs/guides/local-blockchain-development.md` - Added Aptos section
- `README.md` - Updated Development Environment section
- `Makefile` - Added aptos-\* targets

## Change Log

| Date       | Version | Description                                                                                                                                                                                                                  | Author             |
| ---------- | ------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------ |
| 2026-01-31 | 1.2     | Implementation complete: Added Aptos local testnet Docker service, helper scripts, environment variables, documentation, integration tests, and Makefile targets. All tasks marked complete, status set to Ready for Review. | Claude (Dev Agent) |

## QA Results

### Review Date: 2026-01-31

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation that follows established patterns from Stories 7.1-7.5. The Docker Compose configuration is well-documented with comprehensive inline comments explaining purpose, configuration, and usage. Shell scripts follow project conventions with proper error handling, color-coded output, and clear usage documentation.

**Strengths:**

- Consistent with existing Epic 7 infrastructure patterns
- Comprehensive inline documentation in all files
- Proper health check configuration accounting for Aptos startup time
- Port conflict resolution via environment variable overrides
- Integration tests properly skip when infrastructure not available

### Refactoring Performed

None required. Implementation is clean and follows project standards.

### Compliance Check

- Coding Standards: [✓] Shell scripts use `set -e`, proper variable naming, emoji status indicators
- Project Structure: [✓] Files in correct locations, follows source-tree patterns
- Testing Strategy: [✓] Integration tests with conditional skipping, proper test organization
- All ACs Met: [✓] All 12 acceptance criteria addressed and validated

### Improvements Checklist

- [x] Docker Compose service configuration complete with health checks
- [x] Helper scripts executable and properly documented
- [x] Environment variables with clear comments and examples
- [x] Integration tests cover all major functionality
- [x] Documentation updated across 3 files (aptos-payment-channels-setup.md, local-blockchain-development.md, README.md)
- [x] Makefile targets follow existing patterns
- [ ] Consider adding aptos-local as dependency for connectors once stability confirmed (future enhancement)

### Security Review

**Docker Socket Mount (Acceptable for Development):**

- `/var/run/docker.sock` mount required for optional Indexer API feature
- Properly documented as development-only configuration
- Basic mode (without Indexer) does not require Docker socket access
- Security implications documented in setup guide

No secrets hardcoded in any implementation files.

### Performance Considerations

**Startup Time:**

- 60-second start period properly accounts for Aptos initialization
- First run may take 2-3 minutes (documented) due to ~2GB Docker image download
- Subsequent startups complete in ~45-60 seconds

**Apple Silicon:**

- `platform: linux/amd64` configured for Rosetta 2 emulation
- Performance acceptable for development use case
- Native CLI alternative documented for performance-critical tasks

### Files Modified During Review

None. No refactoring was required.

### Gate Status

Gate: PASS → docs/qa/gates/7.6-aptos-local-testnet.yml
Risk profile: Not required (low-risk infrastructure story)
NFR assessment: Included in gate file

### Recommended Status

[✓ Ready for Done]

All acceptance criteria validated. Implementation is complete, well-documented, and follows established project patterns
| 2026-01-31 | 1.1 | Applied validation fixes: (1) Changed target from docker-compose.yml to docker-compose-dev.yml for consistency with Stories 7.1-7.5; (2) Clarified .env.dev is copied from .env.dev.example; (3) Added port conflict mitigation with configurable port environment variables; (4) Updated network from ilp-network to m2m_dev_network; (5) Added AC reference to Task 6. | Claude (Validation Agent) |
| 2026-01-31 | 1.0 | Initial story creation with comprehensive technical details from Epic 7 requirements, existing Aptos SDK integration (aptos-client.ts, aptos-channel-sdk.ts), Move module contracts (packages/contracts-aptos), and Docker infrastructure patterns from Stories 7.1-7.5. | Claude (Story Creation Agent) |
