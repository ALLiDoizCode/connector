# Story 24.3: Expose sendPacket() as Public Method on ConnectorNode

## Status

Done

## Story

**As a** library consumer,
**I want** to call `connector.sendPacket()` to send ILP Prepare packets,
**so that** I can initiate payments without going through the HTTP admin API.

## Acceptance Criteria

1. `connector.sendPacket(params)` sends an ILP Prepare and returns Fulfill/Reject
2. Routing uses the same RoutingTable longest-prefix matching as BTP-originated packets
3. Timeout derived from `expiresAt` parameter
4. Returns ILP Reject (not throws) for routing/delivery failures
5. Throws `ConnectorNotStartedError` if called before `start()`
6. `POST /ilp/send` admin endpoint still works (unchanged)
7. New unit tests cover routing, fulfillment, rejection, and error cases

## Tasks / Subtasks

- [x] Task 1: Define `SendPacketParams` interface and `ConnectorNotStartedError` class (AC: 1, 5)
  - [x] 1.1 In `packages/connector/src/config/types.ts`, add the `SendPacketParams` interface:
    ```typescript
    export interface SendPacketParams {
      /** ILP destination address (RFC-0015 format) */
      destination: string;
      /** Transfer amount in smallest currency unit */
      amount: bigint;
      /** 32-byte SHA-256 execution condition */
      executionCondition: Buffer;
      /** Packet expiration timestamp */
      expiresAt: Date;
      /** Optional application data payload */
      data?: Buffer;
    }
    ```
    The `data` field is optional because many callers won't need it — default to `Buffer.alloc(0)` internally. This matches the ILP Prepare packet shape but uses a flat params object rather than forcing callers to construct `{ type: PacketType.PREPARE, ... }`. [Source: packages/shared/src/types/ilp.ts lines 60-79]
  - [x] 1.2 Define `ConnectorNotStartedError` in `packages/connector/src/config/config-loader.ts` alongside existing `ConfigurationError`:
    ```typescript
    export class ConnectorNotStartedError extends Error {
      constructor(message: string = 'Connector is not started. Call start() before sendPacket().') {
        super(message);
        this.name = 'ConnectorNotStartedError';
      }
    }
    ```
    Co-locate with `ConfigurationError` since both are connector-level errors. The existing `config-loader.ts` already exports `ConfigurationError` — adding `ConnectorNotStartedError` here keeps error types in one place. [Source: packages/connector/src/config/config-loader.ts]

- [x] Task 2: Add `sendPacket()` method to `ConnectorNode` (AC: 1, 2, 3, 4, 5)
  - [x] 2.1 In `packages/connector/src/core/connector-node.ts`, add the public method:

    ```typescript
    /**
     * Send an ILP Prepare packet through the connector's routing logic.
     * Routes through PacketHandler using RoutingTable longest-prefix matching.
     *
     * @param params - Packet parameters (destination, amount, condition, expiry, data)
     * @returns ILP Fulfill or Reject packet
     * @throws ConnectorNotStartedError if connector has not been started
     */
    async sendPacket(params: SendPacketParams): Promise<ILPFulfillPacket | ILPRejectPacket> {
      if (!this._btpServerStarted) {
        throw new ConnectorNotStartedError();
      }

      const packet: ILPPreparePacket = {
        type: PacketType.PREPARE,
        destination: params.destination,
        amount: params.amount,
        executionCondition: params.executionCondition,
        expiresAt: params.expiresAt,
        data: params.data ?? Buffer.alloc(0),
      };

      this._logger.info(
        {
          event: 'send_packet',
          destination: params.destination,
          amount: params.amount.toString(),
          expiresAt: params.expiresAt.toISOString(),
        },
        'Sending packet via public API'
      );

      try {
        return await this._packetHandler.handlePreparePacket(packet, this._config.nodeId);
      } catch (error) {
        this._logger.error(
          {
            event: 'send_packet_error',
            destination: params.destination,
            error: error instanceof Error ? error.message : String(error),
          },
          'Unexpected error sending packet'
        );
        return {
          type: PacketType.REJECT,
          code: ILPErrorCode.T00_INTERNAL_ERROR,
          triggeredBy: this._config.nodeId,
          message: 'Internal connector error',
          data: Buffer.alloc(0),
        } as ILPRejectPacket;
      }
    }
    ```

  - [x] 2.2 Import the necessary types at the top of `connector-node.ts`:
    - `SendPacketParams` from `../config/types`
    - `ConnectorNotStartedError` from `../config/config-loader`
    - `ILPPreparePacket`, `ILPFulfillPacket`, `ILPRejectPacket`, `PacketType`, `ILPErrorCode` from `@agent-runtime/shared`
  - [x] 2.3 **Key design decisions:**
    - **Uses `_btpServerStarted` as the started check**: This field is set to `true` in `start()` at line 565 and reset to `false` in `stop()` at line 989. It accurately reflects whether the connector is in an operational state — PacketHandler, RoutingTable, BTPClientManager are all initialized in the constructor but peers aren't connected and servers aren't listening until `start()` completes. [Source: packages/connector/src/core/connector-node.ts lines 63, 565, 989]
    - **Passes `this._config.nodeId` as `fromPeerId`**: When packets originate from the local connector (not from a BTP peer), using the connector's own nodeId as the source peer is semantically correct — it identifies this connector as the packet originator. The existing `handlePreparePacket()` uses `fromPeerId` for logging and telemetry, and for routing decisions (credit limit checks use `sourcePeerId`). [Source: packages/connector/src/core/packet-handler.ts line 834-839]
    - **Delegates entirely to `PacketHandler.handlePreparePacket()`**: This ensures routing, validation, expiry decrement, settlement recording, local delivery, and BTP forwarding all use the exact same code path as BTP-originated packets. No logic duplication. [Source: packages/connector/src/core/packet-handler.ts lines 834-1262]
    - **Returns `ILPFulfillPacket | ILPRejectPacket`**: Routing/delivery failures are returned as ILP Reject packets (consistent with how `handlePreparePacket` works), not thrown as exceptions. The only exception is `ConnectorNotStartedError` for the pre-start check. [Source: Epic 24 AC 4]
    - **Timeout derives from `expiresAt`**: The caller passes `expiresAt` in the params, and `PacketHandler.handlePreparePacket()` uses `decrementExpiry()` to compute forwarding timeout from this value. No separate timeout parameter is needed. [Source: packages/connector/src/core/packet-handler.ts lines 1029-1048]

- [x] Task 3: Update `packages/connector/src/index.ts` exports (AC: 1, 5)
  - [x] 3.1 Export `SendPacketParams` type from `index.ts`:
    ```typescript
    export type {
      ConnectorConfig,
      LocalDeliveryConfig,
      LocalDeliveryHandler,
      LocalDeliveryRequest,
      LocalDeliveryResponse,
      SendPacketParams,
    } from './config/types';
    ```
  - [x] 3.2 Export `ConnectorNotStartedError` class from `index.ts`:
    ```typescript
    export {
      ConnectorNode,
      ConfigLoader,
      ConfigurationError,
      ConnectorNotStartedError,
      RoutingTable,
      PacketHandler,
      BTPServer,
      BTPClient,
      LocalDeliveryClient,
      createLogger,
    };
    ```
  - [x] 3.3 Re-export `ILPFulfillPacket`, `ILPRejectPacket` types from `@agent-runtime/shared` for convenience — library consumers need these to type-check the `sendPacket()` return value. Add to the type exports block:
    ```typescript
    export type { ILPFulfillPacket, ILPRejectPacket } from '@agent-runtime/shared';
    ```
    **Note**: `@agent-runtime/shared` already exports `ILPFulfillPacket` and `ILPRejectPacket` (lines 18-19 of `packages/shared/src/index.ts`). This re-export is a convenience so library consumers can import everything from `@agent-runtime/connector` without adding `@agent-runtime/shared` as a direct dependency.

- [x] Task 4: Add unit tests for `sendPacket()` on ConnectorNode (AC: 1, 2, 3, 4, 5, 7)
  - [x] 4.1 In `packages/connector/src/core/connector-node.test.ts`, add a new `describe('sendPacket()')` block. Add `handlePreparePacket` to the `mockPacketHandler` mock (currently missing — add `handlePreparePacket: jest.fn()`):
    ```typescript
    mockPacketHandler = {
      processPrepare: jest.fn(),
      setBTPServer: jest.fn(),
      setLocalDeliveryHandler: jest.fn(),
      handlePreparePacket: jest.fn(),
    } as unknown as jest.Mocked<PacketHandler>;
    ```
  - [x] 4.2 Test: `sendPacket() routes packet through PacketHandler.handlePreparePacket()` (AC: 1, 2)
    - Start connector, call sendPacket with valid params
    - Verify `mockPacketHandler.handlePreparePacket` was called with an ILPPreparePacket matching the params
    - Verify `fromPeerId` argument is the connector's nodeId
  - [x] 4.3 Test: `sendPacket() returns Fulfill on successful routing` (AC: 1)
    - Mock `handlePreparePacket` to return an ILPFulfillPacket
    - Verify `sendPacket()` returns the same fulfill packet
  - [x] 4.4 Test: `sendPacket() returns Reject on routing failure (no route)` (AC: 4)
    - Mock `handlePreparePacket` to return an ILPRejectPacket with F02_UNREACHABLE
    - Verify `sendPacket()` returns the reject packet (does NOT throw)
  - [x] 4.5 Test: `sendPacket() throws ConnectorNotStartedError before start()` (AC: 5)
    - Create ConnectorNode but do NOT call `start()`
    - Call `sendPacket()` — expect it to throw `ConnectorNotStartedError`
  - [x] 4.6 Test: `sendPacket() throws ConnectorNotStartedError after stop()` (AC: 5)
    - Start connector, stop it, then call `sendPacket()`
    - Expect `ConnectorNotStartedError`
  - [x] 4.7 Test: `sendPacket() constructs ILPPreparePacket with correct fields` (AC: 1, 3)
    - Verify the constructed packet has `type: PacketType.PREPARE`, correct `destination`, `amount`, `executionCondition`, `expiresAt`, and `data`
    - Verify `data` defaults to `Buffer.alloc(0)` when not provided in params
  - [x] 4.8 Test: `sendPacket() forwards custom data payload` (AC: 1)
    - Call `sendPacket()` with `data: Buffer.from('test-payload')`
    - Verify the constructed `ILPPreparePacket` passed to `handlePreparePacket` has `data` equal to `Buffer.from('test-payload')` (not the default empty buffer)
  - [x] 4.9 Test: `sendPacket() returns T00 Reject on unexpected handlePreparePacket error` (AC: 4)
    - Mock `handlePreparePacket` to throw an unexpected `Error('something broke')`
    - Verify `sendPacket()` returns an ILPRejectPacket with code `T00_INTERNAL_ERROR` (does NOT throw)
    - Verify logger.error is called with `event: 'send_packet_error'`
  - [x] 4.10 Test: `sendPacket() logs send_packet event` (AC: 1)
    - Verify logger.info is called with `event: 'send_packet'` including destination and amount

- [x] Task 5: Verify existing tests and TypeScript compilation (AC: 6, 7)
  - [x] 5.1 Run all existing ConnectorNode tests to confirm no regressions
  - [x] 5.2 Run all existing PacketHandler tests to confirm no regressions
  - [x] 5.3 Run `npm run build` from monorepo root to verify no TypeScript compilation errors
  - [x] 5.4 Run full test suite to verify no regressions across the monorepo

## Dev Notes

### Epic Context

This is the third story in Epic 24 (Connector Library API — Brownfield Enhancement). Story 24.1 (Done) established config-object construction. Story 24.2 (Done) added in-process function handler delivery. This story adds the `sendPacket()` public method, enabling library consumers to initiate ILP payments without HTTP.

### Previous Story Insights (Story 24.2)

- Types like `LocalDeliveryRequest`, `LocalDeliveryResponse` successfully moved to `config/types.ts` with re-exports for backward compat
- `PacketHandler` setter pattern (e.g., `setLocalDeliveryHandler()`) works cleanly for cross-cutting concerns
- All existing tests pass (82 across ConnectorNode + PacketHandler), full monorepo build clean
- 2667 tests pass total; 5 pre-existing failures are wallet derivation performance tests
- ConnectorNode test mocks use `jest.mock()` of module + mock instances in `beforeEach()`
  [Source: docs/stories/24.2.story.md#dev-agent-record]

### Relevant Source Tree

```
packages/connector/src/
├── core/
│   ├── connector-node.ts          # PRIMARY: Add sendPacket() method
│   ├── connector-node.test.ts     # Add sendPacket() unit tests
│   ├── packet-handler.ts          # REFERENCE: handlePreparePacket() (reused, not modified)
│   └── packet-handler.test.ts     # NOT MODIFIED (no PacketHandler changes)
├── config/
│   ├── types.ts                   # Add SendPacketParams interface
│   └── config-loader.ts           # Add ConnectorNotStartedError class
├── index.ts                       # Add exports for SendPacketParams, ConnectorNotStartedError
```

[Source: docs/architecture/source-tree.md]

### PacketHandler.handlePreparePacket() — The Routing Logic to Reuse

`sendPacket()` delegates entirely to `PacketHandler.handlePreparePacket(packet, fromPeerId)`. This method (lines 834-1262 of packet-handler.ts) performs the full ILP routing flow:

1. **Validation**: Validates packet structure, destination format (RFC-0015), expiration, execution condition length
2. **Route lookup**: `RoutingTable.getNextHop(destination)` — longest-prefix matching, returns peer ID or null
3. **Local delivery check**: If `nextHop === nodeId || nextHop === 'local'`, delivers locally (function handler > HTTP client > auto-fulfill stub)
4. **Expiry decrement**: Subtracts 1000ms safety margin, rejects if insufficient time
5. **Settlement recording**: If enabled, calculates connector fee, records TigerBeetle transfers, checks credit limits
6. **BTP forwarding**: `forwardToNextHop()` sends packet to next-hop peer via BTPClientManager or BTPServer
7. **Telemetry**: Emits PACKET_RECEIVED, ROUTE_LOOKUP, PACKET_FORWARDED, PACKET_FULFILLED/REJECTED events

All of this logic is reused — `sendPacket()` only constructs the `ILPPreparePacket` from params and calls `handlePreparePacket`.

[Source: packages/connector/src/core/packet-handler.ts lines 834-1262]

### ConnectorNode Lifecycle and \_btpServerStarted Flag

The `_btpServerStarted` field (line 63) tracks whether the connector is in an operational state:

- Initialized to `false` in constructor
- Set to `true` in `start()` after BTP server starts listening (line 565)
- Reset to `false` in `stop()` (line 989)

This is the correct field to check in `sendPacket()` because:

- Before `start()`: BTP server not listening, no peer connections established, forwarding would fail
- After `stop()`: BTP server stopped, peers disconnected, forwarding would fail
- During `start()`: RoutingTable, PacketHandler, BTPClientManager are initialized in constructor, but peers connect later in `start()` — `_btpServerStarted` is set before peer connections, which is fine because routing to local delivery still works even without connected peers

[Source: packages/connector/src/core/connector-node.ts lines 63, 565, 989]

### Current ConnectorNode Test Patterns

The test file uses Jest module mocking (`jest.mock()`) and mock instances created in `beforeEach()`:

- `PacketHandler` is mocked via `jest.mock('./packet-handler')` at the top
- `mockPacketHandler` has manual mock methods (currently: `processPrepare`, `setBTPServer`, `setLocalDeliveryHandler`)
- Must add `handlePreparePacket: jest.fn()` to the mock to test `sendPacket()` — currently missing from mock
- Tests create ConnectorNode with `new ConnectorNode(testConfigPath, mockLogger)`, where `ConfigLoader.loadConfig` returns a test config
- To test started vs not-started state, some tests call `await connectorNode.start()` while others test pre-start behavior

[Source: packages/connector/src/core/connector-node.test.ts]

### ILPPreparePacket Structure

The `sendPacket()` method constructs an `ILPPreparePacket` from `SendPacketParams`:

```typescript
interface ILPPreparePacket {
  type: PacketType.PREPARE; // Always 12
  amount: bigint; // Transfer amount
  destination: ILPAddress; // ILP address (string)
  executionCondition: Buffer; // 32-byte SHA-256 hash
  expiresAt: Date; // Expiration timestamp
  data: Buffer; // Application data payload
}
```

The only difference from `SendPacketParams` is the `type` field (added automatically) and `data` defaulting to `Buffer.alloc(0)`.

[Source: packages/shared/src/types/ilp.ts lines 60-79]

### Current Package Exports

After Story 24.2, `packages/connector/src/index.ts` exports:

```typescript
// Classes
export {
  ConnectorNode,
  ConfigLoader,
  ConfigurationError,
  RoutingTable,
  PacketHandler,
  BTPServer,
  BTPClient,
  LocalDeliveryClient,
  createLogger,
};

// Types
export type {
  ConnectorConfig,
  LocalDeliveryConfig,
  LocalDeliveryHandler,
  LocalDeliveryRequest,
  LocalDeliveryResponse,
} from './config/types';
```

Task 3 adds `SendPacketParams` to types and `ConnectorNotStartedError` to class exports.

[Source: packages/connector/src/index.ts]

### Coding Standards

- TypeScript strict mode, no `any` types except in test mocks [Source: docs/architecture/coding-standards.md]
- File naming: kebab-case (`config-loader.ts`) [Source: docs/architecture/coding-standards.md]
- Classes: PascalCase (`ConnectorNode`) [Source: docs/architecture/coding-standards.md]
- Use Pino logger exclusively (no `console.log`) [Source: docs/architecture/coding-standards.md]
- All async functions must handle errors with try-catch [Source: docs/architecture/coding-standards.md]
- Private members: camelCase with `_` prefix [Source: docs/architecture/coding-standards.md]
- All ILP packet responses use typed returns (`ILPFulfillPacket | ILPRejectPacket`) [Source: docs/architecture/coding-standards.md]

### Testing

- **Framework:** Jest 29.7.x with `ts-jest` [Source: docs/architecture/tech-stack.md]
- **File Convention:** Co-located `<filename>.test.ts` next to source [Source: docs/architecture/coding-standards.md]
- **Test Location:** ConnectorNode tests at `packages/connector/src/core/connector-node.test.ts`
- **Pattern:** AAA (Arrange, Act, Assert) with descriptive test names
- **Mocking:** Jest built-in (`jest.fn()`, `jest.mock()`)
- **Mock Isolation:** Create fresh mock instances in `beforeEach()`, use `mockResolvedValueOnce()` for sequential calls
- **Resource Cleanup:** Use `afterEach()` to release all resources
- **Coverage Requirement:** >80% line coverage for connector package

## Change Log

| Date       | Version | Description                                                                                                                                                                             | Author       |
| ---------- | ------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------ |
| 2026-02-11 | 1.0     | Initial story creation                                                                                                                                                                  | Scrum Master |
| 2026-02-11 | 1.1     | Validation fixes: resolve Task 3.3 shared exports ambiguity, add try-catch error handling to sendPacket(), add test for custom data payload, add test for unexpected error → T00 Reject | Scrum Master |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6

### Completion Notes

All 5 tasks implemented successfully. Implementation adds `sendPacket()` public method to `ConnectorNode` that constructs an `ILPPreparePacket` from flat `SendPacketParams` and delegates to `PacketHandler.handlePreparePacket()` — reusing all existing routing, validation, settlement, and forwarding logic. Returns `ILPFulfillPacket | ILPRejectPacket` (never throws for routing/delivery failures). Throws `ConnectorNotStartedError` if called before `start()`.

Key debug issues resolved during implementation:

1. TypeScript discriminated union types in test mocks required `as const` on the `type` field to narrow from generic `PacketType` to literal `PacketType.FULFILL`/`PacketType.REJECT`
2. Jest module mocking of `config-loader.ts` replaced the entire module, making `ConnectorNotStartedError` undefined at runtime. Fixed by using factory function with `jest.requireActual()` to preserve real error classes while only mocking `ConfigLoader` methods

### Test Results

- ConnectorNode tests: 47/47 passed (38 existing + 9 new sendPacket tests)
- Config-loader tests: 43/43 passed (no regressions)
- PacketHandler tests: 44/44 passed (no regressions)
- TypeScript build: clean, no errors
- Full monorepo test suite: 2673 passed, 8 failed (all pre-existing: OER perf, wallet derivation perf, claim-redemption timeout)

### File List

| File                                                 | Action   | Description                                                                                          |
| ---------------------------------------------------- | -------- | ---------------------------------------------------------------------------------------------------- |
| `packages/connector/src/config/types.ts`             | Modified | Added `SendPacketParams` interface                                                                   |
| `packages/connector/src/config/config-loader.ts`     | Modified | Added `ConnectorNotStartedError` class                                                               |
| `packages/connector/src/core/connector-node.ts`      | Modified | Added `sendPacket()` public method with imports                                                      |
| `packages/connector/src/core/connector-node.test.ts` | Modified | Added 9 sendPacket() unit tests, updated mock setup                                                  |
| `packages/connector/src/index.ts`                    | Modified | Added exports: `ConnectorNotStartedError`, `SendPacketParams`, `ILPFulfillPacket`, `ILPRejectPacket` |

### Change Log

| Date       | Change                                                                                                            | Author                      |
| ---------- | ----------------------------------------------------------------------------------------------------------------- | --------------------------- |
| 2026-02-11 | Implemented all 5 tasks for Story 24.3: sendPacket() public method, types, error class, exports, and 9 unit tests | Dev Agent (Claude Opus 4.6) |

## QA Results

### Review Date: 2026-02-11

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Implementation is clean and well-structured. The `sendPacket()` method correctly delegates to `PacketHandler.handlePreparePacket()` with no logic duplication. The `SendPacketParams` interface provides an ergonomic caller-facing API that avoids requiring callers to construct full `ILPPreparePacket` objects. Error handling follows established patterns: `ConnectorNotStartedError` for pre-condition violations, ILP Reject for routing/delivery failures, and a catch-all that converts unexpected exceptions to `T00_INTERNAL_ERROR` rejects rather than propagating them.

The Jest mock setup for `config-loader.ts` uses `jest.requireActual()` to preserve real error classes while mocking `ConfigLoader` methods -- a sound approach that avoids the common pitfall of module mocking replacing error constructors.

### Refactoring Performed

No refactoring was necessary. The implementation is already well-structured and follows established patterns from Stories 24.1 and 24.2.

### Compliance Check

- Coding Standards: ✓ TypeScript strict mode, Pino logger exclusively, typed returns (`ILPFulfillPacket | ILPRejectPacket`), proper naming conventions, `_btpServerStarted` private prefix, no `console.log`
- Project Structure: ✓ Co-located tests, types in `config/types.ts`, errors in `config/config-loader.ts`, exports from `index.ts`
- Testing Strategy: ✓ 9 new unit tests covering all ACs, AAA pattern, descriptive test names, mock isolation with `beforeEach`/`jest.clearAllMocks()`
- All ACs Met: ✓ All 7 acceptance criteria verified (see trace below)

### Improvements Checklist

- [x] All 5 tasks implemented correctly
- [x] `sendPacket()` routes through `handlePreparePacket()` -- same code path as BTP-originated packets (AC 1, 2)
- [x] Timeout derived from `expiresAt` parameter via `decrementExpiry()` in PacketHandler (AC 3)
- [x] Returns ILP Reject (not throws) for routing/delivery failures (AC 4)
- [x] Throws `ConnectorNotStartedError` before `start()` and after `stop()` (AC 5)
- [x] `POST /ilp/send` admin endpoint unchanged -- no modifications to admin-server or existing HTTP paths (AC 6)
- [x] 9 new unit tests cover routing, fulfillment, rejection, error, data payload, and logging cases (AC 7)
- [x] `SendPacketParams`, `ConnectorNotStartedError`, `ILPFulfillPacket`, `ILPRejectPacket` all exported from `index.ts`
- [ ] Minor: `eslint-disable-next-line @typescript-eslint/no-explicit-any` used twice in test for T00 reject assertion (lines 973-976) -- consider using type assertion to `ILPRejectPacket` instead of `any` cast

### Security Review

No security concerns. `sendPacket()` is a local in-process API only callable by the library consumer (not network-accessible). No new attack surface introduced. The method uses the same validation and routing path as BTP-originated packets, inheriting all existing security checks (packet validation, expiry enforcement, credit limit checks when settlement is enabled).

### Performance Considerations

No performance concerns. `sendPacket()` adds one `Buffer.alloc(0)` for the default `data` field and one structured log call before delegating to `handlePreparePacket()`. The hot path is identical to BTP-originated packet processing.

### Files Modified During Review

No files were modified during this review.

### Gate Status

Gate: PASS → docs/qa/gates/24.3-expose-sendpacket-public-method.yml
Risk profile: Low (additive public method, no existing behavior changes)

### Recommended Status

[✓ Ready for Done] -- All 7 acceptance criteria met, 47/47 ConnectorNode tests pass (including 9 new), 43/43 config-loader tests pass, 44/44 PacketHandler tests pass, TypeScript build clean, no regressions.
