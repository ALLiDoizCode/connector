# Story 21.5: Standardize Channel Status Enum and Response Types

**Epic:** 21 - Payment Channel Admin APIs
**Story Number:** 21.5
**Status:** Done
**Priority:** P2 (Medium — Polish & Safety)

## Story

**As a** BLS developer,
**I want** channel status values and response types to be consistent between agent-runtime and agent-society,
**so that** the BLS can reliably parse channel state responses and make correct decisions based on status transitions.

## Acceptance Criteria

1. Canonical `AdminChannelStatus` type defined: `'opening' | 'open' | 'closing' | 'closed' | 'settling' | 'settled'` (Gap 11). Named `AdminChannelStatus` to avoid collision with the existing on-chain `ChannelStatus` (`'opened' | 'closed' | 'settled'`) in `@agent-runtime/shared`
2. `'active'` is treated as an alias for `'open'` — normalization maps `'active'` → `'open'` in all API responses
3. `'opened'` (on-chain SDK past-tense) is treated as an alias for `'open'` — normalization maps `'opened'` → `'open'` so that `GET /admin/channels/:channelId` returns consistent values whether sourced from ChannelMetadata or PaymentChannelSDK
4. `'settling'` is a valid canonical status (in-progress settlement after close) — distinct from `'settled'` (final)
5. All channel status values in `admin-api.ts` use the canonical enum (no ad-hoc strings)
6. `GET /admin/channels/:channelId` response returns status from the canonical enum
7. `GET /admin/channels` list response returns normalized status; `?status=` query filter matches against normalized values
8. `POST /admin/channels` response uses actual status (from Story 21.4), constrained to canonical enum
9. `POST /admin/channels/:channelId/deposit` response returns normalized status (not hardcoded `'open'`)
10. `POST /admin/channels/:channelId/close` guard conditions use canonical enum values (not raw `'active'`)
11. `OpenChannelResponse` interface includes `chain` and `deposit` fields — documented as superset of agent-society's `OpenChannelResult` (Gap 10)
12. `ChannelDetailResponse` interface documented with field mapping to agent-society's `ChannelState`
13. `ChannelMetadata.status` in `channel-manager.ts` updated to use `AdminChannelStatus` type (or internal superset referencing it)
14. Status normalization function: maps internal and on-chain statuses (e.g., `'active'` → `'open'`, `'opened'` → `'open'`) before returning to API consumers
15. `DepositResponse.status` and `CloseChannelResponse.status` typed as `AdminChannelStatus` (not bare `string`)
16. Unit tests for status normalization (all canonical values pass through, `'active'` → `'open'`, `'opened'` → `'open'`, `'settling'` passes through, unknown status logged as warning)
17. Integration-level test verifying normalized status appears in actual API responses
18. All existing channel endpoint tests continue to pass

## Tasks / Subtasks

- [x] Task 1: Define canonical AdminChannelStatus type and update ChannelMetadata (AC: 1, 2, 3, 4, 13)
  - [x] Add to `packages/connector/src/settlement/types.ts`:
    ```typescript
    /**
     * Canonical Admin API channel status values shared between agent-runtime and agent-society.
     * Named AdminChannelStatus to avoid collision with the on-chain ChannelStatus
     * ('opened' | 'closed' | 'settled') exported from @agent-runtime/shared.
     */
    export type AdminChannelStatus =
      | 'opening'
      | 'open'
      | 'closing'
      | 'closed'
      | 'settling'
      | 'settled';
    ```
  - [x] Add normalization function to `packages/connector/src/settlement/types.ts`:

    ```typescript
    const CANONICAL_STATUSES: readonly string[] = [
      'opening',
      'open',
      'closing',
      'closed',
      'settling',
      'settled',
    ];

    /**
     * Normalize any channel status string to the canonical AdminChannelStatus.
     * Handles aliases from two sources:
     * - ChannelMetadata (internal): 'active' → 'open'
     * - PaymentChannelSDK (on-chain): 'opened' → 'open'
     */
    export function normalizeChannelStatus(status: string, logger?: Logger): AdminChannelStatus {
      if (status === 'active' || status === 'opened') return 'open';
      if (CANONICAL_STATUSES.includes(status)) {
        return status as AdminChannelStatus;
      }
      logger?.warn({ status }, 'Unknown channel status, defaulting to opening');
      return 'opening';
    }
    ```

  - [x] Update `ChannelMetadata.status` in `channel-manager.ts` (line 40) from `'opening' | 'active' | 'closing' | 'settling' | 'closed'` to reference `AdminChannelStatus`:
    ```typescript
    import { AdminChannelStatus } from './types';
    // ...
    status: AdminChannelStatus;
    ```
  - [x] Update all internal assignments in `channel-manager.ts` that set `status: 'active'` to `status: 'open'` (line 249 in `openChannelForPeer`)
  - [x] Update `checkIdleChannels()` (line 298) — change `metadata.status !== 'active'` to `metadata.status !== 'open'`

- [x] Task 2: Update channel response types (AC: 11, 12, 15)
  - [x] Update `OpenChannelResponse` in `admin-api.ts` to use `AdminChannelStatus`:
    ```typescript
    /** POST /admin/channels response.
     *  Superset of agent-society's OpenChannelResult — includes `chain` and `deposit`
     *  fields that agent-society ignores but are useful for debugging.
     *  Agent-society expects: { channelId: string, status: string }
     */
    export interface OpenChannelResponse {
      channelId: string;
      chain: string;
      status: AdminChannelStatus;
      deposit: string;
    }
    ```
  - [x] Update `ChannelSummary.status` to `AdminChannelStatus`
  - [x] Update `ChannelDetailResponse.status` to `AdminChannelStatus` and add JSDoc:
    ```typescript
    /** GET /admin/channels/:channelId response.
     *  Agent-society's ChannelState expects: { channelId, status, chain }
     *  This response is a superset — additional fields (deposit, etc.) are safe to ignore.
     */
    ```
  - [x] Update `DepositResponse.status` to `AdminChannelStatus`
  - [x] Update `CloseChannelResponse.status` to `AdminChannelStatus`
  - [x] Import `AdminChannelStatus` from `../settlement/types` in `admin-api.ts`

- [x] Task 3: Apply status normalization to all channel endpoints (AC: 5, 6, 7, 8, 9, 10)
  - [x] `GET /admin/channels` (line ~1050) — normalize status for each channel in list response:
    ```typescript
    status: normalizeChannelStatus(ch.status, log),
    ```
  - [x] `GET /admin/channels` — normalize `?status=` query filter to match against normalized values:
    ```typescript
    if (filterStatus) {
      const normalizedFilter = normalizeChannelStatus(filterStatus, log);
      channels = channels.filter(
        (ch) => normalizeChannelStatus(ch.status, log) === normalizedFilter
      );
    }
    ```
  - [x] `GET /admin/channels/:channelId` — normalize status in detail response (lines ~1130, ~1144)
  - [x] `POST /admin/channels` — normalize status in creation response (lines ~925, ~985)
  - [x] `POST /admin/channels/:channelId/deposit` — replace hardcoded `status: 'open'` (lines 1213, 1236) with `status: normalizeChannelStatus(metadata.status, log)`
  - [x] `POST /admin/channels/:channelId/close` — update guard condition (line 1274) from `metadata.status !== 'active'` to `normalizeChannelStatus(metadata.status, log) !== 'open'`:
    ```typescript
    const normalizedStatus = normalizeChannelStatus(metadata.status, log);
    if (normalizedStatus !== 'open' && normalizedStatus !== 'opening') {
      // ...
    }
    ```
  - [x] Deposit guard (line 1179) — update `metadata.status !== 'active'` to use normalization:
    ```typescript
    if (normalizeChannelStatus(metadata.status, log) !== 'open') {
      // ...
    }
    ```
  - [x] Search for any remaining hardcoded `'active'` or `'open'` status strings in admin-api.ts and replace with normalized values
  - [x] Import `normalizeChannelStatus` from `../settlement/types` in `admin-api.ts`

- [x] Task 4: Write unit tests (AC: 14, 16, 17, 18)
  - [x] Create `packages/connector/src/settlement/types.test.ts`
  - [x] Test `normalizeChannelStatus('opening')` → `'opening'`
  - [x] Test `normalizeChannelStatus('open')` → `'open'`
  - [x] Test `normalizeChannelStatus('active')` → `'open'` (ChannelMetadata alias)
  - [x] Test `normalizeChannelStatus('opened')` → `'open'` (on-chain SDK alias)
  - [x] Test `normalizeChannelStatus('closing')` → `'closing'`
  - [x] Test `normalizeChannelStatus('closed')` → `'closed'`
  - [x] Test `normalizeChannelStatus('settling')` → `'settling'`
  - [x] Test `normalizeChannelStatus('settled')` → `'settled'`
  - [x] Test `normalizeChannelStatus('unknown')` → `'opening'` (default with warning logged)
  - [x] Test that logger.warn is called for unknown status values
  - [x] Test that logger.warn is NOT called when no logger is provided (graceful no-op)
  - [x] Add integration-level test in `admin-api-channels.test.ts`: verify GET /admin/channels response contains normalized status values (e.g., channel with internal `'active'` returns `'open'` in JSON response)
  - [x] Add integration-level test: verify GET /admin/channels/:channelId normalizes on-chain SDK `'opened'` to `'open'` in response
  - [x] Verify all existing channel endpoint tests pass

## Dev Notes

### Gap Context

This story addresses 2 integration gaps from `INTEGRATION-GAPS.md`:

- **Gap 10 (P3):** `OpenChannelResponse` has `chain` and `deposit` fields that agent-society's `OpenChannelResult` doesn't expect. Extra fields are benign (ignored by agent-society), but should be documented as a superset.
- **Gap 11 (P2):** Channel status values are inconsistent. Agent-society expects `'opening' | 'open' | 'closed' | 'settled'`. Agent-runtime uses `'active'` in some places, `'open'` in others. The BLS compares against specific enum values.

### Why `AdminChannelStatus` (not `ChannelStatus`)

The shared package `packages/shared/src/types/payment-channel.ts:11` already exports:

```typescript
// On-chain SDK states (maps to Solidity ChannelState enum)
export type ChannelStatus = 'opened' | 'closed' | 'settled';
```

This is imported by `PaymentChannelSDK` and used in `ChannelState.status`. To avoid a name collision within the monorepo, the new Admin API type is named `AdminChannelStatus`. The two types serve different purposes:

- **`ChannelStatus`** (`@agent-runtime/shared`): Raw on-chain states — uses past tense `'opened'`
- **`AdminChannelStatus`** (`settlement/types.ts`): Normalized API-facing states — uses present tense `'open'`

**IMPORTANT:** Always import `AdminChannelStatus` from `../settlement/types`, never from `@agent-runtime/shared`.

### Current Internal Status Enum (channel-manager.ts:40)

The actual `ChannelMetadata.status` type before this story is:

```typescript
status: 'opening' | 'active' | 'closing' | 'settling' | 'closed';
```

### On-Chain SDK Status (PaymentChannelSDK.getChannelState)

The `GET /admin/channels/:channelId` endpoint (line ~1124) returns `state.status` from the on-chain SDK when available. The SDK `ChannelState.status` uses `'opened' | 'closed' | 'settled'` (past-tense `'opened'`, not `'open'`). The normalization function must handle this.

### Status Alias Mapping Summary

| Source                       | Raw Value      | Normalized | Reason                                     |
| ---------------------------- | -------------- | ---------- | ------------------------------------------ |
| ChannelMetadata (internal)   | `'active'`     | `'open'`   | Agent-society expects `'open'`             |
| PaymentChannelSDK (on-chain) | `'opened'`     | `'open'`   | On-chain uses past tense; API uses present |
| All other canonical values   | (pass through) | (same)     | Already canonical                          |

### Key Mapping Decisions

- `'active'` → `'open'` (alias — agent-society expects `'open'`)
- `'opened'` → `'open'` (alias — on-chain SDK uses past tense)
- `'settling'` → `'settling'` (keep as-is — represents in-progress settlement after unilateral close, distinct from `'settled'` which is final)
- Agent-society's `ChannelState` type uses `'opening' | 'open' | 'closed' | 'settled'` — the canonical enum is a superset that adds `'closing'` and `'settling'` for finer-grained lifecycle tracking

### Key File Locations

| Action     | File                                                     | Context                                                                                          |
| ---------- | -------------------------------------------------------- | ------------------------------------------------------------------------------------------------ |
| **Modify** | `packages/connector/src/settlement/types.ts`             | Add AdminChannelStatus type + normalizeChannelStatus function                                    |
| **Modify** | `packages/connector/src/settlement/channel-manager.ts`   | Update ChannelMetadata.status to use AdminChannelStatus; change 'active' → 'open' in assignments |
| **Modify** | `packages/connector/src/http/admin-api.ts`               | Use AdminChannelStatus in response types; normalize status in all endpoints                      |
| **Modify** | `packages/connector/src/http/admin-api-channels.test.ts` | Add integration test for normalized status in responses                                          |
| **Create** | `packages/connector/src/settlement/types.test.ts`        | Unit tests for normalizeChannelStatus                                                            |

### Agent-Society Expected Types

```typescript
// agent-society packages/core/src/types.ts lines 159-176
interface OpenChannelResult {
  channelId: string;
  status: string; // expects 'opening' | 'open' | ...
}

interface ChannelState {
  channelId: string;
  status: 'opening' | 'open' | 'closed' | 'settled';
  chain: string;
}
```

### Current Status Inconsistencies in admin-api.ts

```typescript
// line ~1054 — GET /admin/channels passes raw ch.status to response
status: ch.status,  // could be 'active' from ChannelMetadata

// line ~1179 — deposit guard checks raw 'active'
if (metadata.status !== 'active') { ... }

// line ~1213, ~1236 — deposit response hardcodes 'open'
status: 'open',

// line ~1274 — close guard checks raw 'active'
if (metadata.status !== 'active' && metadata.status !== 'opening') { ... }
```

Note: Story 21.4 already fixed the POST /admin/channels response to use `metadata.status` instead of hardcoded `'open'`. The status normalization in this story builds on that fix.

### channel-manager.ts Internal Assignments

```typescript
// line 249 — openChannelForPeer sets status to 'active'
status: 'active',

// line 298 — checkIdleChannels compares against 'active'
if (metadata.status !== 'active') { continue; }

// line 345 — closeIdleChannel sets status to 'closing'
metadata.status = 'closing';

// line 387 — cooperative close sets status to 'closed'
metadata.status = 'closed';

// line 491 — settleAfterChallenge sets status to 'closed'
metadata.status = 'closed';
```

After this story, `'active'` assignments become `'open'`, and all comparisons use canonical values.

### Technical Constraints

- TypeScript strict mode — no `any` types
- Pino logger only (`import type { Logger } from 'pino'`)
- Co-located test files (`*.test.ts` next to source)
- `satisfies` keyword used for response type checking in admin-api.ts
- `normalizeChannelStatus` accepts optional logger parameter to avoid requiring logger in pure unit tests

### Testing

**Framework:** Jest 29.7.x with ts-jest
**Convention:** Co-located `*.test.ts`
**Coverage:** >80% line coverage
**Pattern:** AAA (Arrange, Act, Assert)

## Change Log

| Date       | Version | Description                                                                                                                                                                                                         | Author                 |
| ---------- | ------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------- |
| 2026-02-09 | 1.0     | Initial story draft from INTEGRATION-GAPS.md (Gaps 10, 11)                                                                                                                                                          | Sarah (PO)             |
| 2026-02-09 | 1.1     | Address validation findings: add 'settling' to canonical enum, update ChannelMetadata.status, add deposit/close endpoint normalization, fix stale line refs, add integration test, add Dev Agent Record/QA sections | Claude (validation)    |
| 2026-02-09 | 1.2     | Rename ChannelStatus → AdminChannelStatus to avoid name collision with shared package on-chain type; add 'opened' → 'open' normalization for PaymentChannelSDK status values                                        | Claude (re-validation) |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6

### Debug Log References

- No debug issues encountered. All tests passed on first run after fixing one pre-existing test expectation.

### Completion Notes List

- Tasks 1-3 were already completed prior to this session (type definition, response types, endpoint normalization)
- Task 4 (tests): `types.test.ts` had 12 unit tests already written; `admin-api-channels.test.ts` had 6 integration tests in Story 21.5 describe block already written
- Fixed `channel-manager.test.ts:112` — updated expected status from `'active'` to `'open'` to match Task 1 implementation change
- 3 pre-existing test failures unrelated to Story 21.5: claim-redemption (timeout), throughput-benchmark (flaky perf), explorer-lifecycle (WebSocket race)

### File List

- `packages/connector/src/settlement/types.ts` — Added `AdminChannelStatus` type and `normalizeChannelStatus` function (Modified)
- `packages/connector/src/settlement/types.test.ts` — Unit tests for `normalizeChannelStatus` (Created)
- `packages/connector/src/settlement/channel-manager.ts` — Updated `ChannelMetadata.status` to `AdminChannelStatus`, changed `'active'` → `'open'` (Modified)
- `packages/connector/src/settlement/channel-manager.test.ts` — Updated expected status from `'active'` to `'open'` (Modified)
- `packages/connector/src/http/admin-api.ts` — Used `AdminChannelStatus` in response types, applied `normalizeChannelStatus` to all endpoints (Modified)
- `packages/connector/src/http/admin-api-channels.test.ts` — Added Story 21.5 integration tests for status normalization (Modified)

## QA Results

### Review Date: 2026-02-09

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation quality. The story addresses a real cross-repo integration gap (inconsistent channel status values between agent-runtime and agent-society) with a clean, well-scoped solution. Key strengths:

- **Type safety**: `AdminChannelStatus` union type prevents ad-hoc status strings at compile time. The naming choice (`AdminChannelStatus` vs `ChannelStatus`) correctly avoids collision with the on-chain SDK type in `@agent-runtime/shared`.
- **Normalization function**: `normalizeChannelStatus` is pure, testable, and handles both known alias sources (`'active'` from ChannelMetadata, `'opened'` from PaymentChannelSDK) with a sensible default + warning for unknown values.
- **Consistent application**: All 6 channel endpoints (`POST`, `GET` list, `GET` detail, deposit, close, plus query filter) consistently use the normalization function. No hardcoded status strings remain in `admin-api.ts`.
- **Backward compatibility**: The `'active'` alias mapping ensures existing `ChannelMetadata` records work correctly through the normalization layer. The `?status=active` query filter also normalizes, providing full backward-compatible filtering.

### Refactoring Performed

No refactoring needed. The implementation is clean, focused, and follows established patterns.

### Compliance Check

- Coding Standards: ✓ TypeScript strict mode, Pino logger, no `any` in production code, kebab-case files, PascalCase types
- Project Structure: ✓ Co-located tests, types in `settlement/types.ts`, API types in `admin-api.ts`
- Testing Strategy: ✓ Unit tests (12) for normalization function, integration tests (6) for API endpoint normalization, all co-located
- All ACs Met: ✓ All 18 acceptance criteria verified (see traceability below)

### AC Traceability

| AC  | Description                                                      | Verification                                                         |
| --- | ---------------------------------------------------------------- | -------------------------------------------------------------------- |
| 1   | `AdminChannelStatus` type defined                                | `types.ts:24` — union type with 6 values                             |
| 2   | `'active'` alias → `'open'`                                      | `types.ts:35`, unit test `types.test.ts:39-41`                       |
| 3   | `'opened'` alias → `'open'`                                      | `types.ts:35`, unit test `types.test.ts:43-45`                       |
| 4   | `'settling'` is valid canonical                                  | `types.ts:24`, unit test `types.test.ts:29-31`                       |
| 5   | All admin-api.ts uses canonical enum                             | Verified: no ad-hoc status strings remain                            |
| 6   | GET detail returns canonical status                              | `admin-api.ts:1127,1142` — `normalizeChannelStatus()` applied        |
| 7   | GET list returns normalized + filter                             | `admin-api.ts:1048-1050,1057` — filter and response normalized       |
| 8   | POST response uses actual status                                 | `admin-api.ts:927,986` — reads `metadata.status` via normalization   |
| 9   | Deposit response normalized                                      | `admin-api.ts:1216,1239` — `normalizeChannelStatus(metadata.status)` |
| 10  | Close guard uses canonical                                       | `admin-api.ts:1277-1278` — normalizes before comparison              |
| 11  | `OpenChannelResponse` has `chain` + `deposit`                    | `admin-api.ts:1598-1603` with JSDoc                                  |
| 12  | `ChannelDetailResponse` documented                               | `admin-api.ts:1615-1624` with JSDoc mapping                          |
| 13  | `ChannelMetadata.status` uses `AdminChannelStatus`               | `channel-manager.ts:41`                                              |
| 14  | Normalization function implemented                               | `types.ts:34-41`                                                     |
| 15  | `DepositResponse.status` and `CloseChannelResponse.status` typed | `admin-api.ts:1641,1652`                                             |
| 16  | Unit tests for normalization                                     | `types.test.ts` — 12 tests covering all cases                        |
| 17  | Integration test for normalized API responses                    | `admin-api-channels.test.ts:2453-2705` — 6 tests                     |
| 18  | Existing tests pass                                              | All 169 tests pass (3 suites)                                        |

### Improvements Checklist

- [x] All canonical statuses pass through normalization correctly (verified in unit tests)
- [x] Both alias mappings (`'active'` → `'open'`, `'opened'` → `'open'`) tested
- [x] Unknown status warning logged correctly
- [x] No logger = graceful no-op (no crash)
- [x] All 6 endpoints use `normalizeChannelStatus` consistently
- [x] Query filter `?status=` normalizes both filter value and channel status before comparison
- [x] `channel-manager.ts` internal assignments updated from `'active'` to `'open'`
- [x] `channel-manager.test.ts` updated expected status from `'active'` to `'open'`
- [x] Response type interfaces all use `AdminChannelStatus` (not bare `string`)

### Security Review

No security concerns. This is a type-safety and consistency improvement. The normalization function does not introduce any new attack surface. Unknown statuses default to `'opening'` (safe fallback) with a logged warning.

### Performance Considerations

No performance concerns. The `normalizeChannelStatus` function is O(1) for alias checks and O(n) for the canonical status array check where n=6 (constant). The `CANONICAL_STATUSES` array is small and read-only.

### Files Modified During Review

None. No refactoring was needed.

### Gate Status

Gate: PASS → docs/qa/gates/21.5-standardize-channel-status-enum-and-response-types.yml

### Recommended Status

✓ Ready for Done
