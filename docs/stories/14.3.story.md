<!-- Powered by BMADâ„¢ Core -->

# Story 14.3: Add Public Testnet Configuration

## Status

Done

## Story

**As a** developer running integration tests,
**I want** a `NETWORK_MODE` environment variable that switches between local containers and public testnets,
**So that** I can run tests on ARM64 without Docker image limitations and get production-like testing behavior.

## Acceptance Criteria

1. `NETWORK_MODE` environment variable supports `testnet` and `local` values (default: `local`)
2. When `NETWORK_MODE=testnet`, agents connect to public testnet URLs for all three chains
3. When `NETWORK_MODE=local`, agents connect to local Docker containers (existing behavior)
4. Testnet URLs are configurable via environment variables with sensible defaults
5. Test runner detects network mode and adjusts faucet/funding behavior accordingly
6. Documentation updated to explain both modes

## Tasks / Subtasks

**Task Execution Strategy:** This story adds the `NETWORK_MODE` configuration layer that Story 14.4 will use to update the test infrastructure. Focus on environment variable handling and URL configuration.

**Implementation Status:** Tasks 1-3 and 5 are complete. The remaining work focuses on faucet function updates (Task 4), unit tests (Task 6), and documentation (Task 7).

- [x] Task 1: Define Testnet URL Constants âœ… COMPLETE
  - [x] Created `packages/connector/src/test/testnet-config.ts` with:
    - `TESTNET_URLS` constants for Aptos, XRP, and Base Sepolia
    - `LOCAL_URLS` constants for Docker container endpoints
    - `NetworkMode` type (`'testnet' | 'local'`)

- [x] Task 2: Update TestConfig Interface âœ… COMPLETE
  - [x] Added `networkMode: NetworkMode` to TestConfig in docker-agent-test-runner.ts (line 58)
  - [x] `parseNetworkMode()` function parses `NETWORK_MODE` environment variable

- [x] Task 3: Create Network Mode URL Resolution âœ… COMPLETE
  - [x] `getChainUrls(networkMode, isDocker)` function implemented in testnet-config.ts
  - [x] Returns testnet URLs when `networkMode === 'testnet'`
  - [x] Returns local Docker URLs when `networkMode === 'local'`
  - [x] Supports environment variable overrides for all URLs

- [x] Task 4: Update Faucet Functions for Testnet Mode âœ… COMPLETE
  - [x] Fixed `configureAgentsAptos()` to use `this.config.aptosNodeUrl` instead of hardcoded `'http://aptos-local:8080'`
  - [x] Modified `fundXRPAccounts()` to use testnet faucet via `fundXRPAccountsViaTestnetFaucet()` when `networkMode === 'testnet'`
  - [x] Added `httpsPost()` utility function for HTTPS testnet faucet API calls
  - [x] Note: `aptosFaucetFund()` already uses `this.config.aptosFaucetUrl` correctly

- [x] Task 5: Add Testnet Timeout Configuration âœ… COMPLETE
  - [x] `TIMEOUTS` constant in testnet-config.ts with local and testnet profiles
  - [x] `getTimeouts(networkMode)` function returns appropriate timeout values
  - [x] TestConfig includes `timeouts` object populated from `getTimeouts()`

- [x] Task 6: Add Unit Tests for Network Mode Configuration âœ… COMPLETE
  - [x] Created test file: `packages/connector/src/test/testnet-config.test.ts`
  - [x] Test `parseNetworkMode()`: 8 tests covering default, local, testnet, case insensitivity, invalid values
  - [x] Test `getChainUrls()` for testnet mode returns correct URLs (5 tests)
  - [x] Test `getChainUrls()` for local mode - Docker and host context (5 tests)
  - [x] Test environment variable overrides take precedence (6 tests)
  - [x] Test `getTimeouts()` returns correct values for each mode (3 tests)
  - [x] Test TESTNET_URLS and LOCAL_URLS constants (6 tests)
  - [x] Total: 28 tests passing

- [x] Task 7: Update Documentation âœ… COMPLETE
  - [x] Added NETWORK_MODE section to `docs/guides/local-blockchain-development.md`
  - [x] Documented all environment variables with defaults and examples
  - [x] Added usage examples for running tests in testnet mode
  - [x] Documented timeout adjustments and faucet rate limits
  - [x] Added ARM64 development workflow example

## Dev Notes

### Story Context

This is Story 14.3 (revised) in Epic 14: Public Testnet Integration. The original 28.3 focused on building multi-arch Docker images; this replacement adds public testnet configuration support.

**Epic 14 Context:**

- **Story 14.1** (Done): Add Agent Server Aptos HTTP Endpoints
- **Story 14.2** (Done): Add Test Runner Aptos Phases
- **Story 14.3 (this story)**: Add Public Testnet Configuration
- **Story 14.4**: Update Test Infrastructure for Testnets
- **Story 14.5**: Production Connector Aptos Settlement

### Current Implementation State

**âœ… Already Implemented (do not re-implement):**

- `packages/connector/src/test/testnet-config.ts` exists with:
  - `TESTNET_URLS` and `LOCAL_URLS` constants
  - `NetworkMode` type, `ChainUrls` interface
  - `parseNetworkMode()`, `getChainUrls()`, `getTimeouts()` functions
- `docker-agent-test-runner.ts` imports and uses testnet-config.ts
- `TestConfig` interface includes `networkMode` field
- Configuration logging shows network mode and URLs at test startup

**ðŸ”§ Remaining Work:**

1. **Fix hardcoded URL** in `configureAgentsAptos()` at line 1208:
   - Change `'http://aptos-local:8080'` to `this.config.aptosNodeUrl`
2. **Add testnet faucet logic** to `fundXRPAccounts()`:
   - When `networkMode === 'testnet'`, use XRP testnet faucet API instead of genesis account
3. **Create unit tests** for testnet-config.ts
4. **Update documentation** with NETWORK_MODE usage

### Public Testnet URLs

| Chain        | Node URL                                    | Faucet URL                             |
| ------------ | ------------------------------------------- | -------------------------------------- |
| Aptos        | `https://fullnode.testnet.aptoslabs.com/v1` | `https://faucet.testnet.aptoslabs.com` |
| XRP          | `wss://s.altnet.rippletest.net:51233`       | `https://faucet.altnet.rippletest.net` |
| Base Sepolia | `https://sepolia.base.org`                  | N/A (use external faucets)             |

### Faucet API Differences

**Aptos Testnet Faucet:**

```bash
POST https://faucet.testnet.aptoslabs.com/mint
Content-Type: application/json
{ "address": "0x...", "amount": 100000000 }
```

**XRP Testnet Faucet:**

```bash
POST https://faucet.altnet.rippletest.net/accounts
Content-Type: application/json
{ "destination": "rXXXX..." }
```

**Base Sepolia:**

- No programmatic faucet; use pre-funded accounts or external faucets

### Technical Constraints

- Testnet faucets have rate limits (typically 1 request per minute per IP)
- Testnet transactions take longer to confirm (5-30 seconds vs instant locally)
- Testnet state persists between test runs (may need cleanup logic)

### File Locations

**Files Already Created:**

- `packages/connector/src/test/testnet-config.ts` - âœ… Testnet URL constants and configuration (complete)

**Files to Create:**

- `packages/connector/src/test/testnet-config.test.ts` - Unit tests for network mode configuration

**Files to Modify:**

- `packages/connector/src/test/docker-agent-test-runner.ts` - Fix hardcoded URL in `configureAgentsAptos()` (line 1208), add testnet faucet logic to `fundXRPAccounts()`
- `docs/guides/local-blockchain-development.md` - Add NETWORK_MODE documentation section

### Testing

**Test File Location:** `packages/connector/src/test/testnet-config.test.ts`

**Testing Framework:** Jest 29.7.x (per tech-stack.md)

**Testing Standards:**

- Co-located tests (`*.test.ts` alongside source file) per coding-standards.md
- Use Jest's `beforeEach`/`afterEach` to mock and restore `process.env`
- Test both success and edge cases (invalid environment values)

**Required Test Cases:**

1. `parseNetworkMode()` - Verify default to 'local', accept 'testnet', handle invalid values
2. `getChainUrls()` - Verify correct URLs for testnet vs local mode
3. `getChainUrls()` - Verify Docker vs host context URL differences for local mode
4. `getChainUrls()` - Verify environment variable overrides take precedence
5. `getTimeouts()` - Verify correct timeout values for each mode

**Example Test Structure:**

```typescript
describe('testnet-config', () => {
  const originalEnv = process.env;

  beforeEach(() => {
    jest.resetModules();
    process.env = { ...originalEnv };
  });

  afterEach(() => {
    process.env = originalEnv;
  });

  describe('parseNetworkMode', () => {
    it('returns local when NETWORK_MODE not set', () => {
      delete process.env.NETWORK_MODE;
      expect(parseNetworkMode()).toBe('local');
    });
    // ... more tests
  });
});
```

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### File List

| File                                                      | Action   | Description                                                                                                                          |
| --------------------------------------------------------- | -------- | ------------------------------------------------------------------------------------------------------------------------------------ |
| `packages/connector/src/test/docker-agent-test-runner.ts` | Modified | Fixed hardcoded Aptos URL in `configureAgentsAptos()`, added `httpsPost()` utility, added `fundXRPAccountsViaTestnetFaucet()` method |
| `packages/connector/src/test/testnet-config.ts`           | Modified | Added `TimeoutConfig` type export                                                                                                    |
| `packages/connector/src/test/testnet-config.test.ts`      | Created  | 28 unit tests for network mode configuration                                                                                         |
| `docs/guides/local-blockchain-development.md`             | Modified | Added Network Mode Configuration section with environment variables, usage examples, and ARM64 workflow                              |

### Completion Notes

- All 7 tasks completed successfully
- 28 unit tests passing for testnet-config module
- Type checking passes with no errors
- Linting passes with only pre-existing warnings (unrelated to this story)
- `configureAgentsAptos()` now uses `this.config.aptosNodeUrl` instead of hardcoded Docker hostname
- `fundXRPAccounts()` now supports both local (genesis account) and testnet (faucet API) modes
- Added comprehensive documentation for `NETWORK_MODE` environment variable
- Environment variable overrides work for all chain URLs

### Debug Log References

No blocking issues encountered during implementation.

## QA Results

### Review Date: 2026-01-31

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Excellent** - Clean, well-structured implementation following project standards. The testnet-config module is properly separated with clear responsibilities. Test coverage is comprehensive with 28 passing unit tests.

**Highlights:**

- Clean separation of URL configuration logic from test runner
- Proper environment variable override support for all chain URLs
- Appropriate timeout configuration differentiation between local and testnet modes
- TypeScript interfaces properly defined (`ChainUrls`, `TimeoutConfig`, `NetworkMode`)

### Refactoring Performed

None required - code quality is already high.

### Compliance Check

- Coding Standards: âœ“ TypeScript strict mode, proper naming conventions (UPPER_SNAKE_CASE for constants, camelCase for functions), no console.log in production code
- Project Structure: âœ“ Co-located tests (`testnet-config.test.ts` alongside `testnet-config.ts`)
- Testing Strategy: âœ“ Comprehensive unit tests covering all functions and edge cases
- All ACs Met: âœ“ All 6 acceptance criteria fully implemented and verified

### Improvements Checklist

All items already addressed by developer:

- [x] NETWORK_MODE environment variable supports testnet/local values (AC1)
- [x] Testnet mode connects to public testnet URLs for all chains (AC2)
- [x] Local mode connects to Docker containers (AC3)
- [x] Environment variable overrides for all URLs (AC4)
- [x] Testnet faucet API integration for XRP (AC5)
- [x] Documentation updated with NETWORK_MODE section (AC6)
- [x] Fixed hardcoded Aptos URL in configureAgentsAptos()
- [x] Added httpsPost utility for HTTPS faucet calls
- [x] Comprehensive unit test coverage (28 tests)

### Security Review

**Status: PASS**

- No hardcoded secrets or credentials
- Testnet faucet URLs are properly configurable
- No sensitive data exposed in logs

### Performance Considerations

**Status: PASS**

- Appropriate timeout differentiation (5s local vs 30s testnet for faucet calls)
- Configuration parsing happens once at startup, not per-request
- httpsPost function includes configurable timeout

### Files Modified During Review

None - no refactoring needed.

### Gate Status

Gate: PASS â†’ docs/qa/gates/28.3-add-public-testnet-configuration.yml

### Recommended Status

âœ“ Ready for Done

All acceptance criteria verified. Tests pass (28/28). Type checking and linting pass. Documentation complete.

## Change Log

| Date       | Version | Description                                                                                | Author        |
| ---------- | ------- | ------------------------------------------------------------------------------------------ | ------------- |
| 2026-01-31 | 1.2     | Implementation complete: Tasks 4, 6, 7 finished, 28 unit tests passing                     | Dev Agent     |
| 2026-01-31 | 1.1     | Validation update: marked completed tasks, added Testing section, specified file locations | QA Validation |
| 2026-01-31 | 1.0     | New story replacing deprecated multi-arch Docker image story                               | Product Owner |
