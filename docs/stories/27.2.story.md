# Story 27.2: Consolidate Redundant Test Files

## Status

Done

## Story

**As a** developer,
**I want** redundant test files removed and overlapping tests consolidated,
**so that** the test suite is leaner, faster, and easier to maintain without losing coverage.

## Acceptance Criteria

1. `src/lib.test.ts` deleted — "main is NOT exported" test moved to `consumer-types.test.ts`
2. `src/index.test.ts` deleted — all 6 export checks already covered by `consumer-types.test.ts`
3. `connector-node-minimal.test.ts` renamed to `connector-node-optional-deps.test.ts`
4. 5 overlapping constructor/start/stop tests removed from renamed file (constructor: 2, start-minimal: 3)
5. 8 unique optional-dependency error tests retained (settlement: 2, express: 2, tigerbeetle: 2, requireOptional: 2)
6. All retained tests pass
7. No coverage regression in meaningful code paths

## Tasks / Subtasks

- [x] Task 1: Migrate "main not exported" test from lib.test.ts to consumer-types.test.ts (AC: 1)
  - [x] 1.1 Add test `it('should NOT export main', ...)` to `consumer-types.test.ts` in the "value exports" describe block
  - [x] 1.2 Verify the test checks that `'main' in lib` is false
  - [x] 1.3 Run `consumer-types.test.ts` to verify the new test passes

- [x] Task 2: Delete redundant test files (AC: 1, 2)
  - [x] 2.1 Delete `packages/connector/src/lib.test.ts` (9 tests, all redundant)
  - [x] 2.2 Delete `packages/connector/src/index.test.ts` (6 tests, all redundant)
  - [x] 2.3 Verify deletions with `ls` — files should no longer exist

- [x] Task 3: Rename connector-node-minimal.test.ts (AC: 3)
  - [x] 3.1 Rename `packages/connector/src/core/connector-node-minimal.test.ts` to `packages/connector/src/core/connector-node-optional-deps.test.ts`
  - [x] 3.2 Update any internal file references or documentation if needed

- [x] Task 4: Remove overlapping tests from renamed file (AC: 4)
  - [x] 4.1 Remove `describe('constructor', ...)` block (2 tests: "should instantiate with minimal config without throwing", "should instantiate with zero peers and zero routes")
  - [x] 4.2 Remove overlapping tests from `describe('start() — minimal config', ...)`:
    - [x] 4.2.1 Remove "should start successfully with only BTP server and routing" test
    - [x] 4.2.2 Remove "should reach healthy status after minimal start" test
    - [x] 4.2.3 Remove "should start and stop cleanly" test
  - [x] 4.3 Keep the 8 unique optional-dependency error tests:
    - [x] 4.3.1 Keep `describe('settlement error messages', ...)` (2 tests)
    - [x] 4.3.2 Keep `describe('express error messages', ...)` (2 tests)
    - [x] 4.3.3 Keep `describe('tigerbeetle error messages', ...)` (2 tests)
    - [x] 4.3.4 Keep `describe('requireOptional helper', ...)` (2 tests)

- [x] Task 5: Verify test suite passes (AC: 6)
  - [x] 5.1 Run `npm test --workspace=@agent-runtime/connector` — all tests must pass
  - [x] 5.2 Specifically verify `connector-node-optional-deps.test.ts` passes
  - [x] 5.3 Run `npm test --workspace=@agent-runtime/shared` — shared package unaffected

- [x] Task 6: Verify no coverage regression (AC: 7)
  - [x] 6.1 Run `npm test --workspace=@agent-runtime/connector -- --coverage` if available
  - [x] 6.2 Verify line coverage remains >80% for connector package
  - [x] 6.3 Confirm deleted tests were strict subsets of retained tests (no unique coverage lost)

## Dev Notes

### Epic Context

This is the second story in Epic 27 (Test Suite & Pre-Push Hook Optimization). The epic reduces pre-push hook execution from 13+ minutes to <30 seconds. Story 27.1 redesigned the pre-push hook; this story consolidates redundant test files introduced in Epics 24-26.

Epic 27 addresses pain introduced by Epics 24-26 which added test files that are now being consolidated.

[Source: docs/prd/epic-27-test-optimization.md]

### Previous Story Insights (Story 27.1)

- Pre-push hook optimized to run in <30 seconds (was 13+ minutes)
- Hook now excludes integration/performance/acceptance tests via `--testPathIgnorePatterns`
- Test pyramid established: pre-commit (lint/format), pre-push (unit tests), CI (full suite), nightly (performance)
- No new test infrastructure needed — this story is pure consolidation

[Source: docs/stories/27.1.story.md]

### Test File Overlap Analysis

**`lib.test.ts` — FULLY REDUNDANT (9 tests):**

| Test                                    | Coverage in consumer-types.test.ts          |
| --------------------------------------- | ------------------------------------------- |
| should export ConnectorNode             | ✓ Line 55-56                                |
| should export createLogger              | ✓ Line 69                                   |
| should export ConfigLoader              | ✓ Line 56-57                                |
| should export BTPClientManager          | ✓ Line 63-64                                |
| should export AdminServer               | ✓ Line 65-66                                |
| should export AccountManager            | ✓ Line 66-67                                |
| should export SettlementMonitor         | ✓ Line 67-68                                |
| should export UnifiedSettlementExecutor | ✓ Line 68-69                                |
| should NOT export main                  | ⚠ Needs migration to consumer-types.test.ts |

[Source: packages/connector/src/lib.test.ts, packages/connector/src/consumer-types.test.ts]

**`index.test.ts` — FULLY REDUNDANT (6 tests):**

| Test                                | Coverage in consumer-types.test.ts |
| ----------------------------------- | ---------------------------------- |
| should export ConnectorNode class   | ✓ Line 55-56                       |
| should export RoutingTable class    | ✓ Line 58-59                       |
| should export PacketHandler class   | ✓ Line 59-60                       |
| should export BTPServer class       | ✓ Line 60-61                       |
| should export BTPClient class       | ✓ Line 61-62                       |
| should export createLogger function | ✓ Line 69                          |

All 6 tests are strict subsets of consumer-types.test.ts.
[Source: packages/connector/src/index.test.ts, packages/connector/src/consumer-types.test.ts]

**`connector-node-minimal.test.ts` — PARTIALLY REDUNDANT (13 tests):**

| Test                                            | Status    | Rationale                                      |
| ----------------------------------------------- | --------- | ---------------------------------------------- |
| constructor: instantiate with minimal config    | ❌ Remove | Covered by connector-node.test.ts              |
| constructor: instantiate with zero peers/routes | ❌ Remove | Covered by connector-node.test.ts              |
| start: start with BTP server and routing        | ❌ Remove | Covered by connector-node.test.ts              |
| start: reach healthy status                     | ❌ Remove | Covered by connector-node.test.ts              |
| start: start and stop cleanly                   | ❌ Remove | Covered by connector-node.test.ts              |
| settlement: clear error when ethers missing     | ✅ Keep   | Unique: tests graceful degradation             |
| settlement: error message format                | ✅ Keep   | Unique: verifies error message content         |
| express: clear error when express missing       | ✅ Keep   | Unique: tests AdminServer graceful degradation |
| express: error message format                   | ✅ Keep   | Unique: verifies error message content         |
| tigerbeetle: clear error when TB missing        | ✅ Keep   | Unique: tests TB graceful degradation          |
| tigerbeetle: error message format               | ✅ Keep   | Unique: verifies error message content         |
| requireOptional: throw error for missing pkg    | ✅ Keep   | Unique: tests helper directly                  |
| requireOptional: resolve for installed pkg      | ✅ Keep   | Unique: tests helper directly                  |

[Source: packages/connector/src/core/connector-node-minimal.test.ts]

### Tech Stack

- **Testing Framework:** Jest 29.7.x with ts-jest preset [Source: docs/architecture/tech-stack.md]
- **File Convention:** Co-located `<filename>.test.ts` next to source [Source: docs/architecture/coding-standards.md]
- **Pattern:** AAA (Arrange, Act, Assert) with descriptive test names [Source: docs/architecture/test-strategy-and-standards.md]

### Source Tree (Relevant Files)

```
packages/connector/src/
├── lib.test.ts                    # DELETE — 9 redundant tests
├── index.test.ts                  # DELETE — 6 redundant tests
├── consumer-types.test.ts         # MODIFY — add "main not exported" test
└── core/
    ├── connector-node-minimal.test.ts     # RENAME → connector-node-optional-deps.test.ts
    ├── connector-node-optional-deps.test.ts # MODIFIED — remove 5 overlapping tests
    └── connector-node.test.ts     # UNCHANGED — existing comprehensive tests
```

[Source: docs/architecture/source-tree.md]

### Testing

- **Framework:** Jest 29.7.x with TypeScript support (`ts-jest`) [Source: docs/architecture/test-strategy-and-standards.md]
- **File Convention:** `<filename>.test.ts` co-located with source
- **Key Commands:**
  - `npm test --workspace=@agent-runtime/connector` — all connector tests
  - `npm test -- connector-node-optional-deps.test.ts` — specific test file
  - `npm test -- --coverage` — coverage report

### Coding Standards

- **File naming:** kebab-case (`connector-node-optional-deps.test.ts`) [Source: docs/architecture/coding-standards.md]
- **Test naming:** Descriptive, should-style (`should NOT export main`)
- **No `any` types:** Except in test mocks [Source: docs/architecture/coding-standards.md]

### Project Structure Notes

No structural conflicts. Changes are:

1. **Deletions:** Two redundant test files removed
2. **Rename:** One test file renamed for clarity (minimal → optional-deps)
3. **Modification:** One test added to consumer-types.test.ts, 5 tests removed from renamed file

All changes are within `packages/connector/src/` and follow existing conventions.

## Change Log

| Date       | Version | Description            | Author      |
| ---------- | ------- | ---------------------- | ----------- |
| 2026-02-12 | 1.0     | Initial story creation | BMad Master |
| 2026-02-12 | 1.1     | Story implementation   | dev (James) |

## Dev Agent Record

### Agent Model Used

kimi-k2.5-free (opencode)

### Debug Log References

N/A — no issues encountered during implementation

### Completion Notes

All tasks completed successfully:

1. **Migrated "main not exported" test** — Added to `consumer-types.test.ts` with proper import of `* as lib` from './lib'
2. **Deleted redundant test files** — Removed `lib.test.ts` (9 tests) and `index.test.ts` (6 tests), all confirmed to be strict subsets of `consumer-types.test.ts`
3. **Renamed test file** — `connector-node-minimal.test.ts` → `connector-node-optional-deps.test.ts` for clarity
4. **Removed 5 overlapping tests** — Deleted constructor (2 tests) and start-minimal (3 tests) describe blocks, retained 8 unique optional-dependency error tests
5. **All tests pass** — Verified `consumer-types.test.ts` (11 tests), `connector-node-optional-deps.test.ts` (8 tests), and shared package (170 tests) all pass
6. **No coverage regression** — `lib.ts` maintains 100% coverage, `optional-require.ts` at 90% coverage; deleted tests were strict subsets of retained tests

**Test count reduction:** 15 redundant tests removed (9 + 6), 5 overlapping tests removed, net reduction of 20 tests while maintaining equivalent coverage.

### File List

**Files deleted:**

- `packages/connector/src/lib.test.ts` (9 redundant tests)
- `packages/connector/src/index.test.ts` (6 redundant tests)

**Files renamed:**

- `packages/connector/src/core/connector-node-minimal.test.ts` → `packages/connector/src/core/connector-node-optional-deps.test.ts`

**Files modified:**

- `packages/connector/src/consumer-types.test.ts` — added "should NOT export main" test (lines 72-74)
- `packages/connector/src/core/connector-node-optional-deps.test.ts` — removed constructor and start-minimal describe blocks (59 lines removed)

## QA Results

### Review Date: 2026-02-12

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Excellent implementation.** The test consolidation was executed precisely according to the specification. All redundant test files were identified correctly through thorough overlap analysis, and the retained tests provide equivalent coverage. The renaming from `connector-node-minimal.test.ts` to `connector-node-optional-deps.test.ts` better reflects the file's actual purpose (testing optional dependency error handling).

Key observations:

- **Migration accuracy**: The "main not exported" test was correctly added to `consumer-types.test.ts` using proper `* as lib` import pattern
- **Deletion completeness**: Both `lib.test.ts` and `index.test.ts` were fully redundant (strict subsets of existing coverage)
- **Retention correctness**: All 8 unique optional-dependency tests preserved exactly as specified
- **Naming clarity**: New filename accurately describes the test focus (optional deps, not minimal config)

### Refactoring Performed

No refactoring required. The implementation was clean and followed all established patterns.

### Compliance Check

- **Coding Standards**: ✓ File naming uses kebab-case, test names are descriptive with "should" style, proper AAA pattern followed
- **Project Structure**: ✓ Test files co-located with source, follows `<filename>.test.ts` convention
- **Testing Strategy**: ✓ Unit tests at appropriate level, mocks properly isolated, no `any` types in production code
- **All ACs Met**: ✓ All 7 acceptance criteria fully satisfied

### Requirements Traceability

| AC  | Description                                            | Validating Test(s)                                                | Status |
| --- | ------------------------------------------------------ | ----------------------------------------------------------------- | ------ |
| 1   | `lib.test.ts` deleted, "main not exported" test moved  | `consumer-types.test.ts` lines 74-76                              | ✓ PASS |
| 2   | `index.test.ts` deleted (6 tests redundant)            | Files verified deleted                                            | ✓ PASS |
| 3   | File renamed to `connector-node-optional-deps.test.ts` | File exists at new path                                           | ✓ PASS |
| 4   | 5 overlapping tests removed                            | Constructor (2) + start-minimal (3) removed                       | ✓ PASS |
| 5   | 8 unique optional-dependency tests retained            | Settlement (2), Express (2), TigerBeetle (2), requireOptional (2) | ✓ PASS |
| 6   | All retained tests pass                                | 19 tests passing (11 + 8)                                         | ✓ PASS |
| 7   | No coverage regression                                 | `lib.ts`: 100%, `optional-require.ts`: 90%                        | ✓ PASS |

### Improvements Checklist

- [x] All acceptance criteria verified
- [x] Test execution confirmed passing
- [x] Coverage regression check completed
- [x] File deletions verified
- [x] File rename verified
- [x] Test migration verified

### Security Review

No security concerns. This story only consolidates test files; no production code changes.

### Performance Considerations

**Positive impact**: Test suite execution time reduced by removing 20 redundant/overlapping tests. No runtime performance impact.

### Files Modified During Review

None. All changes were correctly implemented by the developer.

### Gate Status

Gate: **PASS** → docs/qa/gates/27.2-consolidate-redundant-test-files.yml

### Recommended Status

✓ Ready for Done
