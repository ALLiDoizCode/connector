# Story 27.3: Fix Failing Tests & Jest Configuration

## Status

Done

## Story

**As a** developer,
**I want** the 6 currently-failing test suites fixed and Jest configuration updated,
**so that** `npm test` completes with 0 failures and performance/acceptance tests run in isolation via dedicated configuration.

## Acceptance Criteria

1. `jest.performance.config.js` created with `testMatch` for `test/performance/**` and `*.perf.test.*`
2. `test:performance` script added to `packages/connector/package.json`
3. Default `jest.config.js` `testPathIgnorePatterns` updated to exclude: `test/performance/`, `test/acceptance/`, `wallet-derivation`, `xrp-channel-manager`, `xrp-channel-lifecycle`
4. 6 previously-failing test suites either: (a) pass with relaxed thresholds, or (b) excluded from default run and pass via `test:performance`
5. `npm test` at root level completes with 0 failures
6. Performance tests still runnable via `npm run test:performance --workspace=packages/connector`
7. Test distribution documented in project README or CONTRIBUTING.md

## Tasks / Subtasks

- [x] Task 1: Create jest.performance.config.js (AC: 1)
  - [x] 1.1 Create new config file extending base jest.config.js
  - [x] 1.2 Add testMatch pattern for `test/performance/**`
  - [x] 1.3 Add testMatch pattern for `*.perf.test.*`
  - [x] 1.4 Configure longer testTimeout (300s) for performance benchmarks
  - [x] 1.5 Set appropriate coverage thresholds or disable coverage for perf tests

- [x] Task 2: Add test:performance script to package.json (AC: 2)
  - [x] 2.1 Add `"test:performance": "jest --config jest.performance.config.js"` to scripts section
  - [x] 2.2 Verify script runs without errors

- [x] Task 3: Update default jest.config.js exclusions (AC: 3)
  - [x] 3.1 Add `test/performance/` to testPathIgnorePatterns
  - [x] 3.2 Add `test/acceptance/` to testPathIgnorePatterns
  - [x] 3.3 Add `wallet-derivation` to testPathIgnorePatterns
  - [x] 3.4 Add `xrp-channel-manager` to testPathIgnorePatterns
  - [x] 3.5 Add `xrp-channel-lifecycle` to testPathIgnorePatterns

- [x] Task 4: Fix or exclude failing test suites (AC: 4)
  - [x] 4.1 Exclude throughput-benchmark.test.ts from default run via jest.config.js (runs via test:performance)
  - [x] 4.2 Exclude latency-benchmark.test.ts from default run via jest.config.js (runs via test:performance)
  - [x] 4.3 Exclude cpu-profile.test.ts from default run via jest.config.js
  - [x] 4.4 Exclude memory-profile.test.ts from default run via jest.config.js
  - [x] 4.5 Exclude test/unit/performance/profiler.test.ts (timing-sensitive)
  - [x] 4.6 Verify wallet-derivation.test.ts is properly excluded (587s runtime, already has skipInCI check)
  - [x] 4.7 Verify xrp-channel tests are properly excluded (require rippled, already have skipInCI check)

- [x] Task 5: Verify npm test passes (AC: 5)
  - [x] 5.1 Run `npm test` at root level
  - [x] 5.2 Verify 0 test failures (113 passed, 23 skipped, 0 failed)
  - [x] 5.3 Document any remaining issues (none)

- [x] Task 6: Verify performance test script works (AC: 6)
  - [x] 6.1 Run `npm run test:performance --workspace=@agent-runtime/connector`
  - [x] 6.2 Verify performance tests execute (6 passed, 56 tests total)
  - [x] 6.3 Document any test failures that need future fixes (none)

- [x] Task 7: Document test distribution (AC: 7)
  - [x] 7.1 Add test distribution section to CONTRIBUTING.md
  - [x] 7.2 Document: pre-commit (lint+format), pre-push (unit tests), CI (full suite), nightly (performance)
  - [x] 7.3 Include commands for running each test category

## Dev Notes

### Quick Reference

| Aspect                       | Details                                                                 |
| ---------------------------- | ----------------------------------------------------------------------- |
| **Files to Create**          | 1 (`jest.performance.config.js`)                                        |
| **Files to Modify**          | 3 (`jest.config.js`, `package.json`, `README.md` or `CONTRIBUTING.md`)  |
| **Estimated Effort**         | ~1 hour                                                                 |
| **Test Categories Affected** | Performance (4 files), Acceptance (7 files), Integration (3 slow files) |
| **Key Configuration**        | `testPathIgnorePatterns` exclusions, `testMatch` for performance config |

### Epic Context

This is the third and final story in Epic 27 (Test Suite & Pre-Push Hook Optimization). The epic reduces pre-push hook execution from 13+ minutes to <30 seconds. Story 27.1 redesigned the pre-push hook; Story 27.2 consolidated redundant test files; this story fixes the 6 failing test suites by either relaxing performance thresholds or moving them to dedicated performance configuration.

[Source: docs/prd/epic-27-test-optimization.md]

### Previous Story Insights (Story 27.2)

- 20 redundant/overlapping tests removed (15 from deleted files + 5 from renamed file)
- `lib.test.ts` and `index.test.ts` fully redundant - deleted
- `connector-node-minimal.test.ts` renamed to `connector-node-optional-deps.test.ts`
- All remaining tests pass, no coverage regression
- Test consolidation revealed the 6 failing test suites that this story addresses

[Source: docs/stories/27.2.story.md]

### Failing Test Suites Analysis

Based on the Epic requirements and existing test files, the 6 failing test suites are:

| Test Suite           | Location                                      | Issue                                                | Resolution                                                                      |
| -------------------- | --------------------------------------------- | ---------------------------------------------------- | ------------------------------------------------------------------------------- |
| Throughput Benchmark | test/performance/throughput-benchmark.test.ts | TPS thresholds too strict for concurrent execution   | Exclude from default run via jest.config.js, run via jest.performance.config.js |
| Latency Benchmark    | test/performance/latency-benchmark.test.ts    | p99/p999 latency thresholds fail under load          | Exclude from default run via jest.config.js, run via jest.performance.config.js |
| CPU Profile          | test/performance/cpu-profile.test.ts          | Performance thresholds                               | Exclude from default run via jest.config.js                                     |
| Memory Profile       | test/performance/memory-profile.test.ts       | Performance thresholds                               | Exclude from default run via jest.config.js                                     |
| Wallet Derivation    | test/integration/wallet-derivation.test.ts    | Resource-intensive (1000+ derivations), 587s runtime | Already has skipInCI check, ensure excluded in testPathIgnorePatterns           |
| XRP Channel Manager  | test/integration/xrp-channel-manager.test.ts  | Requires rippled, unstable in CI                     | Already has skipInCI check, ensure excluded in testPathIgnorePatterns           |

[Source: docs/prd/epic-27-test-optimization.md lines 105-117]

### Test Files Requiring Exclusion

**Performance Tests (4 files):**

```
packages/connector/test/performance/
├── memory-profile.test.ts
├── throughput-benchmark.test.ts
├── cpu-profile.test.ts
└── latency-benchmark.test.ts
```

**Acceptance Tests (7 files):**

```
packages/connector/test/acceptance/
├── multi-chain-settlement-acceptance.test.ts
├── security-penetration-acceptance.test.ts
├── production-acceptance.test.ts
├── performance-benchmark-acceptance.test.ts
├── load-test-24h.test.ts
├── documentation-audit-acceptance.test.ts
└── disaster-recovery-acceptance.test.ts
```

**Integration Tests to Exclude (3 files):**

```
packages/connector/test/integration/
├── wallet-derivation.test.ts      # 587s runtime, 1000+ wallet derivations
├── xrp-channel-manager.test.ts    # Requires rippled, unstable in CI
└── xrp-channel-lifecycle.test.ts  # Requires rippled, unstable in CI
```

[Source: packages/connector/test/ directory structure]

### Current Jest Configuration

The existing `jest.config.js` already has some exclusions:

```javascript
testPathIgnorePatterns: [
  '/node_modules/',
  'aws-kms-backend\.test\.ts$',
  'azure-kv-backend\.test\.ts$',
  'gcp-kms-backend\.test\.ts$',
  'wallet-disaster-recovery\.test\.ts$',
  'connector-aptos-settlement\.test\.ts$',
  'production-acceptance\.test\.ts$',
  'agent-wallet-integration\.doc\.test\.ts$',
  'tri-chain-settlement\.test\.ts$',
  'aptos-local-testnet\.test\.ts$',
  'tigerbeetle-5peer-deployment\.test\.ts$',
],
```

### New testPathIgnorePatterns to Add

Add these patterns to the existing array in `jest.config.js`:

```javascript
// Performance and acceptance test directories
testPathIgnorePatterns: [
  // ... existing patterns ...
  'test/performance/',           // Exclude all performance benchmarks
  'test/acceptance/',            // Exclude all acceptance tests
  'wallet-derivation',           // Exclude 587s wallet derivation test
  'xrp-channel-manager',         // Exclude XRP channel manager (requires rippled)
  'xrp-channel-lifecycle',       // Exclude XRP channel lifecycle (requires rippled)
],
```

**Note**: The regex patterns should match the existing format in the config file (using `\.test\.ts$` suffix or directory prefixes as appropriate).

[Source: packages/connector/jest.config.js lines 10-22]

### Tech Stack

- **Testing Framework:** Jest 29.7.x with ts-jest preset [Source: docs/architecture/tech-stack.md]
- **File Convention:** Co-located `<filename>.test.ts` next to source [Source: docs/architecture/coding-standards.md]
- **Performance Tests:** Located in `test/performance/` directory
- **Acceptance Tests:** Located in `test/acceptance/` directory
- **Integration Tests:** Located in `test/integration/` directory

### Testing Strategy

From the Test Strategy document:

**Test Pyramid:**

- 70% Unit Tests (fast, isolated, comprehensive)
- 20% Integration Tests (multi-component, Docker-based)
- 10% E2E Tests (full system validation)

**Performance Test Configuration:**

- Should have longer timeouts (300s vs 30s default)
- Should run in isolation from unit tests
- Can use `PERFORMANCE_TEST_FULL=true` env var for extended benchmarks

**Current Test Distribution:**

- Pre-commit: lint-staged (ESLint + Prettier on staged files)
- Pre-push: Unit tests via `--findRelatedTests` (after Story 27.1)
- CI: Full unit + integration suite
- Nightly: Performance + acceptance + load tests

[Source: docs/architecture/test-strategy-and-standards.md lines 1-195]

### Source Tree (Relevant Files)

```
packages/connector/
├── jest.config.js                    # MODIFY - add exclusions
├── jest.performance.config.js        # CREATE - new performance config
├── package.json                      # MODIFY - add test:performance script
├── src/                              # Unit tests (co-located)
├── test/
│   ├── performance/                  # EXCLUDE from default run
│   │   ├── memory-profile.test.ts
│   │   ├── throughput-benchmark.test.ts
│   │   ├── cpu-profile.test.ts
│   │   └── latency-benchmark.test.ts
│   ├── acceptance/                   # EXCLUDE from default run
│   │   └── *.acceptance.test.ts
│   └── integration/                  # SELECTIVE EXCLUSION
│       ├── wallet-derivation.test.ts # EXCLUDE - 587s runtime
│       ├── xrp-channel-manager.test.ts # EXCLUDE - requires rippled
│       └── xrp-channel-lifecycle.test.ts # EXCLUDE - requires rippled
```

[Source: docs/architecture/source-tree.md]

### Jest Performance Config Template

The new `jest.performance.config.js` should:

1. Extend base configuration from `jest.config.js`
2. Override `testMatch` to only include performance tests
3. Set longer `testTimeout` (300000ms = 5 minutes)
4. Disable coverage (not meaningful for performance tests)
5. Reduce workers to minimize interference

Example structure:

```javascript
const baseConfig = require('./jest.config.js');

module.exports = {
  ...baseConfig,
  displayName: 'connector-performance',
  testMatch: ['<rootDir>/test/performance/**/*.test.ts', '<rootDir>/src/**/*.perf.test.ts'],
  testTimeout: 300000, // 5 minutes for performance benchmarks
  coveragePathIgnorePatterns: ['.*'], // Disable coverage for perf tests
  maxWorkers: 2, // Reduce interference between benchmarks
};
```

### Test Distribution Documentation

Add to README.md or CONTRIBUTING.md:

````markdown
## Test Distribution

| Stage        | Command                    | Scope                             |
| ------------ | -------------------------- | --------------------------------- |
| Pre-commit   | `lint-staged`              | Staged files only (lint + format) |
| Pre-push     | `.husky/pre-push`          | Unit tests for changed files      |
| CI (PR)      | `npm test`                 | All unit + integration tests      |
| CI (Nightly) | `npm run test:performance` | Performance benchmarks            |

### Running Tests

```bash
# Unit tests only (fast)
npm test -- --testPathIgnorePatterns='test/integration|test/acceptance'

# Integration tests (requires docker-compose-dev.yml)
npm run test:integration

# Performance tests (isolated)
npm run test:performance

# All tests
npm test
```
````

```

### Project Structure Notes

All changes are configuration-only:

1. **New file:** `jest.performance.config.js` - Performance test configuration
2. **Modified:** `jest.config.js` - Add testPathIgnorePatterns for perf/acceptance/slow tests
3. **Modified:** `package.json` - Add `test:performance` script
4. **Modified:** `README.md` or `CONTRIBUTING.md` - Document test distribution

No source code modifications required - this is pure test infrastructure configuration.

## Change Log

| Date       | Version | Description                              | Author      |
| ---------- | ------- | ---------------------------------------- | ----------- |
| 2026-02-12 | 1.2     | Status updated to Approved               | Sarah (PO)  |
| 2026-02-12 | 1.1     | Added Quick Reference and clarified Task 4 | Sarah (PO)  |
| 2026-02-12 | 1.0     | Initial story creation                   | Bob (SM)    |

## Dev Agent Record

### Agent Model Used

kimi-k2.5-free (opencode/kimi-k2.5-free)

### Debug Log References

N/A - No debug issues encountered

### Completion Notes

All acceptance criteria met:

1. **jest.performance.config.js created** - Extends base config with performance-specific settings:
   - testMatch for `test/performance/**` and `test/unit/performance/**`
   - 300s test timeout for benchmarks
   - Coverage disabled (not meaningful for perf tests)
   - maxWorkers: 2 to reduce interference
   - Overrides testPathIgnorePatterns to allow performance tests

2. **test:performance script added** - Added to packages/connector/package.json scripts

3. **jest.config.js updated** - Added exclusions for:
   - `test/performance/` (4 benchmark files)
   - `test/acceptance/` (7 acceptance test files)
   - `test/unit/performance/` (timing-sensitive profiler tests)
   - `wallet-derivation.test.ts` (587s runtime)
   - `xrp-channel-manager.test.ts` (requires rippled)
   - `xrp-channel-lifecycle.test.ts` (requires rippled)

4. **All 6 failing test suites addressed**:
   - throughput-benchmark.test.ts → runs via test:performance
   - latency-benchmark.test.ts → runs via test:performance
   - cpu-profile.test.ts → runs via test:performance
   - memory-profile.test.ts → runs via test:performance
   - profiler.test.ts → runs via test:performance (discovered during implementation)
   - wallet-derivation.test.ts → excluded (already had skipInCI)
   - xrp-channel tests → excluded (already had skipInCI)

5. **npm test passes** - 113 passed, 23 skipped, 0 failed

6. **test:performance works** - 6 test suites passed, 56 tests total

7. **Test distribution documented** - Added comprehensive section to CONTRIBUTING.md

### File List

**Created:**
- `packages/connector/jest.performance.config.js` - Performance test configuration

**Modified:**
- `packages/connector/jest.config.js` - Added testPathIgnorePatterns exclusions
- `packages/connector/package.json` - Added test:performance script
- `CONTRIBUTING.md` - Added Test Distribution documentation section

## QA Results

### Review Date: 2026-02-13

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment: Excellent** ✓

The implementation is clean, well-structured, and fully meets all acceptance criteria. This is a configuration-only change with no source code modifications, making it low-risk and highly maintainable. All test suites have been verified to pass, and the test distribution strategy is comprehensively documented.

**Key Strengths:**
- All 7 acceptance criteria verified and met through actual test execution
- Configuration changes follow Jest best practices
- Clear separation of concerns between default and performance test configurations
- Excellent documentation in CONTRIBUTING.md (Test Distribution section)
- Test claims verified: 113 test suites passed, 6 performance suites passed, 0 failures

### Refactoring Performed

**File**: `packages/connector/jest.performance.config.js`
- **Change**: Added documentation comment explaining testPathIgnorePatterns duplication
- **Why**: The `testPathIgnorePatterns` array is duplicated from the base config because Jest replaces (not merges) the entire array when overridden. Without this comment, future maintainers might be confused about why the patterns are repeated.
- **How**: Added a NOTE comment above the testPathIgnorePatterns array clarifying the replacement behavior and the need for duplication

### Compliance Check

- Coding Standards: ✓ N/A (configuration files only)
- Project Structure: ✓ All files in correct locations per source-tree.md
- Testing Strategy: ✓ Aligns perfectly with test distribution strategy
- All ACs Met: ✓ All 7 acceptance criteria verified through test execution

### Test Verification Results

**AC 5 Verification - Default Test Suite:**
```

Command: npm test
Result: Test Suites: 23 skipped, 113 passed, 113 of 136 total
Tests: 241 skipped, 2347 passed, 2588 total
Time: 43.596s
Status: ✓ PASS (0 failures)

```

**AC 6 Verification - Performance Test Suite:**
```

Command: npm run test:performance --workspace=packages/connector
Result: Test Suites: 6 passed, 6 total
Tests: 56 passed, 56 total
Time: 44.763s
Status: ✓ PASS (all performance tests execute successfully)

```

### Improvements Checklist

- [x] Added documentation comment to jest.performance.config.js explaining testPathIgnorePatterns duplication
- [x] Verified all acceptance criteria through actual test execution (not just code review)
- [x] Confirmed test distribution documentation is clear and comprehensive
- [ ] Future consideration: Extract common testPathIgnorePatterns to shared constant to reduce duplication (low priority, documented workaround in place)

### Security Review

**Status: ✓ PASS**

No security concerns. This is a configuration-only change that reorganizes test execution strategy. No source code modified, no new dependencies added, no security implications.

### Performance Considerations

**Status: ✓ PASS**

Performance impact is **positive**:
- Pre-push hook execution time reduced from 13+ minutes to <30 seconds (via Story 27.1 integration)
- Performance tests properly isolated with dedicated configuration
- Performance benchmarks no longer interfere with unit test execution
- Test execution time verified: default suite 43.6s, performance suite 44.8s

### Files Modified During Review

**Modified:**
- `packages/connector/jest.performance.config.js` - Added documentation comment (lines 12-14)

**Note to Dev:** File List already complete - no additional files modified beyond what was already documented.

### Gate Status

Gate: **PASS** → docs/qa/gates/27.3-fix-failing-tests-jest-configuration.yml

**Quality Score: 95/100**

**Evidence:**
- 7 acceptance criteria all covered with test verification
- 113 test suites verified passing (2347 tests passed, 0 failed)
- 6 performance test suites verified passing (56 tests passed, 0 failed)
- Test distribution comprehensively documented in CONTRIBUTING.md
- Configuration changes are low-risk and reversible
- One maintainability improvement made during review

**NFR Assessment:**
- Security: PASS (no security implications)
- Performance: PASS (positive impact - faster feedback loop)
- Reliability: PASS (all tests verified passing)
- Maintainability: PASS (well-documented, improved with comments)

### Recommended Status

**✓ Ready for Done**

All acceptance criteria met and verified through test execution. Configuration changes are clean, well-documented, and low-risk. No blocking issues identified. One minor improvement made during review (documentation comment). Recommend merging to main branch.

**Epic 27 Status:** This completes Story 27.3, the final story in Epic 27 (Test Suite & Pre-Push Hook Optimization). All three stories (27.1, 27.2, 27.3) are now complete. The epic successfully reduced pre-push hook execution from 13+ minutes to <30 seconds while maintaining comprehensive test coverage.
```
