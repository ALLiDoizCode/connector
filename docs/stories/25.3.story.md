# Story 25.3: Export All Composition Types

## Status

Done

## Story

**As a** library consumer,
**I want** all types needed for in-process composition to be exported,
**so that** I can construct and interact with `ConnectorNode` with full type safety.

## Acceptance Criteria

1. All classes listed in epic scope are exported from library entry point
2. All types listed in epic scope are exported from library entry point
3. Consumer test file compiles with strict TypeScript — no `any` casts needed
4. ILP packet types re-exported from `@agent-runtime/shared` for convenience
5. No internal-only types leaked (implementation details stay private)
6. `npm pack` includes all `.d.ts` files for exported types
7. TypeScript compilation succeeds across the monorepo

## Tasks / Subtasks

- [x] Task 1: Add missing class exports to `lib.ts` (AC: 1)
  - [x] 1.1 Import and export `BTPClientManager` from `./btp/btp-client-manager` [Source: packages/connector/src/btp/btp-client-manager.ts:15]
  - [x] 1.2 Import and export `AdminServer` from `./http/admin-server` [Source: packages/connector/src/http/admin-server.ts:50]
  - [x] 1.3 Import and export `AccountManager` from `./settlement/account-manager` [Source: packages/connector/src/settlement/account-manager.ts:121]
  - [x] 1.4 Import and export `SettlementMonitor` from `./settlement/settlement-monitor` [Source: packages/connector/src/settlement/settlement-monitor.ts:116]
  - [x] 1.5 Import and export `UnifiedSettlementExecutor` from `./settlement/unified-settlement-executor` [Source: packages/connector/src/settlement/unified-settlement-executor.ts:58]
    - Note: The class is named `UnifiedSettlementExecutor` (not `SettlementExecutor`). Export using the actual class name to avoid renaming confusion.

- [x] Task 2: Add missing type exports to `lib.ts` (AC: 2)
  - [x] 2.1 Add `PeerConfig` to the `export type { ... } from './config/types'` block — this is the connector config `PeerConfig` at `config/types.ts:61` with `id`, `url`, `authToken` fields
  - [x] 2.2 Add `RouteConfig` to the `export type { ... } from './config/types'` block — at `config/types.ts:105` with `prefix`, `nextHop`, `priority` fields
  - [x] 2.3 Add `SettlementConfig` to the `export type { ... } from './config/types'` block — at `config/types.ts:527` with `connectorFeePercentage`, `enableSettlement`, `tigerBeetleClusterId`, `tigerBeetleReplicas` fields

- [x] Task 3: Add `ILPPreparePacket` re-export from `@agent-runtime/shared` (AC: 4)
  - [x] 3.1 Add `ILPPreparePacket` to the existing `export type { ILPFulfillPacket, ILPRejectPacket } from '@agent-runtime/shared'` line in `lib.ts` — resulting in `export type { ILPPreparePacket, ILPFulfillPacket, ILPRejectPacket } from '@agent-runtime/shared'`
  - [x] 3.2 `ILPPreparePacket` is already exported from `@agent-runtime/shared` at `packages/shared/src/types/ilp.ts:60` — no changes needed in the shared package

- [x] Task 4: Verify no internal-only types are leaked (AC: 5)
  - [x] 4.1 Review all new exports to ensure none expose internal implementation details:
    - `BTPClientManager` — manages peer connections, reasonable for advanced library consumers
    - `AdminServer` — optional HTTP wrapper, documented as "optional" in epic
    - `AccountManager` — settlement account management, needed for composition
    - `SettlementMonitor` — balance monitoring, needed for composition
    - `UnifiedSettlementExecutor` — settlement routing, needed for composition
  - [x] 4.2 Verify no private/internal types are accidentally exported (e.g., `PeerAccountMetadata`, `AccountLedgerCodes`, `PeerAccountPair` from `settlement/types.ts` should NOT be exported — these are internal implementation details)
  - [x] 4.3 Verify settlement's `PeerConfig` (from `settlement/types.ts:251`) is NOT exported from lib.ts — it's a different interface than the connector config `PeerConfig` (from `config/types.ts:61`). Only the config `PeerConfig` should be exported. If there's a naming conflict, use the config one (it's the one consumers need for `ConnectorConfig.peers`).

- [x] Task 5: Create consumer test file for type completeness (AC: 3)
  - [x] 5.1 Create `packages/connector/src/consumer-types.test.ts` — a TypeScript compilation test that imports all exported types and verifies they're usable with full type safety
  - [x] 5.2 Test: import all 15 value exports (10 existing + 5 new: `ConnectorNode`, `ConfigLoader`, `ConfigurationError`, `ConnectorNotStartedError`, `RoutingTable`, `PacketHandler`, `BTPServer`, `BTPClient`, `BTPClientManager`, `AdminServer`, `AccountManager`, `SettlementMonitor`, `UnifiedSettlementExecutor`, `LocalDeliveryClient`, `createLogger`) and verify each is a function/class with `typeof`
  - [x] 5.3 Test: import all 18 type exports (14 existing + 3 new config types + 1 new ILP type: `ConnectorConfig`, `PeerConfig`, `RouteConfig`, `SettlementConfig`, `LocalDeliveryConfig`, `LocalDeliveryHandler`, `LocalDeliveryRequest`, `LocalDeliveryResponse`, `SendPacketParams`, `PeerRegistrationRequest`, `PeerInfo`, `PeerAccountBalance`, `RouteInfo`, `RemovePeerResult`, `AdminSettlementConfig`, `ILPPreparePacket`, `ILPFulfillPacket`, `ILPRejectPacket`) and create typed variables — verify compilation (no `any` needed)
  - [x] 5.4 Test: construct a minimal `ConnectorConfig` object with `PeerConfig[]` peers and `RouteConfig[]` routes — verify it type-checks without `any` casts
  - [x] 5.5 Test: define a `LocalDeliveryHandler` function with proper types — verify it type-checks without `any` casts
  - [x] 5.6 Test: create `SendPacketParams` object — verify it type-checks without `any` casts

- [x] Task 6: Update existing `lib.test.ts` to cover new exports (AC: 1, 2)
  - [x] 6.1 Add tests for new class exports: `BTPClientManager`, `AdminServer`, `AccountManager`, `SettlementMonitor`, `UnifiedSettlementExecutor` — verify each is a function (constructor)
  - [x] 6.2 Verify `main` is still NOT exported (regression check from Story 25.1)

- [x] Task 7: Verify `npm pack` includes all `.d.ts` files (AC: 6)
  - [x] 7.1 Run `npx tsc --project packages/connector/tsconfig.json --noEmit` to verify TypeScript compilation
  - [x] 7.2 Run `npm pack --workspace=@agent-runtime/connector --dry-run` and verify the output includes `dist/lib.d.ts` and all relevant `.d.ts` files for exported modules
  - [x] 7.3 Verify `.d.ts` files exist for: `lib.d.ts`, `core/connector-node.d.ts`, `btp/btp-client-manager.d.ts`, `http/admin-server.d.ts`, `settlement/account-manager.d.ts`, `settlement/settlement-monitor.d.ts`, `settlement/unified-settlement-executor.d.ts`

- [x] Task 8: Run full test suite and verify no regressions (AC: 7)
  - [x] 8.1 Run `npm test --workspace=@agent-runtime/connector` — all existing tests must pass
  - [x] 8.2 Run `npm test --workspace=@agent-runtime/shared` — shared package unaffected
  - [x] 8.3 Specifically verify `connector-node.test.ts` (75 tests) still passes
  - [x] 8.4 Specifically verify `lib.test.ts` (updated with new exports) passes
  - [x] 8.5 Specifically verify `consumer-types.test.ts` (new) passes
  - [x] 8.6 Run `npx tsc --project packages/connector/tsconfig.json --noEmit` — TypeScript compilation clean

## Dev Notes

### Epic Context

This is the third and final story in Epic 25 (CLI/Library Separation & Lifecycle Cleanup). Stories 25.1 (Split Library Exports from Process Entrypoint) and 25.2 (Clean ConnectorNode Lifecycle Methods) are both complete. This story focuses on ensuring all types needed for programmatic composition are exported from the library entry point.

Epic 25 stories:

- **25.1** (Done): Split library exports from process entrypoint
- **25.2** (Done): Clean ConnectorNode lifecycle methods
- **25.3** (this story): Export all composition types
  [Source: docs/prd/epic-25-cli-library-separation.md]

### Previous Story Insights (Story 25.2)

- `stop()` now shuts down SettlementExecutor, SettlementMonitor, TigerBeetleClient, and AccountManager
- Added `_tigerBeetleClient` class field to ConnectorNode to retain reference for cleanup
- `stop()` is idempotent (guard at top checks `_btpServerStarted`, `_adminServer`, `_explorerServer`)
- `start()` → `stop()` → `start()` reentrant — all state reset in `stop()`
- 75/75 connector-node tests pass (67 existing + 8 new lifecycle tests)
- Pre-existing failures in btp-client.test.ts, wallet-derivation.test.ts, and oer.perf.test.ts unchanged
  [Source: docs/stories/25.2.story.md#dev-agent-record]

### Current `lib.ts` Exports

`packages/connector/src/lib.ts` (50 lines) currently exports:

**Classes/Values (10):**

- `ConnectorNode` from `./core/connector-node`
- `ConfigLoader`, `ConfigurationError`, `ConnectorNotStartedError` from `./config/config-loader`
- `createLogger` from `./utils/logger`
- `RoutingTable` from `./routing/routing-table`
- `PacketHandler` from `./core/packet-handler`
- `BTPServer` from `./btp/btp-server`
- `BTPClient` from `./btp/btp-client`
- `LocalDeliveryClient` from `./core/local-delivery-client`

**Types (12):**

- From `./config/types`: `ConnectorConfig`, `LocalDeliveryConfig`, `LocalDeliveryHandler`, `LocalDeliveryRequest`, `LocalDeliveryResponse`, `SendPacketParams`, `PeerRegistrationRequest`, `PeerInfo`, `PeerAccountBalance`, `RouteInfo`, `RemovePeerResult`
- From `./settlement/types`: `AdminSettlementConfig`
- From `@agent-runtime/shared`: `ILPFulfillPacket`, `ILPRejectPacket`
  [Source: packages/connector/src/lib.ts]

### Epic-vs-Code Naming Discrepancy

The epic scope (Story 25.3) lists `SettlementExecutor` as a class to export. The actual class in the codebase is `UnifiedSettlementExecutor` (at `packages/connector/src/settlement/unified-settlement-executor.ts:58`). This story exports the actual class name `UnifiedSettlementExecutor` — no rename alias is created. The epic requirement is satisfied by exporting the real class.
[Source: docs/prd/epic-25-cli-library-separation.md line 162 vs packages/connector/src/settlement/unified-settlement-executor.ts:58]

### Missing Exports (to be added)

**Classes to add (5):**

1. `BTPClientManager` — `packages/connector/src/btp/btp-client-manager.ts:15`
2. `AdminServer` — `packages/connector/src/http/admin-server.ts:50`
3. `AccountManager` — `packages/connector/src/settlement/account-manager.ts:121`
4. `SettlementMonitor` — `packages/connector/src/settlement/settlement-monitor.ts:116`
5. `UnifiedSettlementExecutor` — `packages/connector/src/settlement/unified-settlement-executor.ts:58`

**Types to add (4):**

1. `PeerConfig` — `packages/connector/src/config/types.ts:61` (connector config peer, NOT settlement peer)
2. `RouteConfig` — `packages/connector/src/config/types.ts:105`
3. `SettlementConfig` — `packages/connector/src/config/types.ts:527`
4. `ILPPreparePacket` — already exported from `@agent-runtime/shared` at `packages/shared/src/types/ilp.ts:60`, just needs re-export from lib.ts

### `SendPacketResult` Note

The epic scope lists `SendPacketResult` as a type to export. However, this type **does not exist** in the codebase. `ConnectorNode.sendPacket()` returns `Promise<ILPFulfillPacket | ILPRejectPacket>` directly — the return type is the existing ILP packet union, not a named result type. Since `ILPFulfillPacket` and `ILPRejectPacket` are already exported (and `ILPPreparePacket` will be added in this story), there is no need to create a separate `SendPacketResult` type. The epic requirement is satisfied by the existing packet type exports.
[Source: packages/connector/src/core/connector-node.ts:237 — `async sendPacket(params: SendPacketParams): Promise<ILPFulfillPacket | ILPRejectPacket>`]

### `PeerConfig` Naming Conflict

There are TWO different `PeerConfig` interfaces in the codebase:

1. **`config/types.ts:61`** — Connector config peer: `{ id: string; url: string; authToken: string }` — Used in `ConnectorConfig.peers`. **This is the one to export.**
2. **`settlement/types.ts:251`** — Settlement peer: `{ peerId: string; address: string; settlementPreference: ... }` — Used internally by `UnifiedSettlementExecutor`. **Do NOT export this one from lib.ts.**

Since both are named `PeerConfig` but have different fields, only export the config one. The settlement `PeerConfig` is an internal implementation detail used by the settlement subsystem.
[Source: packages/connector/src/config/types.ts:61, packages/connector/src/settlement/types.ts:251]

### File Locations

Changes are isolated to:

```
packages/connector/src/
├── lib.ts                   # MODIFIED — add missing class imports/exports, add type exports
├── lib.test.ts              # MODIFIED — add tests for new class exports
├── consumer-types.test.ts   # NEW — TypeScript compilation test for all exports
```

No other files need modification. The classes and types being exported already exist — this story only adds import/export statements to `lib.ts` and creates tests to verify completeness.

### Testing

- **Framework:** Jest 29.7.x with `ts-jest` [Source: docs/architecture/tech-stack.md]
- **File Convention:** Co-located `<filename>.test.ts` next to source [Source: docs/architecture/coding-standards.md]
- **Pattern:** AAA (Arrange, Act, Assert) with descriptive test names
- **Mocking:** Not needed for this story — tests are primarily import verification and type compilation checks
- **Coverage:** The consumer-types test is a compilation test — it verifies types are importable and usable, not runtime behavior
- **Key Test Scenarios:**
  1. All value exports are functions/constructors (`typeof X === 'function'`)
  2. All type exports can be used to create typed variables (compilation check)
  3. `ConnectorConfig` can be constructed with `PeerConfig[]` and `RouteConfig[]` (composition check)
  4. `LocalDeliveryHandler` type can be used for function signatures (function type check)
  5. `SendPacketParams` can be constructed with proper types (Buffer, Date, bigint)
  6. `main` is NOT exported (regression check)
     [Source: docs/architecture/test-strategy-and-standards.md]

### Coding Standards

- TypeScript strict mode, no `any` types except in test mocks [Source: docs/architecture/coding-standards.md]
- File naming: kebab-case [Source: docs/architecture/coding-standards.md]
- Pino logger exclusively (no `console.log`) [Source: docs/architecture/coding-standards.md]
  [Source: docs/architecture/coding-standards.md]

### Project Structure Notes

No structural conflicts. The new `consumer-types.test.ts` file follows the co-located test convention. All changes are within `packages/connector/src/` and only affect export statements and test files.

## File List

| File                                            | Action   | Description                                                                                                                                                                                                                      |
| ----------------------------------------------- | -------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `packages/connector/src/lib.ts`                 | MODIFIED | Added 5 class imports/exports (BTPClientManager, AdminServer, AccountManager, SettlementMonitor, UnifiedSettlementExecutor), 3 type exports (PeerConfig, RouteConfig, SettlementConfig), 1 ILP type re-export (ILPPreparePacket) |
| `packages/connector/src/lib.test.ts`            | MODIFIED | Added 5 tests for new class exports, retained regression check for main not exported                                                                                                                                             |
| `packages/connector/src/consumer-types.test.ts` | NEW      | TypeScript compilation test verifying all 15 value exports and 18 type exports are usable with full type safety                                                                                                                  |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6

### Debug Log References

No debug issues encountered.

### Completion Notes

- All 8 tasks completed successfully
- `lib.ts` now exports 15 value exports and 18 type exports
- `consumer-types.test.ts` (10 tests) and `lib.test.ts` (9 tests) both pass
- `connector-node.test.ts` (75 tests) passes — no regressions
- TypeScript compilation clean (`tsc --noEmit` passes)
- `npm pack --dry-run` confirms all 7 required `.d.ts` files included
- Shared package tests (170/170) unaffected
- Pre-existing wallet-derivation performance test failures unchanged (not related to this story)
- No internal types leaked — verified `PeerAccountMetadata`, `AccountLedgerCodes`, `PeerAccountPair`, and settlement `PeerConfig` are NOT exported

## QA Results

### Review Date: 2026-02-11

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation quality. Story 25.3 is purely additive — adding import/export statements to `lib.ts` and creating verification tests. The code is clean, well-organized, and follows established patterns from Stories 25.1 and 25.2. The `consumer-types.test.ts` is a thorough TypeScript compilation test that validates all 15 value exports and 18 type exports with realistic usage scenarios. No `any` casts used anywhere.

### Refactoring Performed

No refactoring was needed. The implementation is minimal and correct.

### Compliance Check

- Coding Standards: ✓ TypeScript strict mode, kebab-case files, no `any` types, Pino logger
- Project Structure: ✓ Co-located tests, correct barrel export pattern via `index.ts → lib.ts`
- Testing Strategy: ✓ AAA pattern, descriptive test names, compilation verification approach
- All ACs Met: ✓ All 7 acceptance criteria verified (see traceability below)

### AC Traceability

| AC  | Description                                   | Verification                                                                                                  |
| --- | --------------------------------------------- | ------------------------------------------------------------------------------------------------------------- |
| 1   | All classes exported from library entry point | `lib.test.ts` verifies all 15 value exports are functions (9 tests)                                           |
| 2   | All types exported from library entry point   | `consumer-types.test.ts` imports all 18 types and creates typed variables (10 tests)                          |
| 3   | Consumer test compiles with strict TypeScript | `consumer-types.test.ts` compiles and runs — no `any` casts                                                   |
| 4   | ILP packet types re-exported from shared      | `ILPPreparePacket` added to existing `ILPFulfillPacket`, `ILPRejectPacket` re-export line                     |
| 5   | No internal-only types leaked                 | Settlement `PeerConfig`, `PeerAccountMetadata`, `AccountLedgerCodes`, `PeerAccountPair` NOT in lib.ts exports |
| 6   | `npm pack` includes all `.d.ts` files         | `package.json` correctly points `main`/`types` to `dist/lib.js`/`dist/lib.d.ts` with `exports` map            |
| 7   | TypeScript compilation succeeds               | `tsc --noEmit` passes clean with zero errors                                                                  |

### Improvements Checklist

- [x] All acceptance criteria verified through code review and test execution
- [x] No internal types leaked (settlement PeerConfig, PeerAccountMetadata, AccountLedgerCodes, PeerAccountPair confirmed absent)
- [x] Naming discrepancy documented (UnifiedSettlementExecutor vs SettlementExecutor from epic)
- [x] SendPacketResult absence documented (return type is union of existing ILP packet types)

### Security Review

No security concerns. This story only adds `export` statements — no new endpoints, authentication changes, or data handling. All exported classes already existed; they're now just accessible to library consumers.

### Performance Considerations

No performance impact. Export statements are resolved at module load time and add zero runtime overhead.

### Files Modified During Review

No files modified during review.

### Gate Status

Gate: PASS → docs/qa/gates/25.3-export-all-composition-types.yml
Risk profile: Low — purely additive export-only changes, no behavioral modifications
NFR assessment: All PASS

### Recommended Status

✓ Ready for Done

## Change Log

| Date       | Version | Description                                                                 | Author            |
| ---------- | ------- | --------------------------------------------------------------------------- | ----------------- |
| 2026-02-11 | 1.0     | Initial story creation                                                      | Scrum Master      |
| 2026-02-11 | 1.1     | Add epic naming discrepancy note, export count annotations in Tasks 5.2/5.3 | QA Validation     |
| 2026-02-11 | 1.2     | Implementation complete — all tasks done, tests passing                     | Dev Agent (James) |
