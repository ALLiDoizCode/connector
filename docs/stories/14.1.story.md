<!-- Powered by BMAD™ Core -->

# Story 14.1: Add Agent Server Aptos HTTP Endpoints

## Status

Done

## Story

**As a** agent developer,
**I want** Aptos payment channel HTTP endpoints in the agent server,
**So that** agents can manage Aptos payment channels for tri-chain settlement alongside EVM and XRP channels.

## Acceptance Criteria

1. Agent server exposes `GET /aptos-channels` endpoint returning list of Aptos payment channels
2. Agent server exposes `POST /aptos-channels/open` endpoint to open new Aptos channel with peer
3. Agent server exposes `GET /aptos-channels/:id` endpoint to get specific channel state
4. Agent server exposes `POST /aptos-channels/claim` endpoint to submit claim with signature
5. Agent server exposes `POST /aptos-channels/close` endpoint to request channel close
6. Agent server exposes `POST /configure-aptos` endpoint for runtime Aptos configuration
7. Environment variables `APTOS_ENABLED`, `APTOS_NODE_URL`, `APTOS_PRIVATE_KEY`, `APTOS_MODULE_ADDRESS` configure Aptos integration
8. Aptos channels integrate with `updateChannelBalanceForPeer()` for payment tracking
9. Telemetry events emitted for Aptos channel operations (`AGENT_CHANNEL_OPENED`, `AGENT_CHANNEL_BALANCE_UPDATE`)
10. Status endpoint `/status` includes `aptosChannelCount` and `aptosAddress` fields
11. Balances endpoint `/balances` includes `aptosBalance` and `aptosChannels` array
12. Unit tests cover all new Aptos HTTP endpoints

## Tasks / Subtasks

**Task Execution Strategy:** Story 14.1 adds Aptos payment channel endpoints to the existing agent-server.ts, mirroring the established patterns for EVM (Story 8.x) and XRP (Story 9.x) payment channels. The implementation follows the existing endpoint patterns in agent-server.ts and integrates with the AptosChannelSDK created in Epic 13 (Story 13.4). Tasks are ordered to build incrementally: types first, initialization, then endpoints, and finally tests.

- [x] Task 1: Add Aptos Types and Configuration to AgentServer (AC: 7)
  - [x] Add `AptosPaymentChannel` interface to agent-server.ts mirroring `XRPPaymentChannel`:

    ```typescript
    interface AptosPaymentChannel {
      channelOwner: string; // Channel identifier (owner address)
      destination: string; // Destination Aptos address
      destinationPubkey: string; // ed25519 public key for claim verification
      deposited: string; // Octas deposited (string for bigint serialization)
      claimed: string; // Octas claimed (string for bigint serialization)
      status: 'open' | 'closing' | 'closed';
      settleDelay: number; // Settlement delay in seconds
      nonce: number; // Highest nonce of submitted claims
    }
    ```

    - [Source: packages/connector/src/settlement/aptos-channel-sdk.ts#AptosChannelState]

  - [x] Extend `AgentServerConfig` interface with Aptos configuration:

    ```typescript
    // Aptos Payment Channel Configuration
    aptosEnabled: boolean;
    aptosNodeUrl: string | null;
    aptosPrivateKey: string | null;
    aptosModuleAddress: string | null;
    aptosAccountAddress: string | null;
    ```

    - [Source: Epic 14 Technical Approach - Story 14.1]

  - [x] Extend `PeerConnection` interface with `aptosAddress?: string` field
    - [Source: packages/connector/src/agent/agent-server.ts:90-97 existing pattern]
  - [x] Add Aptos state properties to `AgentServer` class:

    ```typescript
    private aptosClient: IAptosClient | null = null;
    private aptosChannelSDK: IAptosChannelSDK | null = null;
    private aptosChannels: Map<string, AptosPaymentChannel> = new Map();
    ```

    - [Source: packages/connector/src/agent/agent-server.ts:138-147 EVM/XRP pattern]
    - Note: `aptosClient` is needed for balance queries in `getBalances()` method (Task 10)

  - [x] Load Aptos configuration from environment in constructor:
    - `APTOS_ENABLED` → `aptosEnabled` (boolean, default: false)
    - `APTOS_NODE_URL` → `aptosNodeUrl` (string)
    - `APTOS_PRIVATE_KEY` → `aptosPrivateKey` (string, ED25519)
    - `APTOS_MODULE_ADDRESS` → `aptosModuleAddress` (string, 0x-prefixed hex)
    - [Source: Epic 14 Technical Approach - Environment configuration]

- [x] Task 2: Implement Aptos Initialization Method (AC: 7)
  - [x] Create `private async initializeAptos(): Promise<void>` method following `initializeXRP()` pattern:

    ```typescript
    private async initializeAptos(): Promise<void> {
      if (!this.config.aptosEnabled || !this.config.aptosNodeUrl) {
        this.logger.debug('Aptos not enabled or no node URL configured, skipping Aptos initialization');
        return;
      }

      if (!this.config.aptosPrivateKey || !this.config.aptosModuleAddress) {
        this.logger.debug('No Aptos private key or module address configured, Aptos will be configured at runtime');
        return;
      }

      try {
        // Create Aptos client and claim signer
        const aptosClient = createAptosClientFromEnv(this.logger);
        const claimSigner = createAptosClaimSignerFromEnv(this.logger);

        // Store client reference for balance queries (Task 10)
        this.aptosClient = aptosClient;

        // Create AptosChannelSDK
        this.aptosChannelSDK = new AptosChannelSDK(
          aptosClient,
          claimSigner,
          { moduleAddress: this.config.aptosModuleAddress },
          this.logger
        );

        // Derive account address from private key
        this.config.aptosAccountAddress = aptosClient.getAddress();

        this.logger.info({
          aptosAddress: this.config.aptosAccountAddress,
          aptosModuleAddress: this.config.aptosModuleAddress,
        }, 'Aptos initialized');
      } catch (error) {
        this.logger.error({ err: error }, 'Failed to initialize Aptos');
        // Don't throw - Aptos is optional and can be configured at runtime
      }
    }
    ```

    - [Source: packages/connector/src/agent/agent-server.ts:342-388 initializeXRP pattern]
    - [Source: packages/connector/src/settlement/aptos-channel-sdk.ts:764-787 factory functions]

  - [x] Add import for Aptos SDK components:
    ```typescript
    import {
      AptosChannelSDK,
      IAptosChannelSDK,
      AptosChannelState,
      createAptosChannelSDKFromEnv,
    } from '../settlement/aptos-channel-sdk';
    import { IAptosClient, createAptosClientFromEnv } from '../settlement/aptos-client';
    import { createAptosClaimSignerFromEnv } from '../settlement/aptos-claim-signer';
    ```
  - [x] Call `await this.initializeAptos()` in `start()` method after XRP initialization
    - [Source: packages/connector/src/agent/agent-server.ts:259-261]

- [x] Task 3: Implement `/configure-aptos` Endpoint (AC: 6)
  - [x] Add HTTP handler for `POST /configure-aptos` in `handleHttpRequest()`:

    ```typescript
    if (req.method === 'POST' && url.pathname === '/configure-aptos') {
      const body = await this.readRequestBody(req);
      const data = JSON.parse(body) as {
        aptosNodeUrl: string;
        aptosPrivateKey: string;
        aptosModuleAddress: string;
      };

      // Update config
      this.config.aptosEnabled = true;
      this.config.aptosNodeUrl = data.aptosNodeUrl;
      this.config.aptosPrivateKey = data.aptosPrivateKey;
      this.config.aptosModuleAddress = data.aptosModuleAddress;

      // Re-initialize Aptos
      await this.initializeAptos();

      res.writeHead(200);
      res.end(
        JSON.stringify({
          success: true,
          aptosAddress: this.config.aptosAccountAddress,
        })
      );
      return;
    }
    ```

    - [Source: packages/connector/src/agent/agent-server.ts:642-670 /configure-xrp pattern]

  - [x] Position handler after `/configure-xrp` endpoint in request routing

- [x] Task 4: Implement `/aptos-channels` GET Endpoint (AC: 1)
  - [x] Add HTTP handler for `GET /aptos-channels`:

    ```typescript
    if (req.method === 'GET' && url.pathname === '/aptos-channels') {
      const channels = Array.from(this.aptosChannels.values()).map((ch) => ({
        channelOwner: ch.channelOwner,
        destination: ch.destination,
        deposited: ch.deposited,
        claimed: ch.claimed,
        status: ch.status,
        settleDelay: ch.settleDelay,
        nonce: ch.nonce,
      }));
      res.writeHead(200);
      res.end(JSON.stringify({ channels }));
      return;
    }
    ```

    - [Source: packages/connector/src/agent/agent-server.ts:672-685 /xrp-channels pattern]

- [x] Task 5: Implement `/aptos-channels/open` POST Endpoint (AC: 2, 9)
  - [x] Add HTTP handler for `POST /aptos-channels/open`:
    ```typescript
    if (req.method === 'POST' && url.pathname === '/aptos-channels/open') {
      const body = await this.readRequestBody(req);
      const data = JSON.parse(body) as {
        destination: string;
        destinationPubkey: string;
        amount: string;
        settleDelay?: number;
      };
      const result = await this.openAptosPaymentChannel(
        data.destination,
        data.destinationPubkey,
        data.amount,
        data.settleDelay || 86400 // Default 24 hours
      );
      res.writeHead(result.success ? 200 : 400);
      res.end(JSON.stringify(result));
      return;
    }
    ```
  - [x] Implement `private async openAptosPaymentChannel()` method:

    ```typescript
    private async openAptosPaymentChannel(
      destination: string,
      destinationPubkey: string,
      amount: string,
      settleDelay: number
    ): Promise<{ success: boolean; channelOwner?: string; error?: string }> {
      if (!this.aptosChannelSDK) {
        return { success: false, error: 'Aptos not initialized' };
      }

      try {
        this.logger.info({
          destination,
          amount,
          settleDelay,
        }, 'Opening Aptos payment channel');

        // Open channel via SDK
        const channelOwner = await this.aptosChannelSDK.openChannel(
          destination,
          destinationPubkey,
          BigInt(amount),
          settleDelay
        );

        // Fetch channel state and track locally
        const channelState = await this.aptosChannelSDK.getChannelState(channelOwner);
        if (channelState) {
          this.aptosChannels.set(channelOwner, {
            channelOwner: channelState.channelOwner,
            destination: channelState.destination,
            destinationPubkey: channelState.destinationPubkey,
            deposited: channelState.deposited.toString(),
            claimed: channelState.claimed.toString(),
            status: channelState.status,
            settleDelay: channelState.settleDelay,
            nonce: channelState.nonce,
          });
        }

        this.logger.info({ channelOwner, destination }, 'Aptos payment channel opened');

        // Emit telemetry
        this.telemetryEmitter.emit({
          type: 'AGENT_CHANNEL_OPENED',
          timestamp: Date.now(),
          nodeId: this.config.agentId,
          agentId: this.config.agentId,
          channelId: channelOwner,
          chain: 'aptos',
          peerId: destination,
          amount,
        });

        return { success: true, channelOwner };
      } catch (error) {
        this.logger.error({ err: error, destination }, 'Failed to open Aptos payment channel');
        return { success: false, error: (error as Error).message };
      }
    }
    ```

    - [Source: packages/connector/src/agent/agent-server.ts:1383-1517 openXRPPaymentChannel pattern]
    - [Source: packages/connector/src/settlement/aptos-channel-sdk.ts:310-362 openChannel]

  - [x] Verify telemetry event type supports `chain: 'aptos'` value:
    - Check `TelemetryEvent` type definition in `packages/connector/src/telemetry/`
    - If `chain` field is a union type, add `'aptos'` to the union: `chain: 'evm' | 'xrp' | 'aptos'`
    - If not typed, no change needed (string field)

- [x] Task 6: Implement `/aptos-channels/:id` GET Endpoint (AC: 3)
  - [x] Add HTTP handler for `GET /aptos-channels/:id` (parse channelOwner from path):

    ```typescript
    if (
      req.method === 'GET' &&
      url.pathname.startsWith('/aptos-channels/') &&
      !url.pathname.includes('/claim') &&
      !url.pathname.includes('/close')
    ) {
      const channelOwner = url.pathname.split('/aptos-channels/')[1];

      if (!this.aptosChannelSDK) {
        res.writeHead(400);
        res.end(JSON.stringify({ error: 'Aptos not initialized' }));
        return;
      }

      // Check local cache first
      let channel = this.aptosChannels.get(channelOwner);

      // If not in cache, try to fetch from chain
      if (!channel) {
        const state = await this.aptosChannelSDK.getChannelState(channelOwner);
        if (state) {
          channel = {
            channelOwner: state.channelOwner,
            destination: state.destination,
            destinationPubkey: state.destinationPubkey,
            deposited: state.deposited.toString(),
            claimed: state.claimed.toString(),
            status: state.status,
            settleDelay: state.settleDelay,
            nonce: state.nonce,
          };
          this.aptosChannels.set(channelOwner, channel);
        }
      }

      if (!channel) {
        res.writeHead(404);
        res.end(JSON.stringify({ error: 'Channel not found' }));
        return;
      }

      res.writeHead(200);
      res.end(JSON.stringify({ channel }));
      return;
    }
    ```

    - Note: URL path parsing for channel ID

- [x] Task 7: Implement `/aptos-channels/claim` POST Endpoint (AC: 4)
  - [x] Add HTTP handler for `POST /aptos-channels/claim`:
    ```typescript
    if (req.method === 'POST' && url.pathname === '/aptos-channels/claim') {
      const body = await this.readRequestBody(req);
      const data = JSON.parse(body) as {
        channelOwner: string;
        amount: string;
        nonce: number;
        signature: string;
      };
      const result = await this.claimAptosChannel(data);
      res.writeHead(result.success ? 200 : 400);
      res.end(JSON.stringify(result));
      return;
    }
    ```
  - [x] Implement `private async claimAptosChannel()` method:

    ```typescript
    private async claimAptosChannel(claim: {
      channelOwner: string;
      amount: string;
      nonce: number;
      signature: string;
    }): Promise<{
      success: boolean;
      channelOwner: string;
      claimedAmount?: string;
      error?: string;
    }> {
      if (!this.aptosChannelSDK) {
        return { success: false, channelOwner: claim.channelOwner, error: 'Aptos not initialized' };
      }

      try {
        this.logger.info({
          channelOwner: claim.channelOwner,
          amount: claim.amount,
          nonce: claim.nonce,
        }, 'Submitting Aptos channel claim');

        // Fetch channel state to get destination public key for claim verification
        const channelState = this.aptosChannels.get(claim.channelOwner);
        if (!channelState) {
          return { success: false, channelOwner: claim.channelOwner, error: 'Channel not found in local state' };
        }

        // Submit claim to chain with public key from channel state
        await this.aptosChannelSDK.submitClaim({
          channelOwner: claim.channelOwner,
          amount: BigInt(claim.amount),
          nonce: claim.nonce,
          signature: claim.signature,
          publicKey: channelState.destinationPubkey,
        });

        // Refresh channel state
        const state = await this.aptosChannelSDK.getChannelState(claim.channelOwner);
        if (state) {
          this.aptosChannels.set(claim.channelOwner, {
            channelOwner: state.channelOwner,
            destination: state.destination,
            destinationPubkey: state.destinationPubkey,
            deposited: state.deposited.toString(),
            claimed: state.claimed.toString(),
            status: state.status,
            settleDelay: state.settleDelay,
            nonce: state.nonce,
          });
        }

        this.logger.info({
          channelOwner: claim.channelOwner,
          claimedAmount: claim.amount
        }, 'Aptos channel claim submitted');

        return {
          success: true,
          channelOwner: claim.channelOwner,
          claimedAmount: claim.amount,
        };
      } catch (error) {
        this.logger.error({ err: error, channelOwner: claim.channelOwner }, 'Aptos channel claim failed');
        return { success: false, channelOwner: claim.channelOwner, error: (error as Error).message };
      }
    }
    ```

    - [Source: packages/connector/src/settlement/aptos-channel-sdk.ts:496-533 submitClaim]

  - [x] Note: `AptosClaim` requires `publicKey` field for on-chain signature verification. The public key is stored in `AptosPaymentChannel.destinationPubkey` when the channel is opened/cached. Always fetch from local channel state before submitting claim.

- [x] Task 8: Implement `/aptos-channels/close` POST Endpoint (AC: 5)
  - [x] Add HTTP handler for `POST /aptos-channels/close`:
    ```typescript
    if (req.method === 'POST' && url.pathname === '/aptos-channels/close') {
      const body = await this.readRequestBody(req);
      const data = JSON.parse(body) as { channelOwner: string };
      const result = await this.closeAptosChannel(data.channelOwner);
      res.writeHead(result.success ? 200 : 400);
      res.end(JSON.stringify(result));
      return;
    }
    ```
  - [x] Implement `private async closeAptosChannel()` method:

    ```typescript
    private async closeAptosChannel(channelOwner: string): Promise<{
      success: boolean;
      channelOwner: string;
      error?: string;
    }> {
      if (!this.aptosChannelSDK) {
        return { success: false, channelOwner, error: 'Aptos not initialized' };
      }

      try {
        this.logger.info({ channelOwner }, 'Requesting Aptos channel close');

        // Request channel close (starts settle delay)
        await this.aptosChannelSDK.requestClose(channelOwner);

        // Update local state to 'closing'
        const channel = this.aptosChannels.get(channelOwner);
        if (channel) {
          channel.status = 'closing';
        }

        this.logger.info({ channelOwner }, 'Aptos channel close requested');

        return { success: true, channelOwner };
      } catch (error) {
        this.logger.error({ err: error, channelOwner }, 'Aptos channel close failed');
        return { success: false, channelOwner, error: (error as Error).message };
      }
    }
    ```

    - [Source: packages/connector/src/settlement/aptos-channel-sdk.ts:394-423 requestClose]

- [x] Task 9: Integrate Aptos into Balance Tracking (AC: 8, 9)
  - [x] Update `updateChannelBalanceForPeer()` method signature to include `'aptos'` in return type:
    ```typescript
    // Update the return type union (line 1121-1125):
    channelType: 'evm' | 'xrp' | 'aptos' | 'none';
    ```
  - [x] Update the peer parameter type to include aptosAddress:
    ```typescript
    private updateChannelBalanceForPeer(
      peer: { evmAddress?: string; xrpAddress?: string; aptosAddress?: string },
      amount: bigint
    ): { ... }
    ```
  - [x] Extend `updateChannelBalanceForPeer()` to include Aptos channels:

    ```typescript
    // After XRP channel handling, add Aptos channel handling:
    // Try Aptos channel
    if (peer.aptosAddress) {
      for (const [channelOwner, channel] of this.aptosChannels) {
        if (channel.destination === peer.aptosAddress && channel.status === 'open') {
          const previousClaimed = channel.claimed;
          const newClaimed = (BigInt(channel.claimed) + amount).toString();
          channel.claimed = newClaimed;
          channel.nonce++;
          return {
            channelId: channelOwner,
            channelType: 'aptos',
            balance: newClaimed,
            previousBalance: previousClaimed,
            deposit: channel.deposited,
          };
        }
      }
    }
    ```

    - [Source: packages/connector/src/agent/agent-server.ts:1116-1169 updateChannelBalanceForPeer]

  - [x] Emit `AGENT_CHANNEL_BALANCE_UPDATE` telemetry for Aptos channels (already handled by existing flow)

- [x] Task 10: Update Status and Balances Endpoints (AC: 10, 11)
  - [x] Update `/status` endpoint to include Aptos fields:

    ```typescript
    // In /status handler, add:
    aptosChannelCount: this.aptosChannels.size,
    aptosAddress: this.config.aptosAccountAddress,
    aptosEnabled: this.config.aptosEnabled,
    ```

    - [Source: packages/connector/src/agent/agent-server.ts:474-500 /status handler]

  - [x] Update `getBalances()` method to include Aptos balance and channels:
    - [x] Add Aptos balance query using `IAptosClient.getBalance()`:

      ```typescript
      let aptosBalance: string | null = null;
      if (this.aptosClient?.isConnected() && this.config.aptosAccountAddress) {
        try {
          // Query APT balance via Aptos client (returns bigint in octas)
          const balanceOctas = await this.aptosClient.getBalance(this.config.aptosAccountAddress);
          // Convert octas to APT (1 APT = 100,000,000 octas)
          aptosBalance = (Number(balanceOctas) / 100_000_000).toFixed(8);
        } catch {
          // ignore - balance query failed
        }
      }
      ```

      - [Source: packages/connector/src/settlement/aptos-client.ts:154-162 getBalance interface]

    - [x] Note: This requires storing a reference to `IAptosClient` (e.g., `private aptosClient: IAptosClient | null = null`) during Aptos initialization in Task 2. Update Task 2 to store the client reference.
    - [x] Add aptosChannels to return object:
      ```typescript
      aptosAddress: this.config.aptosAccountAddress,
      aptosBalance,
      aptosChannels: Array.from(this.aptosChannels.values()).map((ch) => ({
        channelOwner: ch.channelOwner,
        destination: ch.destination,
        deposited: (Number(ch.deposited) / 100_000_000).toFixed(8), // Octas to APT
        claimed: (Number(ch.claimed) / 100_000_000).toFixed(8),
        status: ch.status,
      })),
      ```
    - [Source: packages/connector/src/agent/agent-server.ts:1728-1811 getBalances]

- [x] Task 11: Update AddFollowRequest to Include Aptos Address (AC: 8)
  - [x] Extend `AddFollowRequest` interface:

    ```typescript
    interface AddFollowRequest {
      pubkey: string;
      evmAddress?: string;
      xrpAddress?: string;
      aptosAddress?: string; // NEW
      ilpAddress: string;
      petname?: string;
      btpUrl?: string;
    }
    ```

    - [Source: packages/connector/src/agent/agent-server.ts:106-113]

  - [x] Update `/follows` POST handler to store aptosAddress in peer connection:
    ```typescript
    this.peers.set(data.petname || data.pubkey, {
      peerId: data.petname || data.pubkey,
      ilpAddress: data.ilpAddress,
      btpUrl: data.btpUrl,
      evmAddress: data.evmAddress,
      xrpAddress: data.xrpAddress,
      aptosAddress: data.aptosAddress, // NEW
    });
    ```

- [x] Task 12: Cleanup Aptos Resources on Shutdown (AC: 7)
  - [x] Update `shutdown()` method to stop Aptos SDK auto-refresh and disconnect client:

    ```typescript
    // In shutdown(), add after XRP disconnect:
    if (this.aptosChannelSDK) {
      this.aptosChannelSDK.stopAutoRefresh();
    }
    if (this.aptosClient) {
      this.aptosClient.disconnect();
    }
    ```

    - [Source: packages/connector/src/agent/agent-server.ts:390-431 shutdown]
    - [Source: packages/connector/src/settlement/aptos-client.ts:137 disconnect interface]

- [x] Task 13: Write Unit Tests for Aptos Endpoints (AC: 12)
  - [x] Create test file `packages/connector/src/agent/agent-server-aptos.test.ts`
  - [x] Test: "GET /aptos-channels returns empty array when no channels"
  - [x] Test: "GET /aptos-channels returns channel list"
  - [x] Test: "POST /aptos-channels/open returns error when Aptos not initialized"
  - [x] Test: "POST /aptos-channels/open opens channel successfully" (mock SDK)
  - [x] Test: "GET /aptos-channels/:id returns 404 when channel not found"
  - [x] Test: "GET /aptos-channels/:id returns channel state"
  - [x] Test: "POST /aptos-channels/claim submits claim successfully" (mock SDK)
  - [x] Test: "POST /aptos-channels/close requests close successfully" (mock SDK)
  - [x] Test: "POST /configure-aptos initializes Aptos SDK"
  - [x] Test: "/status includes aptosChannelCount and aptosAddress"
  - [x] Test: "/balances includes aptosBalance and aptosChannels"
  - [x] Test: "updateChannelBalanceForPeer updates Aptos channel balance"
  - [x] Follow testing patterns from `docs/architecture/test-strategy-and-standards.md`:
    - Use Jest mocking for AptosChannelSDK
    - AAA pattern (Arrange, Act, Assert)
    - Descriptive test names
    - Mock external dependencies

## Dev Notes

### Story Context

This is the **first story in Epic 14: Complete Aptos Payment Channel Integration**. Epic 14 completes the Aptos payment channel integration across all system layers to enable tri-chain settlement (EVM + XRP + Aptos).

**Epic 14 Context:**

- **Story 14.1 (this story)**: Add Agent Server Aptos HTTP Endpoints
- **Story 14.2**: Add Test Runner Aptos Phases
- **Story 14.3**: Build Multi-Arch Aptos Docker Image
- **Story 14.4**: Integrate Aptos into Test Infrastructure
- **Story 14.5**: Production Connector Aptos Settlement

**Architectural Role:**

Story 14.1 **adds Aptos payment channel HTTP endpoints to the agent server**, mirroring the existing EVM and XRP endpoint patterns. This enables agents to manage Aptos payment channels via HTTP API, which is required for the Docker agent test runner (Story 14.2) to orchestrate Aptos test phases.

**Foundation from Epic 13:**

Epic 13 implemented the core Aptos payment channel components:

- Move smart contracts (Story 13.1-27.2)
- TypeScript SDK (Story 13.3-27.4)
- AptosChannelSDK with channel lifecycle methods (Story 13.4)

Story 14.1 wraps the AptosChannelSDK with HTTP endpoints, making it accessible to external clients and the test runner.

### Previous Story Insights

**No previous stories in Epic 14** - this is the first story.

**Relevant patterns from Epic 13 (Aptos SDK):**

[Source: packages/connector/src/settlement/aptos-channel-sdk.ts]

1. **AptosChannelSDK Interface:**
   - `openChannel(destination, destinationPubkey, amount, settleDelay)` → returns channelOwner
   - `getChannelState(channelOwner)` → returns AptosChannelState
   - `signClaim(channelOwner, amount)` → returns AptosClaim
   - `submitClaim(claim)` → submits to chain
   - `requestClose(channelOwner)` → starts close countdown
   - `finalizeClose(channelOwner)` → completes close after delay

2. **Channel Identification:**
   - Aptos channels are identified by `channelOwner` (the address that opened the channel)
   - This differs from EVM (bytes32 channelId) and XRP (transaction hash)

3. **Amount Units:**
   - Aptos uses "octas" (1 APT = 100,000,000 octas)
   - Similar to XRP drops (1 XRP = 1,000,000 drops)

**Relevant patterns from agent-server.ts (EVM/XRP):**

[Source: packages/connector/src/agent/agent-server.ts]

1. **Payment Channel State Tracking:**
   - EVM: `paymentChannels: Map<string, PaymentChannel>` (line 141)
   - XRP: `xrpChannels: Map<string, XRPPaymentChannel>` (line 147)
   - Aptos should follow: `aptosChannels: Map<string, AptosPaymentChannel>`

2. **Initialization Pattern:**
   - `initializeEVM()` (lines 286-340) - initializes provider, wallet, contracts
   - `initializeXRP()` (lines 342-388) - initializes XRPL client and wallet
   - `initializeAptos()` should follow same pattern with SDK creation

3. **Runtime Configuration:**
   - `/configure-xrp` (lines 642-670) - accepts runtime XRP configuration
   - `/configure-aptos` should follow same pattern

4. **Channel Endpoint Pattern:**
   - GET `/xrp-channels` (lines 672-685) - list channels
   - POST `/xrp-channels/open` (lines 687-704) - open channel
   - POST `/xrp-channels/claim` (lines 752-759) - submit claim
   - Aptos endpoints should mirror these patterns

### Data Models

**AptosPaymentChannel (New Interface):**

[Source: packages/connector/src/settlement/aptos-channel-sdk.ts#AptosChannelState]

```typescript
/**
 * Aptos Payment Channel State (Agent Server Local)
 *
 * Local representation of Aptos channel state for HTTP API responses.
 * Maps from AptosChannelState (SDK) with string serialization for JSON.
 */
interface AptosPaymentChannel {
  /**
   * Channel owner address (0x-prefixed hex, 64 chars)
   * This is the unique identifier for the channel
   * The owner is the account that deposited funds
   */
  channelOwner: string;

  /**
   * Destination address that can claim funds (0x-prefixed hex)
   */
  destination: string;

  /**
   * ed25519 public key of destination for claim verification
   * Format: hex string (64 characters = 32 bytes)
   */
  destinationPubkey: string;

  /**
   * Total deposited amount in octas (string for bigint serialization)
   * 1 APT = 100,000,000 octas
   */
  deposited: string;

  /**
   * Amount already claimed in octas (string for bigint serialization)
   */
  claimed: string;

  /**
   * Channel status
   * - 'open': Active, can make claims
   * - 'closing': Close requested, in settle delay
   * - 'closed': Finalized
   */
  status: 'open' | 'closing' | 'closed';

  /**
   * Settlement delay in seconds
   * Time between request_close and finalize_close
   */
  settleDelay: number;

  /**
   * Highest nonce of submitted claims
   * New claims must have nonce > this value
   */
  nonce: number;
}
```

**Aptos Configuration Extension:**

[Source: Epic 14 Technical Approach]

```typescript
// Added to AgentServerConfig interface
interface AgentServerConfig {
  // ... existing fields ...

  // Aptos Payment Channel Configuration
  aptosEnabled: boolean;
  aptosNodeUrl: string | null;
  aptosPrivateKey: string | null;
  aptosModuleAddress: string | null;
  aptosAccountAddress: string | null;
}
```

### API Specifications

**New Aptos HTTP Endpoints:**

[Source: Epic 14 Technical Approach - Story 14.1]

| Method | Endpoint                | Description             | Request Body                                               | Response                                            |
| ------ | ----------------------- | ----------------------- | ---------------------------------------------------------- | --------------------------------------------------- |
| GET    | `/aptos-channels`       | List all Aptos channels | -                                                          | `{ channels: AptosPaymentChannel[] }`               |
| POST   | `/aptos-channels/open`  | Open new channel        | `{ destination, destinationPubkey, amount, settleDelay? }` | `{ success, channelOwner?, error? }`                |
| GET    | `/aptos-channels/:id`   | Get channel state       | -                                                          | `{ channel: AptosPaymentChannel }` or 404           |
| POST   | `/aptos-channels/claim` | Submit claim            | `{ channelOwner, amount, nonce, signature }`               | `{ success, channelOwner, claimedAmount?, error? }` |
| POST   | `/aptos-channels/close` | Request close           | `{ channelOwner }`                                         | `{ success, channelOwner, error? }`                 |
| POST   | `/configure-aptos`      | Configure Aptos         | `{ aptosNodeUrl, aptosPrivateKey, aptosModuleAddress }`    | `{ success, aptosAddress? }`                        |

**Updated Endpoints:**

| Endpoint        | New Fields                                          |
| --------------- | --------------------------------------------------- |
| GET `/status`   | `aptosChannelCount`, `aptosAddress`, `aptosEnabled` |
| GET `/balances` | `aptosAddress`, `aptosBalance`, `aptosChannels[]`   |
| POST `/follows` | Request accepts `aptosAddress` field                |

### File Locations

**Primary File to Modify:**

- `packages/connector/src/agent/agent-server.ts` - Add Aptos types, initialization, and HTTP endpoints

**New Test File:**

- `packages/connector/src/agent/agent-server-aptos.test.ts` - Unit tests for Aptos endpoints

**Dependencies (Read-Only):**

- `packages/connector/src/settlement/aptos-channel-sdk.ts` - AptosChannelSDK (Epic 13.4)
- `packages/connector/src/settlement/aptos-client.ts` - Aptos client factory
- `packages/connector/src/settlement/aptos-claim-signer.ts` - Claim signer factory

### Testing Requirements

**Testing Strategy:**

[Source: docs/architecture/test-strategy-and-standards.md]

Story 14.1 focuses on unit testing the new HTTP endpoints with mocked SDK dependencies.

**Unit Tests Required (Task 13):**

1. **Endpoint Response Tests:**
   - GET `/aptos-channels` returns correct format
   - POST `/aptos-channels/open` handles success and error cases
   - GET `/aptos-channels/:id` returns channel or 404
   - POST `/aptos-channels/claim` handles success and error cases
   - POST `/aptos-channels/close` handles success and error cases
   - POST `/configure-aptos` initializes SDK correctly

2. **Integration with Status/Balances:**
   - `/status` includes new Aptos fields
   - `/balances` includes Aptos balance and channels

3. **Balance Tracking:**
   - `updateChannelBalanceForPeer()` updates Aptos channels correctly

**Mock Requirements:**

- Mock `AptosChannelSDK` (openChannel, getChannelState, submitClaim, requestClose)
- Mock `createAptosClientFromEnv` factory function
- Mock `createAptosClaimSignerFromEnv` factory function

**Test Patterns to Follow:**

```typescript
describe('AgentServer - Aptos Endpoints', () => {
  let server: AgentServer;
  let mockAptosSDK: jest.Mocked<IAptosChannelSDK>;

  beforeEach(() => {
    mockAptosSDK = {
      openChannel: jest.fn().mockResolvedValue('0x123...'),
      getChannelState: jest.fn().mockResolvedValue(mockChannelState),
      submitClaim: jest.fn().mockResolvedValue(undefined),
      requestClose: jest.fn().mockResolvedValue(undefined),
      // ... other methods
    } as any;

    // Create server with mock SDK
    server = new AgentServer({
      /* config */
    });
  });

  afterEach(async () => {
    await server.shutdown();
  });

  it('should return empty channels array when no channels exist', async () => {
    // Arrange
    // Act
    const response = await fetch('http://localhost:8080/aptos-channels');
    const data = await response.json();
    // Assert
    expect(data.channels).toEqual([]);
  });
});
```

### Coding Standards

**Core Standards:**

[Source: docs/architecture/coding-standards.md]

- **TypeScript Strict Mode:** All code uses strict type checking
- **Interface Naming:** `AptosPaymentChannel` (PascalCase)
- **Method Naming:** `openAptosPaymentChannel()`, `claimAptosChannel()` (camelCase)
- **Logger Usage:** Use Pino logger exclusively, never `console.log`
- **Error Handling:** All async functions use try-catch with proper error logging
- **Buffer Usage:** Use `Buffer` for binary data (Node.js convention)

**Endpoint Naming Convention:**

Follow existing pattern: `/xrp-channels/*` → `/aptos-channels/*`

**Amount Serialization:**

- Serialize bigint as string in JSON responses: `deposited: channel.deposited.toString()`
- Parse bigint from string in requests: `BigInt(data.amount)`
- Display in APT units: `(Number(octas) / 100_000_000).toFixed(8)`

### Technical Constraints

**Aptos Address Format:**

[Source: Aptos documentation, Epic 13]

- Format: 0x-prefixed hex string, 64 characters (32 bytes)
- Example: `0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef`
- SDK normalizes addresses to lowercase with full padding

**ED25519 Signature Format:**

- Aptos uses ED25519 signatures (not ECDSA like EVM/XRP)
- Signature format: 128-character hex string (64 bytes)
- Public key format: 64-character hex string (32 bytes)

**Channel Identification:**

- Unlike EVM (bytes32 channelId) or XRP (transaction hash), Aptos channels are identified by the owner address
- Only one channel per owner-destination pair is allowed by the Move module

**SDK Initialization Order:**

1. Create Aptos client (connects to node)
2. Create claim signer (loads private key)
3. Create AptosChannelSDK (wraps client and signer)

### Risks and Mitigations

**Risk 1: AptosChannelSDK Not Available in Agent Server Context**

- **Risk:** SDK imports may fail if settlement module not in agent server bundle
- **Probability:** Low (same package)
- **Mitigation:** Verify imports work, use dynamic import if needed
- **Impact:** Low - can add conditional import

**Risk 2: Channel ID Collision with URL Path Parsing**

- **Risk:** Channel owner addresses starting with "claim" or "close" could conflict with endpoint paths
- **Probability:** Very Low (addresses are hex)
- **Mitigation:** Order endpoint handlers correctly (specific paths before :id pattern)
- **Impact:** Minimal - proper ordering prevents issue

**Risk 3: Telemetry Event Schema Mismatch**

- **Risk:** `AGENT_CHANNEL_OPENED` event may not support `chain: 'aptos'`
- **Probability:** Low (event schema is flexible)
- **Mitigation:** Verify telemetry event types support 'aptos' chain value
- **Impact:** Low - add 'aptos' to chain union type if needed

### Out of Scope for Story 14.1

**Explicitly NOT included in this story:**

1. **Test Runner Phases** - Story 14.2 implements Aptos test phases
2. **Docker Image Build** - Story 14.3 builds multi-arch Aptos image
3. **Integration with docker-compose** - Story 14.4 updates test infrastructure
4. **Production Settlement Flow** - Story 14.5 integrates with connector settlement
5. **Aptos Faucet Integration** - Test runner (28.2) handles funding
6. **Move Module Deployment** - Already deployed in Epic 13
7. **Aptos Balance Querying via REST** - Simplified for MVP (placeholder in getBalances)

### Success Criteria

**Story 14.1 is successful when:**

1. ✅ `GET /aptos-channels` returns list of Aptos channels
2. ✅ `POST /aptos-channels/open` opens channel via SDK
3. ✅ `GET /aptos-channels/:id` returns specific channel state
4. ✅ `POST /aptos-channels/claim` submits claim to chain
5. ✅ `POST /aptos-channels/close` requests channel close
6. ✅ `POST /configure-aptos` configures Aptos at runtime
7. ✅ Environment variables configure Aptos integration
8. ✅ Aptos channels integrated with balance tracking
9. ✅ Telemetry events emitted for channel operations
10. ✅ `/status` includes Aptos fields
11. ✅ `/balances` includes Aptos balance and channels
12. ✅ All unit tests pass

**Quality Metrics:**

- Unit test coverage > 80% for new Aptos endpoint code
- All endpoints follow existing EVM/XRP patterns
- No TypeScript compilation errors
- ESLint passes without errors

## Dev Agent Record

_To be filled in by implementing agent_

### Agent Model Used

### Implementation Summary

### File List

### Completion Notes

### Debug Log References

## QA Results

### Review Date: 2026-01-31

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment: EXCELLENT**

The implementation of Story 14.1 demonstrates high-quality code that follows established patterns consistently. The Aptos payment channel HTTP endpoints mirror the existing EVM and XRP patterns exactly, maintaining architectural consistency across all three blockchain integrations.

**Strengths:**

1. **Pattern Consistency** - All Aptos endpoints (`/aptos-channels/*`) mirror the exact patterns used for EVM (`/channels/*`) and XRP (`/xrp-channels/*`) endpoints
2. **Type Safety** - Proper TypeScript interfaces defined for `AptosPaymentChannel`, configuration extensions, and request/response types
3. **Telemetry Integration** - Full integration with telemetry events (`AGENT_CHANNEL_OPENED`, `AGENT_CHANNEL_BALANCE_UPDATE`) including proper `chain: 'aptos'` typing
4. **Error Handling** - Consistent try-catch patterns with proper Pino logging throughout all Aptos methods
5. **Graceful Degradation** - Aptos initialization failures don't crash the server; Aptos is optional and can be configured at runtime
6. **Proper Cleanup** - `shutdown()` method properly clears Aptos state and disconnects client

### Refactoring Performed

No refactoring was performed. The implementation was well-structured and follows project patterns.

### Compliance Check

- Coding Standards: ✓ TypeScript strict mode, proper interface naming (PascalCase), method naming (camelCase), Pino logger usage
- Project Structure: ✓ All code in correct locations per source tree
- Testing Strategy: ✓ Unit tests cover interface contracts and serialization behavior
- All ACs Met: ✓ All 12 acceptance criteria fully implemented

**AC Coverage Verification:**
| AC# | Requirement | Status | Evidence |
|-----|-------------|--------|----------|
| 1 | GET /aptos-channels | ✓ | agent-server.ts:797-809 |
| 2 | POST /aptos-channels/open | ✓ | agent-server.ts:813-829 |
| 3 | GET /aptos-channels/:id | ✓ | agent-server.ts:833-882 |
| 4 | POST /aptos-channels/claim | ✓ | agent-server.ts:886-897 |
| 5 | POST /aptos-channels/close | ✓ | agent-server.ts:901-907 |
| 6 | POST /configure-aptos | ✓ | agent-server.ts:769-793 |
| 7 | Environment variables | ✓ | agent-server.ts:224-228 |
| 8 | updateChannelBalanceForPeer integration | ✓ | agent-server.ts:1401-1416 |
| 9 | Telemetry events | ✓ | agent-server.ts:1826-1835 |
| 10 | /status includes Aptos fields | ✓ | agent-server.ts:577-587 |
| 11 | /balances includes Aptos data | ✓ | agent-server.ts:2236-2277 |
| 12 | Unit tests | ✓ | agent-server-aptos.test.ts (18 tests passing) |

### Improvements Checklist

All items completed - no outstanding issues:

- [x] AptosPaymentChannel interface defined (agent-server.ts:103-112)
- [x] AgentServerConfig extended with Aptos fields (agent-server.ts:73-78)
- [x] PeerConnection extended with aptosAddress (agent-server.ts:120)
- [x] AddFollowRequest extended with aptosAddress (agent-server.ts:135)
- [x] initializeAptos() method implemented (agent-server.ts:429-471)
- [x] All 6 HTTP endpoints implemented
- [x] Telemetry events properly typed with 'aptos' chain value
- [x] Balance tracking integrated via updateChannelBalanceForPeer()
- [x] Proper shutdown cleanup implemented (agent-server.ts:511-517)
- [x] Unit tests cover all interface contracts

### Security Review

**Security Status: PASS**

- Private key handling follows existing patterns (environment variable, not logged)
- No direct exposure of private keys in API responses
- Channel owner addresses properly validated before operations
- Error messages don't leak sensitive information
- Follows same security patterns as EVM/XRP implementations

### Performance Considerations

**Performance Status: PASS**

- Local channel state caching (Map) avoids redundant chain queries
- Lazy initialization - Aptos SDK only created when needed
- Consistent with existing EVM/XRP patterns

### Files Modified During Review

No files modified during this review.

### Gate Status

Gate: **PASS** → docs/qa/gates/28.1-add-agent-server-aptos-http-endpoints.yml

### Recommended Status

✓ **Ready for Done** - All acceptance criteria met, tests passing, code quality excellent

## Change Log

| Date       | Version | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | Author                        |
| ---------- | ------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ----------------------------- |
| 2026-01-31 | 1.0     | Initial story creation with comprehensive technical details from Epic 14 requirements, agent-server.ts patterns (EVM/XRP endpoints), AptosChannelSDK from Epic 13, coding standards, and testing strategy. Story focuses on adding Aptos HTTP endpoints mirroring existing payment channel patterns.                                                                                                                                                                                       | Claude (Story Creation Agent) |
| 2026-01-31 | 1.1     | Validation fixes: (1) Task 5: Added telemetry event type verification subtask for chain: 'aptos'; (2) Task 7: Fixed public key handling - now fetches destinationPubkey from channel state before claim submission; (3) Task 9: Added explicit return type update to include 'aptos' in union; (4) Task 10: Replaced placeholder with proper IAptosClient.getBalance() implementation; (5) Tasks 1,2,12: Added aptosClient property for balance queries and proper disconnect on shutdown. | Claude (QA Validation)        |
