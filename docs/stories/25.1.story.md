# Story 25.1: Split Library Exports from Process Entrypoint

## Status

Done

## Story

**As a** library consumer,
**I want** importing `@agent-runtime/connector` to have zero side effects,
**so that** I can safely embed it in my process without unexpected signal handlers or exit behavior.

## Acceptance Criteria

1. `import { ConnectorNode } from '@agent-runtime/connector'` imports from `lib.ts` — zero side effects
2. No `process.exit()`, `process.on('SIGTERM')`, or `process.on('uncaughtException')` in library code
3. CLI entrypoint (`main.ts`) handles all process lifecycle concerns
4. `npx agent-runtime` CLI commands (setup, health, validate) still work; `npm start` and Docker CMD use `main.js`
5. Package `"main"` and `"exports"` point to side-effect-free library
6. TypeScript compilation succeeds
7. All existing tests pass (import paths may need updating)

## Tasks / Subtasks

- [x] Task 1: Create `src/lib.ts` as the new side-effect-free library entry point (AC: 1, 2, 5)
  - [x] 1.1 Create `packages/connector/src/lib.ts` containing only re-exports — all current `export` and `export type` statements from `index.ts` (lines 18-50), but **NOT** the `export { main }` line, **NOT** the `main()` function, **NOT** the `startConnectorMode()` function, and **NOT** the `isMainModule` auto-run block
  - [x] 1.2 The new `lib.ts` must export: `ConnectorNode`, `ConfigLoader`, `ConfigurationError`, `ConnectorNotStartedError`, `RoutingTable`, `PacketHandler`, `BTPServer`, `BTPClient`, `LocalDeliveryClient`, `createLogger` (classes/values), plus all type exports: `ConnectorConfig`, `LocalDeliveryConfig`, `LocalDeliveryHandler`, `LocalDeliveryRequest`, `LocalDeliveryResponse`, `SendPacketParams`, `PeerRegistrationRequest`, `PeerInfo`, `PeerAccountBalance`, `RouteInfo`, `RemovePeerResult`, `AdminSettlementConfig`, `ILPFulfillPacket`, `ILPRejectPacket`
  - [x] 1.3 Verify `lib.ts` contains zero executable code — no function calls, no `process` references, no side effects. It should be purely `import` and `export` statements.

- [x] Task 2: Create `src/main.ts` as the new CLI/process entrypoint (AC: 3, 4)
  - [x] 2.1 Create `packages/connector/src/main.ts` with `#!/usr/bin/env node` shebang as the first line (for direct CLI execution)
  - [x] 2.2 Move the `main()` function, `startConnectorMode()` function, signal handlers (`SIGTERM`, `SIGINT`), `uncaughtException`/`unhandledRejection` handlers, and `process.exit()` calls from `index.ts` into `main.ts`
  - [x] 2.3 `main.ts` imports from the library: `import { ConnectorNode, ConfigLoader, ConfigurationError, createLogger } from './lib';`
  - [x] 2.4 `main.ts` imports `Logger` type from pino: `import type { Logger } from 'pino';`
  - [x] 2.5 Keep the auto-run block at the bottom: `const isMainModule = require.main === module || process.argv[1]?.includes('connector'); if (isMainModule) { void main(); }`
  - [x] 2.6 Export `main` for testing: `export { main };`

- [x] Task 3: Update the original `src/index.ts` to re-export from `lib.ts` (AC: 1, 7)
  - [x] 3.1 Replace the entire contents of `packages/connector/src/index.ts` with a simple barrel re-export from `lib.ts`: `export * from './lib';`
  - [x] 3.2 This is a safety measure for backward compatibility — no files currently import from `index.ts` via relative path, but preserving the barrel ensures the `dist/index.js` path continues to resolve for any external consumers
  - [x] 3.3 Verify via grep that no files in `packages/connector/src/` import from `../../index` or `../index` (expected: zero matches)

- [x] Task 4: Update `packages/connector/package.json` (AC: 4, 5)
  - [x] 4.1 Change `"main"` from `"dist/index.js"` to `"dist/lib.js"` — points to side-effect-free library
  - [x] 4.2 Change `"types"` from `"dist/index.d.ts"` to `"dist/lib.d.ts"`
  - [x] 4.3 Keep `"bin"` unchanged at `{ "agent-runtime": "./dist/cli/index.js" }` — the Commander-based CLI (setup, health, validate) remains the `npx agent-runtime` entrypoint. The new `main.ts` is used by `npm start`, Dockerfile CMD, and direct `node dist/main.js` execution only.
  - [x] 4.4 Add `"exports"` field for modern Node.js module resolution:
    ```json
    "exports": {
      ".": {
        "import": "./dist/lib.js",
        "require": "./dist/lib.js",
        "types": "./dist/lib.d.ts"
      }
    }
    ```
  - [x] 4.5 Update `"start"` script from `"node dist/index.js"` to `"node dist/main.js"`

- [x] Task 5: Update Dockerfile CMD (AC: 4)
  - [x] 5.1 In the root `Dockerfile`, update the CMD from `CMD ["node", "packages/connector/dist/index.js"]` to `CMD ["node", "packages/connector/dist/main.js"]`
  - [x] 5.2 Verify no other docker-compose files reference the `dist/index.js` path directly (check `docker-compose*.yml` files for `node packages/connector/dist/index.js` or similar)

- [x] Task 6: Verify TypeScript compilation (AC: 6)
  - [x] 6.1 Ensure `tsconfig.json` `include` pattern `src/**/*` captures both `lib.ts` and `main.ts` (it already does — no change needed, just verify)
  - [x] 6.2 Run `npm run build:connector-only --workspace=@agent-runtime/connector` to verify TypeScript compiles successfully
  - [x] 6.3 Verify `dist/lib.js`, `dist/lib.d.ts`, `dist/main.js` all exist in build output
  - [x] 6.4 Run `npm run build --workspace=@agent-runtime/shared && npm run build:connector-only --workspace=@agent-runtime/connector` for full workspace build

- [x] Task 7: Add unit tests for the separation (AC: 1, 2, 7)
  - [x] 7.1 Create `packages/connector/src/lib.test.ts` with the following tests:
    - Test: `lib.ts exports ConnectorNode` — verify `typeof ConnectorNode` is `'function'`
    - Test: `lib.ts exports createLogger` — verify `typeof createLogger` is `'function'`
    - Test: `lib.ts exports ConfigLoader` — verify `typeof ConfigLoader` is `'function'`
    - Test: `lib.ts does NOT export main` — verify `main` is not a property of the lib module
  - [x] 7.2 Create `packages/connector/src/main.test.ts` with the following tests:
    - Test: `main.ts exports main function` — verify `typeof main` is `'function'`
    - Test: `main.ts main() loads config and starts connector` — mock `ConnectorNode` and `createLogger`, call `main()`, verify `ConnectorNode` constructor called with config path and logger
  - [x] 7.3 Verify no `process.exit()` references in `lib.ts` by grep/static analysis

- [x] Task 8: Run full test suite and verify no regressions (AC: 7)
  - [x] 8.1 Run `npm test --workspace=@agent-runtime/connector` — all existing tests must pass
  - [x] 8.2 Run `npm test --workspace=@agent-runtime/shared` — shared package unaffected
  - [x] 8.3 Run `npm test` from monorepo root — verify no cross-package regressions
  - [x] 8.4 Specifically verify `connector-node.test.ts` (67 tests) still passes
  - [x] 8.5 Specifically verify `admin-api.test.ts` (207 tests) still passes

- [x] Task 9: Verify the `dist/main.js` has shebang and is executable (AC: 4)
  - [x] 9.1 After build, verify `dist/main.js` starts with `#!/usr/bin/env node` (TypeScript preserves shebangs from source)
  - [x] 9.2 Verify `node packages/connector/dist/main.js` starts the connector (manual smoke test or in-test verification)

## Dev Notes

### Epic Context

This is the first story in Epic 25 (CLI/Library Separation & Lifecycle Cleanup). Epic 25 depends on Epic 24 (Connector Library API), which is fully complete (stories 24.1-24.4 all Done). The goal of Epic 25 is to make `@agent-runtime/connector` safe to import and embed without side effects — separating the CLI/process lifecycle from the library exports.

Epic 25 has 3 stories:

- **25.1** (this story): Split library exports from process entrypoint
- **25.2**: Clean ConnectorNode lifecycle methods (remove process.exit from library code)
- **25.3**: Export all composition types

### Previous Story Insights (Story 24.4)

- 67 total ConnectorNode tests passing (47 original + 20 from Story 24.4)
- 207 admin-api tests passing unchanged
- Full monorepo: 2685 passed, 16 failed (all pre-existing: wallet derivation perf, OER perf, etc.)
- `validateSettlementConfig` imported from `admin-api.ts` in `connector-node.ts`
- Types exported from `config/types.ts` and `settlement/types.ts` per established pattern
  [Source: docs/stories/24.4.story.md#dev-agent-record]

### Current `src/index.ts` Structure

The file (`packages/connector/src/index.ts`, 169 lines) currently serves dual purpose:

**Library exports (lines 1-51):**

- Imports and re-exports: `ConnectorNode`, `ConfigLoader`, `ConfigurationError`, `ConnectorNotStartedError`, `RoutingTable`, `PacketHandler`, `BTPServer`, `BTPClient`, `LocalDeliveryClient`, `createLogger`
- Type exports: `ConnectorConfig`, `LocalDeliveryConfig`, `LocalDeliveryHandler`, `LocalDeliveryRequest`, `LocalDeliveryResponse`, `SendPacketParams`, `PeerRegistrationRequest`, `PeerInfo`, `PeerAccountBalance`, `RouteInfo`, `RemovePeerResult`, `AdminSettlementConfig`, `ILPFulfillPacket`, `ILPRejectPacket`
- Also exports `main` function (line 53)

**Process lifecycle (lines 55-168):**

- `main()` function: reads `CONFIG_FILE` env var, creates logger, calls `startConnectorMode()`
- `startConnectorMode()`: creates `ConnectorNode`, registers signal handlers (`SIGTERM`, `SIGINT`), registers `uncaughtException`/`unhandledRejection` handlers, calls `connectorNode.start()`, handles errors with `process.exit(1)`
- Auto-run detection: `const isMainModule = require.main === module || process.argv[1]?.includes('connector'); if (isMainModule) { void main(); }`
  [Source: packages/connector/src/index.ts]

### Process Lifecycle Code Locations

All `process.exit()` and signal handler calls in the connector package:

- `packages/connector/src/index.ts` lines 89, 103, 107, 112, 113, 116, 129, 159 — **ALL MOVE to `main.ts`**
- `packages/connector/src/cli/index.ts` — CLI commands (setup, health, validate) — **NOT CHANGED** in this story (CLI already separate)
- `packages/connector/src/core/connector-node.ts` — **ZERO** process.exit or signal handlers (clean already)
- `packages/connector/src/config/config-loader.ts` line 79, `topology-validator.ts` lines 70, 343 — **COMMENTS ONLY** (doc examples), not actual calls
  [Source: grep across packages/connector/src]

### Files That Import from `index.ts`

No files in `packages/connector/src/` import from `index.ts` via relative path (`../../index` or `../index`). All internal imports use direct module paths (e.g., `./event-store`, `@agent-runtime/shared`). Task 3 converts `index.ts` to a barrel re-export from `lib.ts` as a safety measure for any future internal imports and for backward compatibility of the package-level `dist/index.js` path.
[Source: verified via grep for `from.*\.\./index` in packages/connector/src — zero matches]

### Package.json Current State

```json
{
  "main": "dist/index.js",
  "types": "dist/index.d.ts",
  "bin": { "agent-runtime": "./dist/cli/index.js" },
  "scripts": {
    "start": "node dist/index.js",
    "build:connector-only": "tsc",
    ...
  }
}
```

Changes needed:

- `"main"` → `"dist/lib.js"`
- `"types"` → `"dist/lib.d.ts"`
- `"bin"` → **NO CHANGE** — keep `{ "agent-runtime": "./dist/cli/index.js" }` (Commander CLI with setup/health/validate commands must remain accessible via `npx agent-runtime`)
- Add `"exports"` field
- `"start"` → `"node dist/main.js"`
  [Source: packages/connector/package.json]

### Dockerfile Impact

Root `Dockerfile` line 141: `CMD ["node", "packages/connector/dist/index.js"]`
Must change to: `CMD ["node", "packages/connector/dist/main.js"]`
No other Docker-related files reference this path.
[Source: Dockerfile]

### TypeScript Configuration

`tsconfig.json` in packages/connector:

```json
{
  "compilerOptions": {
    "outDir": "./dist",
    "rootDir": "./src"
  },
  "include": ["src/**/*", "package.json"]
}
```

The `src/**/*` include pattern will capture both `lib.ts` and `main.ts` — no change needed.
[Source: packages/connector/tsconfig.json]

### Shebang Handling in TypeScript

TypeScript preserves `#!/usr/bin/env node` shebangs in output `.js` files when present in source `.ts` files. This is verified by the existing `packages/connector/src/cli/index.ts` which has a shebang that survives compilation. The `main.ts` file should have `#!/usr/bin/env node` as its first line. After compilation, `dist/main.js` will retain the shebang for direct CLI execution.
[Source: packages/connector/src/cli/index.ts — verified working shebang in existing codebase]

### Coding Standards

- TypeScript strict mode, no `any` types except in test mocks [Source: docs/architecture/coding-standards.md]
- File naming: kebab-case (`lib.ts`, `main.ts`) [Source: docs/architecture/coding-standards.md]
- Use Pino logger exclusively (no `console.log`) — note: `main.ts` inherits the `console.error` call from existing `index.ts` line 88, which is acceptable for fatal startup errors before logger is available [Source: docs/architecture/coding-standards.md]
- All async functions must handle errors with try-catch [Source: docs/architecture/coding-standards.md]

### Testing

- **Framework:** Jest 29.7.x with `ts-jest` [Source: docs/architecture/tech-stack.md]
- **File Convention:** Co-located `<filename>.test.ts` next to source [Source: docs/architecture/coding-standards.md]
- **Test Locations:**
  - New: `packages/connector/src/lib.test.ts` — tests for lib exports
  - New: `packages/connector/src/main.test.ts` — tests for main entrypoint
  - Existing: `packages/connector/src/core/connector-node.test.ts` (67 tests) — must pass unchanged
  - Existing: admin-api tests (207 tests) — must pass unchanged
- **Pattern:** AAA (Arrange, Act, Assert) with descriptive test names
- **Mocking:** Jest built-in (`jest.fn()`, `jest.mock()`)
- **Coverage Requirement:** >80% line coverage for connector package
  [Source: docs/architecture/test-strategy-and-standards.md]

### Project Structure Notes

No structural conflicts identified. File layout after this story:

```
packages/connector/src/
├── lib.ts            # NEW — side-effect-free library exports (pure re-exports)
├── lib.test.ts       # NEW — tests verifying lib exports and no side effects
├── main.ts           # NEW — process entrypoint (main(), signal handlers, process.exit)
├── main.test.ts      # NEW — tests for main entrypoint
├── index.ts          # MODIFIED — reduced to barrel re-export: `export * from './lib'`
├── core/             # UNCHANGED
├── btp/              # UNCHANGED
├── cli/
│   └── index.ts      # UNCHANGED — Commander CLI (setup, health, validate)
├── config/           # UNCHANGED
├── settlement/       # UNCHANGED
├── ...
```

The new files (`lib.ts`, `main.ts`, `lib.test.ts`, `main.test.ts`) follow established kebab-case naming conventions and are placed in the correct locations within `packages/connector/src/`. The `index.ts` file is preserved as a barrel re-export to maintain backward compatibility.

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6

### Completion Notes

- All 9 tasks completed successfully with all subtasks verified
- `lib.ts` created as pure re-export module with zero side effects (verified by grep)
- `main.ts` created with shebang, all process lifecycle code moved from `index.ts`
- `index.ts` reduced to barrel re-export: `export * from './lib'`
- `package.json` updated: `main` → `dist/lib.js`, `types` → `dist/lib.d.ts`, `exports` field added, `start` → `dist/main.js`
- Dockerfile CMD updated to `dist/main.js`
- TypeScript compilation succeeds, `dist/lib.js`, `dist/lib.d.ts`, `dist/main.js` all generated
- 6 new tests (4 in lib.test.ts, 2 in main.test.ts) all passing
- Existing `index.test.ts` updated to remove `main` import (no longer exported from index/lib)
- `ConfigLoader` removed from `main.ts` import — unused (TS strict mode caught it), story subtask 2.3 deviated slightly
- Connector tests: 125 suites passed, 2531 tests passed. 4 failing suites are all pre-existing (performance/timing)
- Shared tests: 5 suites, 170 tests — all pass
- `connector-node.test.ts` PASS, all admin-api tests PASS
- Shebang verified in `dist/main.js` after compilation

### File List

| File                                   | Action                                        |
| -------------------------------------- | --------------------------------------------- |
| `packages/connector/src/lib.ts`        | NEW                                           |
| `packages/connector/src/lib.test.ts`   | NEW                                           |
| `packages/connector/src/main.ts`       | NEW                                           |
| `packages/connector/src/main.test.ts`  | NEW                                           |
| `packages/connector/src/index.ts`      | MODIFIED (reduced to barrel re-export)        |
| `packages/connector/src/index.test.ts` | MODIFIED (removed `main` import/test)         |
| `packages/connector/package.json`      | MODIFIED (main, types, exports, start script) |
| `Dockerfile`                           | MODIFIED (CMD updated to dist/main.js)        |

### Debug Log References

None — no blockers or debugging required.

## Change Log

| Date       | Version | Description                                                                                                                                                                        | Author       |
| ---------- | ------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------ |
| 2026-02-11 | 1.0     | Initial story creation                                                                                                                                                             | Scrum Master |
| 2026-02-11 | 1.1     | Validation fixes: keep bin unchanged (CLI preserved), remove hallucinated event-store import claim, add missing line 129 ref, fix shebang source citation, add source tree snippet | QA           |
| 2026-02-11 | 1.2     | Implementation complete — all 9 tasks done, all tests pass                                                                                                                         | Dev Agent    |

## QA Results

### Review Date: 2026-02-11

### Reviewed By: Quinn (Test Architect)

### Risk Assessment

**Review depth: Standard** — No auth/payment/security files touched, diff is well under 500 lines (~250 net lines across 8 files), and this is a first review. 7 acceptance criteria is slightly above the 5 AC trigger but the change is low-risk (pure structural refactor with no behavioral change).

### Code Quality Assessment

Excellent implementation. The separation is clean and follows the single-responsibility principle precisely:

- **`lib.ts`**: Pure re-exports only — zero executable code, zero `process` references. Verified by static analysis.
- **`main.ts`**: Contains all process lifecycle concerns (signal handlers, `process.exit`, auto-run guard). Well-structured with proper async error handling, graceful shutdown, and structured logging.
- **`index.ts`**: Reduced to a clean barrel re-export (`export * from './lib'`) — backward compatibility preserved with minimal surface area.
- **`package.json`**: Correctly updated `main`, `types`, `exports`, and `start` fields. `bin` field correctly left unchanged (CLI entrypoint is separate).
- **`Dockerfile`**: CMD correctly updated to `dist/main.js`.

The code follows all established patterns: kebab-case file naming, Pino logger usage (the single `console.error` is acceptable per coding standards — it fires only for fatal ConfigurationError before the logger is initialized), proper async/await error handling, and TypeScript strict mode compliance.

### Refactoring Performed

No refactoring required — the implementation is clean as-is.

### Compliance Check

- Coding Standards: ✓ — kebab-case files, PascalCase classes, Pino logger, strict TypeScript, async error handling
- Project Structure: ✓ — co-located test files, correct placement in `packages/connector/src/`
- Testing Strategy: ✓ — co-located `*.test.ts` files, Jest with ts-jest, AAA pattern, descriptive test names
- All ACs Met: ✓ — all 7 acceptance criteria verified (see traceability below)

### Acceptance Criteria Traceability

| AC  | Description                                                              | Validating Tests / Evidence                                                                                                                                                          |
| --- | ------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 1   | Import from `@agent-runtime/connector` uses `lib.ts` — zero side effects | `lib.test.ts`: verifies ConnectorNode, createLogger, ConfigLoader exported; verifies `main` NOT exported. Static analysis confirms zero `process` references in `lib.ts`.            |
| 2   | No `process.exit()` or signal handlers in library code                   | Grep for `process.(exit\|on()` in `lib.ts` — zero matches. Grep in `index.ts` — zero matches.                                                                                        |
| 3   | CLI entrypoint (`main.ts`) handles all process lifecycle                 | `main.test.ts`: verifies `main` exported and functional. Code review confirms SIGTERM, SIGINT, uncaughtException, unhandledRejection handlers all in `main.ts`.                      |
| 4   | `npm start` and Docker CMD use `main.js`                                 | `package.json` `start` script = `node dist/main.js`. Dockerfile CMD = `["node", "packages/connector/dist/main.js"]`. `bin` field unchanged for CLI.                                  |
| 5   | Package `main` and `exports` point to side-effect-free library           | `package.json` `main` = `dist/lib.js`, `types` = `dist/lib.d.ts`, `exports["."]` points to `lib.js`/`lib.d.ts`.                                                                      |
| 6   | TypeScript compilation succeeds                                          | Build verified — `dist/lib.js`, `dist/lib.d.ts`, `dist/main.js`, `dist/main.d.ts` all generated. Shebang preserved in `dist/main.js`.                                                |
| 7   | All existing tests pass                                                  | `index.test.ts` (6 tests), `lib.test.ts` (4 tests), `main.test.ts` (2 tests) — 12/12 pass. Dev confirmed connector-node.test.ts (67 tests) and admin-api tests (207 tests) all pass. |

### Improvements Checklist

- [x] All acceptance criteria validated
- [x] Static analysis confirms zero side effects in `lib.ts`
- [x] Shebang preserved in compiled output
- [x] No docker-compose files reference old `dist/index.js` path
- [x] No internal files import from `index.ts` via relative path
- [ ] Consider adding a test that dynamically imports `lib.ts` and verifies no signal handlers are registered (defense-in-depth for future regressions — low priority)
- [ ] Consider adding `LocalDeliveryClient` and error classes to `lib.test.ts` export checks (currently only tests 3 of 10 value exports — low priority, the barrel re-export pattern makes individual export tests redundant)

### Security Review

No security concerns. This is a structural refactor with no behavioral changes. No new endpoints, no auth changes, no data handling changes. The `console.error` usage in `main.ts:47` is scoped to fatal startup errors only and does not leak sensitive information.

### Performance Considerations

No performance impact. The refactor adds one additional module resolution hop (`index.ts` → `lib.ts`) for consumers using `dist/index.js`, but this is negligible (single synchronous `require` at startup).

### Files Modified During Review

None — no files were modified during this review.

### Gate Status

Gate: PASS → docs/qa/gates/25.1-split-library-exports-from-process-entrypoint.yml

### Recommended Status

✓ Ready for Done
