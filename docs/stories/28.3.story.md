# Story 28.3: Test Suite Compatibility & Documentation

**Epic:** 28 - In-Memory Ledger: Zero-Dependency Accounting
**Story Number:** 28.3
**Status:** Done

## Story Statement

**As a** connector developer,
**I want** all existing AccountManager tests to pass using InMemoryLedgerClient, test helpers updated to use it by default, and documentation reflecting the new default backend,
**so that** the codebase is fully consistent with the in-memory ledger as the default accounting backend, the `tigerbeetle-node` native addon is truly optional, and CI passes without it installed.

## Prerequisites

**Story Dependencies:**

- Story 28.1 (InMemoryLedgerClient implementation) — COMPLETED: Provides the `InMemoryLedgerClient` class
- Story 28.2 (Integrate InMemoryLedgerClient as default backend) — COMPLETED: Wires InMemoryLedgerClient into ConnectorNode factory, removes NoOp stub

**Epic Dependencies:**

- Epic 6 (settlement foundation) — COMPLETED: Provides `AccountManager`, `TigerBeetleClient`, and settlement infrastructure
- Epic 26 (npm publishing readiness) — COMPLETED: Motivates removing native addon requirement
- Epic 27 (test optimization) — COMPLETED: TigerBeetle test cleanup complete

**Context:**
Stories 28.1 and 28.2 created the InMemoryLedgerClient and wired it into ConnectorNode. However, the `AccountManager` constructor still takes a concrete `TigerBeetleClient` type parameter (line 155 of `account-manager.ts`), and Story 28.2 used a type assertion (`as unknown as TigerBeetleClient`) to bridge the gap. The AccountManager unit tests still mock `TigerBeetleClient` via `jest.mock('./tigerbeetle-client')`. This story introduces a proper common interface (`ILedgerClient`), updates `AccountManager` to accept it, removes the type assertion from `connector-node.ts`, updates all test infrastructure to use `InMemoryLedgerClient` by default, and updates documentation.

## Acceptance Criteria

1. **All existing `AccountManager` unit tests pass using `ILedgerClient` interface mocks** — Tests in `account-manager.test.ts` and `account-manager-credit-limits.test.ts` must pass using `jest.Mocked<ILedgerClient>` instead of `jest.Mocked<TigerBeetleClient>`, without `jest.mock('./tigerbeetle-client')`. The interface change proves type compatibility with `InMemoryLedgerClient`; real `InMemoryLedgerClient` behavior is already verified by Story 28.2 integration tests.

2. **Test setup helpers updated to use `InMemoryLedgerClient` by default** — No TigerBeetle mock needed for AccountManager unit tests

3. **`docs/architecture/tech-stack.md` updated** — TigerBeetle row notes it is optional, in-memory ledger is the default

4. **Connector README updated with backend selection documentation** — `packages/connector/README.md` updated to explain both backends and how to select between them

5. **CI passes and `AccountManager` has no runtime `tigerbeetle-node` dependency** — Remove all `loadTigerBeetleSdk()` calls from `AccountManager` by replacing `sdk.AccountFlags.none` and `sdk.TransferFlags.none` with local constants (`0`). After this change, `AccountManager` has zero runtime `tigerbeetle-node` imports — only `import type` (erased at compile time). Note: CI has `tigerbeetle-node` in `devDependencies` (line 165 of connector `package.json`), so it is installed during `npm install`. This AC validates that the **in-memory code path** never calls `requireOptional('tigerbeetle-node')` at runtime.

6. **Existing tests that explicitly test TigerBeetle integration remain functional when `tigerbeetle-node` is available** — Integration tests in `packages/connector/test/integration/` that use real TigerBeetle are unchanged

## Dev Notes

### Previous Story Insights (28.1, 28.2)

**From Story 28.1:**

- `InMemoryLedgerClient` is at `packages/connector/src/settlement/in-memory-ledger-client.ts`
- Implements all 6 methods matching `TigerBeetleClient` public API: `initialize()`, `close()`, `createAccountsBatch()`, `createTransfersBatch()`, `getAccountBalance()`, `getAccountsBatch()`
- Reuses `TigerBeetleConnectionError`, `TigerBeetleAccountError`, `TigerBeetleTransferError` error classes from `tigerbeetle-errors.ts`
- Zero runtime dependency on `tigerbeetle-node` — only `import type` for `AccountBalance`
- `AccountBalance` type is re-exported from `tigerbeetle-client.ts`
- 29/29 unit tests pass

**From Story 28.2:**

- `ConnectorNode._createInMemoryAccountManager()` uses `inMemoryClient as unknown as TigerBeetleClient` type assertion (line 1262 of `connector-node.ts`) — this story removes that by introducing a common interface
- The QA review recommended: "Consider extracting ledger backend selection logic to a separate factory class" — this is out of scope for this story but noted for future work
- All integration tests pass

### Common Interface Design — `ILedgerClient`

The key change in this story is introducing a common interface that both `TigerBeetleClient` and `InMemoryLedgerClient` implement. `AccountManager` only uses 3 methods on its `_tigerBeetleClient` dependency:

1. `createAccountsBatch(accounts)` — Line 317 of `account-manager.ts`
2. `getAccountsBatch(accountIds)` — Line 523 of `account-manager.ts`
3. `createTransfersBatch(transfers)` — Lines 676, 979, 1256 of `account-manager.ts`

However, the full public API shared by both clients includes 6 methods (lifecycle + operations). The interface should include all 6 for completeness, since `ConnectorNode` calls `initialize()` and `close()` directly on the client.

**Interface definition** (new file: `packages/connector/src/settlement/ledger-client.ts`):

```typescript
import type { AccountBalance } from './tigerbeetle-client';

/**
 * Common interface for accounting ledger backends.
 * Implemented by TigerBeetleClient and InMemoryLedgerClient.
 */
export interface ILedgerClient {
  initialize(): Promise<void>;
  close(): Promise<void>;
  createAccountsBatch(
    accounts: Array<{ id: bigint; ledger: number; code: number; flags?: number }>
  ): Promise<void>;
  createTransfersBatch(
    transfers: Array<{
      id: bigint;
      debit_account_id: bigint;
      credit_account_id: bigint;
      amount: bigint;
      [key: string]: unknown;
    }>
  ): Promise<void>;
  getAccountBalance(accountId: bigint): Promise<AccountBalance>;
  getAccountsBatch(accountIds: bigint[]): Promise<Map<bigint, AccountBalance>>;
}
```

**Transfer type in the interface:** The `createTransfersBatch` parameter uses an inline structural type that is compatible with both the `tigerbeetle-node` `Transfer` type and `InMemoryTransfer`. This avoids importing `tigerbeetle-node` in the interface file. The `[key: string]: unknown` index signature ensures structural compatibility with the full `Transfer` type from `tigerbeetle-node`.

**Re-export `AccountBalance`:** The `AccountBalance` type is currently defined in `tigerbeetle-client.ts` (lines 64-68). The interface file should re-export it from there. Alternatively, move `AccountBalance` to `ledger-client.ts` as the canonical location and have `tigerbeetle-client.ts` import from there — but this creates a circular dependency risk. Safest approach: keep `AccountBalance` in `tigerbeetle-client.ts` and import it in `ledger-client.ts`.

[Source: `packages/connector/src/settlement/tigerbeetle-client.ts`, lines 64-68, 80+]
[Source: `packages/connector/src/settlement/in-memory-ledger-client.ts`, lines 28-34]
[Source: `packages/connector/src/settlement/account-manager.ts`, lines 153-156]

### Eliminating `loadTigerBeetleSdk()` from AccountManager (AC: 5)

**Problem:** `AccountManager` has runtime calls to `loadTigerBeetleSdk()` (which invokes `requireOptional('tigerbeetle-node')`) in methods that execute **regardless of which ledger backend is injected**. If `tigerbeetle-node` is not installed, `requireOptional()` throws an error (see `packages/connector/src/utils/optional-require.ts`, lines 20-21). This breaks the zero-dependency promise for npm consumers.

**Affected call sites in `account-manager.ts`:**

- Line 610: `recordPacketTransfer()` — uses `tbSdk.TransferFlags.none` (lines 652, 670)
- Line 919: `recordSettlement()` — uses `tbSdk.TransferFlags.none` (line 955)
- Line 1041: `_buildAccountObject()` — uses `sdk.AccountFlags.none` (line 1056)

**Root cause:** These methods use `tbSdk.TransferFlags.none` and `sdk.AccountFlags.none` to set flags on account/transfer objects. These are simple numeric values — both are `0`.

**Fix:** Replace all `loadTigerBeetleSdk()` calls and `tbSdk`/`sdk` flag references in `AccountManager` with local constants:

```typescript
// Local constants replacing runtime tigerbeetle-node SDK access
// Both AccountFlags.none and TransferFlags.none are 0 in tigerbeetle-node
const ACCOUNT_FLAGS_NONE = 0;
const TRANSFER_FLAGS_NONE = 0;
```

Then replace:

- `const tbSdk = await loadTigerBeetleSdk();` → remove
- `tbSdk.TransferFlags.none` → `TRANSFER_FLAGS_NONE`
- `sdk.AccountFlags.none` → `ACCOUNT_FLAGS_NONE`

Also remove the module-level `loadTigerBeetleSdk()` function (lines 26-35) and `_tbSdk` cache variable (line 26), and remove `import { requireOptional } from '../utils/optional-require';` (line 23) if no other usage remains.

**Impact on tests:** The unit tests call `createPeerAccounts()` 15+ times in `account-manager.test.ts`, which internally calls `_buildAccountObject()` → `loadTigerBeetleSdk()`. After this fix, that code path no longer loads the SDK, so no test mock for `loadTigerBeetleSdk` is needed.

**Important:** The `_convertToBatchWriterTransfer` method (line 1284) returns objects typed as `Transfer` (from `import type { Transfer } from 'tigerbeetle-node'`). This is a type-only import, erased at compile time — no runtime dependency. The method is only called by `_createTransferFn` which is bound to `TigerBeetleBatchWriter`. The batch writer path still works because `_ledgerClient.createTransfersBatch()` accepts the structural type.

[Source: `packages/connector/src/utils/optional-require.ts`, lines 7-25]
[Source: `packages/connector/src/settlement/account-manager.ts`, lines 22-35, 610, 652, 670, 919, 955, 1041, 1056]

### AccountManager Constructor Update

**Current** (line 155 of `account-manager.ts`):

```typescript
constructor(
  config: AccountManagerConfig,
  private readonly _tigerBeetleClient: TigerBeetleClient,
  private readonly _logger: Logger
)
```

**After:**

```typescript
constructor(
  config: AccountManagerConfig,
  private readonly _ledgerClient: ILedgerClient,
  private readonly _logger: Logger
)
```

**Rename the private field** from `_tigerBeetleClient` to `_ledgerClient` throughout `account-manager.ts`. All call sites use the same 3 methods, so the rename is a find-and-replace. Key locations where `this._tigerBeetleClient` is referenced (grep-verified):

- Line 155: Constructor parameter declaration
- Line 317: `createAccountsBatch` call
- Line 523: `getAccountsBatch` call
- Line 676: `createTransfersBatch` call (in `recordPacketTransfer`)
- Line 979: `createTransfersBatch` call (in `recordSettlement` batch path)
- Line 1256: `createTransfersBatch` call (in `_createTransferFn`)

**`TigerBeetleBatchWriter` note:** `TigerBeetleBatchWriter` is defined in a **separate file** (`packages/connector/src/settlement/tigerbeetle-batch-writer.ts`) and does NOT directly reference `_tigerBeetleClient`. It receives a function reference via `this._createTransferFn.bind(this)` (line 173 of `account-manager.ts`). The `_createTransferFn` method (line 1250) calls `this._tigerBeetleClient.createTransfersBatch()` — renaming the field to `_ledgerClient` will update this reference. **No changes to `tigerbeetle-batch-writer.ts` are needed.**

**Import changes in `account-manager.ts`:**

- Remove: `import { TigerBeetleClient } from './tigerbeetle-client';`
- Add: `import { ILedgerClient } from './ledger-client';`
- Keep: `import type { Transfer } from 'tigerbeetle-node';` — this is used in `_createTransferFn()` method which builds TigerBeetle `Transfer` objects. However, since `ILedgerClient.createTransfersBatch()` accepts the structural type, the `Transfer` import may need to change to a structural type. Check usage carefully.

**Important:** `account-manager.ts` line 22 has `import type { Transfer } from 'tigerbeetle-node'` which is used at lines 668-675 to construct transfer objects passed to `createTransfersBatch()`. Since this is a `type`-only import, it won't break at runtime even if `tigerbeetle-node` is not installed (TypeScript erases type-only imports during compilation). Verify this is true with `"isolatedModules": true` in tsconfig.

[Source: `packages/connector/src/settlement/account-manager.ts`, lines 22, 38, 153-156, 317, 523, 676]

### ConnectorNode Type Assertion Removal

**Current** (line 1262 of `connector-node.ts`):

```typescript
inMemoryClient as unknown as TigerBeetleClient,
```

**After:**

```typescript
inMemoryClient,
```

Since `AccountManager` will accept `ILedgerClient`, and `InMemoryLedgerClient` implements `ILedgerClient`, no type assertion is needed.

Also update the TigerBeetle path where `TigerBeetleClient` is passed to `AccountManager` — no change needed there since `TigerBeetleClient` will also implement `ILedgerClient`.

**ConnectorNode import changes:**

- Add: `import { ILedgerClient } from '../settlement/ledger-client';` (if needed for type annotations)
- The `_inMemoryLedgerClient` field type stays as `InMemoryLedgerClient | null` (concrete type is fine for the field)

[Source: `packages/connector/src/core/connector-node.ts`, line 1262]

### Implementing `ILedgerClient` on Both Clients

**`TigerBeetleClient`:** Add `implements ILedgerClient` to the class declaration:

```typescript
export class TigerBeetleClient implements ILedgerClient {
```

This should compile without changes since it already has all 6 methods with matching signatures. However, verify the `createTransfersBatch(transfers: Transfer[])` parameter type — the interface uses the structural type, while TigerBeetle uses the `Transfer` type from `tigerbeetle-node`. TypeScript structural typing should make this compatible (the `Transfer` type has all the required fields plus more), but verify.

**`InMemoryLedgerClient`:** Add `implements ILedgerClient` to the class declaration:

```typescript
export class InMemoryLedgerClient implements ILedgerClient {
```

Again, should compile without changes since it already has all 6 methods.

[Source: `packages/connector/src/settlement/tigerbeetle-client.ts`, line 80]
[Source: `packages/connector/src/settlement/in-memory-ledger-client.ts`]

### AccountManager Unit Test Updates

#### `account-manager.test.ts` (423 lines)

**Current approach:**

- Line 15: `jest.mock('./tigerbeetle-client');`
- Lines 37-40: Creates mock via `new TigerBeetleClient(config, logger) as jest.Mocked<TigerBeetleClient>`
- Uses `jest.fn()` on mock methods

**New approach:**

- Remove `jest.mock('./tigerbeetle-client')` entirely
- Create a real `InMemoryLedgerClient` instance in `beforeEach`:

  ```typescript
  import { InMemoryLedgerClient } from './in-memory-ledger-client';

  let ledgerClient: InMemoryLedgerClient;

  beforeEach(async () => {
    ledgerClient = new InMemoryLedgerClient(
      {
        snapshotPath: path.join(os.tmpdir(), `am-test-${Date.now()}.json`),
        persistIntervalMs: 60000,
      },
      pino({ level: 'silent' })
    );
    await ledgerClient.initialize();
  });

  afterEach(async () => {
    await ledgerClient.close();
    // Clean up snapshot file
  });
  ```

- Pass `ledgerClient as ILedgerClient` (or just `ledgerClient`) to `AccountManager` constructor
- **Key consideration:** Some tests mock specific return values on `getAccountsBatch` or `createAccountsBatch`. With a real `InMemoryLedgerClient`, tests must set up actual account/transfer state instead of mocking return values. This is a significant change — review each test case to determine if it needs state setup rather than mock setup.

**Alternative approach (lower risk):** Instead of using a real `InMemoryLedgerClient`, create a mock that satisfies `ILedgerClient` instead of `TigerBeetleClient`. This preserves the existing test patterns:

```typescript
const mockLedgerClient: jest.Mocked<ILedgerClient> = {
  initialize: jest.fn().mockResolvedValue(undefined),
  close: jest.fn().mockResolvedValue(undefined),
  createAccountsBatch: jest.fn().mockResolvedValue(undefined),
  createTransfersBatch: jest.fn().mockResolvedValue(undefined),
  getAccountBalance: jest.fn(),
  getAccountsBatch: jest.fn().mockResolvedValue(new Map()),
};
```

**Recommended approach:** Use the mock `ILedgerClient` approach (lower risk, preserves existing test patterns). The mock targets the same interface that `InMemoryLedgerClient` implements, proving type compatibility. The integration tests (from Story 28.2) already verify real `InMemoryLedgerClient` behavior.

[Source: `packages/connector/src/settlement/account-manager.test.ts`, lines 15-44]

#### `account-manager-credit-limits.test.ts` (459 lines)

**Current approach:**

- Line 16: `jest.mock('./tigerbeetle-client');`
- Lines 25-29: Creates plain mock object cast to `jest.Mocked<TigerBeetleClient>`

**New approach:**

- Remove `jest.mock('./tigerbeetle-client')`
- Replace `jest.Mocked<TigerBeetleClient>` with `jest.Mocked<ILedgerClient>`
- Update mock object to include all 6 `ILedgerClient` methods
- No other test logic changes needed

[Source: `packages/connector/src/settlement/account-manager-credit-limits.test.ts`, lines 15-29]

### Documentation Updates

#### `docs/architecture/tech-stack.md`

Update the TigerBeetle row in the Technology Stack Table (line 32):

**Current:**

```
| **Database (Accounting)** | TigerBeetle | 0.x | Persistent balance tracking for agent wallets | High-performance distributed accounting, ACID guarantees, designed for financial workloads |
```

**After:**

```
| **Database (Accounting)** | In-memory ledger (default) / TigerBeetle (optional) | N/A / 0.x | Balance tracking for peer settlement | In-memory Map-based ledger is the zero-dependency default; TigerBeetle available as optional high-performance backend when `TIGERBEETLE_CLUSTER_ID` + `TIGERBEETLE_REPLICAS` env vars are set |
```

[Source: `docs/architecture/tech-stack.md`, line 32]

#### `packages/connector/README.md`

Add a new section after the Explorer UI section (around line 50) explaining accounting backend selection:

```markdown
## Accounting Backend

The connector uses a double-entry accounting ledger for balance tracking, settlement threshold detection, and claim signing.

### Default: In-Memory Ledger (Zero Dependencies)

By default, the connector uses a pure TypeScript in-memory ledger that requires no external services or native addons. Balances are persisted to a JSON snapshot file on a configurable interval and restored on restart.

| Variable                     | Default                       | Description               |
| ---------------------------- | ----------------------------- | ------------------------- |
| `LEDGER_SNAPSHOT_PATH`       | `./data/ledger-snapshot.json` | Snapshot file path        |
| `LEDGER_PERSIST_INTERVAL_MS` | `30000`                       | Persistence interval (ms) |

### Optional: TigerBeetle (High-Performance)

For production workloads requiring higher throughput, TigerBeetle can be enabled:

| Variable                 | Required | Description                       |
| ------------------------ | -------- | --------------------------------- |
| `TIGERBEETLE_CLUSTER_ID` | Yes      | TigerBeetle cluster identifier    |
| `TIGERBEETLE_REPLICAS`   | Yes      | Comma-separated replica addresses |

When both env vars are set, the connector uses TigerBeetle. If TigerBeetle initialization fails, it falls back to the in-memory ledger automatically.
```

Also update line 11 of README.md:

- **Current:** `- Balance tracking with TigerBeetle`
- **After:** `- Balance tracking with in-memory ledger (default) or TigerBeetle (optional)`

[Source: `packages/connector/README.md`, lines 11, 50+]

### File Locations

| File                                                                      | Action     | Description                                                                                                                                                                                   |
| ------------------------------------------------------------------------- | ---------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `packages/connector/src/settlement/ledger-client.ts`                      | **Create** | `ILedgerClient` interface definition                                                                                                                                                          |
| `packages/connector/src/settlement/account-manager.ts`                    | **Modify** | Constructor param: `TigerBeetleClient` → `ILedgerClient`, rename `_tigerBeetleClient` → `_ledgerClient`, replace `loadTigerBeetleSdk()` with local constants, remove `requireOptional` import |
| `packages/connector/src/settlement/tigerbeetle-client.ts`                 | **Modify** | Add `implements ILedgerClient`                                                                                                                                                                |
| `packages/connector/src/settlement/in-memory-ledger-client.ts`            | **Modify** | Add `implements ILedgerClient`                                                                                                                                                                |
| `packages/connector/src/core/connector-node.ts`                           | **Modify** | Remove `as unknown as TigerBeetleClient` type assertion                                                                                                                                       |
| `packages/connector/src/settlement/account-manager.test.ts`               | **Modify** | Remove `jest.mock`, use `ILedgerClient` mock                                                                                                                                                  |
| `packages/connector/src/settlement/account-manager-credit-limits.test.ts` | **Modify** | Remove `jest.mock`, use `ILedgerClient` mock                                                                                                                                                  |
| `docs/architecture/tech-stack.md`                                         | **Modify** | Update TigerBeetle row                                                                                                                                                                        |
| `packages/connector/README.md`                                            | **Modify** | Add accounting backend section                                                                                                                                                                |

**Key methods in `account-manager.ts` that need `loadTigerBeetleSdk()` removal:**

- `_buildAccountObject()` (~line 1020) — builds account objects, uses `sdk.AccountFlags.none`. Called by `createPeerAccounts()` which is called 15+ times in unit tests.
- `recordPacketTransfer()` (~line 600) — builds transfer objects, uses `tbSdk.TransferFlags.none`
- `recordSettlement()` (~line 918) — builds transfer objects, uses `tbSdk.TransferFlags.none`
- `_convertToBatchWriterTransfer()` (line 1284) — returns `Transfer` typed objects for batch writer. Uses `import type { Transfer }` (compile-time only). Does NOT call `loadTigerBeetleSdk()` — no changes needed.

**No changes needed:**

- `packages/connector/src/settlement/tigerbeetle-batch-writer.ts` (receives function reference, doesn't touch ledger client directly)
- `packages/connector/src/settlement/in-memory-ledger-client.test.ts` (Story 28.1, tests InMemoryLedgerClient directly)
- `packages/connector/test/integration/in-memory-ledger-integration.test.ts` (Story 28.2, tests factory wiring)
- `packages/connector/test/integration/account-manager.test.ts` (uses real TigerBeetle, unchanged)
- `packages/connector/test/integration/account-manager-balance-tracking.test.ts` (uses real TigerBeetle, unchanged)
- `packages/connector/src/settlement/tigerbeetle-errors.ts` (error classes remain as-is)

**Export consideration:** If `ILedgerClient` should be consumable by downstream packages (e.g., `agent-society`), check whether a barrel file (`packages/connector/src/settlement/index.ts` or equivalent) exists and add the export there. If no barrel file exists, skip — consumers can import directly from `./settlement/ledger-client`.

### Coding Standards

- TypeScript strict mode, no `any` types except in test mocks
- Pino logger for all logging (never `console.log`)
- File naming: kebab-case (`ledger-client.ts`)
- Interface naming: PascalCase with `I` prefix (`ILedgerClient`)
- Private members: `_` prefix
- Co-located tests: `*.test.ts` next to source file
- Async/await pattern for all async operations

[Source: `docs/architecture/coding-standards.md`]

### Testing Strategy

**Unit tests:**

- Framework: Jest 29.7.x with `ts-jest`
- Co-located test files
- Mock `ILedgerClient` for AccountManager unit tests (not real InMemoryLedgerClient — keep unit tests fast and isolated)
- Use `pino({ level: 'silent' })` for quiet tests
- AAA pattern (Arrange, Act, Assert) with descriptive test names

**Verification approach:**

1. Run `account-manager.test.ts` — all tests must pass with `ILedgerClient` mock (no `jest.mock('./tigerbeetle-client')`)
2. Run `account-manager-credit-limits.test.ts` — all tests must pass with `ILedgerClient` mock
3. Run `in-memory-ledger-client.test.ts` — 29/29 tests still pass (no changes to this file)
4. Run full connector test suite — no regressions
5. Run `npm run build` — TypeScript compilation succeeds
6. Run `npm run lint` — no lint errors
7. Verify `account-manager.ts` has zero runtime `tigerbeetle-node` dependency: `grep -n 'requireOptional\|loadTigerBeetleSdk' packages/connector/src/settlement/account-manager.ts` should return no matches. Only `import type` references should remain.

[Source: `docs/architecture/test-strategy-and-standards.md`]

### Technical Constraints

- Node.js 22 LTS
- TypeScript `import type` for `tigerbeetle-node` types ensures zero runtime dependency when using in-memory path. After removing `loadTigerBeetleSdk()` from `AccountManager` (Task 4), the only runtime `requireOptional('tigerbeetle-node')` call is inside `TigerBeetleClient` itself.
- The `tigerbeetle-node` package is already `peerDependencies` with `optional: true` in `packages/connector/package.json` (lines 96, 109-111)
- `account-manager.ts` uses `import type { Transfer } from 'tigerbeetle-node'` (line 22) — this is erased at compile time, so it's safe even without `tigerbeetle-node` installed. But the `createTransfersBatch` method in the interface must accept a structurally compatible type.
- The `TigerBeetleBatchWriter` class (defined in `tigerbeetle-batch-writer.ts`, NOT in `account-manager.ts`) receives a function reference and does NOT directly access the ledger client. The rename from `_tigerBeetleClient` to `_ledgerClient` only affects `_createTransferFn` (line 1256) which is bound to the batch writer at line 173. No changes needed in `tigerbeetle-batch-writer.ts`.

### CI Validation

The existing CI pipeline (`npm test`) runs unit tests. Note: `tigerbeetle-node` IS installed in CI via `devDependencies` (line 165 of connector `package.json`). After this story:

- Unit tests pass — `AccountManager` tests use `ILedgerClient` mocks, no `jest.mock('./tigerbeetle-client')` needed
- `AccountManager` has zero runtime `requireOptional('tigerbeetle-node')` calls — all `loadTigerBeetleSdk()` calls replaced with local constants
- Integration tests that use TigerBeetle are gated behind `E2E_TESTS=true` env var — they remain functional when TigerBeetle is available but don't block CI
- TypeScript compilation succeeds — all `tigerbeetle-node` imports in `AccountManager` are `import type` (erased at compile time)
- For npm consumers who install `@agent-runtime/connector` WITHOUT `tigerbeetle-node`: the in-memory path works fully because `AccountManager` no longer calls `requireOptional('tigerbeetle-node')`. The only remaining `requireOptional('tigerbeetle-node')` call is in `TigerBeetleClient` itself (which is only instantiated when TigerBeetle env vars are set).

## Tasks / Subtasks

### 1. Create `ILedgerClient` interface (AC: 1, 2)

- [x] Create `packages/connector/src/settlement/ledger-client.ts`
- [x] Define `ILedgerClient` interface with all 6 methods:
  - `initialize(): Promise<void>`
  - `close(): Promise<void>`
  - `createAccountsBatch(accounts: Array<{ id: bigint; ledger: number; code: number; flags?: number }>): Promise<void>`
  - `createTransfersBatch(transfers: Array<{ id: bigint; debit_account_id: bigint; credit_account_id: bigint; amount: bigint; [key: string]: unknown }>): Promise<void>`
  - `getAccountBalance(accountId: bigint): Promise<AccountBalance>`
  - `getAccountsBatch(accountIds: bigint[]): Promise<Map<bigint, AccountBalance>>`
- [x] Import and re-export `AccountBalance` from `tigerbeetle-client.ts`
- [x] Export the interface

### 2. Update `TigerBeetleClient` to implement `ILedgerClient` (AC: 6)

- [x] Add `import { ILedgerClient } from './ledger-client';` to `tigerbeetle-client.ts`
- [x] Add `implements ILedgerClient` to the class declaration
- [x] Verify TypeScript compiles without errors (method signatures must match)

### 3. Update `InMemoryLedgerClient` to implement `ILedgerClient` (AC: 1)

- [x] Add `import { ILedgerClient } from './ledger-client';` to `in-memory-ledger-client.ts`
- [x] Add `implements ILedgerClient` to the class declaration
- [x] Verify TypeScript compiles without errors

### 4. Remove `loadTigerBeetleSdk()` from AccountManager (AC: 5)

- [x] Add local constants at the top of `account-manager.ts` (after imports):
  ```typescript
  // Local constants replacing runtime tigerbeetle-node SDK access.
  // Both AccountFlags.none and TransferFlags.none are 0 in tigerbeetle-node.
  const ACCOUNT_FLAGS_NONE = 0;
  const TRANSFER_FLAGS_NONE = 0;
  ```
- [x] In `_buildAccountObject()`: remove `const sdk = await loadTigerBeetleSdk();` and replace `sdk.AccountFlags.none` with `ACCOUNT_FLAGS_NONE`
- [x] In `recordPacketTransfers()`: remove `const tbSdk = await loadTigerBeetleSdk();` and replace `tbSdk.TransferFlags.none` with `TRANSFER_FLAGS_NONE`
- [x] In `recordSettlement()`: remove `const tbSdk = await loadTigerBeetleSdk();` and replace `tbSdk.TransferFlags.none` with `TRANSFER_FLAGS_NONE`
- [x] Remove the module-level `loadTigerBeetleSdk()` function and `_tbSdk` cache variable
- [x] Remove `import { requireOptional } from '../utils/optional-require';`
- [x] Verify `import type { Transfer } from 'tigerbeetle-node'` remains — this is type-only and erased at compile time
- [x] Run `npm run build` to verify compilation succeeds

### 5. Update `AccountManager` to accept `ILedgerClient` (AC: 1, 2)

- [x] Replace `import { TigerBeetleClient } from './tigerbeetle-client';` with `import type { ILedgerClient } from './ledger-client';`
- [x] Change constructor parameter from `private readonly _tigerBeetleClient: TigerBeetleClient` to `private readonly _ledgerClient: ILedgerClient`
- [x] Rename all references to `this._tigerBeetleClient` → `this._ledgerClient` throughout the file (6 locations — find-and-replace)
- [x] Verify `_createTransferFn` still compiles after rename — it calls `this._ledgerClient.createTransfersBatch()` which accepts the structural type
- [x] `TigerBeetleBatchWriter` (in separate file `tigerbeetle-batch-writer.ts`) needs NO changes — it receives a function reference
- [x] Run `npm run build` to verify compilation succeeds

### 6. Update `ConnectorNode` to remove type assertion (AC: 1)

- [x] In `connector-node.ts`: change `inMemoryClient as unknown as TigerBeetleClient` to just `inMemoryClient`
- [x] Verify no other `as unknown as TigerBeetleClient` assertions remain
- [x] Verify both the TigerBeetle path and in-memory path pass `AccountManager` construction without type assertions

### 7. Update `account-manager.test.ts` (AC: 1, 2)

- [x] Remove `jest.mock('./tigerbeetle-client');`
- [x] Replace `import { TigerBeetleClient } from './tigerbeetle-client';` with `import { ILedgerClient } from './ledger-client';`
- [x] Replace `mockTigerBeetleClient: jest.Mocked<TigerBeetleClient>` with `mockLedgerClient: jest.Mocked<ILedgerClient>`
- [x] Update `beforeEach` to create a plain mock object satisfying `ILedgerClient`
- [x] Update all `new AccountManager(config, mockTigerBeetleClient, mockLogger)` → `new AccountManager(config, mockLedgerClient, mockLogger)`
- [x] Update all `mockTigerBeetleClient.*` references → `mockLedgerClient.*`
- [x] Run tests — all 20 tests pass

### 8. Update `account-manager-credit-limits.test.ts` (AC: 1, 2)

- [x] Remove `jest.mock('./tigerbeetle-client');`
- [x] Replace `import { TigerBeetleClient } from './tigerbeetle-client';` with `import { ILedgerClient } from './ledger-client';`
- [x] Replace `mockTigerBeetleClient: jest.Mocked<TigerBeetleClient>` with `mockLedgerClient: jest.Mocked<ILedgerClient>`
- [x] Update mock object to satisfy `ILedgerClient` interface
- [x] Update all references from `mockTigerBeetleClient` → `mockLedgerClient`
- [x] Run tests — all 14 tests pass

### 9. Update documentation (AC: 3, 4)

- [x] Update `docs/architecture/tech-stack.md`: Change TigerBeetle row to reflect in-memory ledger as default, TigerBeetle as optional
- [x] Update `packages/connector/README.md`:
  - Change line 11: "Balance tracking with TigerBeetle" → "Balance tracking with in-memory ledger (default) or TigerBeetle (optional)"
  - Add "Accounting Backend" section with default/optional backend documentation and env var tables

### 10. Verify CI compatibility (AC: 5)

- [x] Run `npm run build` — TypeScript compilation succeeds
- [x] Run `npm run lint` — no lint errors (0 errors, 2 pre-existing warnings)
- [x] Run `npm test` in connector package — all unit tests pass (2380 pass, 1 pre-existing integration test failure from Story 28.2)
- [x] Verify `account-manager.ts` has NO `requireOptional('tigerbeetle-node')` or `loadTigerBeetleSdk()` calls remaining — only `import type` references to `tigerbeetle-node`
- [x] Verify `requireOptional('tigerbeetle-node')` only exists in `tigerbeetle-client.ts` (the TigerBeetle-specific code path)
- [x] Verify existing TigerBeetle integration tests still work when `tigerbeetle-node` IS available (run with `E2E_TESTS=true` if Docker infrastructure is available)

### 11. Final verification

- [x] Run full test suite: `npm test` from repo root
- [x] Verify `in-memory-ledger-client.test.ts` — 29/29 tests still pass
- [x] Verify `account-manager.test.ts` — all 20 tests pass
- [x] Verify `account-manager-credit-limits.test.ts` — all 14 tests pass
- [x] Run `npm run build` — clean compilation
- [x] Run `npm run lint` — no errors

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6

### Debug Log References

No debug log entries required — all tasks completed without blocking issues.

### Completion Notes

- All 11 tasks completed successfully
- `ILedgerClient` interface created as the common abstraction layer
- Both `TigerBeetleClient` and `InMemoryLedgerClient` now implement `ILedgerClient`
- `AccountManager` no longer has any runtime dependency on `tigerbeetle-node` — all `loadTigerBeetleSdk()` calls replaced with local constants (`ACCOUNT_FLAGS_NONE = 0`, `TRANSFER_FLAGS_NONE = 0`)
- The `as unknown as TigerBeetleClient` type assertion in `ConnectorNode` has been removed
- Unit tests use `jest.Mocked<ILedgerClient>` plain objects instead of `jest.mock('./tigerbeetle-client')`
- 63/63 settlement unit tests pass (20 + 14 + 29)
- 1 pre-existing integration test failure in `in-memory-ledger-integration.test.ts` (untracked file from Story 28.2, not caused by this story's changes)
- Build and lint clean

### File List

| File                                                                      | Action   | Description                                                                                                                                                                                                                      |
| ------------------------------------------------------------------------- | -------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `packages/connector/src/settlement/ledger-client.ts`                      | Created  | `ILedgerClient` interface definition with 6 methods, re-exports `AccountBalance`                                                                                                                                                 |
| `packages/connector/src/settlement/account-manager.ts`                    | Modified | Constructor param `TigerBeetleClient` → `ILedgerClient`, renamed `_tigerBeetleClient` → `_ledgerClient`, removed `loadTigerBeetleSdk()` / `requireOptional` import, added `ACCOUNT_FLAGS_NONE` / `TRANSFER_FLAGS_NONE` constants |
| `packages/connector/src/settlement/tigerbeetle-client.ts`                 | Modified | Added `implements ILedgerClient` to class declaration                                                                                                                                                                            |
| `packages/connector/src/settlement/in-memory-ledger-client.ts`            | Modified | Added `implements ILedgerClient` to class declaration                                                                                                                                                                            |
| `packages/connector/src/core/connector-node.ts`                           | Modified | Removed `inMemoryClient as unknown as TigerBeetleClient` type assertion                                                                                                                                                          |
| `packages/connector/src/settlement/account-manager.test.ts`               | Modified | Removed `jest.mock`, uses `jest.Mocked<ILedgerClient>` plain mock                                                                                                                                                                |
| `packages/connector/src/settlement/account-manager-credit-limits.test.ts` | Modified | Removed `jest.mock`, uses `jest.Mocked<ILedgerClient>` plain mock                                                                                                                                                                |
| `docs/architecture/tech-stack.md`                                         | Modified | Updated TigerBeetle row to show in-memory ledger as default                                                                                                                                                                      |
| `packages/connector/README.md`                                            | Modified | Added Accounting Backend section, updated balance tracking line                                                                                                                                                                  |

## QA Results

### Review Date: 2026-02-13

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation. The `ILedgerClient` interface is well-designed with all 6 methods, proper `AccountBalance` re-export, and a structural transfer type that avoids importing `tigerbeetle-node`. The `AccountManager` refactoring is clean — constructor parameter renamed, all `loadTigerBeetleSdk()` calls eliminated with local constants, and the `import type { Transfer }` retained correctly as a compile-time-only import. The `ConnectorNode` type assertion removal is minimal and correct. Test files cleanly use `jest.Mocked<ILedgerClient>` plain objects without `jest.mock` module interception.

### Refactoring Performed

No additional refactoring performed — implementation is clean as delivered.

### Compliance Check

- Coding Standards: ✓ TypeScript strict mode, no `any` types (except justified test casts), kebab-case files, `_` prefix on private members, PascalCase `I`-prefix interface
- Project Structure: ✓ New `ledger-client.ts` co-located in settlement directory, tests co-located
- Testing Strategy: ✓ Unit tests use mock `ILedgerClient` (fast/isolated), integration tests (Story 28.2) cover real `InMemoryLedgerClient` behavior
- All ACs Met: ✓ All 6 acceptance criteria verified (see details below)

### AC Verification

1. **AC 1 — Unit tests pass with ILedgerClient mocks**: ✓ Both `account-manager.test.ts` (20 tests) and `account-manager-credit-limits.test.ts` (14 tests) pass using `jest.Mocked<ILedgerClient>` without `jest.mock('./tigerbeetle-client')`. Confirmed via grep: zero occurrences of `jest.mock('./tigerbeetle-client')` in settlement source files.
2. **AC 2 — Test helpers use InMemoryLedgerClient by default**: ✓ Both test files create plain mock objects satisfying `ILedgerClient` — no TigerBeetle mock infrastructure needed.
3. **AC 3 — tech-stack.md updated**: ✓ Line 32 updated to show "In-memory ledger (default) / TigerBeetle (optional)" with proper description.
4. **AC 4 — Connector README updated**: ✓ Line 11 updated, new "Accounting Backend" section added with env var tables for both backends.
5. **AC 5 — No runtime tigerbeetle-node dependency in AccountManager**: ✓ Confirmed via grep: zero matches for `requireOptional` or `loadTigerBeetleSdk` in `account-manager.ts`. Only `import type { Transfer } from 'tigerbeetle-node'` remains (line 22) — erased at compile time. `requireOptional('tigerbeetle-node')` only exists in `tigerbeetle-client.ts` (line 120).
6. **AC 6 — TigerBeetle integration tests unchanged**: ✓ `TigerBeetleClient` now implements `ILedgerClient` — no behavioral changes. Integration tests in `packages/connector/test/integration/` are unmodified.

### Improvements Checklist

- [x] All acceptance criteria met
- [x] 63/63 settlement unit tests pass (20 + 14 + 29)
- [x] TypeScript compilation clean (no errors)
- [x] ESLint clean (no errors or warnings on modified files)
- [x] Zero runtime `requireOptional('tigerbeetle-node')` calls in AccountManager
- [x] `as unknown as TigerBeetleClient` type assertion removed from ConnectorNode
- [ ] Minor: `account-manager.ts` module-level JSDoc header still references "TigerBeetle account pairs" — cosmetic, not blocking

### Security Review

No security concerns. The change is purely a type-level refactoring and SDK flag constant extraction. No new attack surface introduced. The `tigerbeetle-node` native addon is now truly optional for npm consumers — only loaded when TigerBeetle env vars are configured.

### Performance Considerations

No performance impact. The `ACCOUNT_FLAGS_NONE = 0` and `TRANSFER_FLAGS_NONE = 0` constants are static values that replace async `loadTigerBeetleSdk()` calls — this is a net performance improvement (eliminates unnecessary dynamic import caching on every `_buildAccountObject` call).

### Files Modified During Review

None — no modifications made during QA review.

### Gate Status

Gate: PASS → docs/qa/gates/28.3-test-suite-compatibility-documentation.yml
Risk profile: N/A (low-risk refactoring story)
NFR assessment: N/A (no NFR concerns)

### Recommended Status

✓ Ready for Done

## Story Wrap-Up

### Change Log

| Date       | Version | Description                                                                                                                                                                                                                           | Author                             |
| ---------- | ------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------- |
| 2026-02-13 | 1.0     | Initial story draft                                                                                                                                                                                                                   | Claude (create-next-story task)    |
| 2026-02-13 | 1.1     | Validation fixes: added Task 4 (remove loadTigerBeetleSdk from AccountManager), corrected line numbers, clarified AC #1/#5 wording, added TigerBeetleBatchWriter location context, added QA Results section, added barrel export note | Claude (validate-next-story task)  |
| 2026-02-13 | 2.0     | Implementation complete: ILedgerClient interface, AccountManager refactored, tests updated, docs updated, all 63 unit tests pass                                                                                                      | James (dev agent, Claude Opus 4.6) |
