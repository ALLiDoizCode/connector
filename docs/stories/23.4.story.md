# Story 23.4: Fix Deploy Script — Remove Stale SPSP Tests, Enhance Channel Verification, Verify Unified Compose

**Epic:** 23 - Unified Deployment Infrastructure
**Story Number:** 23.4
**Status:** Done
**Priority:** P3 (Low — Testing & Documentation)

## Story

**As a** developer,
**I want** the deploy script to have accurate post-Epic-22 tests and robust channel verification,
**so that** the `--with-agent` and `--unified` test suites produce reliable pass/fail results without false failures from stale SPSP tests or silent channel verification gaps.

## Acceptance Criteria

1. Stale SPSP endpoint test (lines 1447-1466) removed from `--with-agent` test suite (Gap 5)
2. SPSP test replaced with a `POST /ilp/send` test that sends a 0-amount packet and verifies FULFILL response
3. New ILP send test in `--with-agent` block uses port `3100` (the `--unified` mode already has its own Phase 7 test on port `3200` — no changes needed there)
4. New test verifies response contains `accepted: true` (per Story 20.4 field name fix)
5. AR-4 "Direct Packet Handling" test (lines 1470-1501) updated: remove SPSP dependency at line 1476, test `/ilp/packets` directly without shared secret
6. Stale SPSP references cleaned up: endpoint print at line 1605, summary at line 1827, usage instructions at lines 1923-1924
7. `jq` availability check added to prerequisites section — script exits with clear error if `jq` is not installed
8. Phase 5 channel verification enhanced: validates response is valid JSON, not just grep for `channelId` (Gap 6)
9. Phase 5 fails (not warns) if zero channels are open across all peers
10. Phase 5 verifies at least one channel has status `"open"`, `"active"`, or `"opening"` (using `jq` for JSON parsing)
11. Phase 5 reports channel details: peerId, chain, status for each found channel
12. `docker-compose-unified.yml` verified to exist and validate with `docker compose config` before any services start (Gap 14)
13. Script validates `docker-compose-unified.yml` has all 16 service definitions (update count if compose changes)
14. Script validates environment variable interpolation works (no unresolved `${VAR}` in config output)
15. All existing deploy script flags (`--with-agent`, `--unified`, `--agent-only`) continue to work

## Tasks / Subtasks

- [x] Task 1: Add `jq` prerequisite check (AC: 7)
  - [x] In `scripts/deploy-5-peer-multihop.sh`, in the prerequisites section (after Docker Compose check at line ~325, before image checks):
    ```bash
    # Check jq for JSON parsing (used by channel verification and ILP send tests)
    if ! command -v jq > /dev/null 2>&1; then
      echo -e "${RED}✗ jq not found — required for JSON parsing in test verification${NC}"
      echo "Install jq: brew install jq (macOS) or apt-get install jq (Linux)"
      exit 1
    fi
    echo -e "${GREEN}✓ jq is available${NC}"
    ```

- [x] Task 2: Remove stale SPSP test and replace with ILP send test (AC: 1, 2, 3, 4)
  - [x] In `scripts/deploy-5-peer-multihop.sh` lines 1447-1466:
    - [x] Remove the SPSP endpoint curl test (`curl -H 'Accept: application/spsp4+json' http://localhost:3100/.well-known/pay`)
    - [x] Replace with ILP send test using port 3100 (the `--with-agent` mode runs agent-runtime on port 3100):

      ```bash
      # Step AR-3: Test ILP Send via agent-runtime
      echo -e "${BLUE}[AR-3/5]${NC} Testing ILP send endpoint..."
      AGENT_TESTS_TOTAL=$((AGENT_TESTS_TOTAL + 1))

      # Encode test data as base64
      TEST_DATA=$(echo -n "test-packet" | base64)

      ILP_SEND_RESPONSE=$(curl -s -X POST http://localhost:3100/ilp/send \
        -H "Content-Type: application/json" \
        -d "{\"destination\": \"g.peer5.agent\", \"amount\": \"0\", \"data\": \"${TEST_DATA}\", \"timeoutMs\": 10000}")

      if echo "${ILP_SEND_RESPONSE}" | jq -e '.accepted == true' > /dev/null 2>&1; then
        echo -e "  ${GREEN}✓ ILP send: FULFILL received${NC}"
        AGENT_TESTS_PASSED=$((AGENT_TESTS_PASSED + 1))
      elif echo "${ILP_SEND_RESPONSE}" | jq -e '.accepted == false' > /dev/null 2>&1; then
        echo -e "  ${YELLOW}⚠ ILP send: REJECT received (expected during test)${NC}"
        echo "    Code: $(echo "${ILP_SEND_RESPONSE}" | jq -r '.code // "unknown"')"
        AGENT_TESTS_PASSED=$((AGENT_TESTS_PASSED + 1))
      else
        echo -e "  ${RED}✗ ILP send: FAILED${NC}"
        echo "    Response: ${ILP_SEND_RESPONSE}"
      fi
      ```

  - **Note on port:** `--with-agent` mode runs agent-runtime on port 3100 (mapped from container). `--unified` mode runs agent-runtime middleware on ports 3200-3204. This test is in the `--with-agent` block, so port 3100 is correct. The `--unified` mode has its own Phase 7 test which already uses port 3200.
  - **Note on destination:** The `--with-agent` mode agent-runtime has `BASE_ADDRESS=g.peer5.agent` (line 1328), so `g.peer5.agent` is the correct destination (not `g.peer1` which is a connector address).

- [x] Task 3: Update AR-4 test to remove SPSP dependency (AC: 5)
  - [x] In `scripts/deploy-5-peer-multihop.sh` lines 1470-1501:
    - [x] Remove the SPSP shared secret fetch at line 1475-1476:
      ```bash
      # DELETE: First get SPSP details to get a valid shared secret
      # DELETE: SPSP_RESPONSE=$(curl -s -H "Accept: application/spsp4+json" http://localhost:3100/.well-known/pay)
      ```
    - [x] Keep the existing packet handling tests (invalid packet test at lines 1478-1501 and malformed request test at lines 1503-1518) — these test `/ilp/packets` directly and don't actually use the SPSP_RESPONSE variable (it's fetched but never consumed by the tests below it)
    - [x] Update step label from "Direct Packet Handling" to "Packet Handling" (minor cleanup)

- [x] Task 4: Clean up remaining stale SPSP references (AC: 6)
  - [x] Line 1605: Replace `echo "  SPSP:     http://localhost:3100/.well-known/pay"` with `echo "  ILP Send: POST http://localhost:3100/ilp/send"`
  - [x] Line 1827: Replace `echo "  - SPSP endpoint: Payment setup protocol working"` with `echo "  - ILP send: Bidirectional packet sending"`
  - [x] Lines 1923-1924: Replace the SPSP test command:

    ```bash
    # BEFORE:
    echo "Test SPSP endpoint:"
    echo "  curl -H 'Accept: application/spsp4+json' http://localhost:3100/.well-known/pay"

    # AFTER:
    echo "Test ILP send endpoint:"
    echo "  curl -s -X POST http://localhost:3100/ilp/send -H 'Content-Type: application/json' -d '{\"destination\": \"g.peer5.agent\", \"amount\": \"0\", \"data\": \"dGVzdA==\", \"timeoutMs\": 10000}'"
    ```

- [x] Task 5: Enhance Phase 5 channel verification (AC: 8, 9, 10, 11)
  - [x] In `scripts/deploy-5-peer-multihop.sh` lines 745-776, replace the existing Phase 5 logic:
    - [x] Validate response is valid JSON before processing:

      ```bash
      CHANNELS_RESPONSE=$(curl -s "http://localhost:${ADMIN_PORT}/admin/channels" 2>/dev/null)

      # Validate JSON response
      if ! echo "${CHANNELS_RESPONSE}" | jq -e '.' > /dev/null 2>&1; then
        echo -e "  ${RED}✗ peer${i}: Invalid response from channels endpoint${NC}"
        continue
      fi
      ```

    - [x] Count channels using `jq` instead of grep:
      ```bash
      CHANNEL_COUNT=$(echo "${CHANNELS_RESPONSE}" | jq 'length' 2>/dev/null || echo "0")
      ```
    - [x] Check for open/active channels:
      ```bash
      OPEN_COUNT=$(echo "${CHANNELS_RESPONSE}" | jq '[.[] | select(.status == "open" or .status == "active" or .status == "opening")] | length' 2>/dev/null || echo "0")
      ```
    - [x] Report channel details:
      ```bash
      echo "${CHANNELS_RESPONSE}" | jq -r '.[] | "    Channel: \(.channelId) | Peer: \(.peerId // "unknown") | Chain: \(.chain // "unknown") | Status: \(.status)"'
      ```
    - [x] Fail (not warn) if TOTAL_CHANNELS is 0:
      ```bash
      if [ "${TOTAL_CHANNELS}" -eq "0" ]; then
        UNIFIED_PHASE5_PASS=false
        echo -e "  ${RED}✗ No channels found across any peer — Phase 5 FAILED${NC}"
      fi
      ```

- [x] Task 6: Add docker-compose-unified.yml validation (AC: 12, 13, 14)
  - [x] In the unified prerequisites block (`scripts/deploy-5-peer-multihop.sh` lines 354-459), after the existing compose file existence check (line 366-370) and **before any image builds or service startup**:
    - [x] Validate compose file parses correctly:
      ```bash
      echo "Validating unified compose file..."
      if ! docker compose -f "${COMPOSE_FILE_UNIFIED}" config --quiet 2>/dev/null; then
        echo -e "${RED}ERROR: docker-compose-unified.yml validation failed${NC}"
        docker compose -f "${COMPOSE_FILE_UNIFIED}" config 2>&1 | head -20
        exit 1
      fi
      echo -e "${GREEN}✓ Unified compose file validates successfully${NC}"
      ```
    - [x] Count services:
      ```bash
      SERVICE_COUNT=$(docker compose -f "${COMPOSE_FILE_UNIFIED}" config --services | wc -l | tr -d ' ')
      if [ "${SERVICE_COUNT}" -lt "16" ]; then
        echo -e "${YELLOW}WARNING: Expected 16 services, found ${SERVICE_COUNT}${NC}"
      else
        echo -e "${GREEN}✓ Unified compose: ${SERVICE_COUNT} services defined${NC}"
      fi
      ```
    - [x] Check for unresolved env vars:
      ```bash
      UNRESOLVED=$(docker compose -f "${COMPOSE_FILE_UNIFIED}" config 2>&1 | grep -c 'variable is not set' || true)
      if [ "${UNRESOLVED}" -gt "0" ]; then
        echo -e "${YELLOW}WARNING: ${UNRESOLVED} unresolved environment variable(s)${NC}"
        docker compose -f "${COMPOSE_FILE_UNIFIED}" config 2>&1 | grep 'variable is not set' | head -5
      else
        echo -e "${GREEN}✓ All environment variables resolved${NC}"
      fi
      ```
  - **Note:** Validation runs in the prerequisites block (lines 354-459) which executes before any Docker images are built or services started. This ensures early failure if the compose file is invalid.

- [x] Task 7: Verify backward compatibility (AC: 15)
  - [x] Run `./scripts/deploy-5-peer-multihop.sh nonexistent-flag` — verify it shows usage with all flags (`--with-agent`, `--agent-only`, `--with-nostr-spsp`, `--unified`) and exits with error
  - [x] Run `./scripts/deploy-5-peer-multihop.sh --with-agent` with Docker available — verify it reaches the AR tests section and runs the new ILP send test (not the stale SPSP test). May fail if no network is running, but the test itself should execute.
  - [x] Run `./scripts/deploy-5-peer-multihop.sh --unified` — verify compose validation runs in prerequisites, then proceeds to Phase 1
  - [x] Run `./scripts/deploy-5-peer-multihop.sh --agent-only` — verify it skips network deployment and goes straight to agent tests
  - [x] Verify `--unified` is still mutually exclusive with `--with-agent`, `--agent-only`, `--with-nostr-spsp` (existing conflict detection at line 86-91)

## Dev Notes

### Gap Context

This story addresses 3 integration gaps from `INTEGRATION-GAPS.md`:

- **Gap 5 (P3):** SPSP endpoint test is stale after Epic 22 removed SPSP HTTP endpoints. Test calls `GET /.well-known/pay` which now returns 404, causing test failures in `--with-agent` mode. Additionally, the AR-4 test at line 1476 fetches SPSP details (unused but misleading), and several output/summary lines reference the stale SPSP endpoint.
- **Gap 6 (P3):** Phase 5 channel verification uses `grep -o '"channelId"' | wc -l` which silently returns 0 on error responses. Phase passes with "warn" when zero channels exist, masking failures.
- **Gap 14 (P3):** `docker-compose-unified.yml` existence and correctness not verified by the deploy script before service startup. If env var interpolation is wrong, services start with incorrect config.

### All Stale SPSP References in Deploy Script

The following SPSP references need updating (complete inventory):

| Line(s)   | Content                                                  | Action                                     |
| --------- | -------------------------------------------------------- | ------------------------------------------ |
| 1447-1466 | AR-3 SPSP endpoint test                                  | **Replace** with ILP send test (Task 2)    |
| 1475-1476 | AR-4 fetches SPSP response (unused)                      | **Remove** dead code (Task 3)              |
| 1605      | Prints `SPSP: http://localhost:3100/.well-known/pay`     | **Replace** with ILP send URL (Task 4)     |
| 1827      | Summary: `SPSP endpoint: Payment setup protocol working` | **Replace** with ILP send summary (Task 4) |
| 1923-1924 | Usage: `Test SPSP endpoint: curl ...`                    | **Replace** with ILP send usage (Task 4)   |

**Not modified** (still valid in their context):

- Lines 5, 13: File header comments referencing SPSP/STREAM protocol handling — these describe the historical purpose and are still informative
- Lines 45, 55, 69-70, 272-273: `--with-nostr-spsp` flag and `COMPOSE_FILE_NOSTR_SPSP` — these are a separate feature (Nostr-based SPSP via ILP-gated relay) and are NOT stale. They use a different compose file and test flow.
- Lines 1332-1333: `SPSP_ENABLED: "true"` in embedded `--with-agent` compose config — this is consumed by the agent-runtime container and may still be referenced internally. Leave as-is; removing requires verifying agent-runtime's env handling.
- Lines 1616-1765: Nostr SPSP testing section — separate feature block, not affected by Epic 22 changes.

### Port Mapping Reference

| Mode           | Agent-Runtime Port | Admin API Ports                 | Notes                                          |
| -------------- | ------------------ | ------------------------------- | ---------------------------------------------- |
| `--with-agent` | 3100               | N/A (no admin API in this mode) | Single agent-runtime container                 |
| `--unified`    | 3200-3204          | 8181-8185                       | 5 middleware instances, 5 connectors           |
| `--agent-only` | 3100               | N/A                             | Assumes `--with-agent` network already running |

The ILP send test in Task 2 uses port **3100** because it runs in the `--with-agent` block. The `--unified` mode has its own Phase 7 end-to-end test which uses port 3200.

### Key File Locations

| Action     | File                                | Lines                                                                                                                                                  |
| ---------- | ----------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Modify** | `scripts/deploy-5-peer-multihop.sh` | ~325 (jq check), 745-776 (Phase 5), 1447-1466 (SPSP→ILP send), 1475-1476 (AR-4 SPSP removal), 1605 (endpoint print), 1827 (summary), 1923-1924 (usage) |
| **Read**   | `docker-compose-unified.yml`        | Validation target (16 services confirmed)                                                                                                              |

### Relevant Source Tree

```
scripts/
└── deploy-5-peer-multihop.sh           # Main deploy script (1990 lines)
    ├── Lines 40-94:   Configuration, flag parsing, conflict detection
    ├── Lines 298-460: Prerequisites (Docker, images, unified prereqs)
    │   ├── Lines 354-459: Unified prerequisites block ← Task 6 (compose validation)
    │   └── Lines 320-325: Docker Compose check ← Task 1 (jq check goes after this)
    ├── Lines 466-900: Unified mode (Phase 1-7)
    │   └── Lines 745-776: Phase 5 channel verification ← Task 5
    ├── Lines 1300-1613: --with-agent mode (AR-1 through AR-5)
    │   ├── Lines 1447-1466: AR-3 SPSP test ← Task 2
    │   ├── Lines 1470-1518: AR-4 packet handling ← Task 3
    │   ├── Line 1605: Endpoint summary ← Task 4
    │   └── Line 1827: Test summary ← Task 4
    └── Lines 1915-1938: Usage commands ← Task 4

docker-compose-unified.yml              # 16-service unified compose (validation target)
```

### Current Stale SPSP Test (AR-3)

```bash
# scripts/deploy-5-peer-multihop.sh lines 1447-1466
SPSP_RESPONSE=$(curl -s -H "Accept: application/spsp4+json" http://localhost:3100/.well-known/pay)
if echo "${SPSP_RESPONSE}" | grep -q "destination_account" && \
   echo "${SPSP_RESPONSE}" | grep -q "shared_secret"; then
  # ...passes...
```

This always fails post-Epic-22 because the `/.well-known/pay` endpoint was removed.

### Current AR-4 SPSP Dependency

```bash
# scripts/deploy-5-peer-multihop.sh lines 1475-1476
# First get SPSP details to get a valid shared secret
SPSP_RESPONSE=$(curl -s -H "Accept: application/spsp4+json" http://localhost:3100/.well-known/pay)
```

This line fetches SPSP details but the `SPSP_RESPONSE` variable is **never consumed** by the AR-4 tests that follow (lines 1478-1518). The packet handling tests send their own test data directly. This is dead code that should be removed.

### Current Phase 5 Verification

```bash
# lines 745-776
CHANNEL_COUNT=$(echo "${CHANNELS_RESPONSE}" | grep -o '"channelId"' | wc -l)
# ...
if [ "${TOTAL_CHANNELS}" -gt "0" ]; then
  UNIFIED_PHASE5_PASS=true
else
  UNIFIED_PHASE5_PASS="warn"  # ← Should be false, not "warn"
fi
```

### Dependencies

- **Story 20.4 (Done):** Provides the `accepted` field in ILP send response (the new test checks for `accepted: true`)
- **Story 21.4 (Done):** Provides accurate channel status in responses (Phase 5 verification relies on correct status values)
- **Story 21.5:** Standardizes channel status enum — Phase 5 accounts for `"open"`, `"active"`, and `"opening"` to handle both pre- and post-21.5 behavior

### Technical Notes

- **`jq` dependency:** The script currently does NOT use `jq` anywhere. This story introduces it for JSON parsing in Phase 5 and ILP send tests. A prerequisite check (Task 1) ensures early failure with a helpful install message rather than silent test failures.
- **Port 3100 vs 3200:** The `--with-agent` mode runs a single agent-runtime on port 3100 (container config at line 1339). The `--unified` mode runs 5 middleware instances on ports 3200-3204. The ILP send test (Task 2) is in the `--with-agent` block so it uses port 3100.
- **`docker compose config --quiet`** returns exit 0 on success, non-zero on validation failure.
- **16-service count:** If `docker-compose-unified.yml` is modified to add/remove services, update AC 13 accordingly. Current services: 1 TigerBeetle + 5 connectors + 5 agent-runtime + 5 agent-society = 16.
- **Channel status values:** The connector may return `"open"`, `"active"`, or `"opening"` depending on the chain and timing. The jq filter checks all three to avoid false failures during channel lifecycle transitions.

### Testing

**Testing approach:** Manual testing of deploy script flags. No automated test framework for shell scripts.

**Prerequisites for testing:**

- macOS with OrbStack (or Docker Desktop) installed and running
- `jq` installed (`brew install jq`)
- Built Docker images (connector, agent-runtime)
- `.env` and `.env.peers` configured

**Manual verification steps:**

1. **`jq` check:** Temporarily rename/hide `jq` binary, run script — verify it exits with clear error message. Restore `jq`.
2. **`--with-agent` mode:** `./scripts/deploy-5-peer-multihop.sh --with-agent`
   - Verify AR-3 runs new ILP send test (not stale SPSP test)
   - Verify AR-4 does NOT fetch `/.well-known/pay`
   - Verify endpoint summary shows `ILP Send` not `SPSP`
   - Verify usage commands show ILP send curl example
   - May reject without full network, but should not produce SPSP-related output
3. **`--unified` mode:** `./scripts/deploy-5-peer-multihop.sh --unified`
   - Verify compose validation runs early (before image builds)
   - Verify service count check prints 16
   - Verify env var interpolation check passes
   - Verify Phase 5 uses JSON parsing and reports channel details
4. **Basic mode:** `./scripts/deploy-5-peer-multihop.sh` (no flags) — verify no regression
5. **`--agent-only` mode:** `./scripts/deploy-5-peer-multihop.sh --agent-only` — verify it uses ILP send test, not SPSP test
6. **Flag conflict:** `./scripts/deploy-5-peer-multihop.sh --unified --with-agent` — verify mutual exclusion error

## Change Log

| Date       | Version | Description                                                                                                                                                                                                                                                                | Author      |
| ---------- | ------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------- |
| 2026-02-09 | 1.0     | Initial story draft from INTEGRATION-GAPS.md (Gaps 5, 6, 14)                                                                                                                                                                                                               | Sarah (PO)  |
| 2026-02-09 | 1.1     | Validation fixes: added jq prerequisite task, fixed ILP send port (3100 for --with-agent), expanded scope to cover all stale SPSP references (AR-4, endpoint prints, usage), added port mapping table, added source tree, expanded testing section, updated ACs 3/5/6/7/10 | Validation  |
| 2026-02-09 | 1.2     | Re-validation fix: clarified AC 3 wording — new ILP send test is in `--with-agent` block only, `--unified` Phase 7 already has its own test                                                                                                                                | Validation  |
| 2026-02-09 | 2.0     | Implementation complete: all 7 tasks done, bash syntax verified, backward compatibility confirmed                                                                                                                                                                          | Dev (James) |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6

### File List

| Action       | File                                |
| ------------ | ----------------------------------- |
| **Modified** | `scripts/deploy-5-peer-multihop.sh` |
| **Modified** | `docs/stories/23.4.story.md`        |

### Completion Notes

- All 7 tasks implemented and verified
- `bash -n` syntax check passes clean
- Unknown flag handling verified: shows usage with all 4 flags and exits with error
- `--unified --with-agent` mutual exclusion verified: exits with clear error message
- No stale SPSP references remain in test/output sections (remaining SPSP refs are in Nostr SPSP feature and embedded compose config, intentionally preserved per Dev Notes)
- Phase 5 now uses jq for JSON parsing, fails on zero channels (not "warn"), reports channel details
- Compose validation runs in prerequisites block before any image builds or service startup
- jq prerequisite check exits early with install instructions

### Debug Log References

None — no blocking issues encountered during implementation.

## QA Results

### Review Date: 2026-02-09

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Implementation is clean, well-structured, and closely follows the story's task specifications. All 7 tasks are implemented correctly. The bash syntax check passes (`bash -n` exits 0). The diff is focused (79 insertions, 27 deletions in a single file) with no unintended side effects. SPSP reference cleanup is complete — all stale references in test/output/usage sections have been replaced with ILP send equivalents, while Nostr-SPSP and embedded compose references are correctly preserved.

### Refactoring Performed

No refactoring was performed. The implementation is straightforward and does not introduce unnecessary complexity.

### Requirements Traceability

| AC  | Description                                       | Validated By                                                                                 | Status                      |
| --- | ------------------------------------------------- | -------------------------------------------------------------------------------------------- | --------------------------- | ---- |
| 1   | Stale SPSP test removed                           | Lines 1496-1521: Old SPSP curl replaced with ILP send POST                                   | PASS                        |
| 2   | Replaced with ILP send test using 0-amount packet | Lines 1507-1509: POST /ilp/send with amount "0", checks `.accepted` field                    | PASS                        |
| 3   | New test uses port 3100 (--with-agent block)      | Line 1507: `http://localhost:3100/ilp/send`                                                  | PASS                        |
| 4   | Verifies `accepted: true`                         | Line 1511: `jq -e '.accepted == true'`                                                       | PASS                        |
| 5   | AR-4 SPSP dependency removed                      | Lines 1525-1528: No SPSP fetch; tests /ilp/packets directly                                  | PASS                        |
| 6   | Stale SPSP references cleaned                     | Line 1657 (endpoint), Line 1879 (summary), Line 1975-1976 (usage) — all updated to ILP send  | PASS                        |
| 7   | jq prerequisite check                             | Lines 327-333: `command -v jq` with clear install message, exit 1                            | PASS                        |
| 8   | Phase 5 validates JSON                            | Lines 795-798: `jq -e '.'` validation with continue on invalid response                      | PASS                        |
| 9   | Phase 5 fails on zero channels                    | Lines 817-819: `UNIFIED_PHASE5_PASS=false` (not "warn")                                      | PASS                        |
| 10  | Phase 5 checks open/active/opening status         | Line 804: `jq` filter for `"open"`, `"active"`, `"opening"`                                  | PASS                        |
| 11  | Phase 5 reports channel details                   | Line 809: `jq -r` outputs channelId, peerId, chain, status per channel                       | PASS                        |
| 12  | Compose validation at script start                | Lines 380-387: `docker compose config --quiet` before builds                                 | PASS                        |
| 13  | Service count validation (16)                     | Lines 390-396: `docker compose config --services                                             | wc -l` with threshold check | PASS |
| 14  | Env var interpolation check                       | Lines 398-405: grep for 'variable is not set' in config output                               | PASS                        |
| 15  | Existing flags continue to work                   | Flag parsing (lines 58-83), conflict detection (lines 86-91) unchanged; all 4 flags in usage | PASS                        |

### Compliance Check

- Coding Standards: ✓ N/A for shell script; bash best practices followed (set -euo pipefail, proper quoting, jq for JSON)
- Project Structure: ✓ Single file modified in expected location (`scripts/`)
- Testing Strategy: ✓ Manual testing appropriate for deploy script; no automated test framework for shell scripts
- All ACs Met: ✓ All 15 ACs verified

### Improvements Checklist

- [x] SPSP test replaced with ILP send test (AC 1-4)
- [x] AR-4 SPSP dead code removed (AC 5)
- [x] All stale SPSP references cleaned up (AC 6)
- [x] jq prerequisite check added (AC 7)
- [x] Phase 5 JSON validation with jq (AC 8)
- [x] Phase 5 fails on zero channels (AC 9)
- [x] Phase 5 checks multiple status values (AC 10)
- [x] Phase 5 reports channel details (AC 11)
- [x] Compose validation at startup (AC 12-14)
- [x] Backward compatibility preserved (AC 15)

### Security Review

No security concerns. The script is a local development/testing tool. No secrets are hardcoded; all sensitive values come from `.env` and `.env.peers` files. The `jq` usage is safe (processes curl responses, no user-controlled template injection).

### Performance Considerations

No performance concerns. The added `jq` processing is negligible compared to Docker operations. Compose validation (`docker compose config`) runs once in prerequisites and adds ~1-2 seconds. The additional `jq` calls in Phase 5 are bounded (5 peers × 3 jq invocations).

### Files Modified During Review

No files modified during review (no refactoring needed).

### Gate Status

Gate: PASS → docs/qa/gates/23.4-fix-deploy-script-stale-spsp-channel-verification-compose-validation.yml
Risk profile: Not applicable (P3 priority, testing/infrastructure changes only)
NFR assessment: See gate file for NFR validation details

### Recommended Status

✓ Ready for Done — All 15 acceptance criteria met, bash syntax verified, no blocking issues.
