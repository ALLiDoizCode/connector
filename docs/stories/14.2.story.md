<!-- Powered by BMAD™ Core -->

# Story 14.2: Add Test Runner Aptos Phases

## Status

Done

## Story

**As a** developer running the Docker agent test,
**I want** Aptos payment channel test phases in the test runner,
**So that** Aptos payment channels are tested end-to-end alongside EVM and XRP channels in the integration test suite.

## Acceptance Criteria

1. `docker-agent-test-runner.ts` includes `aptosEnabled` flag in `TestConfig` interface (default: true)
2. `AgentInfo` interface extended with `aptosAddress?: string`, `aptosPrivateKey?: string`, and `aptosPublicKey?: string` fields
3. Test runner includes "Fund Aptos Accounts" phase that funds each agent with APT from the Aptos faucet
4. Test runner includes "Configure Agents Aptos" phase that calls `/configure-aptos` on each agent
5. "Update Peer Addresses" phase includes `aptosAddress` in follow configuration
6. Test runner includes "Open Aptos Payment Channels" phase that opens channels between peers following social graph
7. Test runner includes "Verify Aptos Channels" phase that queries `/aptos-channels` and validates channel state
8. Test runner includes "Claim Aptos Channels" phase that triggers claim submission on each channel
9. Test runner includes "Verify Aptos Settlement" phase that confirms on-chain channel state
10. Test output shows successful Aptos phases: "✓ Open Aptos Payment Channels: Opened N channels"
11. Aptos phases are conditional on `aptosEnabled` flag (skip if disabled via `APTOS_ENABLED=false`)
12. Integration test passes with all Aptos phases on ARM64 Mac with native Aptos mode

## Tasks / Subtasks

**Task Execution Strategy:** Story 14.2 adds Aptos payment channel test phases to the existing `docker-agent-test-runner.ts`, mirroring the established patterns for EVM (lines 614-920) and XRP (lines 929-1479) payment channel testing. The implementation follows the existing phase structure and integrates with the Aptos HTTP endpoints added in Story 14.1. Tasks are ordered to build incrementally: types/config first, then funding, configuration, channel operations, and finally verification phases.

- [x] Task 1: Add Aptos Configuration to TestConfig and AgentInfo (AC: 1, 2)
  - [ ] Extend `TestConfig` interface with Aptos configuration:

    ```typescript
    interface TestConfig {
      // ... existing fields ...
      aptosEnabled: boolean;
      aptosNodeUrl: string;
      aptosFaucetUrl: string;
      aptosModuleAddress: string;
    }
    ```

    - [Source: packages/connector/src/test/docker-agent-test-runner.ts:45-55 TestConfig]

  - [ ] Extend `AgentInfo` interface with Aptos fields:

    ```typescript
    interface AgentInfo {
      // ... existing fields ...
      aptosAddress?: string; // Aptos account address (0x-prefixed hex)
      aptosPrivateKey?: string; // ED25519 private key for testing
      aptosPublicKey?: string; // ED25519 public key for channel opening (needed for destinationPubkey)
    }
    ```

    - [Source: packages/connector/src/test/docker-agent-test-runner.ts:31-43 AgentInfo]
    - Note: `aptosPublicKey` needed for `/aptos-channels/open` endpoint's `destinationPubkey` parameter

  - [ ] Update constructor to load Aptos configuration from environment:
    - `APTOS_ENABLED` → `aptosEnabled` (default: true)
    - `APTOS_NODE_URL` → `aptosNodeUrl` (default: `http://aptos-local:8080` for Docker, `http://localhost:8080` for host)
    - `APTOS_FAUCET_URL` → `aptosFaucetUrl` (default: `http://aptos-local:8081` for Docker, `http://localhost:8081` for host)
    - `APTOS_MODULE_ADDRESS` → `aptosModuleAddress` (read from environment, required for channel operations)
    - [Source: packages/connector/src/test/docker-agent-test-runner.ts:279-296 constructor]
  - [ ] Add Aptos configuration to console output in `run()`:

    ```typescript
    console.log(`  Aptos Enabled: ${this.config.aptosEnabled}`);
    console.log(`  Aptos Node URL: ${this.config.aptosNodeUrl}`);
    console.log(`  Aptos Faucet URL: ${this.config.aptosFaucetUrl}`);
    console.log(`  Aptos Module Address: ${this.config.aptosModuleAddress}`);
    ```

    - [Source: packages/connector/src/test/docker-agent-test-runner.ts:328-336]

- [x] Task 2: Add Aptos Faucet and Node HTTP Utilities (AC: 3)
  - [ ] Create `aptosNodeRequest(method, path, body?)` utility function for Aptos REST API:

    ```typescript
    private async aptosNodeRequest(
      method: 'GET' | 'POST',
      path: string,
      body?: unknown
    ): Promise<unknown> {
      const url = `${this.config.aptosNodeUrl}${path}`;
      if (method === 'GET') {
        return httpGet(url);
      }
      return httpPost(url, body || {});
    }
    ```

    - [Source: packages/connector/src/test/docker-agent-test-runner.ts:1552-1597 xrplRpcRequest pattern]

  - [ ] Create `aptosFaucetFund(address)` utility function:

    ```typescript
    private async aptosFaucetFund(address: string): Promise<boolean> {
      try {
        // Local testnet faucet API: POST /mint with { address, amount }
        // Verified via scripts/aptos-fund-account.sh and integration tests
        const response = await httpPost(`${this.config.aptosFaucetUrl}/mint`, {
          address: address,
          amount: 100_000_000_000, // 1000 APT in octas (100B)
        });
        return response && (response as { success?: boolean }).success !== false;
      } catch (error) {
        console.log(`    Warning: Faucet fund failed for ${address}: ${(error as Error).message}`);
        return false;
      }
    }
    ```

    - **Faucet API Verified:** Local testnet uses `POST /mint` with `{ address: string, amount: number }`
    - [Source: scripts/aptos-fund-account.sh:83-85, packages/connector/test/integration/aptos-local-testnet.test.ts:156-164]

- [x] Task 3: Implement "Fund Aptos Accounts" Phase (AC: 3)
  - [ ] Add Aptos funding phase to `run()` method after XRP funding:

    ```typescript
    // Fund Aptos Accounts (after XRP)
    if (this.config.aptosEnabled) {
      await this.runPhase('Fund Aptos Accounts', async () => {
        return await this.fundAptosAccounts();
      });
    }
    ```

    - [Source: packages/connector/src/test/docker-agent-test-runner.ts:366-376]

  - [ ] Implement `private async fundAptosAccounts(): Promise<string>`:

    ```typescript
    private async fundAptosAccounts(): Promise<string> {
      let fundedCount = 0;
      const errors: string[] = [];

      for (const agent of this.agents) {
        try {
          // Generate Aptos account using Aptos SDK or use pre-generated
          // For local testnet, we can generate accounts and fund via faucet

          // Option 1: Use faucet to create and fund account
          // The faucet typically creates an account and funds it in one call

          // Generate a random ED25519 keypair for the agent
          // In practice, agents will derive their own keypair
          const keypair = this.generateAptosKeypair();
          const aptosAddress = keypair.address;
          const aptosPrivateKey = keypair.privateKey;

          // Fund via faucet
          const funded = await this.aptosFaucetFund(aptosAddress);

          if (funded) {
            agent.aptosAddress = aptosAddress;
            agent.aptosPrivateKey = aptosPrivateKey;
            agent.aptosPublicKey = keypair.publicKey; // Store for channel opening
            fundedCount++;
            console.log(`    Funded ${agent.agentId} Aptos account: ${aptosAddress.slice(0, 10)}...`);
          } else {
            errors.push(`${agent.agentId}: Faucet failed`);
          }
        } catch (error) {
          errors.push(`${agent.agentId}: ${(error as Error).message}`);
        }
      }

      if (errors.length > 0) {
        console.log(
          `    Funding errors: ${errors.slice(0, 3).join('; ')}${errors.length > 3 ? '...' : ''}`
        );
      }

      return `Funded ${fundedCount} Aptos accounts with 1000 APT each`;
    }
    ```

    - [Source: packages/connector/src/test/docker-agent-test-runner.ts:929-1007 fundXRPAccounts pattern]

  - [ ] Implement `generateAptosKeypair()` helper using `@aptos-labs/ts-sdk` (already a dependency v1.39.0):

    ```typescript
    // Import at top of file:
    import { Account } from '@aptos-labs/ts-sdk';

    private generateAptosKeypair(): { address: string; privateKey: string; publicKey: string } {
      // Use @aptos-labs/ts-sdk for proper ED25519 keypair and address derivation
      // This ensures correct Aptos address format (SHA3-256 hash of public key)
      const account = Account.generate();

      return {
        address: account.accountAddress.toString(),
        privateKey: account.privateKey.toString().replace('0x', ''), // 64 hex chars
        publicKey: account.publicKey.toString().replace('0x', ''),   // 64 hex chars
      };
    }
    ```

    - **SDK Confirmed Available:** `@aptos-labs/ts-sdk` v1.39.0 in packages/connector/package.json
    - [Source: packages/connector/package.json:31]

- [x] Task 4: Implement "Configure Agents Aptos" Phase (AC: 4)
  - [ ] Add Aptos configuration phase to `run()` method:
    ```typescript
    // Configure Agents with Aptos (after Fund Aptos Accounts)
    if (this.config.aptosEnabled) {
      await this.runPhase('Configure Agents Aptos', async () => {
        return await this.configureAgentsAptos();
      });
    }
    ```
  - [ ] Implement `private async configureAgentsAptos(): Promise<string>`:

    ```typescript
    private async configureAgentsAptos(): Promise<string> {
      let configuredCount = 0;
      const errors: string[] = [];

      // Agents are inside Docker, use Docker network hostnames
      const aptosNodeUrlForAgents = 'http://aptos-local:8080';

      for (const agent of this.agents) {
        if (!agent.aptosPrivateKey) {
          errors.push(`${agent.agentId}: No Aptos private key available`);
          continue;
        }

        try {
          const result = (await httpPost(`${agent.httpUrl}/configure-aptos`, {
            aptosNodeUrl: aptosNodeUrlForAgents,
            aptosPrivateKey: agent.aptosPrivateKey,
            aptosModuleAddress: this.config.aptosModuleAddress,
          })) as { success: boolean; aptosAddress?: string };

          if (result.success) {
            configuredCount++;
            if (result.aptosAddress) {
              agent.aptosAddress = result.aptosAddress;
            }
          } else {
            errors.push(`${agent.agentId}: Configuration failed`);
          }
        } catch (error) {
          errors.push(`${agent.agentId}: ${(error as Error).message}`);
        }
      }

      if (errors.length > 0) {
        console.log(
          `    Config errors: ${errors.slice(0, 3).join('; ')}${errors.length > 3 ? '...' : ''}`
        );
      }

      return `Configured ${configuredCount} agents with Aptos credentials`;
    }
    ```

    - [Source: packages/connector/src/test/docker-agent-test-runner.ts:1013-1053 configureAgentsXRP pattern]

- [x] Task 5: Update "Update Peer Addresses" Phase (AC: 5)
  - [ ] Modify `updatePeerAddresses()` to include `aptosAddress`:

    ```typescript
    // In updatePeerAddresses(), update the httpPost call:
    await httpPost(`${agent.httpUrl}/follows`, {
      pubkey: followedAgent.pubkey,
      ilpAddress: followedAgent.ilpAddress,
      evmAddress: followedAgent.evmAddress || undefined,
      xrpAddress: followedAgent.xrpAddress || undefined,
      aptosAddress: followedAgent.aptosAddress || undefined, // NEW
      petname: followedAgent.agentId,
      btpUrl: btpUrlForDocker,
    });
    ```

    - [Source: packages/connector/src/test/docker-agent-test-runner.ts:1080-1087]

- [x] Task 6: Implement "Open Aptos Payment Channels" Phase (AC: 6)
  - [ ] Add Aptos channel opening phase to `run()` method:

    ```typescript
    // Open Aptos Payment Channels (after XRP channels)
    if (this.config.aptosEnabled) {
      await this.runPhase('Open Aptos Payment Channels', async () => {
        return await this.openAptosChannels();
      });
    }
    ```

    - [Source: packages/connector/src/test/docker-agent-test-runner.ts:395-399]

  - [ ] Implement `private async openAptosChannels(): Promise<string>`:

    ```typescript
    private async openAptosChannels(): Promise<string> {
      const topology =
        this.config.agentCount <= 5
          ? SOCIAL_GRAPH_5_PEERS
          : this.generateSocialGraph(this.config.agentCount);

      let channelCount = 0;
      const errors: string[] = [];
      const APTOS_CHANNEL_AMOUNT = '100000000000'; // 1000 APT in octas (100B)
      const SETTLE_DELAY = 3600; // 1 hour

      for (const [peerIndexStr, followIndices] of Object.entries(topology)) {
        const peerIndex = parseInt(peerIndexStr, 10);
        if (peerIndex >= this.config.agentCount) continue;

        const agent = this.agents[peerIndex];
        if (!agent || !agent.aptosAddress) continue;

        for (const followIndex of followIndices) {
          if (followIndex >= this.config.agentCount) continue;
          const targetAgent = this.agents[followIndex];
          if (!targetAgent || !targetAgent.aptosAddress) continue;

          try {
            // Get target agent's public key for claim verification
            // Public key is stored in AgentInfo during account generation (Task 3)
            const destinationPubkey = targetAgent.aptosPublicKey || '';
            if (!destinationPubkey) {
              errors.push(`${agent.agentId} -> ${targetAgent.agentId}: No public key for destination`);
              continue;
            }

            // Call agent HTTP API to open Aptos payment channel
            const result = (await httpPost(`${agent.httpUrl}/aptos-channels/open`, {
              destination: targetAgent.aptosAddress,
              destinationPubkey: destinationPubkey,
              amount: APTOS_CHANNEL_AMOUNT,
              settleDelay: SETTLE_DELAY,
            })) as { channelOwner?: string; success: boolean; error?: string };

            if (result.success && result.channelOwner) {
              channelCount++;
              console.log(
                `    Opened Aptos channel: ${agent.agentId} -> ${targetAgent.agentId} (${result.channelOwner.slice(0, 10)}...)`
              );
            } else {
              errors.push(
                `${agent.agentId} -> ${targetAgent.agentId}: ${result.error || 'Unknown error'}`
              );
            }
          } catch (error) {
            errors.push(`${agent.agentId} -> ${targetAgent.agentId}: ${(error as Error).message}`);
          }
        }
      }

      if (errors.length > 0) {
        console.log(
          `    Aptos channel errors: ${errors.slice(0, 3).join('; ')}${errors.length > 3 ? '...' : ''}`
        );
      }

      return `Opened ${channelCount} Aptos payment channels`;
    }
    ```

    - [Source: packages/connector/src/test/docker-agent-test-runner.ts:1099-1159 openXRPChannels pattern]

- [x] Task 7: Implement "Verify Aptos Channels" Phase (AC: 7)
  - [ ] Add Aptos channel verification phase to `run()` method:

    ```typescript
    // Verify Aptos Payment Channel State (after XRP verification)
    if (this.config.aptosEnabled) {
      await this.runPhase('Verify Aptos Channels', async () => {
        return await this.verifyAptosChannels();
      });
    }
    ```

    - [Source: packages/connector/src/test/docker-agent-test-runner.ts:419-423]

  - [ ] Implement `private async verifyAptosChannels(): Promise<string>`:

    ```typescript
    private async verifyAptosChannels(): Promise<string> {
      let totalChannels = 0;
      let totalDeposited = 0n;
      const agentStats: string[] = [];

      for (const agent of this.agents) {
        try {
          const channelsResult = (await httpGet(`${agent.httpUrl}/aptos-channels`)) as {
            channels: Array<{
              channelOwner: string;
              destination: string;
              deposited: string;
              claimed: string;
              status: string;
            }>;
          };

          const channels = channelsResult.channels || [];
          totalChannels += channels.length;

          for (const ch of channels) {
            totalDeposited += BigInt(ch.deposited || '0');
          }

          if (channels.length > 0) {
            agentStats.push(`${agent.agentId}: ${channels.length} Aptos channels`);
          }
        } catch (error) {
          // Aptos channels endpoint may not be available - skip
          console.log(`    Warning: Could not query Aptos channels for ${agent.agentId}`);
        }
      }

      if (agentStats.length > 0) {
        console.log(`    Aptos channel distribution: ${agentStats.join(', ')}`);
      }

      // Convert octas to APT for display (1 APT = 100M octas)
      const depositInAPT = Number(totalDeposited) / 100_000_000;
      return `Verified ${totalChannels} Aptos channels with ${depositInAPT.toFixed(2)} APT deposited`;
    }
    ```

    - [Source: packages/connector/src/test/docker-agent-test-runner.ts:1164-1199 verifyXRPChannels pattern]

- [x] Task 8: Implement "Claim Aptos Channels" Phase (AC: 8)
  - [ ] Add Aptos claim phase to `run()` method:
    ```typescript
    // Claim Aptos Channels (after XRP claim)
    if (this.config.aptosEnabled) {
      await this.runPhase('Claim Aptos Channels', async () => {
        return await this.claimAptosChannels();
      });
    }
    ```
  - [ ] Implement `private async claimAptosChannels(): Promise<string>`:

    ```typescript
    private async claimAptosChannels(): Promise<string> {
      let claimedCount = 0;
      const errors: string[] = [];

      for (const agent of this.agents) {
        try {
          // Get channels where this agent is the destination
          const channelsResult = (await httpGet(`${agent.httpUrl}/aptos-channels`)) as {
            channels: Array<{
              channelOwner: string;
              destination: string;
              deposited: string;
              claimed: string;
              nonce: number;
              status: string;
            }>;
          };

          // For each channel where agent is destination, try to submit a claim
          // Note: In a real test, claims would be signed by the channel owner
          // and submitted by the destination. For integration testing,
          // we verify the claim endpoint works correctly.

          for (const ch of channelsResult.channels || []) {
            if (ch.status !== 'open') continue;

            // Skip if already fully claimed
            if (ch.claimed === ch.deposited) continue;

            try {
              // For testing, claim a small amount (10 APT = 1B octas)
              const claimAmount = Math.min(
                1_000_000_000, // 10 APT
                Number(BigInt(ch.deposited) - BigInt(ch.claimed))
              ).toString();

              // Note: Real claim requires signature from channel owner
              // This test validates the HTTP endpoint flow
              const result = (await httpPost(`${agent.httpUrl}/aptos-channels/claim`, {
                channelOwner: ch.channelOwner,
                amount: claimAmount,
                nonce: ch.nonce + 1,
                signature: '0x...', // Would need real signature from owner
              })) as { success: boolean; error?: string };

              if (result.success) {
                claimedCount++;
              }
            } catch {
              // Claim may fail without valid signature - expected
            }
          }
        } catch (error) {
          errors.push(`${agent.agentId}: ${(error as Error).message}`);
        }
      }

      if (errors.length > 0) {
        console.log(
          `    Claim errors: ${errors.slice(0, 3).join('; ')}${errors.length > 3 ? '...' : ''}`
        );
      }

      return `Submitted ${claimedCount} Aptos channel claims`;
    }
    ```

    - [Source: packages/connector/src/test/docker-agent-test-runner.ts claimXRPChannels pattern]
    - Note: Full claim testing requires proper signature flow; this validates endpoint connectivity

- [x] Task 9: Implement "Verify Aptos Settlement" Phase (AC: 9)
  - [ ] Add Aptos settlement verification phase to `run()` method:
    ```typescript
    // Verify Aptos Settlement On-Chain (after XRP settlement verification)
    if (this.config.aptosEnabled) {
      await this.runPhase('Verify Aptos Settlement', async () => {
        return await this.verifyAptosSettlement();
      });
    }
    ```
  - [ ] Implement `private async verifyAptosSettlement(): Promise<string>`:

    ```typescript
    private async verifyAptosSettlement(): Promise<string> {
      let verifiedChannels = 0;
      let totalClaimed = 0n;
      const errors: string[] = [];

      for (const agent of this.agents) {
        try {
          const channelsResult = (await httpGet(`${agent.httpUrl}/aptos-channels`)) as {
            channels: Array<{
              channelOwner: string;
              destination: string;
              deposited: string;
              claimed: string;
              status: string;
            }>;
          };

          for (const ch of channelsResult.channels || []) {
            verifiedChannels++;
            totalClaimed += BigInt(ch.claimed || '0');

            // Optionally verify on-chain state via Aptos node
            // For now, trust the agent's local state
          }
        } catch (error) {
          errors.push(`${agent.agentId}: ${(error as Error).message}`);
        }
      }

      if (errors.length > 0) {
        console.log(
          `    Verification errors: ${errors.slice(0, 3).join('; ')}${errors.length > 3 ? '...' : ''}`
        );
      }

      const claimedInAPT = Number(totalClaimed) / 100_000_000;
      return `Verified ${verifiedChannels} Aptos channels, ${claimedInAPT.toFixed(2)} APT claimed`;
    }
    ```

    - [Source: packages/connector/src/test/docker-agent-test-runner.ts verifyXRPSettlement pattern]

- [x] Task 10: Update "Report Agent Balances" Phase (AC: 10)
  - [ ] Modify `reportAgentBalances()` to include Aptos balances:

    ```typescript
    // In reportAgentBalances(), update the balances query handling:
    const balances = (await httpGet(`${agent.httpUrl}/balances`)) as {
      evmAddress?: string;
      evmBalance?: string;
      xrpAddress?: string;
      xrpBalance?: string;
      aptosAddress?: string; // NEW
      aptosBalance?: string; // NEW
    };

    // Add Aptos balance to report
    if (balances.aptosAddress && balances.aptosBalance) {
      console.log(`      Aptos: ${balances.aptosBalance} APT`);
    }
    ```

    - [Source: packages/connector/src/test/docker-agent-test-runner.ts reportAgentBalances]

- [x] Task 11: Add Aptos Status to collectAgentInfo (AC: 2)
  - [ ] Update `collectAgentInfo()` to fetch Aptos address from status:

    ```typescript
    // In collectAgentInfo(), update status response type:
    const status = (await httpGet(`${httpUrl}/status`)) as {
      agentId: string;
      pubkey: string;
      ilpAddress: string;
      evmAddress: string;
      xrpAddress?: string;
      aptosAddress?: string; // NEW
      aptosPublicKey?: string; // NEW (for channel opening)
      initialized: boolean;
    };

    // Update AgentInfo assignment:
    this.agents.push({
      index: i,
      containerId: `agent-${i}`,
      httpUrl,
      btpUrl,
      agentId: status.agentId,
      pubkey: status.pubkey,
      ilpAddress: status.ilpAddress,
      evmAddress: status.evmAddress || '',
      xrpAddress: status.xrpAddress || '',
      xrpSecret: '',
      aptosAddress: status.aptosAddress || '', // NEW
      aptosPrivateKey: '', // NEW - set during fundAptosAccounts
      aptosPublicKey: '', // NEW - set during fundAptosAccounts
      initialized: status.initialized,
    });
    ```

    - [Source: packages/connector/src/test/docker-agent-test-runner.ts:514-543]

- [x] Task 12: Update Phase Ordering in run() Method (AC: 11)
  - [ ] Ensure Aptos phases are in correct order and conditional:

    ```typescript
    // Phase ordering in run():
    // ... Phase 1-5: Agents, Info, Social Graph, EVM Contracts, EVM Funding

    // Phase 6: Fund XRP Accounts (if XRP enabled)
    // Phase 7: Configure Agents XRP (if XRP enabled)
    // Phase 8: Fund Aptos Accounts (if Aptos enabled)     // NEW
    // Phase 9: Configure Agents Aptos (if Aptos enabled)  // NEW
    // Phase 10: Update Peer Addresses
    // Phase 11: Establish BTP Connections
    // Phase 12: Open EVM Payment Channels (if EVM enabled)
    // Phase 13: Open XRP Payment Channels (if XRP enabled)
    // Phase 14: Open Aptos Payment Channels (if Aptos enabled)  // NEW
    // Phase 15: Broadcast Events
    // Phase 16: Verify Results
    // Phase 17: Verify EVM Channels (if EVM enabled)
    // Phase 18: Verify XRP Channels (if XRP enabled)
    // Phase 19: Verify Aptos Channels (if Aptos enabled)  // NEW
    // Phase 20: Settle EVM Channels (if EVM enabled)
    // Phase 21: Claim XRP Channels (if XRP enabled)
    // Phase 22: Claim Aptos Channels (if Aptos enabled)   // NEW
    // Phase 23: Verify EVM Settlement (if EVM enabled)
    // Phase 24: Verify XRP Settlement (if XRP enabled)
    // Phase 25: Verify Aptos Settlement (if Aptos enabled) // NEW
    // Phase 26: Report Agent Balances
    ```

    - [Source: packages/connector/src/test/docker-agent-test-runner.ts:339-458]

- [x] Task 13: Add Import for Aptos SDK (AC: 3)
  - [ ] Add import for `@aptos-labs/ts-sdk` Account class for key generation:

    ```typescript
    // At top of file, add import for Aptos SDK account generation:
    import { Account } from '@aptos-labs/ts-sdk';
    ```

    - **Dependency already available:** `@aptos-labs/ts-sdk` v1.39.0 in packages/connector/package.json
    - [Source: packages/connector/package.json:31]
    - This provides proper ED25519 keypair generation with correct Aptos address derivation (SHA3-256)

- [x] Task 14: Integration Test Validation (AC: 12)
  - [ ] Run full Docker agent test with Aptos enabled:
    ```bash
    APTOS_ENABLED=true ./scripts/run-docker-agent-test.sh
    ```
  - [ ] Verify test output shows all Aptos phases:
    - `✓ Fund Aptos Accounts: Funded N Aptos accounts`
    - `✓ Configure Agents Aptos: Configured N agents`
    - `✓ Open Aptos Payment Channels: Opened N channels`
    - `✓ Verify Aptos Channels: Verified N channels`
    - `✓ Claim Aptos Channels: Submitted N claims`
    - `✓ Verify Aptos Settlement: Verified N channels`
  - [ ] Verify test passes on ARM64 Mac with native Aptos mode
  - [ ] Verify test passes with `APTOS_ENABLED=false` (Aptos phases skipped)

## Dev Notes

### Story Context

This is the **second story in Epic 14: Complete Aptos Payment Channel Integration**. Epic 14 completes the Aptos payment channel integration across all system layers to enable tri-chain settlement (EVM + XRP + Aptos).

**Epic 14 Context:**

- **Story 14.1** (Complete): Add Agent Server Aptos HTTP Endpoints
- **Story 14.2 (this story)**: Add Test Runner Aptos Phases
- **Story 14.3**: Build Multi-Arch Aptos Docker Image
- **Story 14.4**: Integrate Aptos into Test Infrastructure
- **Story 14.5**: Production Connector Aptos Settlement

**Architectural Role:**

Story 14.2 **adds Aptos payment channel test phases to the Docker agent test runner**, enabling end-to-end validation of Aptos channels alongside EVM and XRP. This ensures the Aptos HTTP endpoints (Story 14.1) work correctly in the full integration test environment.

**Dependency:**

Story 14.2 depends on Story 14.1 (Aptos HTTP endpoints) being complete. The test runner will call the endpoints implemented in 28.1:

- `POST /configure-aptos`
- `POST /aptos-channels/open`
- `GET /aptos-channels`
- `POST /aptos-channels/claim`

### Previous Story Insights

**Story 14.1 Completion Notes:**

Story 14.1 added the following Aptos HTTP endpoints to agent-server.ts:

1. **`POST /configure-aptos`** - Runtime Aptos configuration
   - Request: `{ aptosNodeUrl, aptosPrivateKey, aptosModuleAddress }`
   - Response: `{ success, aptosAddress }`
   - [Source: agent-server.ts:769-793]

2. **`GET /aptos-channels`** - List all Aptos channels
   - Response: `{ channels: AptosPaymentChannel[] }`
   - [Source: agent-server.ts:797-809]

3. **`POST /aptos-channels/open`** - Open new channel
   - Request: `{ destination, destinationPubkey, amount, settleDelay }`
   - Response: `{ success, channelOwner?, error? }`
   - [Source: agent-server.ts:813-829]

4. **`GET /aptos-channels/:id`** - Get channel state
   - Response: `{ channel: AptosPaymentChannel }`
   - [Source: agent-server.ts:833-882]

5. **`POST /aptos-channels/claim`** - Submit claim
   - Request: `{ channelOwner, amount, nonce, signature }`
   - Response: `{ success, channelOwner, claimedAmount?, error? }`
   - [Source: agent-server.ts:886-897]

6. **`/status` updates** - Includes `aptosChannelCount`, `aptosAddress`, `aptosEnabled`
   - [Source: agent-server.ts:577-587]

7. **`/balances` updates** - Includes `aptosAddress`, `aptosBalance`, `aptosChannels[]`
   - [Source: agent-server.ts:2236-2277]

### Data Models

**Extended TestConfig:**

[Source: packages/connector/src/test/docker-agent-test-runner.ts]

```typescript
interface TestConfig {
  // Existing fields
  anvilRpcUrl: string;
  xrplRpcUrl: string;
  xrplWssUrl: string;
  xrpEnabled: boolean;
  evmEnabled: boolean;
  agentCount: number;
  agentBaseHttpPort: number;
  agentBaseBtpPort: number;
  useDockerHostnames: boolean;

  // New Aptos fields
  aptosEnabled: boolean;
  aptosNodeUrl: string;
  aptosFaucetUrl: string;
  aptosModuleAddress: string;
}
```

**Extended AgentInfo:**

[Source: packages/connector/src/test/docker-agent-test-runner.ts]

```typescript
interface AgentInfo {
  // Existing fields
  index: number;
  containerId: string;
  httpUrl: string;
  btpUrl: string;
  agentId: string;
  pubkey: string;
  ilpAddress: string;
  evmAddress: string;
  xrpAddress: string;
  xrpSecret: string;
  initialized: boolean;

  // New Aptos fields
  aptosAddress?: string; // Account address (0x-prefixed, 64 hex chars)
  aptosPrivateKey?: string; // ED25519 private key for agent configuration
  aptosPublicKey?: string; // ED25519 public key for channel opening (destinationPubkey)
}
```

**Note on aptosPublicKey:** The public key is generated during `fundAptosAccounts()` phase using `@aptos-labs/ts-sdk` Account.generate() and stored in AgentInfo. This is needed for the `destinationPubkey` parameter when opening channels, as the `/status` endpoint does not expose the public key.

### API Specifications

**Agent Server Endpoints Used by Test Runner:**

| Method | Endpoint                | Purpose                    | Request                                                   | Response                                     |
| ------ | ----------------------- | -------------------------- | --------------------------------------------------------- | -------------------------------------------- |
| POST   | `/configure-aptos`      | Configure Aptos at runtime | `{ aptosNodeUrl, aptosPrivateKey, aptosModuleAddress }`   | `{ success, aptosAddress }`                  |
| GET    | `/aptos-channels`       | List Aptos channels        | -                                                         | `{ channels: AptosPaymentChannel[] }`        |
| POST   | `/aptos-channels/open`  | Open new channel           | `{ destination, destinationPubkey, amount, settleDelay }` | `{ success, channelOwner?, error? }`         |
| POST   | `/aptos-channels/claim` | Submit claim               | `{ channelOwner, amount, nonce, signature }`              | `{ success, claimedAmount?, error? }`        |
| GET    | `/status`               | Get agent status           | -                                                         | Includes `aptosAddress`, `aptosChannelCount` |
| GET    | `/balances`             | Get agent balances         | -                                                         | Includes `aptosBalance`, `aptosChannels`     |
| POST   | `/follows`              | Add follow with addresses  | `{ ..., aptosAddress? }`                                  | -                                            |

**Aptos Local Testnet Endpoints:**

| Service       | Endpoint                       | Purpose               |
| ------------- | ------------------------------ | --------------------- |
| Node REST API | `http://aptos-local:8080/v1`   | Aptos node operations |
| Faucet        | `http://aptos-local:8081/mint` | Fund test accounts    |

### File Locations

**Primary File to Modify:**

- `packages/connector/src/test/docker-agent-test-runner.ts` - Add Aptos test phases

**Related Files (Read-Only):**

- `packages/connector/src/agent/agent-server.ts` - Aptos HTTP endpoints (Story 14.1)
- `packages/connector/src/settlement/aptos-channel-sdk.ts` - Aptos SDK (Epic 13)
- `docker-compose-agent-test.yml` - Docker test infrastructure

### Testing Requirements

**Testing Strategy:**

[Source: docs/architecture/test-strategy-and-standards.md]

Story 14.2 is primarily validated through the integration test itself. The test phases should:

1. **Complete Successfully** - All Aptos phases pass
2. **Handle Errors Gracefully** - Failed operations logged, don't crash
3. **Skip When Disabled** - `APTOS_ENABLED=false` skips all Aptos phases
4. **Work on ARM64** - Test passes on ARM64 Mac with native Aptos

**Integration Test Validation (Task 14):**

```bash
# Run full test with Aptos
APTOS_ENABLED=true ./scripts/run-docker-agent-test.sh

# Verify Aptos phases in output
# Verify no Aptos phases with APTOS_ENABLED=false
```

**Expected Test Output:**

```
[Phase] Fund Aptos Accounts...
  ✓ Funded 5 Aptos accounts with 1000 APT each (XXms)

[Phase] Configure Agents Aptos...
  ✓ Configured 5 agents with Aptos credentials (XXms)

[Phase] Open Aptos Payment Channels...
    Opened Aptos channel: agent-0 -> agent-1 (0x123...)
    ...
  ✓ Opened 14 Aptos payment channels (XXms)

[Phase] Verify Aptos Channels...
    Aptos channel distribution: agent-0: 4 Aptos channels, ...
  ✓ Verified 14 Aptos channels with 14000.00 APT deposited (XXms)
```

### Coding Standards

**Core Standards:**

[Source: docs/architecture/coding-standards.md]

- **TypeScript Strict Mode:** All code uses strict type checking
- **Method Naming:** `fundAptosAccounts()`, `configureAgentsAptos()`, `openAptosChannels()` (camelCase)
- **Console Logging:** Test runner uses `console.log` (allowed for test output)
- **Error Handling:** All async functions use try-catch with error logging
- **Buffer Usage:** Use `Buffer` for binary data (Node.js convention)

**Test Runner Patterns:**

[Source: packages/connector/src/test/docker-agent-test-runner.ts]

1. **Phase Execution:** Use `runPhase(name, fn)` for all test phases
2. **Error Collection:** Collect errors in array, log summary at end
3. **Topology-Based Operations:** Use social graph for channel operations
4. **Docker Hostname Awareness:** Use Docker hostnames when `useDockerHostnames=true`

### Technical Constraints

**Aptos Address Format:**

- Format: 0x-prefixed hex string, 64 characters (32 bytes)
- Example: `0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef`

**ED25519 Key Generation:**

- Node.js crypto module: `crypto.generateKeyPairSync('ed25519')`
- Private key: 32 bytes
- Public key: 32 bytes
- Aptos address derived from public key hash

**Aptos Amount Units:**

- 1 APT = 100,000,000 octas (100M)
- Channel amounts should be in octas (bigint-safe strings)
- Display amounts in APT for logging

**Local Testnet Services:**

| Service      | Docker Hostname | Host Port | Description   |
| ------------ | --------------- | --------- | ------------- |
| Aptos Node   | aptos-local     | 8080      | REST API      |
| Aptos Faucet | aptos-local     | 8081      | Fund accounts |

### Risks and Mitigations

**Risk 1: Aptos Faucet API Variability** ✅ RESOLVED

- **Risk:** Local testnet faucet may have different API than expected
- **Probability:** Low (verified)
- **Mitigation:** Faucet API confirmed via `scripts/aptos-fund-account.sh` and integration tests
- **Resolution:** Use `POST /mint` with `{ address: "0x...", amount: <octas> }` - this is the actual local testnet faucet API
- **Impact:** None - API is documented and verified

**Risk 2: ED25519 Key Derivation Differences** ✅ RESOLVED

- **Risk:** Aptos address derivation may differ from simple implementation
- **Probability:** None (resolved)
- **Mitigation:** `@aptos-labs/ts-sdk` v1.39.0 is already a dependency in `packages/connector/package.json`
- **Resolution:** Use `Account.generate()` from `@aptos-labs/ts-sdk` for proper key generation and address derivation
- **Impact:** None - SDK is available

**Risk 3: Public Key Availability for Channel Opening** ⚠️ NEEDS ATTENTION

- **Risk:** Agent status endpoint does not currently expose `aptosPublicKey` needed for channel opening
- **Probability:** Confirmed - `/status` only includes `aptosAddress` and `aptosEnabled`, not public key
- **Mitigation Options:**
  1. **Option A (Preferred):** Add `aptosPublicKey` to `/status` response in agent-server.ts (minor update to Story 14.1)
  2. **Option B:** Have test runner derive public key from private key after funding (test runner already has private key)
  3. **Option C:** Update `/configure-aptos` response to return public key alongside address
- **Recommended Resolution:** Implement Option B in test runner - after `generateAptosKeypair()` the public key is already available and can be stored in `AgentInfo.aptosPublicKey` field
- **Impact:** Low - add `aptosPublicKey?: string` to AgentInfo and store during account generation

**Risk 4: Claim Signature Flow**

- **Risk:** Real claims require signatures from channel owner, not destination
- **Probability:** High (by design)
- **Mitigation:** Test validates endpoint connectivity; full claim flow tested in E2E
- **Impact:** Low - expected limitation for integration test

### Out of Scope for Story 14.2

**Explicitly NOT included in this story:**

1. **Agent Server Endpoints** - Already implemented in Story 14.1
2. **Docker Image Build** - Story 14.3 builds multi-arch Aptos image
3. **docker-compose Updates** - Story 14.4 updates test infrastructure
4. **Production Connector** - Story 14.5 integrates with settlement flow
5. **Full Claim Signature Flow** - Requires owner signature; out of scope for test runner
6. **On-Chain State Verification** - Trust agent's local state for MVP

### Success Criteria

**Story 14.2 is successful when:**

1. ✅ `aptosEnabled` flag controls Aptos phase execution
2. ✅ `AgentInfo` includes `aptosAddress`, `aptosPrivateKey`, and `aptosPublicKey`
3. ✅ "Fund Aptos Accounts" phase funds agents via faucet
4. ✅ "Configure Agents Aptos" phase configures agents via HTTP
5. ✅ "Update Peer Addresses" includes `aptosAddress`
6. ✅ "Open Aptos Payment Channels" opens channels between peers
7. ✅ "Verify Aptos Channels" validates channel state
8. ✅ "Claim Aptos Channels" attempts claim submissions
9. ✅ "Verify Aptos Settlement" confirms channel state
10. ✅ Test output shows successful Aptos phases
11. ✅ `APTOS_ENABLED=false` skips Aptos phases
12. ✅ Test passes on ARM64 Mac with native Aptos

**Quality Metrics:**

- All Aptos phases execute without crash
- Errors logged gracefully, don't block other phases
- Phase timing reported accurately
- Consistent with EVM/XRP phase patterns

## Dev Agent Record

_To be filled in by implementing agent_

### Agent Model Used

### Implementation Summary

### File List

### Completion Notes

### Debug Log References

## Change Log

| Date       | Version | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                | Author                        |
| ---------- | ------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------- |
| 2026-01-31 | 1.0     | Initial story creation with comprehensive technical details from Epic 14 requirements, docker-agent-test-runner.ts patterns (EVM/XRP phases), Story 14.1 Aptos endpoints, coding standards, and testing strategy. Story focuses on adding Aptos test phases mirroring existing payment channel patterns.                                                                                                                                                                   | Claude (Story Creation Agent) |
| 2026-01-31 | 1.1     | Validation fixes: (1) Confirmed `@aptos-labs/ts-sdk` v1.39.0 available - updated Task 3 and Task 13 to use `Account.generate()` for proper key derivation; (2) Confirmed faucet API format `POST /mint` with `{ address, amount }` - updated Task 2 with verified API; (3) Added `aptosPublicKey` to AgentInfo for channel opening since `/status` doesn't expose public key - updated Tasks 1, 3, 6, 11 and Data Models; (4) Updated Risk section to mark resolved risks. | Claude (QA Validation)        |
