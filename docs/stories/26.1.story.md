# Story 26.1: Trim Connector Dependencies and Configure Peer Dependencies

## Status

Done

## Story

**As a** package consumer,
**I want** `@agent-society/connector` to have minimal required dependencies,
**so that** I don't pull in blockchain SDKs, cloud libraries, and AI frameworks when I only need the ILP connector.

## Acceptance Criteria

1. `npm install @agent-society/connector` installs ≤ 10 direct dependencies
2. Connector starts successfully with only core dependencies (no settlement, no AdminServer)
3. Settlement features produce clear error message if blockchain SDK not installed
4. AdminServer produces clear error message if Express not installed
5. Dynamic imports used for all optional features — no top-level import failures
6. `peerDependenciesMeta` marks all peer dependencies as optional
7. All existing tests still pass (test environment has all deps installed)
8. New test verifies startup without optional dependencies

## Tasks / Subtasks

- [x] Task 1: Audit and categorize all connector dependencies (AC: 1)
  - [x] 1.1 Review current `packages/connector/package.json` — 42 direct dependencies currently listed
  - [x] 1.2 Categorize each dependency into: **core** (keep as direct), **peer-optional** (move to peerDependencies), **optional** (move to optionalDependencies), or **remove** (unused/dead)
  - [x] 1.3 Verify the following remain as direct dependencies (core):
    - `@agent-society/shared` — ILP types, OER codec
    - `ws` — BTP WebSocket protocol
    - `pino` — Logging
    - `tslib` — TypeScript runtime helpers
    - `zod` — Config validation
    - `js-yaml` — Config file loading (used by ConfigLoader for CLI path)
  - [x] 1.4 Identify and remove unused dependencies that have zero imports in source:
    - `connect-timeout` — zero imports found in src/
    - `multer` — zero imports found in src/
    - `node-cron` — zero imports found in src/
    - `@toon-format/toon` — zero imports found in connector src/ (only used in agent-society)
    - `@aws-sdk/client-s3` — zero imports found in src/
    - `@types/connect-timeout`, `@types/multer` — remove from devDependencies (types for unused packages)
    - `@types/node-cron` — remove from devDependencies (types for unused package)
    - `@types/cors` — move from dependencies to devDependencies (currently misplaced in dependencies; types should always be devDependencies)
  - [x] 1.5 Remove `ethereum-cryptography` from dependencies — only imported via deep path (`ethereum-cryptography/hdkey`) in one integration test file (`test/integration/wallet-derivation.test.ts`). Move to devDependencies. Consider removing entirely if `ethers` bundles the needed crypto primitives.

- [x] Task 2: Move blockchain SDKs to peerDependencies with optional meta (AC: 1, 5, 6)
  - [x] 2.1 Move `ethers` to `peerDependencies` — used in 8 source files (connector-node.ts, payment-channel-sdk.ts, key-manager-signer.ts, environment-backend.ts, evm-rpc-connection-pool.ts, treasury-wallet.ts, claim-redemption-service.ts, test-utils/mock-factories.ts)
  - [x] 2.2 Move `xrpl` to `peerDependencies` — used in 4 source files (xrpl-client.ts, xrp-wss-connection-pool.ts, treasury-wallet.ts, environment-backend.ts)
  - [x] 2.3 Move `@aptos-labs/ts-sdk` to `peerDependencies` — used in 2 source files (aptos-client.ts, aptos-claim-signer.ts)
  - [x] 2.4 Move `tigerbeetle-node` to `peerDependencies` — used in 3 source files (account-manager.ts, account-metadata.ts, tigerbeetle-client.ts)
  - [x] 2.5 Move `better-sqlite3` to `peerDependencies` — used in 7 source files (audit-logger.ts, wallet-security.ts, claim-receiver.ts, claim-sender.ts, xrp-claim-signer.ts, xrp-channel-manager.ts, claim-receiver-db-schema.ts, claim-redemption-service.ts)
  - [x] 2.6 Move `express` to `peerDependencies` — used in 6 source files (health-server.ts, admin-server.ts, admin-api.ts, settlement-api.ts, explorer-server.ts, prometheus-exporter.ts)
  - [x] 2.7 Move `cors` to `peerDependencies` — listed in dependencies but zero imports found (may be used indirectly by express setup)
  - [x] 2.8 Add `peerDependenciesMeta` marking ALL peer dependencies as `{ "optional": true }`

- [x] Task 3: Move optional/niche dependencies to optionalDependencies (AC: 1, 5)
  - [x] 3.1 Move `nostr-tools` to `optionalDependencies` — zero imports in connector src/ (agent-society only)
  - [x] 3.2 Move `@aws-sdk/client-kms` to `optionalDependencies` — used only in `security/backends/aws-kms-backend.ts`
  - [x] 3.3 Move `@azure/identity` and `@azure/keyvault-keys` to `optionalDependencies` — used only in `security/backends/azure-kv-backend.ts`
  - [x] 3.4 Move `@google-cloud/kms` to `optionalDependencies` — used only in `security/backends/gcp-kms-backend.ts`
  - [x] 3.5 Move `ai`, `@ai-sdk/anthropic`, `@ai-sdk/openai` to `optionalDependencies` — zero imports in connector src/ (only agent module)
  - [x] 3.6 Move `sharp` and `qrcode` to `optionalDependencies` — `qrcode` used only in `wallet/wallet-seed-manager.ts`, `sharp` has zero imports
  - [x] 3.7 Move `prom-client` to `optionalDependencies` — used only in `observability/prometheus-exporter.ts`
  - [x] 3.8 Move `@opentelemetry/api`, `@opentelemetry/exporter-trace-otlp-http`, `@opentelemetry/resources`, `@opentelemetry/sdk-node`, `@opentelemetry/semantic-conventions` to `optionalDependencies` — used only in `observability/otel-tracer.ts`
  - [x] 3.9 Move `@libsql/client` to `optionalDependencies` — used only in `explorer/event-store.ts`
  - [x] 3.10 Move `bip39` to `optionalDependencies` — used only in `wallet/wallet-seed-manager.ts`
  - [x] 3.11 Move `inquirer` to `optionalDependencies` — used only in `cli/onboarding-wizard.ts` (CLI-only)
  - [x] 3.12 Move `commander` to `optionalDependencies` — used only in `cli/index.ts` (CLI-only)
  - [x] 3.13 Move `pino-abstract-transport` to `optionalDependencies` — used only in `telemetry/pino-telemetry-transport.ts`

- [x] Task 4: Convert top-level imports to dynamic imports for optional features (AC: 3, 4, 5)
  - [x] 4.1 **Create shared helper (FIRST):** Create `utils/optional-require.ts` with the `requireOptional<T>(packageName, feature)` helper function. All subsequent dynamic imports in Tasks 4.2–4.12 should use this helper for consistency.
    - Example usage: `const { ethers } = await requireOptional<typeof import('ethers')>('ethers', 'EVM settlement');`
  - [x] 4.2 **Settlement modules (ethers):** In all 8 files importing `ethers` (connector-node.ts, payment-channel-sdk.ts, key-manager-signer.ts, environment-backend.ts, evm-rpc-connection-pool.ts, treasury-wallet.ts, claim-redemption-service.ts, test-utils/mock-factories.ts), convert top-level `import { ethers } from 'ethers'` to dynamic `import()` via `requireOptional`. Add clear error message: `"ethers is required for EVM settlement. Install it with: npm install ethers"`. Note: `test-utils/mock-factories.ts` is a test utility — if it only provides test helpers, its ethers import can remain top-level since test environments have all deps installed.
  - [x] 4.3 **Settlement modules (xrpl):** In `xrpl-client.ts` and `xrp-wss-connection-pool.ts`, convert top-level `import` from `'xrpl'` to dynamic `import()` with error message: `"xrpl is required for XRP settlement. Install it with: npm install xrpl"`
  - [x] 4.4 **Settlement modules (@aptos-labs/ts-sdk):** In `aptos-client.ts` and `aptos-claim-signer.ts`, convert top-level imports to dynamic `import()` with error message: `"@aptos-labs/ts-sdk is required for Aptos settlement. Install it with: npm install @aptos-labs/ts-sdk"`
  - [x] 4.5 **TigerBeetle:** In `tigerbeetle-client.ts`, convert top-level `import` from `'tigerbeetle-node'` to dynamic `import()` with error message: `"tigerbeetle-node is required for TigerBeetle accounting. Install it with: npm install tigerbeetle-node"`
  - [x] 4.6 **SQLite:** In files importing `better-sqlite3` (audit-logger.ts, wallet-security.ts, claim-receiver.ts, claim-sender.ts, xrp-claim-signer.ts, xrp-channel-manager.ts, claim-receiver-db-schema.ts, claim-redemption-service.ts), convert to dynamic `import()` with error message: `"better-sqlite3 is required for local persistence. Install it with: npm install better-sqlite3"`
  - [x] 4.7 **Express/HTTP APIs:** In ALL 6 express-using files (admin-server.ts, health-server.ts, admin-api.ts, settlement-api.ts, explorer-server.ts, prometheus-exporter.ts), convert top-level `import express` to dynamic `import()` with error message: `"express is required for HTTP admin/health APIs. Install it with: npm install express"`
  - [x] 4.8 **Cloud KMS backends:** In `aws-kms-backend.ts`, `azure-kv-backend.ts`, `gcp-kms-backend.ts`, convert to dynamic `import()` with descriptive error messages (cloud KMS test files already use dynamic require pattern — extend to source)
  - [x] 4.9 **Observability:** In `otel-tracer.ts`, convert `@opentelemetry/*` imports to dynamic `import()` with error messages. Note: `prometheus-exporter.ts` prom-client import also needs conversion here (express conversion handled in 4.7).
  - [x] 4.10 **Wallet utilities:** In `wallet-seed-manager.ts`, convert `bip39` and `qrcode` imports to dynamic `import()` with error messages
  - [x] 4.11 **Explorer:** In `event-store.ts`, convert `@libsql/client` import to dynamic `import()` with error message
  - [x] 4.12 **Other optional modules:** Convert remaining optional imports (`pino-abstract-transport`, `nostr-tools` if any) to dynamic `import()`

- [x] Task 5: Verify connector starts without optional dependencies (AC: 2, 3, 4)
  - [x] 5.1 Create `packages/connector/src/core/connector-node-minimal.test.ts` — test that verifies ConnectorNode can be instantiated and started with a minimal config (no settlement, no AdminServer, no explorer) when only core dependencies are available
  - [x] 5.2 Test: Constructor does not throw when instantiated with minimal config (nodeId, ilpAddress, port, peers, routes only)
  - [x] 5.3 Test: `start()` succeeds with only BTP server and routing (no settlement subsystem)
  - [x] 5.4 Test: Settlement initialization produces clear error if `ethers` not available (mock the dynamic import to reject)
  - [x] 5.5 Test: AdminServer initialization produces clear error if `express` not available (mock the dynamic import to reject)
  - [x] 5.6 Test: TigerBeetle initialization produces clear error if `tigerbeetle-node` not available
  - [x] 5.7 Test: Error messages include the package name and install command

- [x] Task 6: Verify all existing tests still pass (AC: 7)
  - [x] 6.1 Run `npm test --workspace=@agent-society/connector` — all existing tests must pass (test environment has all deps installed)
  - [x] 6.2 Run `npm test --workspace=@agent-society/shared` — shared package unaffected
  - [x] 6.3 Run `npx tsc --project packages/connector/tsconfig.json --noEmit` — TypeScript compilation clean
  - [x] 6.4 Specifically verify `connector-node.test.ts` (75 tests) still passes
  - [x] 6.5 Specifically verify `lib.test.ts` and `consumer-types.test.ts` still pass (Story 25.3 exports)

- [x] Task 7: Update package.json and verify dependency count (AC: 1, 6)
  - [x] 7.1 Final `packages/connector/package.json` should have ≤ 10 direct `dependencies` entries:
    - `@agent-society/shared`, `ws`, `pino`, `tslib`, `zod`, `js-yaml` (6 confirmed core)
    - Evaluate keeping: `pino-abstract-transport` (could stay if telemetry transport is considered core)
  - [x] 7.2 Verify `peerDependencies` section lists all blockchain SDKs with version ranges
  - [x] 7.3 Verify `peerDependenciesMeta` marks ALL peer dependencies as `{ "optional": true }`
  - [x] 7.4 Verify `optionalDependencies` lists all cloud, AI, observability, and utility packages
  - [x] 7.5 Run `npm ls --workspace=@agent-society/connector --depth=0` to verify dependency tree is correct
  - [x] 7.6 Ensure devDependencies are updated:
    - Keep `@types/express` in devDependencies (needed for TypeScript compilation even though express is now a peerDependency)
    - Keep `@types/better-sqlite3` in devDependencies (needed for TypeScript compilation)
    - Keep `@types/qrcode` in devDependencies (needed for TypeScript compilation even though qrcode moves to optionalDependencies)
    - Verify all `@types/*` packages for removed dependencies are also removed (Task 1.4 handles this)

## Dev Notes

### Epic Context

This is the first story in Epic 26 (npm Publishing Readiness). This epic prepares `@agent-society/shared` and `@agent-society/connector` for npm publication. Story 26.1 focuses specifically on trimming the connector's dependency footprint so that `npm install @agent-society/connector` doesn't pull in 30+ packages for consumers who only need the core ILP connector functionality.

Epic 26 depends on:

- **Epic 24** (Done): Connector Library API — provides the API surface to publish
- **Epic 25** (Done): CLI/Library Separation — provides clean library entry point (`lib.ts`)
  [Source: docs/prd/epic-26-npm-publishing-readiness.md]

### Previous Story Insights (Story 25.3)

- `lib.ts` now exports 15 value exports and 18 type exports
- Library entry point is `packages/connector/src/lib.ts` (mapped to `dist/lib.js` via package.json `main`)
- CLI entry point is `packages/connector/src/cli/index.ts` (mapped to `dist/cli/index.js` via `bin`)
- `consumer-types.test.ts` and `lib.test.ts` verify all exports — these must continue to pass after dynamic import changes
- Pre-existing wallet-derivation performance test failures are unrelated to this story
  [Source: docs/stories/25.3.story.md#completion-notes]

### Current Dependency Analysis

**Current state:** `packages/connector/package.json` has **42 direct dependencies**. The goal is ≤ 10 direct.

**Core dependencies to KEEP (6 packages):**
| Package | Version | Usage | Files |
|---------|---------|-------|-------|
| `@agent-society/shared` | `*` | ILP types, OER codec | Throughout |
| `ws` | `^8.16.0` | BTP WebSocket protocol | btp/btp-server.ts, btp/btp-client.ts |
| `pino` | `^8.21.0` | Structured JSON logging | Throughout |
| `tslib` | `^2.8.1` | TypeScript runtime helpers | Implicit |
| `zod` | `^3.25.76` | Config validation schemas | config/config-loader.ts |
| `js-yaml` | `^4.1.0` | YAML config file loading | config/config-loader.ts |

**Dependencies to move to peerDependencies (with optional meta):**
| Package | Version | Files Using It | Reason Optional |
|---------|---------|----------------|-----------------|
| `ethers` | `^6.16.0` | 8 source files | Only if EVM settlement enabled |
| `xrpl` | `^2.14.3` | 4 source files | Only if XRP settlement enabled |
| `@aptos-labs/ts-sdk` | `^1.39.0` | 2 source files | Only if Aptos settlement enabled |
| `tigerbeetle-node` | `0.16.68` | 3 source files | Only if TigerBeetle accounting enabled |
| `better-sqlite3` | `^11.8.1` | 8 source files | Only if SQLite persistence used |
| `express` | `4.18.x` | 6 source files | Only if HTTP APIs enabled |
| `cors` | `^2.8.6` | 0 source imports | Companion to express |

**Dependencies to move to optionalDependencies:**
| Package | Files Using It | Reason Optional |
|---------|----------------|-----------------|
| `@aws-sdk/client-kms` | 1 source file | Only if AWS KMS used |
| `@azure/identity` | 1 source file | Only if Azure KMS used |
| `@azure/keyvault-keys` | 1 source file | Only if Azure KMS used |
| `@google-cloud/kms` | 1 source file | Only if GCP KMS used |
| `ai` | 0 connector src imports | AI features (agent module) |
| `@ai-sdk/anthropic` | 0 connector src imports | AI provider |
| `@ai-sdk/openai` | 0 connector src imports | AI provider |
| `nostr-tools` | 0 connector src imports | Nostr features |
| `sharp` | 0 connector src imports | Visual features |
| `qrcode` | 1 source file | Paper wallet QR codes |
| `prom-client` | 1 source file | Prometheus metrics |
| `@opentelemetry/*` (5 packages) | 1 source file | Distributed tracing |
| `@libsql/client` | 1 source file | Explorer event store |
| `bip39` | 1 source file | Wallet seed generation |
| `commander` | 1 source file (CLI only) | CLI framework |
| `inquirer` | 1 source file (CLI only) | CLI onboarding wizard |
| `pino-abstract-transport` | 1 source file | Custom Pino transport |

**Dependencies to REMOVE (unused — zero imports in any source or test):**
| Package | Reason |
|---------|--------|
| `connect-timeout` | Zero imports found |
| `multer` | Zero imports found |
| `node-cron` | Zero imports found |
| `@toon-format/toon` | Zero imports in connector (used only in agent-society) |
| `@aws-sdk/client-s3` | Zero imports found |
| `@types/connect-timeout` (dev) | Types for unused package |
| `@types/multer` (dev) | Types for unused package |

**`ethereum-cryptography` note:** Only imported in `test/integration/wallet-derivation.test.ts` — move to devDependencies.

[Source: packages/connector/package.json, import analysis across packages/connector/src/]

### Dynamic Import Pattern

Create a shared utility for consistent optional dependency loading:

**File: `packages/connector/src/utils/optional-require.ts`**

```typescript
/**
 * Dynamically import an optional dependency with a clear error message.
 * Used for dependencies that are peerDependencies or optionalDependencies.
 */
export async function requireOptional<T>(packageName: string, feature: string): Promise<T> {
  try {
    return (await import(packageName)) as T;
  } catch {
    throw new Error(
      `${packageName} is required for ${feature}. Install it with: npm install ${packageName}`
    );
  }
}
```

Usage in source files:

```typescript
// Before (top-level — fails if not installed):
import { ethers } from 'ethers';

// After (dynamic — fails only when feature is used):
const { ethers } = await requireOptional<typeof import('ethers')>('ethers', 'EVM settlement');
```

**Important:** For files that use types from optional packages at the type level (not runtime), use `import type` which is erased at compile time and does NOT require the package to be installed:

```typescript
import type { Provider } from 'ethers'; // OK — erased at compile time
```

Only runtime value imports need to be converted to dynamic imports.
[Source: docs/prd/epic-26-npm-publishing-readiness.md lines 92-94]

### Key Implementation Considerations

1. **`connector-node.ts` is the critical file** — It has a top-level `import { ethers } from 'ethers'` at line 55. This MUST be converted to dynamic import or the entire library entry point fails when ethers is not installed. The ethers import is used during settlement initialization (likely in `start()` method), so converting to dynamic import at point-of-use is the correct approach.

2. **`lib.ts` does NOT need modification** — `lib.ts` imports `AdminServer`, `AccountManager`, `SettlementMonitor`, `UnifiedSettlementExecutor`. These classes internally import `express`, `tigerbeetle-node`, `ethers`, etc. at the top level. Converting those internal imports to dynamic means `lib.ts` itself won't fail, but the classes will fail when instantiated without the optional dep. This is the correct behavior. Do NOT modify `lib.ts` — only convert imports within the files it imports.

3. **Type-only imports are safe** — `import type { ... }` statements are erased at compile time. Only runtime `import { ClassName } from '...'` statements need conversion to dynamic.

4. **Test files don't need conversion** — Test files run in an environment where all dependencies are installed. Only source files need dynamic import conversion. However, the new `connector-node-minimal.test.ts` will mock dynamic imports to simulate missing deps.

5. **Cloud KMS backends already follow the pattern** — The test files for AWS, Azure, and GCP KMS backends already use `require()` with try/catch to conditionally skip tests. Extend this pattern to the source files themselves.

6. **`peerDependenciesMeta` format:**

```json
{
  "peerDependenciesMeta": {
    "ethers": { "optional": true },
    "xrpl": { "optional": true },
    "@aptos-labs/ts-sdk": { "optional": true },
    "tigerbeetle-node": { "optional": true },
    "better-sqlite3": { "optional": true },
    "express": { "optional": true },
    "cors": { "optional": true }
  }
}
```

[Source: docs/prd/epic-26-npm-publishing-readiness.md lines 79-97]

### Source Tree (Relevant Files)

```
packages/connector/
├── package.json                          # PRIMARY — dependency trimming target
├── src/
│   ├── lib.ts                            # Library entry — imports classes with optional deps
│   ├── cli/
│   │   ├── index.ts                      # CLI entry — uses commander (optional for lib consumers)
│   │   └── onboarding-wizard.ts          # Uses inquirer (optional)
│   ├── core/
│   │   ├── connector-node.ts             # CRITICAL — has top-level `import { ethers }`
│   │   └── connector-node-minimal.test.ts # NEW — test startup without optional deps
│   ├── utils/
│   │   ├── optional-require.ts           # NEW — shared dynamic import helper
│   │   └── evm-rpc-connection-pool.ts    # Uses ethers (convert)
│   ├── settlement/
│   │   ├── payment-channel-sdk.ts        # Uses ethers (convert)
│   │   ├── xrpl-client.ts               # Uses xrpl (convert)
│   │   ├── aptos-client.ts              # Uses @aptos-labs/ts-sdk (convert)
│   │   ├── aptos-claim-signer.ts        # Uses @aptos-labs/ts-sdk (convert)
│   │   ├── tigerbeetle-client.ts        # Uses tigerbeetle-node (convert)
│   │   ├── account-manager.ts           # Uses tigerbeetle-node types (convert)
│   │   ├── account-metadata.ts          # Uses tigerbeetle-node types (convert)
│   │   ├── claim-receiver.ts            # Uses better-sqlite3 (convert)
│   │   ├── claim-sender.ts             # Uses better-sqlite3 (convert)
│   │   ├── claim-redemption-service.ts  # Uses better-sqlite3 + ethers (convert both)
│   │   ├── xrp-claim-signer.ts         # Uses better-sqlite3 (convert)
│   │   ├── xrp-channel-manager.ts      # Uses better-sqlite3 (convert)
│   │   ├── claim-receiver-db-schema.ts  # Uses better-sqlite3 (convert)
│   │   └── settlement-api.ts           # Uses express (convert)
│   ├── http/
│   │   ├── admin-server.ts             # Uses express (convert)
│   │   ├── admin-api.ts                # Uses express (convert)
│   │   └── health-server.ts            # Uses express (convert)
│   ├── security/
│   │   ├── key-manager-signer.ts       # Uses ethers types (convert)
│   │   └── backends/
│   │       ├── aws-kms-backend.ts      # Uses @aws-sdk (convert)
│   │       ├── azure-kv-backend.ts     # Uses @azure (convert)
│   │       ├── gcp-kms-backend.ts      # Uses @google-cloud (convert)
│   │       └── environment-backend.ts  # Uses ethers + xrpl (convert)
│   ├── wallet/
│   │   ├── treasury-wallet.ts          # Uses ethers + xrpl (convert)
│   │   ├── wallet-seed-manager.ts      # Uses bip39 + qrcode (convert)
│   │   ├── audit-logger.ts            # Uses better-sqlite3 (convert)
│   │   └── wallet-security.ts         # Uses better-sqlite3 (convert)
│   ├── test-utils/
│   │   └── mock-factories.ts          # Uses ethers (test utility — may keep top-level import)
│   ├── explorer/
│   │   ├── explorer-server.ts         # Uses express (convert)
│   │   └── event-store.ts             # Uses @libsql/client (convert)
│   ├── observability/
│   │   ├── prometheus-exporter.ts     # Uses prom-client + express (convert)
│   │   └── otel-tracer.ts            # Uses @opentelemetry/* (convert)
│   └── telemetry/
│       └── pino-telemetry-transport.ts # Uses pino-abstract-transport (convert)
```

[Source: docs/architecture/source-tree.md, packages/connector/src/ file analysis]

### Testing

- **Framework:** Jest 29.7.x with `ts-jest` [Source: docs/architecture/tech-stack.md]
- **File Convention:** Co-located `<filename>.test.ts` next to source [Source: docs/architecture/coding-standards.md]
- **Pattern:** AAA (Arrange, Act, Assert) with descriptive test names [Source: docs/architecture/test-strategy-and-standards.md]
- **New test file:** `packages/connector/src/core/connector-node-minimal.test.ts` — tests connector startup with mocked missing optional dependencies
- **Mocking approach for new tests:** Use `jest.mock()` to make dynamic `import()` calls reject for specific packages, simulating missing optional deps. Verify that:
  - Constructor + `start()` succeeds when optional features aren't configured
  - Error messages are clear and include package name + install command
  - No top-level import failures prevent module loading
- **Existing test regression:** All existing tests must pass unchanged since the test environment has all dependencies installed. Dynamic imports will resolve successfully in the test environment.
- **Key test commands:**
  - `npm test --workspace=@agent-society/connector` — all tests
  - `npx tsc --project packages/connector/tsconfig.json --noEmit` — type checking
    [Source: docs/architecture/test-strategy-and-standards.md]

### Coding Standards

- TypeScript strict mode, no `any` types except in test mocks [Source: docs/architecture/coding-standards.md]
- File naming: kebab-case (`optional-require.ts`, not `optionalRequire.ts`) [Source: docs/architecture/coding-standards.md]
- Pino logger exclusively (no `console.log`) [Source: docs/architecture/coding-standards.md]
- All async functions must handle errors with try-catch [Source: docs/architecture/coding-standards.md]
  [Source: docs/architecture/coding-standards.md]

### Project Structure Notes

No structural conflicts. New files:

- `packages/connector/src/utils/optional-require.ts` — follows existing `utils/` directory pattern
- `packages/connector/src/core/connector-node-minimal.test.ts` — co-located test convention

All other changes are modifications to existing files (converting top-level imports to dynamic imports, modifying `package.json`).

## Change Log

| Date       | Version | Description                                                                                                                                                                                                                                                | Author       |
| ---------- | ------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------ |
| 2026-02-11 | 1.0     | Initial story creation                                                                                                                                                                                                                                     | Scrum Master |
| 2026-02-11 | 1.1     | Validation fixes: corrected ethers file count (6→8), added missing files to source tree and tasks, reordered Task 4 (helper first), expanded Task 4.7 express scope to all 6 files, added @types cleanup tasks, added Dev Agent Record/QA Results sections | QA Validator |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6 (claude-opus-4-6)

### Debug Log References

N/A — no external debug logs; all validation done via inline test runs.

### Completion Notes

- Reduced direct dependencies from 42 to **6** (target was ≤10)
- 7 blockchain/infrastructure SDKs moved to `peerDependencies` with all marked optional via `peerDependenciesMeta`
- 21 niche/cloud/AI/CLI packages moved to `optionalDependencies`
- 5 unused packages removed entirely (`connect-timeout`, `multer`, `node-cron`, `@toon-format/toon`, `@aws-sdk/client-s3`)
- `ethereum-cryptography` moved from dependencies to devDependencies
- `@types/cors` moved from dependencies to devDependencies
- Created `requireOptional<T>()` helper in `utils/optional-require.ts` for consistent dynamic import with clear error messages
- ~30 source files converted from top-level runtime imports to dynamic `import()` via `requireOptional`
- Several classes refactored to use async factory pattern (e.g., `AptosClient.create()`, `AptosClaimSigner.create()`, `PrometheusExporter.create()`, `createKeyManagerSigner()`)
- `createAdminRouter()` and `createSettlementRouter()` changed from sync to async
- `createTelemetryTransport()` changed from sync to async
- Created `connector-node-minimal.test.ts` with 13 tests verifying startup without optional deps
- All existing tests updated to match new async patterns
- **Test results:** TypeScript clean (0 errors), shared 170/170, connector 130 suites passed, 24 skipped, 1 pre-existing failure (`wallet-derivation.test.ts` performance test — unrelated to this story)

### File List

**New files:**

- `packages/connector/src/utils/optional-require.ts` — shared dynamic import helper
- `packages/connector/src/core/connector-node-minimal.test.ts` — minimal dependency startup tests

**Modified source files (~30 files):**

- `packages/connector/package.json` — dependency restructuring
- `packages/connector/src/core/connector-node.ts` — dynamic ethers import
- `packages/connector/src/settlement/payment-channel-sdk.ts` — lazy initialization pattern
- `packages/connector/src/settlement/aptos-client.ts` — async factory pattern
- `packages/connector/src/settlement/aptos-claim-signer.ts` — async factory pattern
- `packages/connector/src/settlement/aptos-channel-sdk.ts` — async cascading changes
- `packages/connector/src/settlement/tigerbeetle-client.ts` — dynamic import
- `packages/connector/src/settlement/account-manager.ts` — dynamic import
- `packages/connector/src/settlement/account-metadata.ts` — type-only import
- `packages/connector/src/settlement/claim-receiver.ts` — async verifyClaim
- `packages/connector/src/settlement/claim-sender.ts` — type-only import
- `packages/connector/src/settlement/xrp-claim-signer.ts` — type-only import
- `packages/connector/src/settlement/xrp-channel-manager.ts` — type-only import
- `packages/connector/src/settlement/claim-receiver-db-schema.ts` — type-only import
- `packages/connector/src/settlement/claim-redemption-service.ts` — type-only import
- `packages/connector/src/settlement/settlement-api.ts` — dynamic express import
- `packages/connector/src/settlement/unified-settlement-executor.ts` — async cascading
- `packages/connector/src/security/key-manager-signer.ts` — async factory
- `packages/connector/src/security/backends/environment-backend.ts` — lazy initialization
- `packages/connector/src/security/backends/aws-kms-backend.ts` — dynamic import
- `packages/connector/src/security/backends/azure-kv-backend.ts` — dynamic import
- `packages/connector/src/security/backends/gcp-kms-backend.ts` — dynamic import
- `packages/connector/src/http/admin-server.ts` — dynamic express import
- `packages/connector/src/http/health-server.ts` — dynamic express import
- `packages/connector/src/http/admin-api.ts` — async createAdminRouter
- `packages/connector/src/utils/evm-rpc-connection-pool.ts` — dynamic ethers import
- `packages/connector/src/wallet/treasury-wallet.ts` — dynamic ethers+xrpl import
- `packages/connector/src/wallet/wallet-seed-manager.ts` — dynamic bip39+qrcode import
- `packages/connector/src/wallet/audit-logger.ts` — type-only import
- `packages/connector/src/wallet/wallet-security.ts` — type-only import
- `packages/connector/src/observability/prometheus-exporter.ts` — async factory
- `packages/connector/src/observability/otel-tracer.ts` — dynamic OTel imports
- `packages/connector/src/explorer/explorer-server.ts` — dynamic express import
- `packages/connector/src/explorer/event-store.ts` — dynamic libsql import
- `packages/connector/src/telemetry/pino-telemetry-transport.ts` — async transport
- `packages/connector/src/utils/logger.ts` — async overload for telemetry

**Modified test files (~20 files):**

- `packages/connector/src/settlement/payment-channel-sdk.test.ts`
- `packages/connector/src/settlement/claim-receiver.test.ts`
- `packages/connector/src/settlement/aptos-client.test.ts`
- `packages/connector/src/settlement/aptos-claim-signer.test.ts`
- `packages/connector/src/settlement/aptos-channel-sdk.test.ts`
- `packages/connector/src/settlement/settlement-api.test.ts`
- `packages/connector/src/settlement/xrpl-client.test.ts`
- `packages/connector/src/http/admin-api-peers.test.ts`
- `packages/connector/src/http/admin-api-channels.test.ts`
- `packages/connector/src/http/admin-api-settlement.test.ts`
- `packages/connector/src/security/backends/environment-backend.test.ts`
- `packages/connector/src/telemetry/pino-telemetry-transport.test.ts`
- `packages/connector/src/config/key-manager-config.test.ts`
- `packages/connector/test/unit/observability/prometheus-exporter.test.ts`
- `packages/connector/test/unit/agent-server-aptos.test.ts`
- `packages/connector/test/integration/monitoring-alerting.test.ts`
- `packages/connector/test/integration/log-telemetry.test.ts`
- `packages/connector/test/integration/admin-channels-integration.test.ts`
- `packages/connector/test/integration/settlement-api-execution.test.ts`
- `packages/connector/test/integration/aptos-client.test.ts`
- `packages/connector/test/integration/aptos-claim-signer.test.ts`
- `packages/connector/test/integration/aptos-channel-sdk.test.ts`
- `packages/connector/test/integration/aptos-settlement.test.ts`

## QA Results

### Review Date: 2026-02-11

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation quality. The story successfully reduced direct dependencies from 42 to **6** (target was ≤10), a significant achievement. The `requireOptional<T>()` helper pattern is clean, well-typed, and consistently applied across ~30 source files. Several classes were thoughtfully refactored to use async factory patterns where constructors previously relied on synchronous imports. The new `connector-node-minimal.test.ts` provides solid validation of the graceful degradation approach with 13 passing tests.

### Refactoring Performed

No additional refactoring performed during QA review. The developer's implementation is clean and consistent.

### Compliance Check

- Coding Standards: ✓ TypeScript strict mode maintained, no `any` outside test mocks (eslint-disable comments used sparingly and appropriately), kebab-case file naming followed
- Project Structure: ✓ New files follow existing directory conventions (`utils/optional-require.ts`, `core/connector-node-minimal.test.ts`)
- Testing Strategy: ✓ Co-located test file, AAA pattern, descriptive test names, 13 new tests covering minimal startup and error messaging
- All ACs Met: ✓ See AC verification below

### AC Verification

1. **AC1** ✓ — 6 direct dependencies (≤10 target met): `@agent-society/shared`, `js-yaml`, `pino`, `tslib`, `ws`, `zod`
2. **AC2** ✓ — `connector-node-minimal.test.ts` verifies startup with minimal config (BTP + routing only), reaching healthy status
3. **AC3** ✓ — Settlement features produce clear errors: "ethers is required for EVM settlement. Install it with: npm install ethers"
4. **AC4** ✓ — AdminServer produces clear error: "express is required for HTTP admin/health APIs. Install it with: npm install express"
5. **AC5** ✓ — Dynamic imports used via `requireOptional` across ~30 source files; no top-level import failures for exported library surface
6. **AC6** ✓ — `peerDependenciesMeta` marks all 7 peer dependencies as `{ "optional": true }`
7. **AC7** ✓ — All existing tests pass: 130 suites passed, 24 skipped, 2 pre-existing failures in `wallet-derivation.test.ts` (performance tests unrelated to this story)
8. **AC8** ✓ — `connector-node-minimal.test.ts` with 13 tests verifies startup without optional dependencies

### Improvements Checklist

- [x] Reduced 42 dependencies to 6 direct (developer handled)
- [x] Created `requireOptional<T>()` helper with clear error messages (developer handled)
- [x] Converted ~30 source files to dynamic imports (developer handled)
- [x] Created comprehensive minimal startup test suite (developer handled)
- [x] Async factory patterns applied where needed (developer handled)
- [ ] `xrp-claim-signer.ts` lines 13-14: top-level imports of `ripple-binary-codec` and `ripple-keypairs` (transitive deps of `xrpl`) not converted to dynamic import. **Low severity** — these modules are not reachable from `lib.ts` exports, so library consumers are unaffected. Only matters if someone directly imports `xrp-claim-signer` without `xrpl` installed, which is not a realistic scenario.
- [ ] `environment-backend.ts` line 128: uses `require('ripple-keypairs')` instead of `requireOptional` for consistency. **Low severity** — only reached when XRP key type is actively used, which requires `xrpl`.
- [ ] `connector-node-minimal.test.ts`: Jest reports "did not exit one second after test run" — consider adding `afterAll` cleanup or `jest.useFakeTimers()` to prevent timer leak.

### Security Review

No security concerns. Dynamic import conversion does not alter any security-sensitive logic. The `requireOptional` helper properly re-throws errors without swallowing information. No secrets or credentials are affected.

### Performance Considerations

No performance concerns. Dynamic `import()` calls are typically cached by Node.js module system after first load. The async factory patterns (e.g., `AptosClient.create()`, `PrometheusExporter.create()`) add minimal overhead on first initialization. Module-level caching in `account-manager.ts` prevents repeated imports.

### Files Modified During Review

No files modified during review.

### Gate Status

Gate: PASS → docs/qa/gates/26.1-trim-connector-dependencies.yml
Risk profile: N/A (low-risk dependency management story)
NFR assessment: N/A (no NFR changes)

### Recommended Status

✓ Ready for Done — All 8 acceptance criteria met. The unchecked items above are minor consistency improvements that can be addressed in a follow-up story or deferred.
