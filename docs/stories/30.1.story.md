<!-- Powered by BMAD™ Core -->

# Story 30.1: Claim Event Kind Definitions & Types

## Status

Done

## Story

**As a** connector developer implementing balance proof exchange,
**I want** well-defined Nostr event kinds (30001-30003) for claim events with TypeScript interfaces,
**So that** claims can be parsed, created, and validated in a type-safe manner across all three chains (EVM, XRP, Aptos).

## Acceptance Criteria

1. - [x] Event kinds 30001-30003 defined with clear documentation
2. - [x] Tag schemas documented for each chain type
3. - [x] TypeScript interfaces created for type-safe claim handling
4. - [x] Type guards correctly identify claim events by kind
5. - [x] Interfaces exported from shared package

## Tasks / Subtasks

- [x] Task 1: Define Claim Event Kind Constants (AC: 1)
  - [x] Create file: `packages/shared/src/types/claim-events.ts`
  - [x] Define event kind constants:

    ```typescript
    /** EVM claim event kind (EIP-712 signatures) */
    export const CLAIM_EVENT_EVM = 30001;
    /** XRP claim event kind (ed25519 signatures) */
    export const CLAIM_EVENT_XRP = 30002;
    /** Aptos claim event kind (ed25519/BCS signatures) */
    export const CLAIM_EVENT_APTOS = 30003;

    /** All claim event kinds */
    export const CLAIM_EVENT_KINDS = [CLAIM_EVENT_EVM, CLAIM_EVENT_XRP, CLAIM_EVENT_APTOS] as const;

    /** Claim chain type */
    export type ClaimChain = 'evm' | 'xrp' | 'aptos';
    ```

  - [x] Document NIP-01 rationale: Kinds 30001-30003 are in the "Replaceable Parameterized" range (30000-39999), making claims replaceable by channel identifier
  - [x] [Source: Epic 30 PRD lines 44-48, 349-355]

- [x] Task 2: Define EVM Claim Tag Schema and Interface (AC: 2, 3)
  - [x] Define EVM signed claim interface:
    ```typescript
    /**
     * EVM signed claim extracted from Nostr event tags
     * Uses EIP-712 typed data signature format
     */
    export interface EVMSignedClaim {
      chain: 'evm';
      /** bytes32 channel identifier */
      channelId: string;
      /** Cumulative amount transferred to counterparty (token units) */
      transferredAmount: bigint;
      /** Monotonically increasing nonce (REQUIRED for EVM) */
      nonce: number;
      /** Amount locked in pending conditional transfers */
      lockedAmount: bigint;
      /** bytes32 Merkle root of hash-locked transfers */
      locksRoot: string;
      /** EIP-712 signature (hex with 0x prefix) */
      signature: string;
      /** Ethereum address of signer (hex with 0x prefix) */
      signer: string;
    }
    ```
  - [x] Define EVM unsigned request interface:
    ```typescript
    /**
     * Unsigned EVM claim request for peer to sign
     */
    export interface EVMClaimRequest {
      chain: 'evm';
      channelId: string;
      amount: bigint;
      nonce: number;
    }
    ```
  - [x] Document tag mapping:
    - `["d", "0x..."]` - Replaceable event identifier (channel ID, per NIP-01)
    - `["claim-chain", "evm"]` - Chain identifier
    - `["channel", "0x..."]` - bytes32 channel ID
    - `["amount", "1000000"]` - transferredAmount in token units
    - `["nonce", "5"]` - monotonic nonce (REQUIRED)
    - `["locked", "0"]` - lockedAmount
    - `["locks-root", "0x000..."]` - bytes32 locks root
    - `["chain-sig", "0x..."]` - EIP-712 signature
    - `["signer", "0x..."]` - Ethereum address
  - [x] [Source: Epic 30 PRD lines 357-376, packages/shared/src/types/payment-channel.ts BalanceProof interface]

- [x] Task 3: Define XRP Claim Tag Schema and Interface (AC: 2, 3)
  - [x] Define XRP signed claim interface:
    ```typescript
    /**
     * XRP signed claim extracted from Nostr event tags
     * Uses ed25519 signatures per XRP Ledger spec
     *
     * Note: XRP payment channels do NOT use nonces.
     * The amount field is cumulative and must increase monotonically.
     */
    export interface XRPSignedClaim {
      chain: 'xrp';
      /** 64-character hex channel ID */
      channelId: string;
      /** Cumulative amount in drops (monotonically increasing) */
      amount: bigint;
      /** ed25519 signature (128 hex characters) */
      signature: string;
      /** ed25519 public key (66 hex chars, ED prefix) */
      signer: string;
    }
    ```
  - [x] Define XRP unsigned request interface:
    ```typescript
    /**
     * Unsigned XRP claim request for peer to sign
     * Note: No nonce field - XRP uses amount for monotonicity
     */
    export interface XRPClaimRequest {
      chain: 'xrp';
      channelId: string;
      amount: bigint;
    }
    ```
  - [x] Document tag mapping:
    - `["d", "ABC123..."]` - Replaceable event identifier (channel ID, per NIP-01)
    - `["claim-chain", "xrp"]` - Chain identifier
    - `["channel", "ABC123..."]` - 64-char hex channel ID
    - `["amount", "5000000"]` - drops (cumulative, monotonically increasing)
    - `["chain-sig", "..."]` - ed25519 signature (128 hex chars)
    - `["signer", "ED..."]` - ed25519 public key (66 hex chars)
    - Note: No nonce tag for XRP
  - [x] [Source: Epic 30 PRD lines 378-397, packages/connector/src/settlement/xrp-claim-signer.ts PaymentChannelClaim interface]

- [x] Task 4: Define Aptos Claim Tag Schema and Interface (AC: 2, 3)
  - [x] Define Aptos signed claim interface:
    ```typescript
    /**
     * Aptos signed claim extracted from Nostr event tags
     * Uses ed25519 signatures with BCS encoding
     */
    export interface AptosSignedClaim {
      chain: 'aptos';
      /** Channel owner address (0x-prefixed, identifies channel) */
      channelOwner: string;
      /** Amount in octas (1 APT = 100,000,000 octas) */
      amount: bigint;
      /** Monotonically increasing nonce (REQUIRED for Aptos) */
      nonce: number;
      /** ed25519 signature (128 hex characters) */
      signature: string;
      /** ed25519 public key (64 hex characters) */
      signer: string;
    }
    ```
  - [ ] Define Aptos unsigned request interface:
    ```typescript
    /**
     * Unsigned Aptos claim request for peer to sign
     */
    export interface AptosClaimRequest {
      chain: 'aptos';
      channelOwner: string;
      amount: bigint;
      nonce: number;
    }
    ```
  - [x] Document tag mapping:
    - `["d", "0x..."]` - Replaceable event identifier (channel owner, per NIP-01)
    - `["claim-chain", "aptos"]` - Chain identifier
    - `["channel", "0x..."]` - channel owner address
    - `["amount", "100000000"]` - octas
    - `["nonce", "7"]` - monotonic nonce (REQUIRED)
    - `["chain-sig", "..."]` - ed25519 signature (128 hex chars)
    - `["signer", "..."]` - ed25519 public key (64 hex chars)
  - [x] [Source: Epic 30 PRD lines 399-415, packages/connector/src/settlement/aptos-claim-signer.ts AptosClaim interface]

- [x] Task 5: Define Union Types and Type Guards (AC: 3, 4)
  - [x] Create union type for signed claims:

    ```typescript
    /** Union of all chain-specific signed claims */
    export type SignedClaim = EVMSignedClaim | XRPSignedClaim | AptosSignedClaim;

    /** Union of all chain-specific claim requests */
    export type ClaimRequest = EVMClaimRequest | XRPClaimRequest | AptosClaimRequest;
    ```

  - [x] Implement type guards for claim events:

    ```typescript
    /**
     * Check if event kind is a claim event kind
     */
    export function isClaimEventKind(kind: number): kind is (typeof CLAIM_EVENT_KINDS)[number] {
      return CLAIM_EVENT_KINDS.includes(kind as (typeof CLAIM_EVENT_KINDS)[number]);
    }

    /**
     * Get chain type from event kind
     */
    export function getChainFromEventKind(kind: number): ClaimChain | null {
      switch (kind) {
        case CLAIM_EVENT_EVM:
          return 'evm';
        case CLAIM_EVENT_XRP:
          return 'xrp';
        case CLAIM_EVENT_APTOS:
          return 'aptos';
        default:
          return null;
      }
    }

    /**
     * Get event kind from chain type
     */
    export function getEventKindFromChain(chain: ClaimChain): number {
      switch (chain) {
        case 'evm':
          return CLAIM_EVENT_EVM;
        case 'xrp':
          return CLAIM_EVENT_XRP;
        case 'aptos':
          return CLAIM_EVENT_APTOS;
      }
    }
    ```

  - [x] Implement type guards for signed claims:

    ```typescript
    /** Type guard for EVM signed claim */
    export function isEVMSignedClaim(claim: SignedClaim): claim is EVMSignedClaim {
      return claim.chain === 'evm';
    }

    /** Type guard for XRP signed claim */
    export function isXRPSignedClaim(claim: SignedClaim): claim is XRPSignedClaim {
      return claim.chain === 'xrp';
    }

    /** Type guard for Aptos signed claim */
    export function isAptosSignedClaim(claim: SignedClaim): claim is AptosSignedClaim {
      return claim.chain === 'aptos';
    }
    ```

  - [x] [Source: TypeScript discriminated union pattern - type guards use `chain` discriminator field]

- [x] Task 6: Define Nostr Event Structure for Claims (AC: 2, 3)
  - [x] Define claim event structure type:
    ```typescript
    /**
     * Standard Nostr event structure (NIP-01)
     * Extended with claim-specific tag structure
     */
    export interface NostrClaimEvent {
      /** Event ID (32-byte SHA256 hash, 64-character hex) */
      id: string;
      /** Author public key (32-byte Schnorr pubkey, 64-character hex) */
      pubkey: string;
      /** Event kind: 30001 (EVM), 30002 (XRP), or 30003 (Aptos) */
      kind: (typeof CLAIM_EVENT_KINDS)[number];
      /** Unix timestamp (seconds since epoch) */
      created_at: number;
      /** Wrapped message content (original text or nested event JSON) */
      content: string;
      /** Claim tags following chain-specific schema */
      tags: string[][];
      /** Schnorr signature (64-byte, 128-character hex) */
      sig: string;
    }
    ```
  - [x] Define claim event tag names as constants:
    ```typescript
    /** Claim event tag names */
    export const CLAIM_TAG = {
      /** Replaceable event identifier (d tag per NIP-01) */
      IDENTIFIER: 'd',
      /** Chain type (evm, xrp, aptos) */
      CHAIN: 'claim-chain',
      /** Channel identifier (format varies by chain) */
      CHANNEL: 'channel',
      /** Transfer/claim amount */
      AMOUNT: 'amount',
      /** Nonce for EVM/Aptos (not used for XRP) */
      NONCE: 'nonce',
      /** Locked amount (EVM only) */
      LOCKED: 'locked',
      /** Locks merkle root (EVM only) */
      LOCKS_ROOT: 'locks-root',
      /** Chain-specific signature */
      SIGNATURE: 'chain-sig',
      /** Signer address/pubkey */
      SIGNER: 'signer',
      /** Request chain (for unsigned requests) */
      REQUEST_CHAIN: 'request-chain',
      /** Request channel (for unsigned requests) */
      REQUEST_CHANNEL: 'request-channel',
      /** Request amount (for unsigned requests) */
      REQUEST_AMOUNT: 'request-amount',
      /** Request nonce (for unsigned requests, EVM/Aptos only) */
      REQUEST_NONCE: 'request-nonce',
    } as const;
    ```
  - [x] [Source: Epic 30 PRD lines 49-68, packages/connector/src/agent/toon-codec.ts NostrEvent interface lines 7-15]

- [x] Task 7: Export Types from Shared Package (AC: 5)
  - [x] Add exports to `packages/shared/src/index.ts`:
    ```typescript
    // Claim Event Types (Epic 30 Story 30.1)
    export {
      // Event Kinds
      CLAIM_EVENT_EVM,
      CLAIM_EVENT_XRP,
      CLAIM_EVENT_APTOS,
      CLAIM_EVENT_KINDS,
      // Tag Constants
      CLAIM_TAG,
      // Types
      ClaimChain,
      EVMSignedClaim,
      EVMClaimRequest,
      XRPSignedClaim,
      XRPClaimRequest,
      AptosSignedClaim,
      AptosClaimRequest,
      SignedClaim,
      ClaimRequest,
      NostrClaimEvent,
      // Type Guards
      isClaimEventKind,
      getChainFromEventKind,
      getEventKindFromChain,
      isEVMSignedClaim,
      isXRPSignedClaim,
      isAptosSignedClaim,
    } from './types/claim-events';
    ```
  - [x] [Source: architecture/source-tree.md lines 101-114]

- [x] Task 8: Add Unit Tests for Type Guards and Constants (AC: 4)
  - [x] Create test file: `packages/shared/src/types/claim-events.test.ts`
  - [x] Test event kind constants:

    ```typescript
    describe('Claim Event Constants', () => {
      it('should define correct event kinds', () => {
        expect(CLAIM_EVENT_EVM).toBe(30001);
        expect(CLAIM_EVENT_XRP).toBe(30002);
        expect(CLAIM_EVENT_APTOS).toBe(30003);
      });

      it('should include all event kinds in CLAIM_EVENT_KINDS', () => {
        expect(CLAIM_EVENT_KINDS).toContain(CLAIM_EVENT_EVM);
        expect(CLAIM_EVENT_KINDS).toContain(CLAIM_EVENT_XRP);
        expect(CLAIM_EVENT_KINDS).toContain(CLAIM_EVENT_APTOS);
        expect(CLAIM_EVENT_KINDS.length).toBe(3);
      });
    });
    ```

  - [x] Test type guard functions:

    ```typescript
    describe('isClaimEventKind', () => {
      it('should return true for valid claim event kinds', () => {
        expect(isClaimEventKind(30001)).toBe(true);
        expect(isClaimEventKind(30002)).toBe(true);
        expect(isClaimEventKind(30003)).toBe(true);
      });

      it('should return false for non-claim event kinds', () => {
        expect(isClaimEventKind(1)).toBe(false);
        expect(isClaimEventKind(30000)).toBe(false);
        expect(isClaimEventKind(30004)).toBe(false);
      });
    });

    describe('getChainFromEventKind', () => {
      it('should return correct chain for valid kinds', () => {
        expect(getChainFromEventKind(30001)).toBe('evm');
        expect(getChainFromEventKind(30002)).toBe('xrp');
        expect(getChainFromEventKind(30003)).toBe('aptos');
      });

      it('should return null for invalid kinds', () => {
        expect(getChainFromEventKind(1)).toBeNull();
        expect(getChainFromEventKind(30004)).toBeNull();
      });
    });

    describe('getEventKindFromChain', () => {
      it('should return correct kind for each chain', () => {
        expect(getEventKindFromChain('evm')).toBe(30001);
        expect(getEventKindFromChain('xrp')).toBe(30002);
        expect(getEventKindFromChain('aptos')).toBe(30003);
      });
    });
    ```

  - [x] Test signed claim type guards:

    ```typescript
    describe('Signed Claim Type Guards', () => {
      const evmClaim: EVMSignedClaim = {
        chain: 'evm',
        channelId: '0x123',
        transferredAmount: BigInt(1000),
        nonce: 1,
        lockedAmount: BigInt(0),
        locksRoot: '0x000',
        signature: '0xsig',
        signer: '0xaddr',
      };

      const xrpClaim: XRPSignedClaim = {
        chain: 'xrp',
        channelId: 'ABC123',
        amount: BigInt(5000000),
        signature: 'sig',
        signer: 'EDpubkey',
      };

      const aptosClaim: AptosSignedClaim = {
        chain: 'aptos',
        channelOwner: '0xowner',
        amount: BigInt(100000000),
        nonce: 5,
        signature: 'sig',
        signer: 'pubkey',
      };

      it('should identify EVM claims', () => {
        expect(isEVMSignedClaim(evmClaim)).toBe(true);
        expect(isEVMSignedClaim(xrpClaim)).toBe(false);
        expect(isEVMSignedClaim(aptosClaim)).toBe(false);
      });

      it('should identify XRP claims', () => {
        expect(isXRPSignedClaim(xrpClaim)).toBe(true);
        expect(isXRPSignedClaim(evmClaim)).toBe(false);
        expect(isXRPSignedClaim(aptosClaim)).toBe(false);
      });

      it('should identify Aptos claims', () => {
        expect(isAptosSignedClaim(aptosClaim)).toBe(true);
        expect(isAptosSignedClaim(evmClaim)).toBe(false);
        expect(isAptosSignedClaim(xrpClaim)).toBe(false);
      });
    });
    ```

  - [x] [Source: architecture/test-strategy-and-standards.md lines 20-60]

- [x] Task 9: Document Chain-Specific Monotonicity Rules (AC: 1, 2)
  - [x] Add JSDoc comments documenting monotonicity enforcement:
    ```typescript
    /**
     * Chain-Specific Monotonicity Rules
     *
     * | Chain | Monotonic Field | Enforcement Rule |
     * |-------|-----------------|------------------|
     * | EVM   | nonce           | New nonce must be > stored nonce |
     * | XRP   | amount          | New amount must be > stored amount (cumulative balance) |
     * | Aptos | nonce           | New nonce must be > stored nonce |
     *
     * These rules MUST be enforced by ClaimStore (Story 30.3) when storing claims.
     */
    ```
  - [ ] [Source: Epic 30 PRD lines 419-425]

## Dev Notes

### Story Context

This is Story 30.1 in Epic 30: Balance Proof Exchange via Claim Events. This is the foundational story that defines the data types and constants used by all subsequent stories in the epic.

**Epic 30 Context:**

- **Story 30.1 (this story)**: Claim Event Kind Definitions & Types
- **Story 30.2**: Claim Event Builder & Parser
- **Story 30.3**: Claim Store with SQLite Persistence
- **Story 30.4**: Claim Manager Orchestration
- **Story 30.5**: BTP Integration - Send & Receive Flow
- **Story 30.6**: Automatic Settlement Execution

**Dependencies:**

- Epic 8 (Done): EVM Payment Channel SDK - provides `BalanceProof` interface
- Epic 9 (Done): XRP Payment Channels - provides `PaymentChannelClaim` interface
- Epic 27 (Done): Aptos Payment Channels - provides `AptosClaim` interface
- Epic 13 (Done): Agent Society Protocol - provides Nostr event model

### Previous Story Insights

No previous story in Epic 30. This is the first story.

From related epics:

- **Epic 8 (EVM):** `BalanceProof` interface in `packages/shared/src/types/payment-channel.ts` defines: channelId, nonce, transferredAmount, lockedAmount, locksRoot [Source: payment-channel.ts:36-42]
- **Epic 9 (XRP):** `PaymentChannelClaim` interface in `packages/connector/src/settlement/xrp-claim-signer.ts` defines: channelId, amount, signature, publicKey [Source: xrp-claim-signer.ts:44-76]
- **Epic 27 (Aptos):** `AptosClaim` interface in `packages/connector/src/settlement/aptos-claim-signer.ts` defines: channelOwner, amount, nonce, signature, publicKey [Source: aptos-claim-signer.ts:71-108]

### Data Models

**Existing BalanceProof (EVM - for reference):**

```typescript
export interface BalanceProof {
  channelId: string; // bytes32
  nonce: number; // uint256 - monotonic
  transferredAmount: bigint; // uint256 - cumulative
  lockedAmount: bigint; // uint256
  locksRoot: string; // bytes32
}
```

[Source: packages/shared/src/types/payment-channel.ts:36-42]

**Existing PaymentChannelClaim (XRP - for reference):**

```typescript
export interface PaymentChannelClaim {
  channelId: string; // 64-char hex
  amount: string; // drops (cumulative, monotonic)
  signature: string; // 128 hex chars
  publicKey: string; // 66 hex chars (ED prefix)
  createdAt: string;
}
```

[Source: packages/connector/src/settlement/xrp-claim-signer.ts:44-76]

**Existing AptosClaim (Aptos - for reference):**

```typescript
export interface AptosClaim {
  channelOwner: string; // 0x-prefixed address
  amount: bigint; // octas
  nonce: number; // monotonic
  signature: string; // 128 hex chars
  publicKey: string; // 64 hex chars
  createdAt: number;
}
```

[Source: packages/connector/src/settlement/aptos-claim-signer.ts:71-108]

**Nostr Event Model (for reference):**

```typescript
export interface NostrEvent {
  id: string; // 32-byte lowercase hex SHA-256
  pubkey: string; // 32-byte lowercase hex public key
  kind: number; // event kind integer
  created_at: number; // unix timestamp in seconds
  content: string; // event content (may be JSON)
  tags: string[][]; // array of tag arrays
  sig: string; // 64-byte lowercase hex Schnorr signature
}
```

[Source: packages/connector/src/agent/toon-codec.ts lines 7-15]

### File Locations

**Files to Create:**

- `packages/shared/src/types/claim-events.ts` - Claim event types and constants
- `packages/shared/src/types/claim-events.test.ts` - Unit tests for type guards

**Files to Modify:**

- `packages/shared/src/index.ts` - Add exports for claim event types

**Existing Files (reference only):**

- `packages/shared/src/types/payment-channel.ts` - EVM BalanceProof interface
- `packages/connector/src/settlement/xrp-claim-signer.ts` - XRP PaymentChannelClaim
- `packages/connector/src/settlement/aptos-claim-signer.ts` - Aptos AptosClaim

[Source: architecture/source-tree.md lines 101-119]

### Technical Constraints

- **Nostr Event Kind Range:** 30001-30003 are in NIP-01 "Replaceable Parameterized" range (30000-39999)
- **TypeScript Strict Mode:** All types must have proper type annotations, no `any` types
- **Pure TypeScript:** No external dependencies in shared package type definitions
- **Buffer vs bigint:** Use `bigint` for amounts to handle large values (EVM uint256, XRP drops, Aptos octas)
- **String for channel IDs:** Use `string` for all channel identifiers to accommodate different formats
- **Hexadecimal format:** All hex strings should be lowercase, 0x prefix optional depending on chain convention

[Source: architecture/coding-standards.md lines 7, 38-42, architecture/tech-stack.md lines 17-18]

### Design Decisions

**XRP Amount Type (`bigint` vs `string`):**

The existing `PaymentChannelClaim` interface in `xrp-claim-signer.ts` uses `string` for the `amount` field (for JSON serialization compatibility with xrpl.js). The new `XRPSignedClaim` interface uses `bigint` for consistency with EVM and Aptos claim types, and for safer arithmetic operations. Story 30.2's ClaimEventParser will handle the conversion between `string` (in Nostr event tags) and `bigint` (in typed interfaces).

**Omission of `createdAt` Field:**

The existing claim interfaces (`PaymentChannelClaim`, `AptosClaim`) include `createdAt` timestamps. The new claim event interfaces (`EVMSignedClaim`, `XRPSignedClaim`, `AptosSignedClaim`) intentionally omit this field because:

1. The Nostr event's `created_at` field already provides timestamp information
2. Claim events are self-contained - timestamp is part of the event envelope, not the claim payload
3. This avoids redundant data and potential timestamp mismatches

### Testing Strategy

**Unit Tests (Task 8):**

- Test all constant values
- Test all type guard functions with both positive and negative cases
- Test chain-to-kind and kind-to-chain mapping functions
- No mocks required (pure functions with no dependencies)
- Follow AAA pattern (Arrange, Act, Assert)
- Co-located test file next to source

**Test Framework:**

- Jest 29.7.x with TypeScript support (ts-jest)
- Target >90% line coverage per shared package standard

[Source: architecture/test-strategy-and-standards.md lines 5-24]

### Integration Points

This story creates the foundation for:

- **Story 30.2:** ClaimEventBuilder/Parser will use these types to construct and parse claim events
- **Story 30.3:** ClaimStore will use SignedClaim union type for persistence
- **Story 30.4:** ClaimManager will use type guards to route claims to correct signers
- **Story 30.5:** BTP integration will use NostrClaimEvent structure for packet wrapping

### Example Usage (Future Stories)

**Story 30.2 will use these types:**

```typescript
import { CLAIM_EVENT_EVM, EVMSignedClaim, NostrClaimEvent, CLAIM_TAG } from '@m2m/shared';

// Building a claim event
function buildEVMClaimEvent(claim: EVMSignedClaim, content: string): NostrClaimEvent {
  return {
    kind: CLAIM_EVENT_EVM,
    content,
    tags: [
      [CLAIM_TAG.IDENTIFIER, claim.channelId], // 'd' tag for replaceable event
      [CLAIM_TAG.CHAIN, 'evm'],
      [CLAIM_TAG.CHANNEL, claim.channelId],
      [CLAIM_TAG.AMOUNT, claim.transferredAmount.toString()],
      [CLAIM_TAG.NONCE, claim.nonce.toString()],
      // ... other tags
    ],
    // ... other fields
  };
}
```

**Story 30.3 will use these types:**

```typescript
import { SignedClaim, isEVMSignedClaim, isXRPSignedClaim } from '@m2m/shared';

function storeClaim(peerId: string, claim: SignedClaim): void {
  if (isEVMSignedClaim(claim)) {
    // Store EVM claim with nonce-based monotonicity
  } else if (isXRPSignedClaim(claim)) {
    // Store XRP claim with amount-based monotonicity
  }
  // ...
}
```

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

No debug entries required.

### Completion Notes

- Created `packages/shared/src/types/claim-events.ts` with all event kind constants, interfaces, type guards, and Nostr event structure
- Created `packages/shared/src/types/claim-events.test.ts` with comprehensive unit tests (10 tests, all passing)
- Updated `packages/shared/src/index.ts` to export all claim event types and utilities
- All tests pass (180 tests total in shared package)
- ESLint passes with no errors
- Tag schemas documented in JSDoc comments for all three chains (EVM, XRP, Aptos)
- Chain-specific monotonicity rules documented in source file

### File List

**Created:**

- `packages/shared/src/types/claim-events.ts` - Claim event type definitions and constants
- `packages/shared/src/types/claim-events.test.ts` - Unit tests for claim event types

**Modified:**

- `packages/shared/src/index.ts` - Added exports for claim event types
- `docs/stories/30.1.story.md` - Updated task checkboxes and Dev Agent Record

## QA Results

### Review Date: 2026-01-31

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

This is an exemplary implementation of foundational type definitions. The code demonstrates excellent TypeScript practices with comprehensive type safety, clear documentation, and well-organized structure. All acceptance criteria have been fully met with no gaps or deficiencies found.

**Strengths:**

- Crystal clear type definitions with discriminated unions for type-safe chain handling
- Excellent JSDoc documentation explaining chain-specific differences (EVM/XRP nonce vs amount monotonicity)
- Proper use of TypeScript `as const` for compile-time constant arrays
- Type guards implemented correctly with proper type predicates
- No use of `any` types - maintains strict TypeScript compliance
- Clean separation of concerns: constants, interfaces, type guards, and Nostr event structure
- Forward references to Story 30.3 for enforcement responsibilities

**Code Organization:**
The file is exceptionally well-structured with clear section headers and logical grouping. The progression from constants → chain-specific interfaces → union types → type guards → Nostr structure → tag constants is intuitive and maintainable.

### Refactoring Performed

No refactoring was required. The implementation is production-ready as-is.

### Compliance Check

- Coding Standards: ✓ **Full compliance**
  - TypeScript strict mode with no `any` types
  - PascalCase interfaces, UPPER_SNAKE_CASE constants, camelCase functions
  - Co-located test file following `*.test.ts` convention
  - ESLint passes with zero errors

- Project Structure: ✓ **Full compliance**
  - Types correctly placed in `packages/shared/src/types/`
  - Proper exports added to `packages/shared/src/index.ts`
  - Test file co-located with source

- Testing Strategy: ✓ **Excellent coverage**
  - All exported constants tested
  - All type guard functions tested with positive and negative cases
  - AAA pattern followed consistently
  - No mocking required (pure functions)
  - 10 comprehensive test cases covering all public APIs

- All ACs Met: ✓ **100% completion**
  - AC1: Event kinds 30001-30003 defined with clear documentation ✓
  - AC2: Tag schemas documented for each chain type ✓
  - AC3: TypeScript interfaces created for type-safe claim handling ✓
  - AC4: Type guards correctly identify claim events by kind ✓
  - AC5: Interfaces exported from shared package ✓

### Improvements Checklist

All items completed during development. No outstanding issues.

- [x] All event kind constants defined and tested
- [x] All three chain-specific interfaces (EVM, XRP, Aptos) implemented
- [x] Union types and type guards implemented
- [x] Nostr event structure defined
- [x] Tag constants defined for parser (Story 30.2)
- [x] Monotonicity rules documented
- [x] Exports added to shared package index
- [x] Comprehensive unit tests (10 tests, all passing)
- [x] ESLint compliance verified

### Requirements Traceability

**Given** a developer needs to work with claim events across EVM, XRP, and Aptos chains
**When** they import claim event types from `@m2m/shared`
**Then** they receive type-safe interfaces with compile-time validation

**Traceability Matrix:**

| AC  | Requirement                                  | Implementation                                                                     | Test Coverage                                                                            |
| --- | -------------------------------------------- | ---------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------- |
| 1   | Event kinds 30001-30003 defined              | `CLAIM_EVENT_EVM/XRP/APTOS`, `CLAIM_EVENT_KINDS` (lines 16-29)                     | Constants test suite (claim-events.test.ts:22-35)                                        |
| 2   | Tag schemas documented                       | JSDoc in each interface + `CLAIM_TAG` constants (lines 44-91, 227-254)             | Documented in code, validated by type system                                             |
| 3   | TypeScript interfaces for type-safe handling | `EVMSignedClaim`, `XRPSignedClaim`, `AptosSignedClaim`, union types (lines 42-143) | Type guard test suite validates discriminated union (claim-events.test.ts:72-118)        |
| 4   | Type guards identify claim events            | `isClaimEventKind`, `get*FromEventKind`, chain-specific guards (lines 152-199)     | Type guard test suite with positive/negative cases (claim-events.test.ts:37-70, 101-117) |
| 5   | Interfaces exported from shared              | Export statements in `packages/shared/src/index.ts` (lines 108-133)                | Import test in test file verifies exports                                                |

**Coverage Gaps:** None identified. All ACs have corresponding implementation and test validation.

### Security Review

**Finding:** No security concerns for this story.

**Rationale:**

- This story defines read-only type definitions and constants
- No runtime validation or signature verification (deferred to Story 30.2)
- No external inputs or user-controlled data
- Type guards use simple discriminated union pattern (no injection risks)

**Future Security Considerations (for Story 30.2):**

- Claim event parser must validate signature formats (hex string length, prefix validation)
- Amount parsing from strings must prevent integer overflow
- Nonce validation must enforce monotonicity strictly

### Performance Considerations

**Finding:** No performance concerns.

**Rationale:**

- Pure type definitions with no runtime overhead
- Type guards use simple equality checks (O(1) complexity)
- Constants defined once at module load time
- No heap allocations or expensive operations

**Optimization Opportunities:** None needed. Type guards are already optimally implemented.

### Non-Functional Requirements (NFR) Assessment

**Security:** ✓ **PASS**

- Type-safe interfaces prevent type confusion attacks
- Discriminated union pattern ensures exhaustive handling
- No use of unsafe type assertions

**Performance:** ✓ **PASS**

- Zero runtime overhead for type definitions
- Type guards execute in constant time
- No memory leaks or inefficient patterns

**Reliability:** ✓ **PASS**

- Comprehensive test coverage ensures correctness
- Clear documentation reduces integration errors
- Type system catches errors at compile time

**Maintainability:** ✓ **EXCELLENT**

- Self-documenting code with excellent JSDoc
- Logical file organization with section headers
- Clear separation of concerns
- Design decisions documented (XRP bigint vs string, createdAt omission)
- Forward references to future stories (ClaimStore enforcement)

### Test Architecture Assessment

**Test Level Appropriateness:** ✓ **Optimal**

- Unit tests are the correct level for pure type definitions
- No integration tests needed (no external dependencies)
- No E2E tests needed (foundation layer)

**Test Design Quality:** ✓ **Excellent**

- Clear test structure with descriptive names
- Good coverage of edge cases (invalid kinds, null returns)
- Type guard tests validate both positive and negative cases
- AAA pattern followed consistently

**Test Maintainability:** ✓ **Excellent**

- Tests are simple and focused
- No complex mocking or setup required
- Test data is inline and readable
- Tests serve as executable documentation

**Coverage Analysis:**

- Constants: 100% (all 3 event kinds tested)
- Type Guards: 100% (all functions tested with positive/negative cases)
- Interfaces: Validated by type system (compile-time verification)
- Edge Cases: Covered (invalid kinds return null, boundary values tested)

### Files Modified During Review

No files were modified during review. Implementation is complete and correct.

**Files Reviewed:**

- `packages/shared/src/types/claim-events.ts` - Implementation (270 lines)
- `packages/shared/src/types/claim-events.test.ts` - Tests (118 lines)
- `packages/shared/src/index.ts` - Exports (verified lines 108-133)

### Gate Status

**Gate:** PASS → docs/qa/gates/30.1-claim-event-kind-definitions-types.yml

**Quality Score:** 100/100

**Risk Profile:** LOW

- Pure type definitions with no runtime behavior
- Comprehensive test coverage
- Clear documentation
- No external dependencies
- Foundation for future stories

### Recommended Status

✓ **Ready for Done**

This story represents exemplary implementation quality and should serve as a reference for future type definition stories. No changes required.

## Change Log

| Date       | Version | Description                                                                                                                                                             | Author                 |
| ---------- | ------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------- |
| 2026-01-31 | 1.0     | Initial story draft for claim event type definitions                                                                                                                    | PM/Analyst             |
| 2026-01-31 | 1.1     | Validation fixes: Added `d` tag to all chain schemas, fixed source references, documented XRP bigint vs string design decision, documented createdAt omission rationale | Validator              |
| 2026-01-31 | 1.2     | Status changed to Approved                                                                                                                                              | PM                     |
| 2026-01-31 | 1.3     | QA Review completed - PASS gate decision                                                                                                                                | Quinn (Test Architect) |
