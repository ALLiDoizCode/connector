# Story 28.1: Implement InMemoryLedgerClient

**Epic:** 28 - In-Memory Ledger: Zero-Dependency Accounting
**Story Number:** 28.1
**Status:** Done

## Story Statement

**As a** connector operator,
**I want** a pure TypeScript in-memory ledger that implements the same interface as TigerBeetleClient,
**so that** the connector can track balances, trigger settlements, and sign claims without requiring a TigerBeetle service or any native addons.

## Prerequisites

**Story Dependencies:**

- None (first story in Epic 28)

**Epic Dependencies:**

- Epic 6 (settlement foundation) - COMPLETED: Provides the TigerBeetleClient interface and AccountManager that this story's class must be compatible with
- Epic 26 (npm publishing readiness) - COMPLETED: Motivates removing native addon requirement
- Epic 27 (test optimization) - COMPLETED: TigerBeetle test cleanup complete

**Context:**
The current `TigerBeetleClient` wraps `tigerbeetle-node`, a native addon requiring platform-specific binaries. When TigerBeetle env vars are absent, the connector falls back to a NoOp stub (`_createNoOpAccountManager()` in `connector-node.ts`) that silently disables all balance tracking — settlements never trigger, claims never flow, and no warning is emitted beyond a log line. This story creates a real in-memory replacement so the connector always has working accounting by default.

## Acceptance Criteria

1. **Implements all 6 methods** matching `TigerBeetleClient` public API:
   - `initialize()` — Restore from snapshot file if it exists, start persistence timer
   - `close()` — Persist final snapshot, clear timer
   - `createAccountsBatch(accounts)` — Idempotent account creation in `Map<bigint, Account>`
   - `createTransfersBatch(transfers)` — Validate accounts exist + amount > 0, atomically update debit + credit accounts
   - `getAccountBalance(accountId)` — Direct Map lookup returning `AccountBalance`
   - `getAccountsBatch(accountIds)` — Batch Map lookup returning `Map<bigint, AccountBalance>`

2. **`createAccountsBatch()` is idempotent** — creating an existing account with the same ID is a no-op (no error thrown)

3. **`createTransfersBatch()` validates and atomically updates**:
   - All referenced accounts must exist (throw error if not found)
   - Amount must be > 0 (throw error if not)
   - Both debit and credit account balances updated atomically per transfer

4. **Periodic disk persistence**:
   - Writes snapshot to `{path}.tmp` then renames to `{path}` (atomic replace via write-rename pattern)
   - Only writes when dirty flag is set (skip no-op flushes)
   - Configurable interval via `persistIntervalMs` (default: 30000)
   - Configurable path via `snapshotPath` (string)

5. **Snapshot format**: JSON array of `[accountId_string, { debits_posted_string, credits_posted_string }]` tuples (bigint serialized as string for JSON safety)

6. **On `initialize()`**: Restores from snapshot file if it exists (parsing bigint strings back), starts persistence timer

7. **On `close()`**: Persists final snapshot if dirty, clears timer

8. **Comprehensive unit tests** covering:
   - Account creation (single, batch, idempotency)
   - Transfer creation (valid, invalid account, zero/negative amount)
   - Balance queries (single, batch, missing account)
   - Persistence round-trip (write snapshot → read snapshot → verify state)
   - Dirty flag optimization (no write when not dirty)
   - Error cases (transfer to non-existent account, etc.)

## Dev Notes

### Interface Contract — TigerBeetleClient Public API

The `InMemoryLedgerClient` must implement the same method signatures consumed by `AccountManager`. Here are the exact signatures from the existing `TigerBeetleClient`:

[Source: `packages/connector/src/settlement/tigerbeetle-client.ts`]

```typescript
// AccountBalance interface (lines 64-68)
interface AccountBalance {
  debits: bigint;
  credits: bigint;
  balance: bigint; // Net balance: credits - debits
}

// Method signatures to implement:
async initialize(): Promise<void>
async close(): Promise<void>
async createAccountsBatch(
  accounts: Array<{ id: bigint; ledger: number; code: number; flags?: number }>
): Promise<void>
async createTransfersBatch(transfers: Transfer[]): Promise<void>
async getAccountBalance(accountId: bigint): Promise<AccountBalance>
async getAccountsBatch(accountIds: bigint[]): Promise<Map<bigint, AccountBalance>>
```

**Transfer type** (from `tigerbeetle-node`): The `createTransfersBatch` method receives TigerBeetle `Transfer` objects. The in-memory ledger only needs to use these fields:

- `id: bigint` — Transfer ID (not stored, but used for logging)
- `debit_account_id: bigint` — Account to debit
- `credit_account_id: bigint` — Account to credit
- `amount: bigint` — Transfer amount

Other Transfer fields (`pending_id`, `user_data_*`, `timeout`, `ledger`, `code`, `flags`, `timestamp`) can be ignored by the in-memory implementation.

[Source: `packages/connector/src/settlement/tigerbeetle-client.ts#createTransfersBatch`, lines 435-507]

### How AccountManager Consumes the Client

`AccountManager` receives `TigerBeetleClient` via constructor injection (line 153-156 of `account-manager.ts`):

```typescript
constructor(
  config: AccountManagerConfig,
  private readonly _tigerBeetleClient: TigerBeetleClient,
  private readonly _logger: Logger
)
```

Key usage patterns in `AccountManager`:

- `createAccountsBatch([debitAccount, creditAccount])` — Creates account pairs (line 317)
- `createTransfersBatch(transfers)` — Atomic dual-leg transfers (line 676)
- `getAccountsBatch([debitId, creditId])` — Balance queries (line 523)
- `getAccountBalance(accountId)` — Single balance lookup (used indirectly via getAccountsBatch)

[Source: `packages/connector/src/settlement/account-manager.ts`]

### Account Data Model

Each account in the in-memory Map needs only:

- `debits_posted: bigint` — Total debits posted to this account
- `credits_posted: bigint` — Total credits posted to this account

The `createAccountsBatch` method receives objects with `{ id, ledger, code, flags }` but the in-memory ledger only needs to store the ID as the Map key and track the two balance fields. `ledger`, `code`, and `flags` can be stored but are not used for balance operations.

[Source: `packages/connector/src/settlement/tigerbeetle-client.ts#createAccountsBatch`, lines 239-297]

### Error Handling

The existing `TigerBeetleClient` throws these error types:

- `TigerBeetleAccountError` — For account creation failures and account-not-found
- `TigerBeetleTransferError` — For transfer validation failures
- `TigerBeetleConnectionError` — For uninitialized client access (via `ensureConnected()` guard at line 602-608)

The `InMemoryLedgerClient` should reuse these same error classes so that `AccountManager`'s catch blocks work identically.

**Initialization guard**: The existing `TigerBeetleClient` has a private `ensureConnected()` method (line 602) that throws `TigerBeetleConnectionError` if `_initialized` is false. `InMemoryLedgerClient` must implement the same guard — a private `_ensureInitialized()` method called at the top of `createAccountsBatch`, `createTransfersBatch`, `getAccountBalance`, and `getAccountsBatch`. This ensures identical behavior when methods are called before `initialize()`.

[Source: `packages/connector/src/settlement/tigerbeetle-errors.ts`, `packages/connector/src/settlement/tigerbeetle-client.ts` lines 602-608]

### Persistence Implementation

**Atomic write-rename pattern:**

```
1. JSON.stringify(snapshot) → write to {snapshotPath}.tmp
2. fs.rename({snapshotPath}.tmp, {snapshotPath})  // atomic on same filesystem
```

**Snapshot format** (JSON array of tuples for Map serialization):

```json
[
  ["123456789", { "debits_posted": "1000", "credits_posted": "500" }],
  ["987654321", { "debits_posted": "0", "credits_posted": "2000" }]
]
```

BigInt values serialized as strings because JSON.stringify cannot handle bigint natively.

**Dirty flag**: Set to `true` on any `createAccountsBatch` or `createTransfersBatch` call. Reset to `false` after successful persistence. Timer callback skips write if not dirty.

**On startup (initialize)**:

1. Check if snapshot file exists at `snapshotPath`
2. If exists: read, parse JSON, reconstruct `Map<bigint, Account>` from string keys/values
3. If `.tmp` file exists without main file: log warning, start fresh (partial write from crash)
4. Start `setInterval` timer for periodic persistence

**On shutdown (close)**:

1. If dirty: persist final snapshot
2. Clear interval timer

[Source: `docs/prd/epic-28-in-memory-ledger.md` — Enhancement Details, Risk Mitigation]

### File Locations

- **New file**: `packages/connector/src/settlement/in-memory-ledger-client.ts`
- **New test file**: `packages/connector/src/settlement/in-memory-ledger-client.test.ts`
- **Reuse**: `packages/connector/src/settlement/tigerbeetle-errors.ts` (error classes)
- **Reuse**: `packages/connector/src/settlement/tigerbeetle-client.ts` (reference for `AccountBalance` interface)
- **No changes needed**: `account-manager.ts`, `connector-node.ts` (those are Story 28.2)

[Source: `docs/prd/epic-28-in-memory-ledger.md` — Integration Points]

### Coding Standards

- TypeScript strict mode, no `any` types except in test mocks
- Pino logger for all logging (never `console.log`)
- File naming: kebab-case (`in-memory-ledger-client.ts`)
- Class naming: PascalCase (`InMemoryLedgerClient`)
- Private members: `_` prefix (`_accounts`, \_`dirty`, `_persistTimer`)
- Constants: UPPER_SNAKE_CASE (`DEFAULT_PERSIST_INTERVAL_MS`)
- Co-located tests: `in-memory-ledger-client.test.ts` next to source file
- Async/await pattern for all async operations

[Source: `docs/architecture/coding-standards.md`]

### Testing Strategy

**Unit tests** (`in-memory-ledger-client.test.ts`):

- Test with a Pino logger (use `pino({ level: 'silent' })` for quiet tests)
- Use `os.tmpdir()` for snapshot file paths in tests (avoid polluting project dir)
- Clean up snapshot files in `afterEach`/`afterAll`
- Test categories:
  1. **Account creation**: single account, batch, idempotency (duplicate ID no-op), missing fields
  2. **Transfer creation**: valid transfer, non-existent account error, zero amount error, negative amount error, multiple transfers in batch
  3. **Balance queries**: single account, batch, non-existent account error, balance math (credits - debits)
  4. **Persistence**: write snapshot, read snapshot on new instance init, dirty flag skip, atomic write (verify .tmp removed), empty snapshot (no accounts), persistence error handling (keeps dirty flag, does not throw)
  5. **Lifecycle**: initialize without existing snapshot, initialize with existing snapshot, close persists final state, close clears timer, double initialize is no-op
  6. **Initialization guard**: all 4 data methods throw `TigerBeetleConnectionError` before `initialize()` is called

No existing `AccountManager` tests need modification for this story (that's Story 28.3).

### Previous Story Insights

No previous story in this epic. However, from the broader project context:

- The `TigerBeetleClient` test file at `packages/connector/src/settlement/tigerbeetle-client.test.ts` can serve as a reference for test patterns and expectations
- Account ID generation uses `bigint` throughout — ensure all Map operations handle bigint keys correctly (note: JavaScript `Map` supports bigint keys natively)

### Technical Constraints

- Node.js 22 LTS — `fs.promises.rename()` is atomic on the same filesystem
- The `Transfer` type from `tigerbeetle-node` is used in the method signature — import it as a type-only import (`import type { Transfer }`) to avoid runtime dependency. If `tigerbeetle-node` is not installed, define a minimal compatible interface locally.
- The class should work with **zero** npm dependencies beyond Node.js built-ins (`fs`, `path`, `crypto`) and `pino` (already a project dependency)

## Tasks / Subtasks

### 1. Create InMemoryLedgerClient class skeleton (AC: 1)

- [x] Create `packages/connector/src/settlement/in-memory-ledger-client.ts`
- [x] Define constructor accepting `{ snapshotPath: string, persistIntervalMs?: number }` config and `Logger`
- [x] Define private fields: `_accounts: Map<bigint, { debits_posted: bigint; credits_posted: bigint }>`, `_dirty: boolean`, `_persistTimer: NodeJS.Timeout | null`, `_initialized: boolean`
- [x] Define a local `Transfer` interface with the 4 required fields (`id`, `debit_account_id`, `credit_account_id`, `amount` — all `bigint`). The interface must accept objects that conform to the full `tigerbeetle-node` `Transfer` type, since `AccountManager` constructs full Transfer objects. Use `[key: string]: unknown` index signature or list additional fields as optional to ensure structural compatibility.
- [x] Implement private `_ensureInitialized()` method that throws `TigerBeetleConnectionError` if `_initialized` is false (mirrors `TigerBeetleClient.ensureConnected()` at line 602)
- [x] Export `AccountBalance` type or re-export from `tigerbeetle-client.ts`

### 2. Implement account operations (AC: 1, 2)

- [x] Implement `createAccountsBatch(accounts)`:
  - Call `_ensureInitialized()` at method entry
  - Accept `Array<{ id: bigint; ledger: number; code: number; flags?: number }>`
  - For each account: if `_accounts.has(id)` → skip (idempotent); else add with `{ debits_posted: 0n, credits_posted: 0n }`
  - Set `_dirty = true` if any new account created
  - Log account creation at debug level
- [x] Implement `getAccountBalance(accountId)`:
  - Call `_ensureInitialized()` at method entry
  - Lookup in `_accounts` Map
  - If not found: throw `TigerBeetleAccountError`
  - Return `{ debits: account.debits_posted, credits: account.credits_posted, balance: account.credits_posted - account.debits_posted }`
- [x] Implement `getAccountsBatch(accountIds)`:
  - Call `_ensureInitialized()` at method entry
  - Iterate accountIds, lookup each in Map
  - Return `Map<bigint, AccountBalance>` (skip missing accounts — matches TigerBeetle behavior)

### 3. Implement transfer operations (AC: 1, 3)

- [x] Implement `createTransfersBatch(transfers)`:
  - Call `_ensureInitialized()` at method entry
  - Validate each transfer: `amount > 0n`, both `debit_account_id` and `credit_account_id` exist in `_accounts`
  - For each valid transfer: `debitAccount.debits_posted += amount`, `creditAccount.credits_posted += amount`
  - Set `_dirty = true`
  - Throw `TigerBeetleTransferError` on validation failures (with details)

### 4. Implement persistence (AC: 4, 5, 6, 7)

- [x] Implement `_persistSnapshot()` private method:
  - If not dirty, return early (no-op)
  - Serialize `_accounts` Map to JSON array of `[id_string, { debits_posted_string, credits_posted_string }]` tuples
  - Write to `{snapshotPath}.tmp` using `fs.promises.writeFile`
  - Rename `{snapshotPath}.tmp` → `{snapshotPath}` using `fs.promises.rename`
  - Set `_dirty = false`
  - Log at debug level
  - Wrap in try/catch: on failure (disk full, permission denied), log error at `error` level, keep `_dirty = true` so the next interval retries. Do NOT throw — the timer callback must not crash the process.
- [x] Implement `_restoreSnapshot()` private method:
  - Check if `{snapshotPath}` exists using `fs.promises.access`
  - If exists: read file, parse JSON, reconstruct Map with `BigInt()` conversion
  - If only `.tmp` exists: log warning, start fresh
  - If neither exists: start fresh (empty Map)
- [x] Implement `initialize()`:
  - If already initialized (`_initialized === true`): log warning and return early (no-op, prevents double timer)
  - Ensure snapshot directory exists (`fs.promises.mkdir(path.dirname(snapshotPath), { recursive: true })`)
  - Call `_restoreSnapshot()`
  - Start `setInterval(_persistSnapshot, persistIntervalMs)`
  - Set `_initialized = true`
- [x] Implement `close()`:
  - Call `_persistSnapshot()` (final flush)
  - Clear interval timer
  - Set `_initialized = false`

### 5. Write unit tests (AC: 8)

- [x] Create `packages/connector/src/settlement/in-memory-ledger-client.test.ts`
- [x] **Account creation tests**:
  - Create single account and verify in Map
  - Create batch of accounts
  - Idempotent creation (duplicate ID is no-op)
  - Verify `_dirty` flag set after creation
- [x] **Transfer tests** (AC: 3):
  - Valid transfer: debit and credit accounts updated correctly
  - Transfer with non-existent debit account throws `TigerBeetleTransferError`
  - Transfer with non-existent credit account throws `TigerBeetleTransferError`
  - Transfer with amount = 0 throws error
  - Transfer with negative amount throws error
  - Multiple transfers in a single batch
- [x] **Balance query tests**:
  - `getAccountBalance` returns correct values after transfers
  - `getAccountBalance` throws for non-existent account
  - `getAccountsBatch` returns Map of found accounts (skips missing)
  - Balance math: `balance = credits_posted - debits_posted`
- [x] **Persistence tests** (AC: 4, 5, 6):
  - Write snapshot and verify file content format
  - Initialize from existing snapshot and verify state restored
  - Dirty flag: no write when not dirty
  - Atomic write: verify `.tmp` file cleaned up
  - Initialize with no existing snapshot starts fresh
  - Close persists final state
- [x] **Initialization guard tests**:
  - `createAccountsBatch` throws `TigerBeetleConnectionError` before `initialize()` called
  - `createTransfersBatch` throws `TigerBeetleConnectionError` before `initialize()` called
  - `getAccountBalance` throws `TigerBeetleConnectionError` before `initialize()` called
  - `getAccountsBatch` throws `TigerBeetleConnectionError` before `initialize()` called
- [x] **Lifecycle tests** (AC: 7):
  - Initialize → create accounts → close → new instance initialize → verify accounts restored
  - Close clears persistence timer
  - Double `initialize()` is a no-op (no duplicate timers)
  - Persistence error does not throw (logs error, keeps `_dirty = true` for retry)

### 6. Verify and clean up

- [x] Run `npm run lint` to ensure no linting errors
- [x] Run unit tests and verify all pass
- [x] Verify no runtime dependency on `tigerbeetle-node` (type-only imports or local interface)

## QA Results

### Review Date: 2026-02-13

### Reviewed By: Quinn (Test Architect)

### Risk Assessment

- Auth/payment/security files touched: No (new settlement backend, not auth/payment flow)
- Tests added: Yes (29 unit tests)
- Diff size: ~500 lines (implementation + tests) — standard review depth
- Previous gate: N/A (first story in epic)
- Acceptance criteria count: 8 — standard complexity
- **Review depth: Standard**

### Code Quality Assessment

Excellent implementation quality. The `InMemoryLedgerClient` is a clean, focused class (~350 lines) that correctly implements all 6 methods of the `TigerBeetleClient` public API. Key design decisions are well-executed:

- **Error class reuse**: Correctly reuses `TigerBeetleConnectionError`, `TigerBeetleAccountError`, and `TigerBeetleTransferError` from `tigerbeetle-errors.ts`, ensuring `AccountManager` catch blocks work identically.
- **Validate-then-apply pattern**: `createTransfersBatch` validates all transfers before applying any, preventing partial updates on mid-batch validation failure (tested at line 189-201 of test file).
- **Atomic write-rename persistence**: Correctly implements `writeFile(.tmp) → rename(.tmp → main)` pattern for crash safety.
- **Timer `.unref()`**: Prevents the persistence timer from keeping the Node.js process alive (line 106-108).
- **Index signature on `InMemoryTransfer`**: `[key: string]: unknown` ensures structural compatibility with the full `tigerbeetle-node` `Transfer` type that `AccountManager` constructs.
- **Double-init guard**: `initialize()` returns early if already initialized, preventing duplicate timers.
- **Zero runtime dependency on tigerbeetle-node**: Only `import type` used for `AccountBalance`.

### Refactoring Performed

No refactoring performed. The implementation is clean and follows all project conventions correctly.

### Compliance Check

- Coding Standards: ✓ TypeScript strict mode, Pino logger (no console.log), kebab-case filenames, PascalCase class, `_` prefix private members, UPPER_SNAKE_CASE constant, co-located tests
- Project Structure: ✓ New file placed at `packages/connector/src/settlement/in-memory-ledger-client.ts` alongside existing settlement files
- Testing Strategy: ✓ Co-located `*.test.ts`, silent Pino logger, `os.tmpdir()` for snapshot paths, proper cleanup in `afterEach`
- All ACs Met: ✓ All 8 acceptance criteria verified (see detailed traceability below)

### AC Traceability

| AC  | Description                                         | Validating Tests                                                                                          | Status |
| --- | --------------------------------------------------- | --------------------------------------------------------------------------------------------------------- | ------ |
| 1   | Implements all 6 methods                            | All test categories exercise the 6 public methods                                                         | ✓      |
| 2   | createAccountsBatch is idempotent                   | "should be idempotent — duplicate ID is a no-op"                                                          | ✓      |
| 3   | createTransfersBatch validates & atomically updates | 6 transfer tests: valid, non-existent accounts, zero/negative amount, batch, mid-batch failure            | ✓      |
| 4   | Periodic disk persistence with write-rename         | "should write snapshot file with correct format", "should clean up .tmp file after successful write"      | ✓      |
| 5   | Snapshot format: JSON tuples with bigint strings    | "should write snapshot file with correct format" verifies string serialization                            | ✓      |
| 6   | initialize() restores from snapshot, starts timer   | "should restore state from existing snapshot on initialize", "should start fresh when no snapshot exists" | ✓      |
| 7   | close() persists final snapshot, clears timer       | "should persist final state on close", "close clears persistence timer"                                   | ✓      |
| 8   | Comprehensive unit tests                            | 29 tests across 6 categories: accounts, transfers, balances, persistence, init guard, lifecycle           | ✓      |

### Improvements Checklist

- [x] All acceptance criteria implemented and tested
- [x] Error handling follows existing TigerBeetle error patterns
- [x] Persistence error does not crash process (try/catch with dirty flag retry)
- [x] InMemoryTransfer index signature ensures compatibility with full Transfer type
- [ ] Minor: `createTransfersBatch` sets `_dirty = true` unconditionally even for empty arrays (line 201) — `createAccountsBatch` correctly guards with `if (created > 0)`. Non-blocking since AccountManager never calls with empty arrays.
- [ ] Minor: No explicit test for orphaned `.tmp` file restore path (code at lines 297-307 handles it, but no test validates the warning log). Non-blocking — code path is simple and self-evident.

### Security Review

No security concerns. This is an in-memory data structure with local filesystem persistence. No network exposure, no user input parsing, no authentication surfaces. Snapshot files contain only account IDs and balance numbers (no credentials or PII).

### Performance Considerations

No concerns. `Map<bigint>` operations are O(1). Persistence uses dirty-flag optimization to skip no-op writes. Timer `.unref()` prevents blocking process shutdown. Default 30s interval is appropriate for the stated risk tolerance (ledger tracks settlement triggers, not financial state-of-record).

### Files Modified During Review

None — no modifications performed.

### Gate Status

Gate: PASS → docs/qa/gates/28.1-implement-in-memory-ledger-client.yml
Quality Score: 90

### Recommended Status

✓ Ready for Done — All acceptance criteria met, 29/29 tests passing, 0 lint errors, two minor non-blocking items noted for future consideration.

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6

### File List

| File                                                                | Action  | Description                                                                              |
| ------------------------------------------------------------------- | ------- | ---------------------------------------------------------------------------------------- |
| `packages/connector/src/settlement/in-memory-ledger-client.ts`      | Created | InMemoryLedgerClient implementation — all 6 TigerBeetleClient API methods + persistence  |
| `packages/connector/src/settlement/in-memory-ledger-client.test.ts` | Created | 29 unit tests covering accounts, transfers, balances, persistence, init guard, lifecycle |

### Debug Log References

None — implementation completed without issues.

### Completion Notes

- All 6 methods implemented matching TigerBeetleClient public API: `initialize()`, `close()`, `createAccountsBatch()`, `createTransfersBatch()`, `getAccountBalance()`, `getAccountsBatch()`
- Local `InMemoryTransfer` interface with `[key: string]: unknown` index signature for structural compatibility with full `tigerbeetle-node` Transfer type
- `AccountBalance` type re-exported from `tigerbeetle-client.ts` (no duplication)
- Reuses `TigerBeetleConnectionError`, `TigerBeetleAccountError`, `TigerBeetleTransferError` from `tigerbeetle-errors.ts`
- Persistence uses atomic write-rename pattern; dirty flag prevents unnecessary writes
- Timer uses `.unref()` to prevent keeping the process alive
- Zero runtime dependency on `tigerbeetle-node` — only `import type` for `AccountBalance`
- 29/29 tests pass, 0 lint errors, 24/24 settlement test suites pass (593 tests, no regressions)

## Story Wrap-Up

### Change Log

| Date       | Version | Description                                                                                                                                                                                                              | Author                            |
| ---------- | ------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | --------------------------------- |
| 2026-02-13 | 1.0     | Initial story draft                                                                                                                                                                                                      | Claude (create-next-story task)   |
| 2026-02-13 | 1.1     | Validation fixes: added ensureInitialized guard, Transfer interface compatibility note, QA Results section, double-init guard, persistence error handling, snapshot dir creation in initialize(), expanded test coverage | Claude (validate-next-story task) |
| 2026-02-13 | 2.0     | Implementation complete — all tasks done, 29 tests passing, 0 lint errors                                                                                                                                                | James (dev agent)                 |
