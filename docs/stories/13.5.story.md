# Story 13.5: Tri-Chain Settlement Integration (EVM + XRP + Aptos)

## Status

Done

## Story

**As a** settlement executor,
**I want** to choose between EVM, XRP, and Aptos payment channels based on peer configuration,
**so that** the network supports tri-chain settlement with peer preference.

## Acceptance Criteria

1. Peer configuration extended to include `settlementPreference: 'evm' | 'xrp' | 'aptos' | 'any'`
2. Peer configuration includes Aptos address: `aptosAddress?: string`
3. `UnifiedSettlementExecutor` extended to route Aptos settlements to `AptosChannelSDK`
4. Settlement executor selects settlement method based on peer preference and token
5. Settlement executor handles tri-channel scenarios: same peer with EVM, XRP, and Aptos channels
6. Settlement executor updates TigerBeetle accounts regardless of settlement method
7. Telemetry events added for Aptos settlement operations
8. Unit tests verify settlement routing logic for Aptos peers
9. Integration test demonstrates settlement via Aptos alongside EVM and XRP
10. Configuration documentation updated with Aptos peer settings

## Dev Notes

### Previous Story Insights

**From Story 13.4 (Aptos Payment Channel SDK):**
[Source: docs/stories/13.4.story.md]

- `AptosChannelSDK` implemented with full channel lifecycle management
- All amounts in octas (1 APT = 100,000,000 octas) stored as bigint
- SDK uses factory function `createAptosChannelSDKFromEnv()` for environment-based configuration
- Channel identification: Unlike EVM/XRP, Aptos channels identified by owner address (not unique channel ID)
- SDK maintains local channel state cache via `Map<string, AptosChannelState>`
- SDK auto-increments nonce when signing claims via `claimSigner.getHighestNonce()` + 1
- Unit test coverage: 93.16% (exceeds 80% requirement)
- Key methods: `openChannel()`, `deposit()`, `signClaim()`, `verifyClaim()`, `submitClaim()`, `requestClose()`, `finalizeClose()`, `getChannelState()`
- AptosClaimSigner available for off-chain claim signing with ed25519

**From Story 13.1 (Aptos SDK Integration):**
[Source: docs/stories/13.1.story.md]

- AptosClient wrapper implemented with @aptos-labs/ts-sdk@^1.39.0
- Environment variables: `APTOS_NODE_URL`, `APTOS_PRIVATE_KEY`, `APTOS_ACCOUNT_ADDRESS`, `APTOS_FALLBACK_NODE_URL`
- Error handling uses `AptosErrorCode` enum with 14 error types
- Factory function `createAptosClientFromEnv()` available
- `AptosClient.view()` method for calling view functions on deployed modules

**From Story 13.3 (Off-Chain Claim Signing):**
[Source: docs/stories/13.3.story.md]

- `AptosClaimSigner` uses ed25519 keypair for signing
- BCS encoding matches Move module format
- Environment variable: `APTOS_CLAIM_PRIVATE_KEY`
- Factory function `createAptosClaimSignerFromEnv()` available

**Existing UnifiedSettlementExecutor Patterns:**
[Source: packages/connector/src/settlement/unified-settlement-executor.ts]

- Event-driven architecture: Listens for `SETTLEMENT_REQUIRED` events from SettlementMonitor
- Uses bound handler pattern: `this.boundHandleSettlement = this.handleSettlement.bind(this)` (Event Listener Cleanup pattern)
- Settlement routing based on `tokenId` and `peerConfig.settlementPreference`
- Current preferences: `'evm' | 'xrp' | 'both'` - needs extension to include `'aptos' | 'any'`
- Calls `accountManager.recordSettlement()` after successful settlement
- Private helper `settleViaEVM()` and `settleViaXRP()` for chain-specific logic
- Private helper `findOrCreateXRPChannel()` for channel management
- Default settlement timeout: 86400 seconds (24 hours)

### Data Models

**Updated PeerConfig Interface:**
[Source: docs/prd/epic-13-aptos-payment-channels.md#story-275 + packages/connector/src/settlement/types.ts]

```typescript
/**
 * Peer Configuration with Tri-Chain Settlement Preferences
 *
 * Extends base peer configuration with Aptos settlement capabilities.
 * Connectors use this configuration to determine settlement method per peer.
 */
export interface PeerConfig {
  /**
   * Unique peer identifier
   * Format: kebab-case string (e.g., 'peer-alice', 'peer-bob')
   */
  peerId: string;

  /**
   * Peer address (ILP address)
   * Format: ILP hierarchical address (e.g., 'g.alice', 'g.bob')
   */
  address: string;

  /**
   * Settlement preference for this peer
   * - 'evm': Only settle via EVM payment channels (Epic 8)
   * - 'xrp': Only settle via XRP payment channels (Epic 9)
   * - 'aptos': Only settle via Aptos payment channels (Epic 13)
   * - 'any': Support all methods (auto-select based on token)
   *
   * Note: 'both' is deprecated in favor of 'any' for tri-chain support
   */
  settlementPreference: 'evm' | 'xrp' | 'aptos' | 'any';

  /**
   * Supported settlement tokens
   * Format: Array of token identifiers
   * - ERC20 tokens: Contract address (e.g., '0x...')
   * - XRP: Literal string 'XRP'
   * - APT: Literal string 'APT'
   * Example: ['USDC', 'XRP', 'APT', 'DAI']
   */
  settlementTokens: string[];

  /**
   * Optional: Ethereum address for EVM settlement
   * Required if settlementPreference is 'evm' or 'any' with EVM tokens
   * Format: Ethereum checksummed address (0x prefixed)
   */
  evmAddress?: string;

  /**
   * Optional: XRP Ledger address for XRP settlement
   * Required if settlementPreference is 'xrp' or 'any' with XRP token
   * Format: XRP Ledger r-address
   */
  xrpAddress?: string;

  /**
   * Optional: Aptos address for Aptos settlement
   * Required if settlementPreference is 'aptos' or 'any' with APT token
   * Format: 0x-prefixed 64-character hex (Aptos account address)
   */
  aptosAddress?: string;

  /**
   * Optional: Aptos public key for claim verification
   * Required if settlementPreference is 'aptos' or 'any' with APT token
   * Format: 64-character hex (ed25519 public key)
   */
  aptosPubkey?: string;
}
```

**Updated UnifiedSettlementExecutorConfig Interface:**
[Source: packages/connector/src/settlement/types.ts]

```typescript
/**
 * Unified Settlement Executor Configuration
 *
 * Configuration for tri-chain settlement routing.
 */
export interface UnifiedSettlementExecutorConfig {
  /**
   * Peer configuration map
   * Key: peerId (string)
   * Value: PeerConfig with settlement preferences
   */
  peers: Map<string, PeerConfig>;

  /**
   * Default settlement preference (fallback)
   * Used when peer not found in peers map
   */
  defaultPreference: 'evm' | 'xrp' | 'aptos' | 'any';

  /**
   * Enable settlement execution
   * Set to false to disable settlement (testing mode)
   */
  enabled: boolean;
}
```

**Settlement Decision Matrix:**
[Source: docs/prd/epic-13-aptos-payment-channels.md#story-275]

| Peer Preference | Token | Settlement Method     |
| --------------- | ----- | --------------------- |
| `evm`           | USDC  | EVM Payment Channel   |
| `evm`           | APT   | Error (incompatible)  |
| `xrp`           | XRP   | XRP Payment Channel   |
| `xrp`           | APT   | Error (incompatible)  |
| `aptos`         | APT   | Aptos Payment Channel |
| `aptos`         | USDC  | Error (incompatible)  |
| `any`           | USDC  | EVM Payment Channel   |
| `any`           | XRP   | XRP Payment Channel   |
| `any`           | APT   | Aptos Payment Channel |

### API Specifications

**Extended UnifiedSettlementExecutor Methods:**
[Source: packages/connector/src/settlement/unified-settlement-executor.ts + Epic 13 requirements]

```typescript
/**
 * UnifiedSettlementExecutor Class - Extended for Tri-Chain
 *
 * Orchestrates tri-chain settlement routing between EVM, XRP, and Aptos ledgers.
 * Integrates with TigerBeetle accounting layer for unified balance tracking.
 */
export class UnifiedSettlementExecutor {
  /**
   * Constructor - Extended for Aptos support
   *
   * @param config - Unified settlement configuration with peer preferences
   * @param evmChannelSDK - PaymentChannelSDK for EVM settlements (Epic 8)
   * @param xrpChannelManager - PaymentChannelManager for XRP settlements (Epic 9)
   * @param xrpClaimSigner - ClaimSigner for XRP claim generation
   * @param aptosChannelSDK - AptosChannelSDK for Aptos settlements (Epic 13)
   * @param settlementMonitor - Settlement monitor emitting SETTLEMENT_REQUIRED events
   * @param accountManager - TigerBeetle account manager for balance updates
   * @param telemetryEmitter - Optional TelemetryEmitter for settlement events
   * @param logger - Pino logger instance
   */
  constructor(
    config: UnifiedSettlementExecutorConfig,
    evmChannelSDK: PaymentChannelSDK,
    xrpChannelManager: PaymentChannelManager,
    xrpClaimSigner: ClaimSigner,
    aptosChannelSDK: IAptosChannelSDK | null, // Optional for backward compatibility
    settlementMonitor: SettlementMonitor,
    accountManager: AccountManager,
    telemetryEmitter: TelemetryEmitter | null, // Optional
    logger: Logger
  );

  /**
   * Settle via Aptos payment channels (private)
   *
   * Routes settlement to AptosChannelSDK (Epic 13).
   * Opens new channel if needed, signs claim, updates accounting.
   *
   * @param peerId - Peer identifier
   * @param amount - Amount to settle in octas (string for bigint)
   * @param config - Peer configuration with aptosAddress and aptosPubkey
   */
  private async settleViaAptos(peerId: string, amount: string, config: PeerConfig): Promise<void>;

  /**
   * Find or create Aptos payment channel (private helper)
   *
   * Checks local SDK cache for existing channel.
   * Creates new channel if none exists.
   *
   * @param destination - Aptos destination address (0x-prefixed)
   * @param destinationPubkey - Destination ed25519 public key
   * @param amount - Required channel capacity (octas)
   * @returns Channel owner address (used as channel identifier)
   */
  private async findOrCreateAptosChannel(
    destination: string,
    destinationPubkey: string,
    amount: string
  ): Promise<string>;
}
```

**Telemetry Event Types for Aptos:**
[Source: packages/shared/src/types/payment-channel-telemetry.ts pattern]

```typescript
/**
 * Aptos settlement telemetry events
 */
export type AptosSettlementTelemetryEvent =
  | {
      type: 'APTOS_CHANNEL_OPENED';
      channelOwner: string;
      destination: string;
      amount: string; // octas
      settleDelay: number;
      timestamp: number;
    }
  | {
      type: 'APTOS_CLAIM_SIGNED';
      channelOwner: string;
      amount: string; // octas
      nonce: number;
      timestamp: number;
    }
  | {
      type: 'APTOS_CLAIM_SUBMITTED';
      channelOwner: string;
      amount: string; // octas
      nonce: number;
      txHash: string;
      timestamp: number;
    }
  | {
      type: 'APTOS_SETTLEMENT_COMPLETED';
      peerId: string;
      amount: string; // octas
      channelOwner: string;
      timestamp: number;
    }
  | {
      type: 'APTOS_SETTLEMENT_FAILED';
      peerId: string;
      amount: string; // octas
      error: string;
      timestamp: number;
    };
```

### File Locations

**Files to Modify:**
[Source: docs/architecture/source-tree.md + existing settlement patterns]

- `packages/connector/src/settlement/types.ts` - Extend `PeerConfig` and `UnifiedSettlementExecutorConfig`
- `packages/connector/src/settlement/unified-settlement-executor.ts` - Add Aptos routing logic
- `packages/connector/src/settlement/unified-settlement-executor.test.ts` - Add Aptos routing tests
- `packages/shared/src/types/payment-channel-telemetry.ts` - Add Aptos telemetry types

**Files to Create:**

- `packages/connector/test/integration/tri-chain-settlement.test.ts` - Integration tests for all three chains

**Dependencies (already implemented):**

- `packages/connector/src/settlement/aptos-channel-sdk.ts` (Story 13.4)
- `packages/connector/src/settlement/aptos-client.ts` (Story 13.1)
- `packages/connector/src/settlement/aptos-claim-signer.ts` (Story 13.3)

### Testing Requirements

**Unit Tests (packages/connector/src/settlement/unified-settlement-executor.test.ts):**
[Source: docs/architecture/test-strategy-and-standards.md]

```typescript
describe('UnifiedSettlementExecutor - Aptos Integration', () => {
  let executor: UnifiedSettlementExecutor;
  let mockAptosChannelSDK: jest.Mocked<IAptosChannelSDK>;
  let mockTelemetryEmitter: jest.Mocked<TelemetryEmitter>;

  beforeEach(() => {
    // Create fresh mock instances each test
    mockAptosChannelSDK = {
      openChannel: jest.fn().mockResolvedValue('0xowner...'),
      signClaim: jest.fn().mockReturnValue(mockClaim),
      getMyChannels: jest.fn().mockReturnValue([]),
      getChannelState: jest.fn().mockResolvedValue(null),
    } as any;

    // Create new executor instance
    executor = new UnifiedSettlementExecutor(
      triChainConfig,
      mockEvmSDK,
      mockXrpManager,
      mockXrpClaimSigner,
      mockAptosChannelSDK,
      mockSettlementMonitor,
      mockAccountManager,
      mockTelemetryEmitter,
      mockLogger
    );
  });

  afterEach(() => {
    executor.stop();
  });

  describe('Aptos Settlement Routing', () => {
    it('should route APT token to Aptos settlement when preference is aptos', async () => {
      // Configure peer with aptos preference
      const peerConfig: PeerConfig = {
        peerId: 'peer-charlie',
        address: 'g.charlie',
        settlementPreference: 'aptos',
        settlementTokens: ['APT'],
        aptosAddress: '0x1234...abcd',
        aptosPubkey: 'abcd1234...',
      };

      executor.start();
      mockSettlementMonitor.emit('SETTLEMENT_REQUIRED', {
        peerId: 'peer-charlie',
        balance: '1000000000', // 10 APT in octas
        tokenId: 'APT',
        timestamp: Date.now(),
      });

      await new Promise((resolve) => setTimeout(resolve, 50));

      expect(mockAptosChannelSDK.openChannel).toHaveBeenCalled();
    });

    it('should route APT token to Aptos when preference is any', async () => {
      // Configure peer with any preference
      const peerConfig: PeerConfig = {
        peerId: 'peer-diana',
        address: 'g.diana',
        settlementPreference: 'any',
        settlementTokens: ['USDC', 'XRP', 'APT'],
        evmAddress: '0xevm...',
        xrpAddress: 'rXRP...',
        aptosAddress: '0xaptos...',
        aptosPubkey: 'pubkey...',
      };

      // ... test implementation
    });

    it('should throw error for APT token when preference is evm', async () => {
      // Configure peer with evm-only preference
      const peerConfig: PeerConfig = {
        peerId: 'peer-evm-only',
        address: 'g.evmonly',
        settlementPreference: 'evm',
        settlementTokens: ['USDC'],
        evmAddress: '0xevm...',
      };

      // ... expect error
    });

    it('should throw error for USDC token when preference is aptos', async () => {
      // ... test incompatible token/preference
    });

    it('should emit telemetry on successful Aptos settlement', async () => {
      // ... verify telemetry emission
    });

    it('should emit telemetry on failed Aptos settlement', async () => {
      mockAptosChannelSDK.openChannel.mockRejectedValueOnce(new Error('Network error'));
      // ... verify error telemetry
    });
  });

  describe('Backward Compatibility', () => {
    it('should work without Aptos SDK (null)', async () => {
      const executorNoAptos = new UnifiedSettlementExecutor(
        config,
        mockEvmSDK,
        mockXrpManager,
        mockXrpClaimSigner,
        null, // No Aptos SDK
        mockSettlementMonitor,
        mockAccountManager,
        null,
        mockLogger
      );

      // EVM and XRP settlements should still work
    });

    it('should migrate both preference to any', async () => {
      // Verify backward compatibility
    });
  });
});
```

**Coverage Requirements:**
[Source: docs/architecture/test-strategy-and-standards.md]

- Unit tests: >80% coverage for modified files
- Test all new routing paths (APT token, aptos preference, any preference)
- Test error handling for incompatible combinations
- Test telemetry emission for all Aptos events
- Test backward compatibility with existing EVM/XRP tests

### Technical Constraints

**Feature Flag Implementation:**
[Source: docs/prd/epic-13-aptos-payment-channels.md#story-275]

```typescript
// Environment variable feature flag
// APTOS_SETTLEMENT_ENABLED=true  // Enable Aptos settlement (default after deployment)
// APTOS_SETTLEMENT_ENABLED=false // Disable Aptos settlement (rollback)

private isAptosEnabled(): boolean {
  return process.env.APTOS_SETTLEMENT_ENABLED !== 'false';
}

private async handleSettlement(event: SettlementRequiredEvent): Promise<void> {
  // ... existing logic

  // Check feature flag before Aptos routing
  if (tokenId === 'APT' && peerConfig.settlementPreference !== 'evm') {
    if (!this.isAptosEnabled()) {
      this.logger.warn({ peerId, tokenId }, 'Aptos settlement disabled, skipping');
      throw new SettlementDisabledError('Aptos settlement is currently disabled');
    }
    if (!this.aptosChannelSDK) {
      throw new Error('AptosChannelSDK not configured');
    }
    await this.settleViaAptos(peerId, balance, peerConfig);
  }
  // ... existing EVM/XRP logic unchanged
}
```

**Amount Handling:**
[Source: Story 13.1, Story 13.4]

1. APT amounts in octas (1 APT = 100,000,000 octas)
2. Store as bigint in TypeScript
3. Pass to AptosChannelSDK as bigint
4. Event balance comes as string, convert to bigint for SDK

**Backward Compatibility:**
[Source: Epic 13 Risk Management]

1. `settlementPreference: 'both'` should be treated as `'any'` for backward compatibility
2. Existing EVM/XRP settlement paths remain completely unchanged
3. AptosChannelSDK parameter is optional (null for deployments without Aptos)
4. Telemetry emission is optional (null TelemetryEmitter accepted)

### Security Considerations

**Aptos Address Validation:**
[Source: Epic 13 Security Considerations]

1. Validate `aptosAddress` format before settlement (0x-prefixed, 64 chars)
2. Validate `aptosPubkey` format (64-character hex)
3. Log all Aptos settlement attempts for audit

**Settlement Security:**
[Source: packages/connector/src/settlement/unified-settlement-executor.ts patterns]

1. Only submit transactions signed by configured account
2. Verify peer has valid Aptos address before routing
3. Check sufficient APT balance before channel operations

### Project Structure Notes

**File Organization:**
[Source: docs/architecture/source-tree.md]

The settlement executor follows existing patterns:

- Located in `packages/connector/src/settlement/`
- Uses Pino logger with child logger pattern
- Follows event-driven architecture with EventEmitter
- Bound handler pattern for event listener cleanup

**Integration with Previous Stories:**
Story 13.5 integrates all previous Epic 13 stories:

- Story 13.1: AptosClient for blockchain interactions
- Story 13.3: AptosClaimSigner for off-chain signatures
- Story 13.4: AptosChannelSDK for channel lifecycle
- Uses Move module deployed in Story 13.2 (via SDK)

## Tasks / Subtasks

**Task Execution Strategy:** This story extends UnifiedSettlementExecutor with Aptos routing. Task 1 updates types. Task 2 adds Aptos to constructor. Task 3 implements routing logic. Task 4 implements settleViaAptos. Task 5 adds telemetry. Task 6 adds feature flag. Task 7 implements unit tests. Task 8 implements integration tests.

- [x] Task 1: Update Type Definitions (AC: 1, 2)
  - [x] Update `PeerConfig` in `packages/connector/src/settlement/types.ts`
    - [x] Change `settlementPreference` type to `'evm' | 'xrp' | 'aptos' | 'any'`
    - [x] Add `aptosAddress?: string` field
    - [x] Add `aptosPubkey?: string` field
    - [x] Add JSDoc comments for new fields
  - [x] Update `UnifiedSettlementExecutorConfig` in same file
    - [x] Change `defaultPreference` type to include `'aptos' | 'any'`
  - [x] Add Aptos telemetry types to `packages/shared/src/types/payment-channel-telemetry.ts`
    - [x] Add `APTOS_CHANNEL_OPENED` event type
    - [x] Add `APTOS_CLAIM_SIGNED` event type
    - [x] Add `APTOS_CLAIM_SUBMITTED` event type
    - [x] Add `APTOS_SETTLEMENT_COMPLETED` event type
    - [x] Add `APTOS_SETTLEMENT_FAILED` event type

- [x] Task 2: Extend Constructor and Dependencies (AC: 3)
  - [x] Update `UnifiedSettlementExecutor` constructor in `unified-settlement-executor.ts`
    - [x] Add `aptosChannelSDK: IAptosChannelSDK | null` parameter
    - [x] Add `telemetryEmitter: TelemetryEmitter | null` parameter
    - [x] Store as private readonly fields
    - [x] Add import for `IAptosChannelSDK` from `./aptos-channel-sdk`
  - [x] Update constructor JSDoc with new parameters

- [x] Task 3: Implement Settlement Routing Logic (AC: 4, 5)
  - [x] Update `handleSettlement()` method
    - [x] Add `isAPTToken` check: `tokenId === 'APT'`
    - [x] Add `canUseAptos` check: `peerConfig.settlementPreference === 'aptos' || peerConfig.settlementPreference === 'any'`
    - [x] Add backward compatibility: treat `'both'` as `'any'`
    - [x] Add routing condition for APT + canUseAptos → `settleViaAptos()`
    - [x] Add error for APT + !canUseAptos
    - [x] Add error for !APT + aptos-only preference
    - [x] Maintain existing EVM/XRP routing unchanged
  - [x] Update error messages to include all three chains

- [x] Task 4: Implement settleViaAptos() Method (AC: 3, 6)
  - [x] Implement `private async settleViaAptos()` method
    - [x] Validate `peerConfig.aptosAddress` exists
    - [x] Validate `peerConfig.aptosPubkey` exists
    - [x] Call `findOrCreateAptosChannel()`
    - [x] Call `aptosChannelSDK.signClaim()` with amount
    - [x] Log claim signed and ready for delivery
    - [x] Call `accountManager.recordSettlement()` for TigerBeetle update
    - [x] Log settlement completion
  - [x] Implement `private async findOrCreateAptosChannel()` helper
    - [x] Check `aptosChannelSDK.getMyChannels()` for existing channel to destination
    - [x] If no channel, call `aptosChannelSDK.openChannel()`
    - [x] Default settle delay: 86400 seconds (24 hours)
    - [x] Return channel owner address
    - [x] Log channel creation

- [x] Task 5: Add Telemetry Emission (AC: 7)
  - [x] Add telemetry emission in `settleViaAptos()`
    - [x] Emit `APTOS_CHANNEL_OPENED` when new channel created
    - [x] Emit `APTOS_CLAIM_SIGNED` after signing claim
    - [x] Emit `APTOS_SETTLEMENT_COMPLETED` on success
    - [x] Emit `APTOS_SETTLEMENT_FAILED` on error (in catch block)
  - [x] Guard telemetry with null check: `this.telemetryEmitter?.emit()`
  - [x] Use consistent timestamp format with existing telemetry

- [x] Task 6: Implement Feature Flag (AC: 4)
  - [x] Implement `private isAptosEnabled(): boolean`
    - [x] Check `process.env.APTOS_SETTLEMENT_ENABLED !== 'false'`
    - [x] Default to enabled (true) when env var not set
  - [x] Add feature flag check in `handleSettlement()` before Aptos routing
  - [x] Throw `SettlementDisabledError` when Aptos disabled but APT token requested
  - [x] Create `SettlementDisabledError` class if not exists
  - [x] Log warning when settlement disabled

- [x] Task 7: Implement Unit Tests (AC: 8)
  - [x] Update `packages/connector/src/settlement/unified-settlement-executor.test.ts`
  - [x] Add `mockAptosChannelSDK` mock setup in beforeEach
  - [x] Add test: "should route APT token to Aptos when preference is aptos"
  - [x] Add test: "should route APT token to Aptos when preference is any"
  - [x] Add test: "should throw error for APT token when preference is evm"
  - [x] Add test: "should throw error for APT token when preference is xrp"
  - [x] Add test: "should throw error for USDC token when preference is aptos"
  - [x] Add test: "should handle tri-channel peer with all three addresses"
  - [x] Add test: "should work without Aptos SDK (null) for EVM/XRP"
  - [x] Add test: "should treat 'both' preference as 'any' for backward compatibility"
  - [x] Add test: "should emit APTOS_SETTLEMENT_COMPLETED telemetry"
  - [x] Add test: "should emit APTOS_SETTLEMENT_FAILED telemetry on error"
  - [x] Add test: "should throw SettlementDisabledError when feature flag is false"
  - [x] Add test: "should update TigerBeetle after Aptos settlement"
  - [x] Add test: "should create new channel if none exists"
  - [x] Add test: "should reuse existing channel if one exists"
  - [x] Verify all existing EVM/XRP tests still pass
  - [x] Achieve >80% code coverage for modified files

- [x] Task 8: Implement Integration Tests (AC: 9)
  - [x] Create `packages/connector/test/integration/tri-chain-settlement.test.ts`
  - [x] Add beforeAll() hook with prerequisite checks:
    - [x] Check APTOS_NODE_URL is set
    - [x] Check APTOS_PRIVATE_KEY is set
    - [x] Check APTOS_MODULE_ADDRESS is set
    - [x] Check docker-compose-dev infrastructure (Anvil, rippled)
    - [x] Skip all tests if prerequisites not met
  - [x] Add test: "should settle EVM peer with USDC"
  - [x] Add test: "should settle XRP peer with XRP"
  - [x] Add test: "should settle Aptos peer with APT" (skip if no Aptos testnet)
  - [x] Add test: "should handle peer with all three settlement methods"
  - [x] Add test: "should route correctly based on token type"
  - [x] Document test prerequisites in file header comment

- [x] Task 9: Update Configuration Documentation (AC: 10)
  - [x] Updated `packages/connector/src/settlement/types.ts` with comprehensive JSDoc
  - [x] Document new `settlementPreference` values ('aptos', 'any')
  - [x] Document `aptosAddress` and `aptosPubkey` fields
  - [x] Provide configuration examples for tri-chain peers in JSDoc
  - [x] Document feature flag `APTOS_SETTLEMENT_ENABLED` in unified-settlement-executor.ts
  - [x] Documented rollback procedure via feature flag in code comments

## Testing

**Test Framework:** Jest 29.7.x with ts-jest
[Source: docs/architecture/test-strategy-and-standards.md]

**Test File Locations:**

- Unit tests: `packages/connector/src/settlement/unified-settlement-executor.test.ts`
- Integration tests: `packages/connector/test/integration/tri-chain-settlement.test.ts`

**Test Categories:**

1. **Unit Tests (Jest):**
   - Settlement routing for APT token
   - Settlement routing for 'aptos' preference
   - Settlement routing for 'any' preference
   - Backward compatibility with 'both' preference
   - Error handling for incompatible combinations
   - Telemetry emission
   - Feature flag behavior
   - TigerBeetle account updates

2. **Integration Tests:**
   - End-to-end tri-chain settlement
   - Real blockchain interactions (when configured)
   - Settlement routing with real SDKs

**Running Tests:**

```bash
# Unit tests
cd packages/connector
npm test -- unified-settlement-executor.test.ts

# With coverage
npm test -- unified-settlement-executor.test.ts --coverage

# Integration tests (requires env vars and docker-compose-dev)
npm test -- test/integration/tri-chain-settlement.test.ts
```

**Coverage Goals:**

- Unit test coverage: >80% for modified files
- All new routing paths tested
- All error paths tested

## Change Log

| Date       | Version | Description                        | Author   |
| ---------- | ------- | ---------------------------------- | -------- |
| 2026-01-31 | 0.1     | Initial draft created from Epic 13 | SM Agent |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

None - implementation completed without debugging issues.

### Completion Notes

- All 9 tasks completed successfully
- Unit tests: 41 tests passing in unified-settlement-executor.test.ts
- Integration tests: 5 tests passing (3 skipped - require blockchain infrastructure)
- Types extended for tri-chain support with backward compatibility
- Feature flag APTOS_SETTLEMENT_ENABLED allows runtime disable
- Telemetry events added for Aptos settlement operations
- SettlementDisabledError class added for graceful feature flag handling

### File List

**Modified Files:**

- `packages/connector/src/settlement/types.ts` - Extended PeerConfig and UnifiedSettlementExecutorConfig for tri-chain
- `packages/connector/src/settlement/unified-settlement-executor.ts` - Added Aptos settlement routing and telemetry
- `packages/connector/src/settlement/unified-settlement-executor.test.ts` - Added 25+ new Aptos-related tests
- `packages/shared/src/types/payment-channel-telemetry.ts` - Added Aptos telemetry event types
- `packages/shared/src/index.ts` - Exported new Aptos telemetry types

**New Files:**

- `packages/connector/test/integration/tri-chain-settlement.test.ts` - Integration tests for tri-chain settlement

## QA Results

### Review Date: 2026-01-31

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: EXCELLENT**

The implementation demonstrates high-quality software engineering practices:

1. **Architecture & Design Patterns**: Clean separation of concerns with the `UnifiedSettlementExecutor` properly orchestrating tri-chain routing. The use of the bound handler pattern (`this.boundHandleSettlement = this.handleSettlement.bind(this)`) for event listener cleanup is correctly implemented.

2. **Type Safety**: Strong typing throughout with well-documented interfaces (`PeerConfig`, `UnifiedSettlementExecutorConfig`). The settlement preference type union (`'evm' | 'xrp' | 'aptos' | 'any' | 'both'`) properly covers all cases including backward compatibility.

3. **Error Handling**: Comprehensive error handling with custom error classes (`SettlementDisabledError`), proper validation of required peer configuration fields, and graceful feature flag handling.

4. **Telemetry Integration**: Non-blocking telemetry emission using `try-catch` pattern as required by coding standards. Null-safe `this._telemetryEmitter?.emit()` guard implemented correctly.

5. **Backward Compatibility**: Excellent handling of `'both'` to `'any'` preference migration. Null `AptosChannelSDK` and `TelemetryEmitter` parameters allow incremental deployment.

### Refactoring Performed

None required - code quality is high and follows established patterns.

### Compliance Check

- Coding Standards: ✓ All naming conventions, async/await patterns, Pino logging followed
- Project Structure: ✓ Files in correct locations per source-tree.md
- Testing Strategy: ✓ Unit tests co-located, integration tests in test/integration/, coverage >80%
- All ACs Met: ✓ All 10 acceptance criteria fully implemented and tested

### Improvements Checklist

[All items pass - no outstanding issues]

- [x] Settlement routing logic covers all token/preference combinations
- [x] Feature flag `APTOS_SETTLEMENT_ENABLED` implemented with default enabled
- [x] Telemetry events for all 5 Aptos settlement operations
- [x] TigerBeetle accounting updated after successful settlement
- [x] Unit tests: 41 tests passing with comprehensive coverage
- [x] Integration tests: 5 passing (3 appropriately skipped for infrastructure requirements)
- [x] Backward compatibility maintained for existing EVM/XRP settlements
- [x] JSDoc documentation comprehensive and accurate
- [x] Error messages descriptive and actionable

### Security Review

**Status: PASS**

1. **Address Validation**: `aptosAddress` validated as 0x-prefixed 64-character hex before settlement routing
2. **Public Key Validation**: `aptosPubkey` required and validated before Aptos settlement
3. **Feature Flag Kill Switch**: `APTOS_SETTLEMENT_ENABLED=false` provides emergency disable capability
4. **Input Validation**: All peer configuration fields validated before settlement attempt
5. **Error Isolation**: Settlement failures don't leak internal state; errors are logged and re-thrown

### Performance Considerations

**Status: PASS**

1. **Event-driven Architecture**: Settlement routing triggered by events, not polling
2. **Non-blocking Telemetry**: Telemetry emission wrapped in try-catch to prevent blocking
3. **Existing Channel Reuse**: `findOrCreateAptosChannel()` checks cache before opening new channel
4. **BigInt Handling**: Amounts properly handled as BigInt to avoid precision loss

### Files Modified During Review

None - no refactoring required.

### Gate Status

Gate: **PASS** → docs/qa/gates/27.5-tri-chain-settlement.yml

### Recommended Status

**✓ Ready for Done**

All acceptance criteria met, comprehensive test coverage achieved, code quality excellent, security considerations addressed, and backward compatibility maintained. Story owner may proceed to Done status.
