<!-- Powered by BMAD™ Core -->

# Story 13.5: Built-in Event Kind Handlers

## Status

Done

## Story

**As a** connector developer,
**I want** handlers for core Nostr event kinds (1, 3, 5, 10000) and subscription management,
**So that** agents can store notes, update routing tables, delete events, query databases, and push events to matching subscriptions.

## Acceptance Criteria

1. Kind 1 (Note): Store locally, push to matching subscriptions
2. Kind 3 (Follow): Update routing table
3. Kind 5 (Delete): Remove event from database
4. Kind 10000 (Query): Query database, return results
5. Nostr REQ: Register subscription filter, push matching events over BTP
6. Nostr CLOSE: Unregister subscription
7. Configurable pricing per handler

## Tasks / Subtasks

- [x] Task 1: Create Handlers Directory Structure (AC: 1, 2, 3, 4)
  - [x] Create directory: `packages/connector/src/agent/handlers/`
  - [x] Create file: `packages/connector/src/agent/handlers/index.ts` for exports
  - [x] Export all handler functions and types from index
  - [x] [Source: docs/architecture/agent-society-protocol.md lines 255-261]

- [x] Task 2: Implement Note Handler (Kind 1) (AC: 1, 7)
  - [x] Create file: `packages/connector/src/agent/handlers/note-handler.ts`
  - [x] Import required dependencies:
    ```typescript
    import type { EventHandler, EventHandlerContext, EventHandlerResult } from '../event-handler';
    import { DatabaseSizeExceededError } from '../event-database';
    ```
  - [x] Implement `createNoteHandler(): EventHandler` factory function (no config needed - simple storage handler)
  - [x] Handler logic:
    - [x] Store event in database: `await context.database.storeEvent(context.event)`
    - [x] Return `{ success: true }` on success
    - [x] Handle errors: catch DatabaseSizeExceededError and return `{ success: false, error: { code: 'T00', message: 'Storage limit exceeded' } }`
    - [x] Note: Subscription matching and BTP push is handled by AgentNode (Story 13.6) after handler returns success
  - [x] [Source: docs/architecture/agent-society-protocol.md line 63, docs/prd/epic-13-agent-society-protocol.md line 294]

- [x] Task 3: Implement Follow Handler (Kind 3) (AC: 2, 7)
  - [x] Create file: `packages/connector/src/agent/handlers/follow-handler.ts`
  - [x] Import required dependencies:
    ```typescript
    import type { EventHandler, EventHandlerContext, EventHandlerResult } from '../event-handler';
    import type { FollowGraphRouter } from '../follow-graph-router';
    ```
  - [x] Define `FollowHandlerConfig` interface:
    ```typescript
    interface FollowHandlerConfig {
      followGraphRouter: FollowGraphRouter; // Required for routing updates
    }
    ```
  - [x] Implement `createFollowHandler(config: FollowHandlerConfig): EventHandler` factory function
  - [x] Handler logic:
    - [x] Validate event.kind === 3
    - [x] Call `config.followGraphRouter.updateFromFollowEvent(context.event)` to update routing table
    - [x] Optionally store the Kind 3 event in database for persistence
    - [x] Return `{ success: true }` on success
  - [x] [Source: docs/architecture/agent-society-protocol.md lines 64, 136-153, docs/prd/epic-13-agent-society-protocol.md line 295]

- [x] Task 4: Implement Delete Handler (Kind 5) (AC: 3, 7)
  - [x] Create file: `packages/connector/src/agent/handlers/delete-handler.ts`
  - [x] Import required dependencies:
    ```typescript
    import type { EventHandler, EventHandlerContext, EventHandlerResult } from '../event-handler';
    ```
  - [x] Implement `createDeleteHandler(): EventHandler` factory function
  - [x] Handler logic:
    - [x] Validate event.kind === 5
    - [x] Extract event IDs to delete from event.tags:
      ```typescript
      // NIP-09: ["e", "<event-id>"] tags specify events to delete
      const eventIds = context.event.tags
        .filter((tag) => tag[0] === 'e' && tag.length >= 2)
        .map((tag) => tag[1]);
      ```
    - [x] If no event IDs found, return `{ success: true }` with deletedCount: 0
    - [x] Verify deletion authorization for each event:
      ```typescript
      // Query database for original events to verify author
      const originalEvents = await context.database.queryEvents({ ids: eventIds });
      // Filter to only events authored by the requester
      const authorizedIds = originalEvents
        .filter((e) => e.pubkey === context.event.pubkey)
        .map((e) => e.id);
      ```
    - [x] Call `await context.database.deleteEvents(authorizedIds)` for authorized deletions only
    - [x] Return `{ success: true }` with count of deleted events (authorized deletions only)
    - [x] Log warning for unauthorized deletion attempts (requester pubkey != event author)
  - [x] [Source: docs/architecture/agent-society-protocol.md line 65, docs/prd/epic-13-agent-society-protocol.md line 296]

- [x] Task 5: Implement Query Handler (Kind 10000) (AC: 4, 7)
  - [x] Create file: `packages/connector/src/agent/handlers/query-handler.ts`
  - [x] Import required dependencies:
    ```typescript
    import type { EventHandler, EventHandlerContext, EventHandlerResult } from '../event-handler';
    import type { NostrFilter } from '../event-database';
    ```
  - [x] Define `QueryHandlerConfig` interface:
    ```typescript
    interface QueryHandlerConfig {
      maxResults?: number; // Maximum results to return (default: 100)
      perResultPayment?: bigint; // Additional payment per result (for pricing)
    }
    ```
  - [x] Implement `createQueryHandler(config?: QueryHandlerConfig): EventHandler` factory function
  - [x] Handler logic:
    - [x] Validate event.kind === 10000
    - [x] Parse filter from event.content:
      ```typescript
      const filter: NostrFilter = JSON.parse(context.event.content);
      ```
    - [x] Apply maxResults limit: `filter.limit = Math.min(filter.limit ?? 100, config.maxResults ?? 100)`
    - [x] Query database: `const events = await context.database.queryEvents(filter)`
    - [x] Return `{ success: true, responseEvents: events }`
  - [x] Handle errors: catch JSON parse errors and return `{ success: false, error: { code: 'F01', message: 'Malformed query filter' } }`
  - [x] [Source: docs/architecture/agent-society-protocol.md lines 66, 100-120, docs/prd/epic-13-agent-society-protocol.md line 297]

- [x] Task 6: Define Subscription Types and Interfaces (AC: 5, 6)
  - [x] Create file: `packages/connector/src/agent/subscription-manager.ts`
  - [x] Define `Subscription` interface:
    ```typescript
    interface Subscription {
      id: string; // Subscription ID (client-provided)
      filter: NostrFilter; // Filter criteria for matching events
      peerId: string; // Peer connection ID for pushing events
      createdAt: number; // Unix timestamp when created
    }
    ```
  - [x] Define `SubscriptionManagerConfig` interface:
    ```typescript
    interface SubscriptionManagerConfig {
      maxSubscriptionsPerPeer?: number; // Default: 10
      logger?: Logger;
    }
    ```
  - [x] [Source: docs/architecture/agent-society-protocol.md lines 67-68, 155-178]

- [x] Task 7: Implement SubscriptionManager Class (AC: 5, 6)
  - [x] Create `SubscriptionManager` class in subscription-manager.ts:

    ```typescript
    class SubscriptionManager {
      private subscriptions: Map<string, Map<string, Subscription>>; // peerId -> subId -> Subscription
      private config: SubscriptionManagerConfig;
      private logger: Logger;

      constructor(config: SubscriptionManagerConfig);
    }
    ```

  - [x] Implement `registerSubscription(peerId: string, subId: string, filter: NostrFilter): void`
    - [x] Validate subscription limit per peer
    - [x] Store subscription in nested Map structure
    - [x] Log: `logger.info({ peerId, subId }, 'Subscription registered')`
  - [x] Implement `unregisterSubscription(peerId: string, subId: string): boolean`
    - [x] Remove subscription from Map
    - [x] Return true if removed, false if not found
    - [x] Log: `logger.info({ peerId, subId }, 'Subscription unregistered')`
  - [x] Implement `unregisterAllForPeer(peerId: string): number`
    - [x] Remove all subscriptions for a peer (for connection cleanup)
    - [x] Return count of removed subscriptions
  - [x] Implement `getMatchingSubscriptions(event: NostrEvent): Subscription[]`
    - [x] Iterate all subscriptions, return those whose filter matches the event
    - [x] Match logic: check kinds, authors, since, until, #e, #p filters
  - [x] Implement `getSubscriptionCount(peerId?: string): number`
    - [x] If peerId provided, return count for that peer
    - [x] Otherwise return total subscription count
  - [x] [Source: docs/architecture/agent-society-protocol.md lines 155-178, docs/architecture/components.md lines 73-77]

- [x] Task 8: Implement Filter Matching Logic (AC: 5)
  - [x] Add private method `matchesFilter(event: NostrEvent, filter: NostrFilter): boolean`
  - [x] Match criteria (all must pass, undefined means match all):
    - [x] `ids`: event.id in filter.ids
    - [x] `authors`: event.pubkey in filter.authors
    - [x] `kinds`: event.kind in filter.kinds
    - [x] `since`: event.created_at >= filter.since
    - [x] `until`: event.created_at <= filter.until
    - [x] `#e`: event has 'e' tag matching filter['#e']
    - [x] `#p`: event has 'p' tag matching filter['#p']
  - [x] Return true only if all defined criteria match
  - [x] [Source: docs/architecture/data-models.md lines 280-300]

- [x] Task 9: Create Handler Registration Helper (AC: 7)
  - [x] Create file: `packages/connector/src/agent/handlers/register-built-in-handlers.ts`
  - [x] Define `BuiltInHandlersConfig` interface:
    ```typescript
    interface BuiltInHandlersConfig {
      followGraphRouter: FollowGraphRouter;
      pricing: {
        noteStorage: bigint; // Kind 1 cost
        followUpdate: bigint; // Kind 3 cost
        deletion: bigint; // Kind 5 cost
        queryBase: bigint; // Kind 10000 base cost
        queryPerResult?: bigint; // Additional per-result cost
      };
      logger?: Logger;
    }
    ```
  - [x] Implement `registerBuiltInHandlers(eventHandler: AgentEventHandler, config: BuiltInHandlersConfig): void`
    - [x] Register Kind 1 handler with noteStorage payment
    - [x] Register Kind 3 handler with followUpdate payment
    - [x] Register Kind 5 handler with deletion payment
    - [x] Register Kind 10000 handler with queryBase payment
    - [x] Log registration: `logger.info('Built-in handlers registered')`
  - [x] [Source: docs/architecture/data-models.md lines 343-355, docs/prd/epic-13-agent-society-protocol.md line 300]

- [x] Task 10: Create Unit Tests for Note Handler (AC: 1)
  - [x] Create file: `packages/connector/src/agent/handlers/note-handler.test.ts`
  - [x] Test note storage:
    - [x] Stores event in database successfully
    - [x] Returns success: true
    - [x] Handles DatabaseSizeExceededError gracefully (returns T00 error)
  - [x] Note: Subscription matching tested separately in SubscriptionManager tests (Task 14)
  - [x] [Source: docs/architecture/test-strategy-and-standards.md lines 18-60]

- [x] Task 11: Create Unit Tests for Follow Handler (AC: 2)
  - [x] Create file: `packages/connector/src/agent/handlers/follow-handler.test.ts`
  - [x] Test routing update:
    - [x] Calls followGraphRouter.updateFromFollowEvent with event
    - [x] Returns success: true
    - [x] Handles non-Kind-3 events gracefully (should not happen but defensive)
  - [x] [Source: docs/architecture/test-strategy-and-standards.md lines 18-60]

- [x] Task 12: Create Unit Tests for Delete Handler (AC: 3)
  - [x] Create file: `packages/connector/src/agent/handlers/delete-handler.test.ts`
  - [x] Test event deletion:
    - [x] Extracts event IDs from 'e' tags
    - [x] Queries database for original events to verify authorship
    - [x] Only deletes events where requester pubkey matches original author
    - [x] Calls database.deleteEvents with authorized IDs only
    - [x] Returns success with count of deleted events
    - [x] Handles empty tags (no events to delete) - returns success with count 0
    - [x] Handles malformed tags gracefully (skips invalid tags)
  - [x] Test authorization:
    - [x] Deletes events authored by requester
    - [x] Skips events authored by different pubkey (unauthorized)
    - [x] Logs warning for unauthorized deletion attempts
    - [x] Returns partial success when some events authorized, some not
  - [x] [Source: docs/architecture/test-strategy-and-standards.md lines 18-60]

- [x] Task 13: Create Unit Tests for Query Handler (AC: 4)
  - [x] Create file: `packages/connector/src/agent/handlers/query-handler.test.ts`
  - [x] Test query execution:
    - [x] Parses filter from event.content
    - [x] Calls database.queryEvents with filter
    - [x] Returns events in responseEvents array
    - [x] Respects maxResults limit
    - [x] Handles JSON parse error gracefully
    - [x] Handles empty results
  - [x] [Source: docs/architecture/test-strategy-and-standards.md lines 18-60]

- [x] Task 14: Create Unit Tests for SubscriptionManager (AC: 5, 6)
  - [x] Create file: `packages/connector/src/agent/subscription-manager.test.ts`
  - [x] Test subscription registration:
    - [x] Registers subscription successfully
    - [x] Respects max subscriptions per peer limit
    - [x] Handles duplicate subscription IDs (replace or reject)
  - [x] Test subscription unregistration:
    - [x] Removes subscription successfully
    - [x] Returns false for non-existent subscription
    - [x] unregisterAllForPeer removes all for peer
  - [x] Test filter matching:
    - [x] Matches by kinds
    - [x] Matches by authors
    - [x] Matches by since/until
    - [x] Matches by #e/#p tags
    - [x] Returns empty array when no matches
    - [x] Matches all when filter is empty
  - [x] [Source: docs/architecture/test-strategy-and-standards.md lines 18-60]

- [x] Task 15: Create Unit Tests for Handler Registration Helper (AC: 7)
  - [x] Create file: `packages/connector/src/agent/handlers/register-built-in-handlers.test.ts`
  - [x] Test registration:
    - [x] Registers all 4 built-in handlers (kinds 1, 3, 5, 10000)
    - [x] Applies correct pricing to each handler
    - [x] Injects followGraphRouter into follow handler
    - [x] Works with and without optional logger
  - [x] [Source: docs/architecture/test-strategy-and-standards.md lines 18-60]

- [x] Task 16: Export Handlers and SubscriptionManager from Agent Module (AC: 1-7)
  - [x] Update `packages/connector/src/agent/index.ts` to export:
    - [x] createNoteHandler
    - [x] createFollowHandler, FollowHandlerConfig
    - [x] createDeleteHandler
    - [x] createQueryHandler, QueryHandlerConfig
    - [x] SubscriptionManager, SubscriptionManagerConfig, Subscription
    - [x] registerBuiltInHandlers, BuiltInHandlersConfig
  - [x] [Source: docs/prd/epic-13-agent-society-protocol.md lines 209-224]

## Dev Notes

### Previous Story Insights

Story 13.4 (Follow Graph Router) completed the routing foundation:

- **FollowGraphRouter** provides routing table population from Kind 3 events
- **updateFromFollowEvent(event)** parses ILP address tags and updates routes
- **AgentFollow** interface includes pubkey, ilpAddress, petname, addedAt
- **Integration pattern**: FollowGraphRouter should be injected into Follow handler
- **ILP address validation**: Uses `isValidILPAddress()` from `@m2m/shared`

Key insight: Story 13.5 implements the Kind 3 handler that will call `FollowGraphRouter.updateFromFollowEvent(event)` when follow events are received. The FollowGraphRouter is designed to be injected as a dependency.
[Source: docs/stories/13.4.story.md Dev Agent Record section]

Story 13.3 (Event Handler Dispatch System) established the handler patterns:

- **EventHandler** type: `(context: EventHandlerContext) => Promise<EventHandlerResult>`
- **EventHandlerContext** includes event, packet, amount, source, agentPubkey, database
- **EventHandlerResult** has success, responseEvent, responseEvents, error fields
- **HandlerConfig** with kind, handler, requiredPayment, description
- **registerHandler(config)** for registration
- **InsufficientPaymentError** for payment validation

[Source: docs/stories/13.3.story.md Dev Agent Record section]

### Technical Context

**Built-in Handler Architecture:**
Each handler is implemented as a factory function that returns an EventHandler:

```
createNoteHandler() → EventHandler
createFollowHandler(config) → EventHandler
createDeleteHandler() → EventHandler
createQueryHandler(config) → EventHandler
```

This factory pattern enables:

1. Dependency injection (FollowGraphRouter into Follow handler)
2. Configuration (maxResults for Query handler)
3. Testability (mock dependencies in tests)

[Source: docs/architecture/agent-society-protocol.md lines 60-82]

**Event Kind Reference:**

| Kind  | Name        | Handler Action                              |
| ----- | ----------- | ------------------------------------------- |
| 1     | Note (Text) | Store in DB, push to subscriptions          |
| 3     | Follow List | Update routing table via FollowGraphRouter  |
| 5     | Deletion    | Remove events by ID from DB                 |
| 10000 | Query       | Execute NIP-01 filter query, return results |

[Source: docs/architecture/agent-society-protocol.md lines 63-66, docs/prd/epic-13-agent-society-protocol.md lines 294-300]

**Subscription Architecture (AC 5/6 Clarification):**

Subscription setup happens **out-of-band**, similar to payment channel setup in the settlement layer. This means:

- **AC 5/6 refer to the SubscriptionManager API**, not Nostr REQ/CLOSE message handlers
- Subscriptions are established via configuration, BTP handshake, or other out-of-band mechanism (not via ILP packets)
- SubscriptionManager is a **storage and matching layer** that tracks active subscriptions
- The actual subscription negotiation protocol is outside the scope of this story

```
┌─────────────────────────────────────────────────────────────────────┐
│                     Out-of-Band Subscription Setup                   │
│  (Like payment channel setup - config, BTP handshake, etc.)         │
│                                                                      │
│  Agent A ◄──── subscription negotiation ────► Agent B               │
│                                                                      │
│  Result: SubscriptionManager.registerSubscription(peerId, filter)   │
└─────────────────────────────────────────────────────────────────────┘
```

**Subscription Push Flow (In-Band Event Delivery):**

When a new event arrives that matches a subscription, the Note handler pushes it to subscribers:

```
Agent C sends Kind 1 event to Agent B
         │
         ▼
Note Handler: store event in DB
         │
         ▼
SubscriptionManager.getMatchingSubscriptions(event)
         │
         ▼
Push event to Agent A via BTP (matching subscription)
```

The Note handler is responsible for:

1. Storing the event in the database
2. Calling `subscriptionManager.getMatchingSubscriptions(event)` to find matching peers
3. Returning matching subscriptions (the actual BTP push is handled by AgentNode in Story 13.6)

[Source: docs/architecture/agent-society-protocol.md lines 155-178]

**NIP-09 Deletion Request Format:**

```json
{
  "kind": 5,
  "pubkey": "<author of events to delete>",
  "tags": [
    ["e", "<event-id-to-delete>"],
    ["e", "<another-event-id>"]
  ],
  "content": "<optional reason>"
}
```

Authorization: Only the original author (pubkey) can delete their events.

[Source: Nostr NIP-09 specification]

### Data Models

**NostrFilter Interface (from Story 13.2):**
[Source: docs/architecture/data-models.md lines 280-300]

```typescript
interface NostrFilter {
  ids?: string[]; // Event IDs to match
  authors?: string[]; // Author pubkeys to match
  kinds?: number[]; // Event kinds to match
  since?: number; // Unix timestamp lower bound (>=)
  until?: number; // Unix timestamp upper bound (<=)
  limit?: number; // Maximum results (default: 100)
  '#e'?: string[]; // Events referenced in tags
  '#p'?: string[]; // Pubkeys referenced in tags
}
```

**Subscription Interface:**
[Source: docs/architecture/agent-society-protocol.md lines 67-68]

```typescript
interface Subscription {
  id: string; // Client-provided subscription ID
  filter: NostrFilter; // Filter criteria
  peerId: string; // Connection ID for push delivery
  createdAt: number; // Unix timestamp
}
```

**AgentPricing Reference:**
[Source: docs/architecture/data-models.md lines 343-355]

```typescript
interface AgentPricing {
  storeEvent: bigint; // Cost to store an event (Kind 1)
  queryBase: bigint; // Base cost for query request (Kind 10000)
  queryPerResult: bigint; // Additional cost per result
  subscription: bigint; // Cost per subscription
  forwardHop: bigint; // Cost to forward event
}
```

### File Locations

**New Files (Story 13.5):**

```
packages/connector/src/agent/
├── index.ts                          # Agent module exports (update)
├── toon-codec.ts                     # ToonCodec (from Story 13.1)
├── event-database.ts                 # AgentEventDatabase (from Story 13.2)
├── event-handler.ts                  # AgentEventHandler (from Story 13.3)
├── follow-graph-router.ts            # FollowGraphRouter (from Story 13.4)
├── subscription-manager.ts           # SubscriptionManager (NEW)
├── subscription-manager.test.ts      # SubscriptionManager tests (NEW)
└── handlers/
    ├── index.ts                      # Handler exports (NEW)
    ├── note-handler.ts               # Kind 1 handler (NEW)
    ├── note-handler.test.ts          # Kind 1 tests (NEW)
    ├── follow-handler.ts             # Kind 3 handler (NEW)
    ├── follow-handler.test.ts        # Kind 3 tests (NEW)
    ├── delete-handler.ts             # Kind 5 handler (NEW)
    ├── delete-handler.test.ts        # Kind 5 tests (NEW)
    ├── query-handler.ts              # Kind 10000 handler (NEW)
    ├── query-handler.test.ts         # Kind 10000 tests (NEW)
    ├── register-built-in-handlers.ts # Registration helper (NEW)
    └── register-built-in-handlers.test.ts # Registration tests (NEW)
```

[Source: docs/prd/epic-13-agent-society-protocol.md lines 209-224, docs/architecture/agent-society-protocol.md lines 239-262]

### Testing Requirements

**Unit Test Location:** Co-located with source files
[Source: docs/architecture/test-strategy-and-standards.md line 23]

**Test Framework:** Jest 29.7.x with TypeScript support
[Source: docs/architecture/tech-stack.md line 23]

**Required Test Coverage:**

- Each handler: success path, error paths, edge cases
- SubscriptionManager: registration, unregistration, filter matching
- Registration helper: all handlers registered with correct pricing
- > 80% line coverage per file

**Test Pattern:**
[Source: docs/architecture/test-strategy-and-standards.md lines 36-59]

```typescript
import { createNoteHandler } from './note-handler';
import type { EventHandlerContext } from '../event-handler';

describe('createNoteHandler', () => {
  let mockDatabase: jest.Mocked<AgentEventDatabase>;

  beforeEach(() => {
    mockDatabase = {
      storeEvent: jest.fn().mockResolvedValue(undefined),
      queryEvents: jest.fn().mockResolvedValue([]),
    } as any;
  });

  it('should store event in database', async () => {
    const handler = createNoteHandler();
    const context = createTestContext({ database: mockDatabase });

    const result = await handler(context);

    expect(mockDatabase.storeEvent).toHaveBeenCalledWith(context.event);
    expect(result.success).toBe(true);
  });
});
```

### Technical Constraints

**TypeScript Configuration:**

- Strict mode enabled (`strict: true`)
- No `any` types except in test mocks
- Use async/await for all handler operations
  [Source: docs/architecture/coding-standards.md lines 38-41]

**Naming Conventions:**

- Files: `note-handler.ts`, `subscription-manager.ts` (kebab-case)
- Classes: `SubscriptionManager` (PascalCase)
- Interfaces: `FollowHandlerConfig`, `QueryHandlerConfig`, `Subscription` (PascalCase)
- Functions: `createNoteHandler`, `registerBuiltInHandlers` (camelCase)
  [Source: docs/architecture/coding-standards.md lines 14-20]

**Error Handling:**

- Use Pino logger for all logging (no console.log)
- Return structured errors in EventHandlerResult, don't throw from handlers
- Catch and handle JSON parse errors in query handler
- Handle DatabaseSizeExceededError gracefully
  [Source: docs/architecture/coding-standards.md lines 24, 30-31]

**Logger Usage:**

- Create child logger: `logger.child({ component: 'NoteHandler' })`
- Log at appropriate levels: debug for filter matching, info for operations
  [Source: docs/architecture/coding-standards.md line 24]

### Dependencies

**Existing Dependencies (from previous stories):**

- AgentEventHandler, EventHandlerContext, EventHandlerResult (Story 13.3)
- AgentEventDatabase, NostrFilter, DatabaseSizeExceededError (Story 13.2)
- FollowGraphRouter (Story 13.4)
- NostrEvent (Story 13.1)

**Type Imports:**

```typescript
import type { Logger } from 'pino';
import type { EventHandler, EventHandlerContext, EventHandlerResult } from '../event-handler';
import type { AgentEventDatabase, NostrFilter } from '../event-database';
import type { FollowGraphRouter } from '../follow-graph-router';
import type { NostrEvent } from '../toon-codec';
```

### Edge Cases and Error Scenarios

**Kind 1 (Note) Handler:**

- Event storage fails due to size limit → Return T00 error
- Empty content allowed (valid per NIP-01)

**Kind 3 (Follow) Handler:**

- No ILP tags in event → Router handles gracefully (empty follow list)
- Invalid ILP addresses → Router logs warning and skips

**Kind 5 (Delete) Handler:**

- No 'e' tags → Return success with deletedCount: 0
- Event ID doesn't exist → queryEvents returns empty, nothing to delete
- Delete request from non-author → Query original events, skip those where pubkey doesn't match requester
- Mixed authorization → Delete only authorized events, log warning for unauthorized attempts
- All events unauthorized → Return success with deletedCount: 0 (no error, just no deletions)

**Kind 10000 (Query) Handler:**

- Invalid JSON in content → Return F01 error
- Empty filter (query all) → Apply default limit
- No matching events → Return success with empty responseEvents

**SubscriptionManager:**

- Subscription limit exceeded → Reject registration
- Duplicate subscription ID → Replace existing
- Peer disconnects → Call unregisterAllForPeer for cleanup
- Empty filter → Matches all events

### Integration with Previous Stories

**Story 13.3 Integration (AgentEventHandler):**
Built-in handlers will be registered using:

```typescript
agentEventHandler.registerHandler({
  kind: 1,
  handler: createNoteHandler(),
  requiredPayment: pricing.noteStorage,
  description: 'Note storage',
});
```

**Story 13.6 Integration (AgentNode):**
AgentNode will orchestrate subscription matching after Note handler returns:

```typescript
// After Note handler returns success:
const matchingSubs = subscriptionManager.getMatchingSubscriptions(event);
for (const sub of matchingSubs) {
  // Push event to subscriber via BTP
  await btpClient.sendEvent(sub.peerId, event);
}
```

**Story 13.4 Integration (FollowGraphRouter):**
Follow handler will be injected with FollowGraphRouter:

```typescript
const followHandler = createFollowHandler({
  followGraphRouter: router,
});
// When Kind 3 event received:
// → followHandler calls router.updateFromFollowEvent(event)
// → Routing table updated with new follows
```

## Testing

### Test File Locations

- `packages/connector/src/agent/handlers/note-handler.test.ts`
- `packages/connector/src/agent/handlers/follow-handler.test.ts`
- `packages/connector/src/agent/handlers/delete-handler.test.ts`
- `packages/connector/src/agent/handlers/query-handler.test.ts`
- `packages/connector/src/agent/handlers/register-built-in-handlers.test.ts`
- `packages/connector/src/agent/subscription-manager.test.ts`

[Source: docs/architecture/test-strategy-and-standards.md line 23 - co-located tests]

### Test Framework

Jest 29.7.x with ts-jest for TypeScript support
[Source: docs/architecture/tech-stack.md line 23]

### Test Commands

```bash
# Run all handler tests
npm test -- packages/connector/src/agent/handlers/

# Run SubscriptionManager tests
npm test -- subscription-manager.test.ts

# Run with coverage
npm test -- --coverage packages/connector/src/agent/

# Run all agent module tests
npm test -- packages/connector/src/agent/
```

### Test Coverage Requirements

- > 80% line coverage for each handler
- > 80% line coverage for SubscriptionManager
- All handler success/error paths tested
- All filter matching scenarios tested
  [Source: docs/architecture/test-strategy-and-standards.md lines 7-9]

### Acceptance Criteria Verification

| AC# | Test Scenario                                         | Verification Method                                                                            |
| --- | ----------------------------------------------------- | ---------------------------------------------------------------------------------------------- |
| 1   | Kind 1 (Note): Store locally, push to subscriptions   | Test storeEvent called; subscription matching via SubscriptionManager.getMatchingSubscriptions |
| 2   | Kind 3 (Follow): Update routing table                 | Test followGraphRouter.updateFromFollowEvent called                                            |
| 3   | Kind 5 (Delete): Remove event from database           | Test deleteEvents called with authorized IDs only                                              |
| 4   | Kind 10000 (Query): Query database, return results    | Test queryEvents called, responseEvents returned                                               |
| 5   | SubscriptionManager API: Register subscription filter | Test registerSubscription stores filter, getMatchingSubscriptions returns matches              |
| 6   | SubscriptionManager API: Unregister subscription      | Test unregisterSubscription removes filter, returns true/false                                 |
| 7   | Configurable pricing per handler                      | Test registerBuiltInHandlers applies pricing                                                   |

**Note on AC 5/6:** These test the SubscriptionManager API (storage and matching layer). Subscription setup happens out-of-band (like payment channel setup). Actual BTP push is handled by AgentNode (Story 13.6).

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5

### File List

| File                                                                     | Action   | Description                                        |
| ------------------------------------------------------------------------ | -------- | -------------------------------------------------- |
| packages/connector/src/agent/handlers/index.ts                           | Created  | Handler exports barrel file                        |
| packages/connector/src/agent/handlers/note-handler.ts                    | Created  | Kind 1 (Note) handler implementation               |
| packages/connector/src/agent/handlers/note-handler.test.ts               | Created  | Unit tests for Note handler                        |
| packages/connector/src/agent/handlers/follow-handler.ts                  | Created  | Kind 3 (Follow) handler implementation             |
| packages/connector/src/agent/handlers/follow-handler.test.ts             | Created  | Unit tests for Follow handler                      |
| packages/connector/src/agent/handlers/delete-handler.ts                  | Created  | Kind 5 (Delete) handler implementation             |
| packages/connector/src/agent/handlers/delete-handler.test.ts             | Created  | Unit tests for Delete handler                      |
| packages/connector/src/agent/handlers/query-handler.ts                   | Created  | Kind 10000 (Query) handler implementation          |
| packages/connector/src/agent/handlers/query-handler.test.ts              | Created  | Unit tests for Query handler                       |
| packages/connector/src/agent/handlers/register-built-in-handlers.ts      | Created  | Handler registration helper                        |
| packages/connector/src/agent/handlers/register-built-in-handlers.test.ts | Created  | Unit tests for registration helper                 |
| packages/connector/src/agent/subscription-manager.ts                     | Created  | SubscriptionManager with filter matching           |
| packages/connector/src/agent/subscription-manager.test.ts                | Created  | Unit tests for SubscriptionManager                 |
| packages/connector/src/agent/index.ts                                    | Modified | Added exports for handlers and SubscriptionManager |

### Debug Log References

None required.

### Completion Notes

- All 4 built-in handlers implemented as factory functions (createNoteHandler, createFollowHandler, createDeleteHandler, createQueryHandler)
- SubscriptionManager implements filter matching for all NIP-01 criteria (ids, authors, kinds, since, until, #e, #p)
- Delete handler includes authorization check - only original author can delete events
- registerBuiltInHandlers helper enables easy configuration with pricing
- 80 new unit tests added, all passing
- Full agent module test suite: 230 tests passing
- Linting passes

## QA Results

### Review Date: 2026-01-24

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment: Excellent**

The implementation demonstrates high-quality code architecture with clean factory patterns, proper dependency injection, comprehensive error handling, and full NIP-01/NIP-09 compliance. The code follows project coding standards consistently.

**Strengths:**

- Factory pattern (`createNoteHandler()`, `createFollowHandler()`, etc.) enables clean dependency injection and testability
- Authorization check in delete handler correctly implements NIP-09 (only original author can delete)
- SubscriptionManager implements complete NIP-01 filter matching (ids, authors, kinds, since, until, #e, #p)
- Proper defensive validation in all handlers (kind checks with F99 errors)
- Clean separation of concerns - handlers focus on business logic, registration helper handles wiring
- Excellent documentation with JSDoc comments and code examples

**Minor Observations (not blocking):**

- `_subscriptions` Map uses underscore prefix consistently with project conventions
- Logger fallback patterns are safe and don't leak undefined access

### Refactoring Performed

None required - implementation quality is excellent.

### Compliance Check

- Coding Standards: ✓ Follows kebab-case files, PascalCase classes/interfaces, camelCase functions
- Project Structure: ✓ Co-located tests, proper module exports in index.ts
- Testing Strategy: ✓ AAA pattern, comprehensive mocking, edge case coverage
- All ACs Met: ✓ All 7 acceptance criteria fully implemented (see traceability below)

### Requirements Traceability

| AC# | Acceptance Criteria                                 | Implementation                                                            | Test Coverage                                  |
| --- | --------------------------------------------------- | ------------------------------------------------------------------------- | ---------------------------------------------- |
| 1   | Kind 1 (Note): Store locally, push to subscriptions | `note-handler.ts` stores via `context.database.storeEvent()`              | ✓ note-handler.test.ts: 5 tests                |
| 2   | Kind 3 (Follow): Update routing table               | `follow-handler.ts` calls `followGraphRouter.updateFromFollowEvent()`     | ✓ follow-handler.test.ts: 5 tests              |
| 3   | Kind 5 (Delete): Remove event from database         | `delete-handler.ts` with authorization check per NIP-09                   | ✓ delete-handler.test.ts: 14 tests             |
| 4   | Kind 10000 (Query): Query database, return results  | `query-handler.ts` parses filter from content, returns `responseEvents`   | ✓ query-handler.test.ts: 15 tests              |
| 5   | Nostr REQ: Register subscription filter             | `SubscriptionManager.registerSubscription()` API                          | ✓ subscription-manager.test.ts: 8 tests        |
| 6   | Nostr CLOSE: Unregister subscription                | `SubscriptionManager.unregisterSubscription()` + `unregisterAllForPeer()` | ✓ subscription-manager.test.ts: 5 tests        |
| 7   | Configurable pricing per handler                    | `registerBuiltInHandlers()` accepts pricing config per kind               | ✓ register-built-in-handlers.test.ts: 10 tests |

### Test Architecture Assessment

**Test Quality: Excellent**

- **Test Count:** 80 new tests for Story 13.5 components (230 total in agent module)
- **Coverage:** All Story 13.5 handler files have 100% line coverage
- **Test Patterns:** Proper AAA pattern, descriptive test names, isolated mock instances in `beforeEach()`
- **Edge Cases:** Comprehensive coverage including:
  - Empty inputs (no tags, empty content, empty filter)
  - Authorization failures (delete handler)
  - Malformed inputs (invalid JSON, wrong event kinds)
  - Subscription limits exceeded
  - Filter matching edge cases (exact timestamp bounds)

**Filter Matching Tests (NIP-01 Compliance):**

- ✓ ids matching
- ✓ authors matching
- ✓ kinds matching
- ✓ since/until timestamp bounds (inclusive)
- ✓ #e tag matching
- ✓ #p tag matching
- ✓ Combined criteria (AND logic)
- ✓ Empty filter matches all

### Improvements Checklist

- [x] All handlers implemented as factory functions
- [x] Delete handler includes NIP-09 authorization check
- [x] SubscriptionManager implements complete NIP-01 filter matching
- [x] Registration helper enables configurable pricing
- [x] All exports properly added to index.ts
- [x] 100% test coverage on all new handler files

### Security Review

**Status: PASS**

The delete handler correctly implements authorization:

- Queries original events to verify authorship before deletion
- Only deletes events where `originalEvent.pubkey === requester.pubkey`
- Logs warnings for unauthorized deletion attempts
- Returns success (not error) for unauthorized attempts - appropriate for NIP-09 semantics

No other security concerns identified.

### Performance Considerations

**Status: PASS**

- Filter matching in `SubscriptionManager._matchesFilter()` is O(n) where n = number of subscriptions
- For high subscription counts, consider indexing by kind/author (future optimization, not needed for MVP)
- Query handler respects `maxResults` limit to prevent excessive database reads

### Files Modified During Review

None - no refactoring required.

### Gate Status

Gate: **PASS** → docs/qa/gates/13.5-built-in-event-kind-handlers.yml

### Recommended Status

✓ **Ready for Done** - All acceptance criteria fully implemented with excellent test coverage and code quality.

---

## Change Log

| Date       | Version | Description                                                                                                                                                                                                                                                           | Author     |
| ---------- | ------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------- |
| 2026-01-23 | 0.1     | Initial story draft creation                                                                                                                                                                                                                                          | SM         |
| 2026-01-23 | 0.2     | Clarified AC 5/6 scope: SubscriptionManager API (not REQ/CLOSE handlers), subscription setup is out-of-band like payment channels. Added delete handler authorization subtasks. Fixed naming conventions and factory pattern docs to reflect simplified Note handler. | Validation |
| 2026-01-24 | 1.0     | Implementation complete - all handlers, SubscriptionManager, tests passing                                                                                                                                                                                            | Dev Agent  |
| 2026-01-24 | 1.1     | QA Review complete - PASS gate, all ACs verified, excellent code quality                                                                                                                                                                                              | Quinn (QA) |
