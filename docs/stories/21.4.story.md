# Story 21.4: Channel Opening Integration Fixes — peerAddress Propagation, Validation, and Error Handling

**Epic:** 21 - Payment Channel Admin APIs
**Story Number:** 21.4
**Status:** Done
**Priority:** P0/P1 (Critical + High — Channel Opening Broken)

## Story

**As a** BLS developer,
**I want** `POST /admin/channels` to propagate the `peerAddress` parameter through to the SDK, validate peer existence, and return accurate channel status,
**so that** the BLS can open payment channels during SPSP handshakes without circular dependency on prior peer settlement registration.

## Acceptance Criteria

1. `ChannelManager.openChannelForPeer()` resolves peer address from `options.peerAddress` first, falling back to `config.peerIdToAddressMap` (Gap 13 — the core fix)
2. EVM path in admin-api uses `body.peerAddress` if provided, falls back to `settlementPeers.get(peerId)?.evmAddress`, returns 400 if neither available (Gap 1 — already implemented, verify)
3. XRP path uses `body.peerAddress` if provided, falls back to `peerConfig?.xrpAddress`, returns 400 if neither available (Gap 1 — NOT yet implemented)
4. `POST /admin/channels` validates that `body.peerId` exists in registered peers before opening (Gap 8)
5. Returns 404 with `{ error: 'Not found', message: 'Peer must be registered before opening channels' }` if peer unknown
6. Channel opening response returns actual channel status from `channelManager.getChannelById()`, not hardcoded `'open'` (Gap 7)
7. If `ensureChannelExists()` throws, returns 500 error (already handled by catch block — verify)
8. If metadata is unavailable after channel creation, returns 500 error
9. `peerAddress` validation: after chain routing, EVM addresses must match `/^0x[0-9a-fA-F]{40}$/`, XRP addresses must start with `r` and be 25-35 chars
10. Unit tests for peerAddress propagation through ChannelManager to SDK
11. Unit tests for XRP peerAddress resolution (provided, fallback, missing)
12. Unit tests for peer existence validation (404 on unknown peer)
13. Unit tests for error handling (missing metadata, accurate status)
14. All existing channel tests continue to pass

## Tasks / Subtasks

- [x] Task 1: Fix `openChannelForPeer()` to use `options.peerAddress` (AC: 1) **THIS IS THE CORE FIX**
  - [x] In `packages/connector/src/settlement/channel-manager.ts`, method `openChannelForPeer()` (line ~194):
    - [x] Change address resolution from:
      ```typescript
      const peerAddress = this.config.peerIdToAddressMap.get(peerId);
      ```
      To:
      ```typescript
      const peerAddress = options?.peerAddress || this.config.peerIdToAddressMap.get(peerId);
      ```
    - [x] Keep the existing `if (!peerAddress) throw ...` check (covers both sources missing)
    - [x] Add log line: `this.logger.info({ peerId, peerAddress, source: options?.peerAddress ? 'options' : 'config' }, 'Resolved peer address for channel opening')`
  - **Note:** `ChannelOpenOptions` already has `peerAddress?: string` (line 50) and `ensureChannelExists()` already passes options through. Only `openChannelForPeer()` needs changing.

- [x] Task 2: Verify EVM path in admin-api already works (AC: 2) — **ALREADY IMPLEMENTED**
  - [x] Confirm `admin-api.ts` lines ~849-898 already resolve: `body.peerAddress || peerConfig?.evmAddress`
  - [x] Confirm `peerAddress` is passed in options to `channelManager.ensureChannelExists()`
  - [x] No code changes needed — mark as verified

- [x] Task 3: Update XRP channel opening path to use peerAddress (AC: 3)
  - [x] In `admin-api.ts` XRP path (lines ~900-933):
    - [x] Change from:
      ```typescript
      const peerConfig = settlementPeers?.get(body.peerId);
      if (!peerConfig?.xrpAddress) {
        res
          .status(400)
          .json({ error: 'Bad request', message: 'Peer has no XRP address configured' });
        return;
      }
      ```
      To:
      ```typescript
      const peerConfig = settlementPeers?.get(body.peerId);
      const peerXrpAddress = body.peerAddress || peerConfig?.xrpAddress;
      if (!peerXrpAddress) {
        res.status(400).json({
          error: 'Bad request',
          message: 'Peer XRP address must be provided in request or peer registration',
        });
        return;
      }
      ```
    - [x] Pass resolved `peerXrpAddress` to `xrpChannelLifecycleManager.getOrCreateChannel(body.peerId, peerXrpAddress)`

- [x] Task 4: Add peer existence validation (AC: 4, 5)
  - [x] At the start of `POST /admin/channels` handler in `admin-api.ts` (after `validateOpenChannelRequest`, before chain routing ~line 847):
    - [x] Add:
      ```typescript
      const existingPeers = btpClientManager.getPeerIds();
      if (!existingPeers.includes(body.peerId)) {
        res.status(404).json({
          error: 'Not found',
          message: `Peer '${body.peerId}' must be registered before opening channels`,
        });
        return;
      }
      ```
  - **Note:** `btpClientManager.getPeerIds()` is already available in the router closure (used in route handlers at line ~750)

- [x] Task 5: Fix channel status in response (AC: 6, 7, 8)
  - [x] **EVM path** — after `ensureChannelExists()` returns (lines ~881-898):
    - [x] Replace hardcoded response with:
      ```typescript
      const metadata = channelManager.getChannelById(channelId);
      if (!metadata) {
        res.status(500).json({
          error: 'Internal error',
          message: 'Channel created but metadata unavailable',
        });
        return;
      }
      res.status(201).json({
        channelId,
        chain: body.chain,
        status: metadata.status,
        deposit: body.initialDeposit,
      } satisfies OpenChannelResponse);
      ```
    - [x] Note: `ensureChannelExists()` returns `Promise<string>` — it throws on failure (caught by existing try-catch), never returns null. So `!channelId` check is unnecessary.
  - [x] **XRP path** — after `getOrCreateChannel()` returns (lines ~918-933), replace hardcoded response with:
    ```typescript
    const metadata = channelManager.getChannelById(channelId);
    if (!metadata) {
      res.status(500).json({
        error: 'Internal error',
        message: 'XRP channel created but metadata unavailable',
      });
      return;
    }
    res.status(201).json({
      channelId,
      chain: body.chain,
      status: metadata.status,
      deposit: body.initialDeposit,
    } satisfies OpenChannelResponse);
    ```

- [x] Task 6: Add peerAddress format validation (AC: 9)
  - [x] Validation happens AFTER chain routing (not in `validateOpenChannelRequest`) because format depends on chain type
  - [x] **EVM path** — after resolving `peerAddress`, before calling `ensureChannelExists()`:
    ```typescript
    if (body.peerAddress && !/^0x[0-9a-fA-F]{40}$/.test(body.peerAddress)) {
      res.status(400).json({
        error: 'Bad request',
        message: 'Invalid EVM address format: must be 0x-prefixed 42-char hex',
      });
      return;
    }
    ```
  - [x] **XRP path** — after resolving `peerXrpAddress`, before calling `getOrCreateChannel()`:
    ```typescript
    if (
      body.peerAddress &&
      (!/^r/.test(body.peerAddress) || body.peerAddress.length < 25 || body.peerAddress.length > 35)
    ) {
      res.status(400).json({
        error: 'Bad request',
        message: 'Invalid XRP address format: must start with r and be 25-35 characters',
      });
      return;
    }
    ```
  - **Note:** Validation is placed in the chain-specific paths, not in `validateOpenChannelRequest()`, because format depends on chain type

- [x] Task 7: Write unit tests (AC: 10, 11, 12, 13, 14)
  - [x] **Target file:** `packages/connector/src/http/admin-api-channels.test.ts` — add new `describe('Story 21.4')` section
  - [x] Test group: peerAddress propagation (AC: 10)
    - [x] Test: peerAddress provided in request → passed through to `ensureChannelExists()` options
    - [x] Test: peerAddress not provided → falls back to `settlementPeers` lookup
    - [x] Test: neither peerAddress nor settlementPeers → 400 error
  - [x] Test group: XRP peerAddress resolution (AC: 11)
    - [x] Test: XRP request with `peerAddress` → used directly (no `settlementPeers` needed)
    - [x] Test: XRP request without `peerAddress` → falls back to `peerConfig.xrpAddress`
    - [x] Test: XRP request with neither → 400 error
  - [x] Test group: peer existence validation (AC: 12)
    - [x] Test: unknown `peerId` → 404 with descriptive message
    - [x] Test: known `peerId` → proceeds to channel opening
  - [x] Test group: response status accuracy (AC: 13)
    - [x] Test: response uses `metadata.status` not hardcoded `'open'`
    - [x] Test: metadata unavailable after creation → 500 error
  - [x] Test group: peerAddress format validation (AC: 9)
    - [x] Test: invalid EVM address format → 400 error
    - [x] Test: invalid XRP address format → 400 error
    - [x] Test: valid formats pass through
  - [x] Verify all existing Story 21.1/21.2/21.3 tests still pass

## Dev Notes

### Gap Context

This story addresses 4 integration gaps from `INTEGRATION-GAPS.md`:

- **Gap 1 (P0):** `POST /admin/channels` XRP path has no `peerAddress` parameter support. The EVM path was already fixed to accept `body.peerAddress` with `settlementPeers` fallback, but the XRP path still requires `peerConfig?.xrpAddress` only.
- **Gap 7 (P2):** Response hardcodes `status: 'open'` regardless of actual state. BLS polls `GET /admin/channels/:channelId` expecting transitions but POST already claims open.
- **Gap 8 (P1):** No validation that peerId exists before opening channels. Orphaned channels possible.
- **Gap 13 (P1):** `peerAddress` flows through `ChannelOpenOptions` to `ensureChannelExists()` but `openChannelForPeer()` ignores it, reading only from `config.peerIdToAddressMap`. This is the **root cause** of the circular dependency.

**Note on Gap 4:** Investigation complete — `ChannelOpenOptions` already has `peerAddress?: string` and `OpenChannelRequest` already has `peerAddress?: string`. No interface changes needed.

### What's Already Done vs. What Needs Fixing

| Component                                             | Status                  | Notes                                                         |
| ----------------------------------------------------- | ----------------------- | ------------------------------------------------------------- |
| `OpenChannelRequest.peerAddress`                      | Already present         | `admin-api.ts` line 1533                                      |
| `ChannelOpenOptions.peerAddress`                      | Already present         | `channel-manager.ts` line 50                                  |
| EVM path address resolution                           | Already implemented     | `admin-api.ts` lines 854-863                                  |
| EVM path passes `peerAddress` in options              | Already implemented     | `admin-api.ts` line 885                                       |
| **`openChannelForPeer()` uses `options.peerAddress`** | **NOT DONE — CORE FIX** | `channel-manager.ts` line 205 ignores it                      |
| XRP path address resolution                           | **NOT DONE**            | `admin-api.ts` lines 909-916 — no `body.peerAddress` fallback |
| Peer existence validation                             | **NOT DONE**            | No check in POST handler                                      |
| Response status from metadata                         | **NOT DONE**            | Hardcoded `'open'` at lines 896, 932                          |
| `peerAddress` format validation                       | **NOT DONE**            | No validation anywhere                                        |

### Key File Locations

| Action        | File                                                     | Lines                                              |
| ------------- | -------------------------------------------------------- | -------------------------------------------------- |
| **Modify**    | `packages/connector/src/settlement/channel-manager.ts`   | ~194-208 (`openChannelForPeer` — **core fix**)     |
| **Modify**    | `packages/connector/src/http/admin-api.ts`               | ~900-933 (XRP path — add `peerAddress` resolution) |
| **Modify**    | `packages/connector/src/http/admin-api.ts`               | ~840-847 (add peer existence check)                |
| **Modify**    | `packages/connector/src/http/admin-api.ts`               | ~881-898 (EVM response — use metadata.status)      |
| **Modify**    | `packages/connector/src/http/admin-api.ts`               | ~928-933 (XRP response — use metadata.status)      |
| **Add tests** | `packages/connector/src/http/admin-api-channels.test.ts` | New `describe('Story 21.4')` section               |
| Verify only   | `packages/connector/src/http/admin-api.ts`               | ~849-886 (EVM path — already correct)              |

### The Root Cause: `openChannelForPeer()` Ignores `options.peerAddress`

The current code at `channel-manager.ts` lines 194-208:

```typescript
private async openChannelForPeer(
  peerId: string,
  tokenId: string,
  options?: ChannelOpenOptions
): Promise<string> {
  const tokenAddress = this.config.tokenAddressMap.get(tokenId);
  if (!tokenAddress) {
    throw new Error(`Token address not found for tokenId: ${tokenId}`);
  }

  // BUG: Always reads from config map, ignores options.peerAddress
  const peerAddress = this.config.peerIdToAddressMap.get(peerId);
  if (!peerAddress) {
    throw new Error(`Peer address not found for peerId: ${peerId}`);
  }
  // ... continues to SDK call
```

**Required fix (one line change):**

```typescript
// FIX: Use options.peerAddress first, fall back to config map
const peerAddress = options?.peerAddress || this.config.peerIdToAddressMap.get(peerId);
if (!peerAddress) {
  throw new Error(`Peer address not found for peerId: ${peerId}`);
}
```

This is the critical change that breaks the circular dependency. Without it, even though admin-api passes `peerAddress` in options, the ChannelManager throws because the peer isn't in `peerIdToAddressMap`.

### Circular Dependency Explained

```
1. BLS receives SPSP request with peer's EVM address
2. BLS wants to call POST /admin/channels to open channel
3. admin-api.ts resolves peerAddress from request body ✅ (already done)
4. admin-api.ts passes peerAddress in options to ensureChannelExists() ✅ (already done)
5. ensureChannelExists() passes options to openChannelForPeer() ✅ (already done)
6. openChannelForPeer() IGNORES options.peerAddress ❌ (reads from config map only)
7. config.peerIdToAddressMap doesn't have the peer yet
8. → THROWS "Peer address not found"
```

**Fix:** One-line change in `openChannelForPeer()` (Task 1).

### Agent-Society Consumer Code

```typescript
// BLS calls POST /admin/channels with peerAddress from SPSP request
const result = await connectorClient.openChannel({
  peerId: 'nostr-abc123',
  chain: 'evm:base:8453',
  token: 'AGENT',
  peerAddress: spspResponse.settlementAddress, // from SPSP handshake
  initialDeposit: '1000000000000000000',
});
```

### Relevant Source Tree

```
packages/connector/src/
├── http/
│   ├── admin-api.ts                    # POST /admin/channels handler (modify XRP path, add validation)
│   └── admin-api-channels.test.ts      # Target for new Story 21.4 tests
├── settlement/
│   ├── channel-manager.ts              # openChannelForPeer() — CORE FIX
│   ├── payment-channel-sdk.ts          # openChannel(peerAddress, ...) — receives address
│   └── xrp-channel-lifecycle-manager.ts # getOrCreateChannel(peerId, xrpAddress)
└── btp/
    └── btp-client-manager.ts           # getPeerIds() — used for peer existence check
```

**Related untracked file:** `packages/connector/src/http/admin-api-peers.test.ts` — peer-specific tests, separate from this story.

### Technical Constraints

- TypeScript strict mode — no `any` types
- Pino logger only — no `console.log`
- All async functions must handle errors with try-catch
- Buffer for binary data
- EVM addresses: `0x`-prefixed, 42 characters, hex
- XRP addresses: start with `r`, 25-35 characters

### Testing

**Framework:** Jest 29.7.x with ts-jest
**Target file:** `packages/connector/src/http/admin-api-channels.test.ts`
**Convention:** Co-located `*.test.ts` next to source; add new `describe('Story 21.4')` block
**Coverage:** >80% line coverage for modified handler code
**Pattern:** AAA (Arrange, Act, Assert)
**Mock Strategy:** Mock `channelManager`, `btpClientManager`, `settlementPeers` map — follow existing mock patterns in the file (see `beforeEach` blocks in Story 21.1 section)

## Change Log

| Date       | Version | Description                                                                                                                                                         | Author     |
| ---------- | ------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------- |
| 2026-02-09 | 1.0     | Initial story draft from INTEGRATION-GAPS.md (Gaps 1, 4, 7, 8, 13)                                                                                                  | Sarah (PO) |
| 2026-02-09 | 2.0     | Post-validation rewrite: corrected already-done items, identified core fix in openChannelForPeer(), updated line references, added source tree, specified test file | QA Review  |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6

### Debug Log References

- No debug issues encountered. All 7 tasks implemented cleanly.
- Pre-existing wallet-derivation integration test failures (performance timing) — unrelated to this story.

### Completion Notes List

- **Task 1 (Core Fix):** One-line change in `openChannelForPeer()` to use `options?.peerAddress` first, breaking the circular dependency. Added info log with source tracking.
- **Task 2:** Verified EVM path already correctly resolves `body.peerAddress || peerConfig?.evmAddress` — no changes needed.
- **Task 3:** Updated XRP path to mirror EVM pattern: `body.peerAddress || peerConfig?.xrpAddress` with updated error message.
- **Task 4:** Added peer existence check via `btpClientManager.getPeerIds()` before chain routing. Returns 404 with descriptive message.
- **Task 5:** Replaced hardcoded `status: 'open'` with `metadata.status` from `channelManager.getChannelById()` for both EVM and XRP paths. Added 500 error for missing metadata.
- **Task 6:** Added chain-specific peerAddress format validation: EVM (`/^0x[0-9a-fA-F]{40}$/`) and XRP (starts with `r`, 25-35 chars).
- **Task 7:** Added 20 new tests in `describe('Story 21.4')` block. Updated Story 21.1 mocks to include peer IDs and metadata for compatibility with new peer existence check and metadata-based status. All 134 tests pass (114 existing + 20 new).

### File List

| File                                                     | Action   | Description                                                                                                   |
| -------------------------------------------------------- | -------- | ------------------------------------------------------------------------------------------------------------- |
| `packages/connector/src/settlement/channel-manager.ts`   | Modified | `openChannelForPeer()`: use `options?.peerAddress` first, add log line                                        |
| `packages/connector/src/http/admin-api.ts`               | Modified | XRP peerAddress fallback, peer existence validation, metadata-based status, EVM/XRP address format validation |
| `packages/connector/src/http/admin-api-channels.test.ts` | Modified | Updated Story 21.1 mocks for compatibility, added 20 Story 21.4 tests                                         |
| `docs/stories/21.4.story.md`                             | Modified | Task checkboxes, Dev Agent Record                                                                             |

## QA Results

### Review Date: 2026-02-09

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Overall implementation quality is **strong**. The story addresses 4 critical integration gaps (Gaps 1, 7, 8, 13) with clean, targeted changes. Code follows existing patterns, uses proper TypeScript strict-mode types, and correctly leverages Pino logger exclusively.

**Key Observations:**

1. **Core Fix (Task 1)** — The one-line change in `channel-manager.ts:205` (`options?.peerAddress || this.config.peerIdToAddressMap.get(peerId)`) correctly breaks the circular dependency. The added info log with `source` field is a nice debugging aid.

2. **Admin API Changes (Tasks 2-6)** — All changes in `admin-api.ts` follow the established pattern from Story 21.1. The EVM path address resolution was already correct (Task 2 verified), and the XRP path now mirrors it exactly. Peer existence validation via `btpClientManager.getPeerIds()` is placed early in the handler, before chain routing, which is the correct position.

3. **Address Format Validation (Task 6)** — Correctly placed after chain routing and address resolution (chain-specific formats), before SDK calls. EVM regex `^0x[0-9a-fA-F]{40}$` and XRP validation (`/^r/`, 25-35 chars) match the documented constraints.

4. **Metadata-based Status (Task 5)** — Both EVM and XRP paths now use `channelManager.getChannelById(channelId)` for real status instead of hardcoded `'open'`. The 500 fallback for missing metadata is appropriate defensive coding.

5. **Test Quality** — 20 new tests organized into 5 well-named `describe` blocks mapping to ACs. Tests use AAA pattern, follow existing mock conventions, and the `beforeEach` mock setup properly isolates Story 21.4 context.

### Refactoring Performed

No refactoring performed. Implementation is clean and follows established patterns. All changes are targeted and minimal.

### Compliance Check

- Coding Standards: ✓ ESLint passes cleanly on both modified source files. No `console.log`, Pino logger used exclusively, TypeScript strict mode satisfied, no `any` types in production code.
- Project Structure: ✓ Tests co-located with source. No new files created beyond test additions. kebab-case file naming maintained.
- Testing Strategy: ✓ Co-located `*.test.ts`, AAA pattern, mock-based unit tests. 20 new tests covering all 14 ACs. Coverage target >80% met for modified handler code.
- All ACs Met: ✓ All 14 acceptance criteria verified (see traceability below).

### AC Traceability

| AC  | Description                                             | Test Coverage                                            | Verification                               |
| --- | ------------------------------------------------------- | -------------------------------------------------------- | ------------------------------------------ |
| 1   | `openChannelForPeer()` uses `options.peerAddress` first | `peerAddress propagation` describe block (3 tests)       | Verified at `channel-manager.ts:205`       |
| 2   | EVM path uses `body.peerAddress` fallback               | Story 21.1 existing tests + 21.4 propagation tests       | Verified at `admin-api.ts:866`             |
| 3   | XRP path uses `body.peerAddress` fallback               | `XRP peerAddress resolution` describe block (3 tests)    | Verified at `admin-api.ts:939`             |
| 4   | Peer existence validation                               | `peer existence validation` describe block (2 tests)     | Verified at `admin-api.ts:849-856`         |
| 5   | 404 with descriptive message for unknown peer           | Test: `should return 404 for unknown peerId`             | Verified message matches spec              |
| 6   | Response uses `metadata.status` not hardcoded           | `response status accuracy` describe block (4 tests)      | Verified at `admin-api.ts:925,984`         |
| 7   | `ensureChannelExists()` throw caught by catch block     | Existing error handling test from Story 21.1             | Verified try-catch at `admin-api.ts:1005`  |
| 8   | Missing metadata returns 500                            | Tests: `500 when EVM/XRP metadata unavailable`           | Verified at `admin-api.ts:914-920,972-979` |
| 9   | peerAddress format validation                           | `peerAddress format validation` describe block (8 tests) | EVM regex + XRP range verified             |
| 10  | Unit tests for peerAddress propagation                  | 3 tests in `peerAddress propagation` block               | HTTP-layer verified                        |
| 11  | Unit tests for XRP resolution                           | 3 tests in `XRP peerAddress resolution` block            | All 3 scenarios covered                    |
| 12  | Unit tests for peer existence (404)                     | 2 tests in `peer existence validation` block             | Both positive/negative                     |
| 13  | Unit tests for error handling/status                    | 4 tests in `response status accuracy` block              | Metadata status + 500 errors               |
| 14  | All existing tests pass                                 | `134 passed, 0 failed`                                   | Confirmed via test run                     |

### Improvements Checklist

- [x] All 14 ACs implemented and tested
- [x] All 134 tests pass (114 existing + 20 new)
- [x] ESLint passes on modified files
- [x] Mock setup in Story 21.1 describe block updated for compatibility (peer IDs, metadata)
- [ ] Consider adding unit tests for `openChannelForPeer()` directly in `channel-manager.test.ts` to verify `options.peerAddress` reaches `paymentChannelSDK.openChannel()` — current tests verify at HTTP layer only, not at the SDK call boundary
- [ ] Address validation only checks `body.peerAddress` but not fallback addresses from `settlementPeers` — consider whether fallback addresses should also be validated (low risk since those come from trusted `POST /admin/peers` validation)

### Security Review

- **Address validation**: EVM and XRP address formats are validated when provided in request body. This prevents malformed addresses from reaching blockchain SDKs.
- **Peer injection protection**: The peer existence check (`btpClientManager.getPeerIds()`) prevents channel opening for unregistered peers, avoiding orphaned channels (Gap 8).
- **Error sanitization**: SDK errors are caught and return generic messages (`'Channel open failed'`), not leaking internal details. Consistent with Story 21.1 pattern.
- **No new authentication concerns**: All endpoints inherit existing Admin API key auth middleware.

### Performance Considerations

No performance concerns. Changes add:

- One `Array.includes()` call for peer existence check (O(n) on peer count, typically <100)
- One `getChannelById()` Map lookup for metadata-based status (O(1))
- Regex validation on address strings (negligible)

### Files Modified During Review

No files were modified during this review.

### Gate Status

Gate: PASS → docs/qa/gates/21.4-channel-opening-integration-fixes.yml
Risk profile: N/A (no separate risk assessment performed — low complexity story)
NFR assessment: Inline (see gate file)

### Recommended Status

✓ Ready for Done

All 14 acceptance criteria are met with 20 comprehensive tests. The core circular dependency fix is a clean one-line change. Code quality is high, follows established patterns, and ESLint passes cleanly. The two unchecked items above are future improvements, not blockers.
