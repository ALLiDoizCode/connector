# Story 21.2: Channel Lifecycle Endpoints (Deposit and Close)

**Epic:** 21 - Payment Channel Admin APIs
**Story Number:** 21.2
**Status:** Done

## Story

**As a** BLS developer,
**I want** to deposit funds into a channel and close channels via the Admin API,
**so that** my BLS can fund channels after opening and gracefully close relationships.

## Acceptance Criteria

1. `POST /admin/channels/:channelId/deposit` adds funds to EVM channel
2. `POST /admin/channels/:channelId/deposit` adds funds to XRP channels
   2a. `POST /admin/channels/:channelId/deposit` returns 501 Not Implemented for Aptos (placeholder — no Aptos SDK deposit wired yet)
3. Deposit amount validated as positive integer string
4. 404 returned for unknown channelId
5. 400 returned if channel is not in `open` state (can't deposit to closed channel)
6. `POST /admin/channels/:channelId/close` attempts cooperative close by default
7. Falls back to unilateral close if cooperative close fails
8. Close returns immediately with `status: "closing"` (settlement may take time)
9. Optional `cooperative: false` forces unilateral close
10. Unit tests for deposit validation, close mode selection
11. Integration test: deposit to EVM channel, close cooperatively, verify settled state

## Dev Notes

### Previous Story Insights (Story 21.1)

- Story 21.1 established the channel CRUD pattern: `POST /admin/channels`, `GET /admin/channels`, `GET /admin/channels/:channelId`
- All channel endpoints are defined inside `createAdminRouter()` function factory in `admin-api.ts`
- `AdminAPIConfig` already has `channelManager`, `paymentChannelSDK`, and `xrpChannelLifecycleManager` wired from `ConnectorNode`
- Graceful degradation pattern: channel endpoints return 503 when `channelManager` is undefined (settlement not enabled)
- 47 unit tests in `admin-api-channels.test.ts` covering CRUD endpoints with mocks for `ChannelManager`, `PaymentChannelSDK`, `XRPChannelLifecycleManager`
- BigInt values must be converted to strings before JSON.stringify (JSON cannot serialize BigInt)
- Error sanitization pattern: log full error with Pino, return generic error message to caller
- `ChannelMetadata` has `status: 'opening' | 'active' | 'closing' | 'settling' | 'closed'` — note that the "open" concept maps to `active` status in ChannelMetadata, while `ChannelState` (on-chain) uses `opened | closed | settled`
- `satisfies` type constraint pattern used on response objects for compile-time contract enforcement
- `settlementPeers` Map is wired from `ConnectorNode` to `AdminServer` and available in `createAdminRouter()`
- QA fix from 21.1: SCHEMA-001 — `ChannelDetailResponse` interface added with `[key: string]: unknown` index signature for flexible response shapes
- Aptos channel operations return 501 Not Implemented (placeholder)

### Data Models

**ChannelMetadata** [Source: packages/connector/src/settlement/channel-manager.ts]:

```typescript
export interface ChannelMetadata {
  channelId: string;
  peerId: string;
  tokenId: string;
  tokenAddress: string;
  chain: string; // e.g., "evm:base:8453"
  createdAt: Date;
  lastActivityAt: Date;
  status: 'opening' | 'active' | 'closing' | 'settling' | 'closed';
}
```

**ChannelState (EVM on-chain)** [Source: packages/shared/src/types/payment-channel.ts]:

```typescript
export type ChannelStatus = 'opened' | 'closed' | 'settled';

export interface ChannelState {
  channelId: string;
  participants: [string, string];
  myDeposit: bigint;
  theirDeposit: bigint;
  myNonce: number;
  theirNonce: number;
  myTransferred: bigint;
  theirTransferred: bigint;
  status: ChannelStatus;
  settlementTimeout: number;
  closedAt?: number;
  openedAt: number;
}
```

**BalanceProof** [Source: packages/shared/src/types/payment-channel.ts]:

```typescript
export interface BalanceProof {
  channelId: string;
  nonce: number;
  transferredAmount: bigint;
  lockedAmount: bigint;
  locksRoot: string;
}
```

**New Request/Response Types (to be created in admin-api.ts):**

```typescript
// POST /admin/channels/:channelId/deposit request body
interface DepositRequest {
  amount: string; // Required: positive integer string
  token?: string; // Optional: ERC20 token address (EVM only)
}

// POST /admin/channels/:channelId/deposit response
// NOTE: status returns "open" as the external API label; internally this maps from ChannelMetadata.status === 'active'
interface DepositResponse {
  channelId: string;
  /**
   * For EVM channels: total cumulative deposit from getChannelState().myDeposit (includes all prior deposits).
   * For XRP channels: the incremental deposited amount only (XRP fundChannel() returns void — cumulative total unavailable).
   * Callers should be aware of this semantic difference when interpreting values across chain types.
   */
  newDeposit: string;
  status: string; // Always "open" — maps from internal 'active' to user-friendly 'open'
}

// POST /admin/channels/:channelId/close request body
interface CloseChannelRequest {
  cooperative?: boolean; // Optional: default true
}

// POST /admin/channels/:channelId/close response
interface CloseChannelResponse {
  channelId: string;
  status: string; // "closing" | "settled"
  txHash?: string;
}
```

### API Specifications

**POST /admin/channels/:channelId/deposit — Add funds to a channel** [Source: docs/prd/epic-21-payment-channel-admin-apis.md#Story 21.2]

```
POST /admin/channels/0xabc123/deposit
X-API-Key: <key>
Content-Type: application/json

{
  "amount": "500000"
}
```

**Deposit chain routing logic:**

- Determine chain type from `ChannelMetadata.chain` prefix (not from request body — the channel already knows its chain)
- `evm:*` → `PaymentChannelSDK.deposit(channelId, tokenAddress, amount)` [Source: packages/connector/src/settlement/payment-channel-sdk.ts:286]
  - SDK internally calls `getChannelState()` to compute `newTotalDeposit = state.myDeposit + amount`
  - SDK handles ERC20 approval if needed
  - SDK calls `tokenNetwork.setTotalDeposit()` on-chain
  - Synchronous: blocks until on-chain confirmation
- `xrp:*` → `XRPChannelLifecycleManager.fundChannel(peerId, additionalAmount)` [Source: packages/connector/src/settlement/xrp-channel-lifecycle.ts:254]
  - Takes `peerId` (not channelId) and `additionalAmount` (string, XRP drops)
- `aptos:*` → Return 501 Not Implemented (same pattern as Story 21.1)

**Success Response (200):**

```json
{
  "channelId": "0xabc123...",
  "newDeposit": "1500000",
  "status": "open"
}
```

**Error Responses:**

- `400` — Invalid amount, channel not in open/active state
- `401` — Invalid/missing API key
- `404` — Unknown channelId
- `500` — On-chain deposit operation failed
- `503` — Settlement infrastructure not enabled

---

**POST /admin/channels/:channelId/close — Initiate channel close** [Source: docs/prd/epic-21-payment-channel-admin-apis.md#Story 21.2]

```
POST /admin/channels/0xabc123/close
X-API-Key: <key>
Content-Type: application/json

{
  "cooperative": true
}
```

**Close logic:**

- Channel must be in `active` or `opening` state (not already `closing`/`closed`/`settling`)
- Default: `cooperative: true` — attempt cooperative close first
- **Cooperative close (EVM):** `PaymentChannelSDK.cooperativeSettle(channelId, tokenAddress, myBalanceProof, mySignature, theirBalanceProof, theirSignature)` [Source: packages/connector/src/settlement/payment-channel-sdk.ts:539]
  - Requires both parties' balance proofs and signatures
  - MVP: use placeholder signatures (same pattern as `ChannelManager.closeIdleChannel()` at channel-manager.ts:367-368)
  - On success: channel goes directly to `settled` status
- **If cooperative fails or `cooperative: false`:** Fall back to unilateral close
  - `PaymentChannelSDK.signBalanceProof()` then `PaymentChannelSDK.closeChannel()` [Source: packages/connector/src/settlement/payment-channel-sdk.ts:498]
  - Channel enters `closing` state (challenge period begins)
  - Channel will be settled after challenge period (existing `ChannelManager.scheduleChallengeSettle()` handles this)
- **XRP close:** `XRPChannelLifecycleManager.closeChannel(peerId, 'manual')` [Source: packages/connector/src/settlement/xrp-channel-lifecycle.ts:294]
- **Aptos close:** Return 501 Not Implemented

**Success Response (200):**

```json
{
  "channelId": "0xabc123...",
  "status": "closing",
  "txHash": "0xdef456..."
}
```

or for cooperative settle:

```json
{
  "channelId": "0xabc123...",
  "status": "settled"
}
```

**Error Responses:**

- `400` — Channel not in closeable state
- `401` — Invalid/missing API key
- `404` — Unknown channelId
- `500` — Close operation failed
- `503` — Settlement infrastructure not enabled

### Component Integration Points

**PaymentChannelSDK** [Source: packages/connector/src/settlement/payment-channel-sdk.ts]:

- `deposit(channelId: string, tokenAddress: string, amount: bigint): Promise<void>` — EVM on-chain deposit (line 286). Handles ERC20 approval and calls `setTotalDeposit()`. Updates internal cache.
- `closeChannel(channelId: string, tokenAddress: string, balanceProof: BalanceProof, signature: string): Promise<void>` — Unilateral close (line 498). Validates channel is in `opened` state.
- `cooperativeSettle(channelId, tokenAddress, myBalanceProof, mySignature, theirBalanceProof, theirSignature): Promise<void>` — Cooperative close (line 539). Validates channel is in `opened` state.
- `signBalanceProof(channelId, nonce, transferredAmount, lockedAmount?, locksRoot?): Promise<string>` — EIP-712 signing (line 361).
- `getChannelState(channelId, tokenAddress): Promise<ChannelState>` — Query on-chain state (used to get current deposit, nonces, etc.).

**ChannelManager** [Source: packages/connector/src/settlement/channel-manager.ts]:

- `getChannelById(channelId): ChannelMetadata | null` — Look up channel metadata by ID (line 162)
- `getChannelForPeer(peerId, tokenId): ChannelMetadata | null` — Look up by peer+token (line 151)
- Status update: Admin API must update `ChannelMetadata.status` to `closing` or `closed` after successful operations. Access metadata via `getChannelById()` and mutate directly (ChannelMetadata is a reference from the internal Map).
- `closeIdleChannel(channelId)` (private) — Reference implementation for cooperative close with fallback to unilateral. At line 331. Shows the balance proof construction and placeholder signature pattern.

**XRPChannelLifecycleManager** [Source: packages/connector/src/settlement/xrp-channel-lifecycle.ts]:

- `fundChannel(peerId: string, additionalAmount: string): Promise<void>` — Add funds to XRP channel (line 254). Takes peerId (not channelId). Throws if peer not found.
- `closeChannel(peerId: string, reason: 'idle' | 'expiration' | 'manual'): Promise<void>` — Close XRP channel (line 294). Takes peerId. Logs warning if not found.
- Note: XRP manager indexes by `peerId`, not `channelId`. Must resolve `peerId` from `ChannelMetadata` when handling XRP deposit/close requests.

### File Locations

| Action        | File Path                                                                | Description                                                                                                                                                                                                                                     |
| ------------- | ------------------------------------------------------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Modify**    | `packages/connector/src/http/admin-api.ts`                               | Add `POST /admin/channels/:channelId/deposit` and `POST /admin/channels/:channelId/close` route handlers, add `DepositRequest`, `DepositResponse`, `CloseChannelRequest`, `CloseChannelResponse` types, add `validateDepositRequest()` function |
| **Modify**    | `packages/connector/src/http/admin-api-channels.test.ts`                 | Add unit tests for deposit and close endpoints                                                                                                                                                                                                  |
| **Modify**    | `packages/connector/test/integration/admin-channels-integration.test.ts` | Extend integration test with deposit and close scenarios                                                                                                                                                                                        |
| **Reference** | `packages/connector/src/settlement/payment-channel-sdk.ts`               | `deposit()`, `closeChannel()`, `cooperativeSettle()`, `signBalanceProof()`, `getChannelState()`                                                                                                                                                 |
| **Reference** | `packages/connector/src/settlement/channel-manager.ts`                   | `getChannelById()`, `closeIdleChannel()` reference pattern, `ChannelMetadata` status updates                                                                                                                                                    |
| **Reference** | `packages/connector/src/settlement/xrp-channel-lifecycle.ts`             | `fundChannel()`, `closeChannel()` — XRP equivalents                                                                                                                                                                                             |
| **Reference** | `packages/connector/src/settlement/types.ts`                             | `isValidNonNegativeIntegerString()` — reuse for deposit amount validation                                                                                                                                                                       |

### Technical Constraints

- **No `any` types**: TypeScript strict mode enforced [Source: docs/architecture/coding-standards.md]
- **Pino logger only**: Never use `console.log` [Source: docs/architecture/coding-standards.md]
- **All async functions must handle errors**: Use try-catch, return proper HTTP error codes [Source: docs/architecture/coding-standards.md]
- **BigInt serialization**: `ChannelState` fields are `bigint` — convert to string before JSON response [Source: Story 21.1 Dev Notes]
- **Error sanitization**: Log full error with Pino, return generic sanitized message to caller — do NOT expose raw SDK/RPC errors [Source: Story 21.1 pattern]
- **Backward compatibility**: All existing Admin API endpoints unaffected, existing channel CRUD endpoints unaffected
- **Optional infrastructure**: If `channelManager` or `paymentChannelSDK` is undefined, endpoints return 503 Service Unavailable
- **Synchronous deposit**: `POST /admin/channels/:channelId/deposit` blocks until on-chain confirmation (same as channel open pattern)
- **Close returns status, not completion**: `POST /admin/channels/:channelId/close` returns immediately with `closing` or `settled` status; unilateral close challenge period is handled asynchronously by existing `ChannelManager.scheduleChallengeSettle()`
- **Channel status mapping**: ChannelMetadata uses `active` (not `open`). The deposit endpoint requires `active` status only (an `opening` channel has no on-chain confirmation yet, so deposits would fail). The close endpoint accepts `active` or `opening`. Both reject `closing`/`settling`/`closed` channels
- **XRP uses peerId, not channelId**: XRP lifecycle manager methods take `peerId` as parameter. Resolve from `ChannelMetadata.peerId` after looking up by channelId.
- **Deposit validation**: Use `isValidNonNegativeIntegerString()` from `settlement/types.ts` but additionally require `amount > 0` (positive, not zero — zero deposit is meaningless). Or: accept the existing non-negative validator and let the on-chain call handle zero amounts.
- **Positive integer string validation**: The epic AC says "positive integer string" for deposit amount. Create a simple check: `isValidNonNegativeIntegerString(amount) && amount !== '0'`

### Testing

**Framework:** Jest 29.7.x with ts-jest [Source: docs/architecture/test-strategy-and-standards.md]

**File Convention:** Co-located `*.test.ts` next to source [Source: docs/architecture/coding-standards.md]

**Unit Test File:** `packages/connector/src/http/admin-api-channels.test.ts` (extend existing file)

**Coverage Requirement:** >80% line coverage for new code [Source: docs/architecture/test-strategy-and-standards.md]

**Test Pattern:** AAA (Arrange, Act, Assert) with descriptive names [Source: docs/architecture/test-strategy-and-standards.md]

**Mock Strategy:**

- Reuse existing mock setup from Story 21.1 tests (mockChannelManager, mockPaymentChannelSDK, mockXrpLifecycleManager)
- Add mock methods: `mockPaymentChannelSDK.deposit`, `mockPaymentChannelSDK.closeChannel`, `mockPaymentChannelSDK.cooperativeSettle`, `mockPaymentChannelSDK.signBalanceProof`
- Add mock methods: `mockXrpLifecycleManager.fundChannel`, `mockXrpLifecycleManager.closeChannel`
- Use `supertest` for HTTP-level tests against the Express router
- Create fresh mock instances in `beforeEach()` [Source: docs/architecture/test-strategy-and-standards.md, Anti-Pattern 3]
- Clean up in `afterEach()` [Source: docs/architecture/test-strategy-and-standards.md, Anti-Pattern 5]

**Integration Test File:** `packages/connector/test/integration/admin-channels-integration.test.ts` (extend existing)

- Requires `docker-compose-dev.yml` with Anvil at `http://localhost:8545`
- Use `describeIfInfra` pattern [Source: existing file line 44 — `const describeIfInfra = process.env.E2E_TESTS === 'true' ? describe : describe.skip;`]
- Test: Open channel → deposit → verify increased balance via GET → close → verify settled/closing state

## Tasks / Subtasks

### 1. Add Deposit and Close Request/Response Types (AC: 3)

- [x] In `packages/connector/src/http/admin-api.ts`:
  - [x] Add `DepositRequest` interface: `{ amount: string, token?: string }`
  - [x] Add `DepositResponse` interface: `{ channelId: string, newDeposit: string, status: string }`
  - [x] Add `CloseChannelRequest` interface: `{ cooperative?: boolean }`
  - [x] Add `CloseChannelResponse` interface: `{ channelId: string, status: string, txHash?: string }`
  - [x] Add `validateDepositRequest(body: Record<string, unknown>): { valid: boolean; error?: string }` function
    - [x] Validate `amount` is present, is a string, passes `isValidNonNegativeIntegerString()`, and is not `'0'` (must be positive)
  - [x] Add `returnNotImplemented(res: Response, chain: string, operation: string): void` helper function
    - [x] Returns `res.status(501).json({ error: 'Not Implemented', message: \`\${operation} not yet implemented for ${chain}\` })`
    - [x] Reuse in deposit (Task 2) and close (Task 3) Aptos branches, replacing inline 501 patterns
    - [x] Matches existing Story 21.1 Aptos 501 response shape: `{ error: 'Not Implemented', message: string }` [Source: admin-api.ts:807-810]

### 2. Implement POST /admin/channels/:channelId/deposit (AC: 1, 2, 3, 4, 5)

- [x] Add `router.post('/channels/:channelId/deposit', ...)` handler in `createAdminRouter()`:
  - [x] Check `channelManager` available, return 503 if not
  - [x] Look up channel: `channelManager.getChannelById(channelId)` — return 404 if not found
  - [x] Validate request body using `validateDepositRequest()`
  - [x] Check channel status: must be `active` — return 400 with `"Channel is not in open state"` if status is `closing`, `settling`, or `closed`
  - [x] Parse chain prefix from `metadata.chain`
  - [x] Route by chain type:
    - [x] `evm` → Check `paymentChannelSDK` available (503 if not). Call `paymentChannelSDK.deposit(channelId, metadata.tokenAddress, BigInt(amount))`. After success, query updated state with `paymentChannelSDK.getChannelState(channelId, metadata.tokenAddress)` to get `newDeposit = state.myDeposit.toString()`. Return 200 with `{ channelId, newDeposit, status: "open" }`.
    - [x] `xrp` → Check `xrpChannelLifecycleManager` available (503 if not). Call `xrpChannelLifecycleManager.fundChannel(metadata.peerId, amount)`. Return 200 with `{ channelId, newDeposit: amount, status: "open" }` (XRP `fundChannel()` returns void — total deposit unavailable, so return the deposited amount as best-effort).
    - [x] `aptos` → Call `returnNotImplemented(res, 'aptos', 'Channel deposit')`
  - [x] Update `metadata.lastActivityAt = new Date()` after successful deposit
  - [x] Log with Pino: `logger.info({ channelId, chain, amount }, 'Deposit completed via Admin API')`
  - [x] On failure: catch errors, log full error, return 500 with sanitized message `{ error: "Internal error", message: "Deposit failed" }`

### 3. Implement POST /admin/channels/:channelId/close (AC: 6, 7, 8, 9)

- [x] Add `router.post('/channels/:channelId/close', ...)` handler in `createAdminRouter()`:
  - [x] Check `channelManager` available, return 503 if not
  - [x] Look up channel: `channelManager.getChannelById(channelId)` — return 404 if not found
  - [x] Check channel status: must be `active` or `opening` — return 400 with `"Channel is not in a closeable state"` if status is `closing`, `settling`, or `closed`
  - [x] Parse `cooperative` from request body (default: `true`)
  - [x] Parse chain prefix from `metadata.chain`
  - [x] Route by chain type:
    - [x] `evm` → Check `paymentChannelSDK` available (503 if not).
      - [x] **If cooperative (default):** Attempt cooperative close first:
        - [x] Get channel state: `paymentChannelSDK.getChannelState(channelId, metadata.tokenAddress)`
        - [x] Build balance proofs (same pattern as `ChannelManager.closeIdleChannel` at channel-manager.ts:349-363):
          ```typescript
          const myBalanceProof = {
            channelId,
            nonce: state.myNonce + 1,
            transferredAmount: state.myTransferred,
            lockedAmount: 0n,
            locksRoot: '0x' + '0'.repeat(64),
          };
          const theirBalanceProof = {
            channelId,
            nonce: state.theirNonce,
            transferredAmount: state.theirTransferred,
            lockedAmount: 0n,
            locksRoot: '0x' + '0'.repeat(64),
          };
          ```
        - [x] Use placeholder signatures: `'0x' + '0'.repeat(130)` (same as channel-manager.ts:367-368)
        - [x] Call `paymentChannelSDK.cooperativeSettle(channelId, metadata.tokenAddress, myBalanceProof, mySignature, theirBalanceProof, theirSignature)`
        - [x] On success: update `metadata.status = 'closed'`, return `{ channelId, status: "settled" }`
        - [x] On failure: log warning, fall back to unilateral close (AC: 7)
      - [x] **Unilateral close** (fallback or `cooperative: false`):
        - [x] Get channel state: `paymentChannelSDK.getChannelState(channelId, metadata.tokenAddress)`
        - [x] Sign balance proof: `paymentChannelSDK.signBalanceProof(channelId, state.myNonce + 1, state.myTransferred, 0n, '0x' + '0'.repeat(64))`
        - [x] Build balance proof object
        - [x] Call `paymentChannelSDK.closeChannel(channelId, metadata.tokenAddress, balanceProof, signature)`
        - [x] Update `metadata.status = 'closing'`
        - [x] Return `{ channelId, status: "closing" }`
    - [x] `xrp` → Check `xrpChannelLifecycleManager` available (503 if not). Call `xrpChannelLifecycleManager.closeChannel(metadata.peerId, 'manual')`. Update `metadata.status = 'closing'`. Return `{ channelId, status: "closing" }`.
    - [x] `aptos` → Call `returnNotImplemented(res, 'aptos', 'Channel close')`
  - [x] Log with Pino: `logger.info({ channelId, chain, cooperative }, 'Channel close initiated via Admin API')`
  - [x] On failure: catch errors, log full error, return 500 with sanitized message `{ error: "Internal error", message: "Channel close failed" }`

### 4. Write Unit Tests (AC: 10)

- [x] Extend `packages/connector/src/http/admin-api-channels.test.ts`:
- [x] **Deposit Validation tests (AC: 3, 4, 5):**
  - [x] Valid EVM deposit → 200, newDeposit returned
  - [x] Missing amount → 400
  - [x] Invalid amount (non-numeric) → 400
  - [x] Zero amount → 400
  - [x] Negative amount → 400
  - [x] Unknown channelId → 404
  - [x] Channel in `opening` state → 400 (no on-chain channel yet)
  - [x] Channel in `closing` state → 400
  - [x] Channel in `closed` state → 400
  - [x] Settlement disabled (no channelManager) → 503
- [x] **EVM Deposit routing tests (AC: 1):**
  - [x] EVM deposit calls `paymentChannelSDK.deposit()` with correct args
  - [x] Returns newDeposit from `getChannelState()` after deposit
- [x] **XRP Deposit routing tests (AC: 2):**
  - [x] XRP deposit calls `xrpChannelLifecycleManager.fundChannel()` with peerId and amount
  - [x] XRP deposit returns deposited amount as `newDeposit` (not total)
  - [x] XRP lifecycle manager unavailable → 503
- [x] **Aptos Deposit tests (AC: 2a):**
  - [x] Aptos channel deposit → 501 Not Implemented
- [x] **Close Mode Selection tests (AC: 6, 7, 8, 9):**
  - [x] Default close (no body) → attempts cooperative close first
  - [x] `cooperative: true` → attempts cooperative close
  - [x] `cooperative: false` → skips cooperative, goes straight to unilateral close
  - [x] Cooperative close success → returns `status: "settled"`
  - [x] Cooperative close failure → falls back to unilateral, returns `status: "closing"`
  - [x] Unilateral close → calls `signBalanceProof()` then `closeChannel()`
  - [x] Unknown channelId → 404
  - [x] Channel in `closed` state → 400
  - [x] Settlement disabled → 503
- [x] **XRP Close tests:**
  - [x] XRP close calls `xrpChannelLifecycleManager.closeChannel(peerId, 'manual')`
- [x] **Aptos Close tests:**
  - [x] Aptos channel close → 501 Not Implemented
- [x] **Auth tests:**
  - [x] Deposit endpoint requires API key when configured
  - [x] Close endpoint requires API key when configured
- [x] Use fresh mock instances in `beforeEach()` [Source: docs/architecture/test-strategy-and-standards.md]
- [x] Clean up in `afterEach()` [Source: docs/architecture/test-strategy-and-standards.md]
- [x] Follow AAA pattern with descriptive test names

### 5. Extend Integration Test (AC: 11)

- [x] Extend `packages/connector/test/integration/admin-channels-integration.test.ts`:
  - [x] Reuse existing `beforeAll()` setup (Anvil, contracts, SDK, router)
  - [x] Test: Deposit to existing EVM channel via `POST /admin/channels/:channelId/deposit` → verify 200 response
  - [x] Test: Verify increased deposit via `GET /admin/channels/:channelId` → compare deposit before/after
  - [x] Test: Close channel via `POST /admin/channels/:channelId/close` → verify response has `status: "closing"` or `status: "settled"`
  - [x] Test: Verify channel state via `GET /admin/channels/:channelId` → verify on-chain status reflects closure

### 6. Verify No Regressions

- [x] Run full connector test suite: `cd packages/connector && npm test`
- [x] Verify existing `admin-api-channels.test.ts` Story 21.1 tests (47 tests) still pass
- [x] Verify existing `admin-api-settlement.test.ts` (57 tests) still pass
- [x] Verify existing `unified-settlement-executor.test.ts` (49 tests) still pass
- [x] TypeScript compiles clean: `npx tsc --noEmit`
- [x] ESLint passes: `npx eslint packages/connector/src/http/admin-api.ts`
- [x] Prettier passes: `npx prettier --check packages/connector/src/http/admin-api.ts`

## Project Structure Notes

- All changes are within the **connector** package (`packages/connector/`)
- No cross-package dependencies needed
- New deposit/close endpoints are additive — no existing routes modified
- Deposit delegates to existing `PaymentChannelSDK.deposit()` — no new blockchain logic
- Close follows the same cooperative-with-unilateral-fallback pattern already used by `ChannelManager.closeIdleChannel()` (lines 331-396 of channel-manager.ts) — the Admin API endpoint surfaces this existing internal logic via HTTP
- XRP operations use `peerId` (resolved from `ChannelMetadata`) — not `channelId` directly

### Edge Cases

- **Deposit to closed channel:** Must check `ChannelMetadata.status` before calling SDK. SDK also validates (`deposit` requires channel in `opened` state), but checking metadata first gives a better 400 error message.
- **Concurrent deposits:** `PaymentChannelSDK.deposit()` computes `newTotalDeposit = state.myDeposit + amount` — two concurrent deposits will both query the same `myDeposit` and may conflict on-chain. This is acceptable for an internal Admin API with low concurrency. The on-chain contract handles the nonce correctly.
- **Close already-closing channel:** If `metadata.status` is already `closing`, return 400. Don't attempt double-close.
- **Cooperative close with placeholder signatures:** MVP cooperative close uses `'0x' + '0'.repeat(130)` placeholder signatures (same as `ChannelManager.closeIdleChannel`). This may fail on real contracts requiring valid signatures — in that case, the fallback to unilateral close (AC: 7) handles it gracefully.
- **XRP deposit returns deposited amount as newDeposit:** `XRPChannelLifecycleManager.fundChannel()` returns void so the new total deposit is unavailable. Return the deposited `amount` value as `newDeposit` (best-effort — caller knows it's the incremental amount, not the total).
- **Aptos channels:** Return 501 Not Implemented for both deposit and close (consistent with Story 21.1). Uses shared `returnNotImplemented(res, chain, operation)` helper (Task 1) to eliminate duplicated 501 response logic across deposit/close endpoints and future Aptos operations.
- **Deposit has no `txHash` in response:** `PaymentChannelSDK.deposit()` returns `void`, so the on-chain transaction hash is not surfaced. This is acceptable for MVP; a future enhancement could return the txHash by modifying the SDK return type.
- **Deposit during in-flight close race:** If a cooperative close is in-flight (metadata already set to `closing`) and a concurrent deposit arrives, the metadata status check rejects it with 400. This is correct behavior — no special handling needed.

## Change Log

| Date       | Version | Description                                                                                                                                                                                                                                                                              | Author                       |
| ---------- | ------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------- |
| 2026-02-08 | 1.0     | Initial story draft created from Epic 21                                                                                                                                                                                                                                                 | Claude Opus 4.6 (SM)         |
| 2026-02-08 | 1.1     | QA validation fixes: clarify active→open status mapping in DepositResponse, resolve deposit status contradiction (active only, not opening), replace XRP "unknown" newDeposit with deposited amount, add opening status rejection test, document txHash absence and close-race edge case | Claude Opus 4.6 (QA)         |
| 2026-02-08 | 1.2     | Story validation fixes: clarify AC #2 Aptos is 501 placeholder, add JSDoc for newDeposit EVM/XRP semantic difference, add ESLint/Prettier checks to regression task, verify 47-test count on Story 21.1 tests                                                                            | Claude Opus 4.6 (Validation) |
| 2026-02-08 | 1.3     | Nice-to-have fixes: split AC #2 into 2/2a for XRP vs Aptos clarity, add `returnNotImplemented()` helper as explicit subtask in Task 1 (referenced by Tasks 2 & 3), add `describeIfInfra` source location in integration test notes, add Aptos 501 unit tests for deposit and close       | Claude Opus 4.6 (Validation) |
| 2026-02-08 | 2.0     | Implementation complete: deposit/close endpoints, 41 new unit tests (88 total), integration tests extended                                                                                                                                                                               | Claude Opus 4.6 (Dev)        |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6

### Completion Notes

- All 6 tasks completed successfully
- 41 new unit tests added (88 total in admin-api-channels.test.ts)
- 2 new integration tests added for deposit and close flows
- `returnNotImplemented()` helper also refactored existing Story 21.1 Aptos 501 response
- TypeScript compiles clean, ESLint clean on source files, Prettier formatted
- Pre-existing ESLint `no-explicit-any` warnings in test mock logger (line 82, 870) — inherited from Story 21.1 pattern, not introduced by this story
- Existing test suites unaffected: admin-api-settlement (57 tests), unified-settlement-executor (49 tests)

### File List

| Action       | File Path                                                                |
| ------------ | ------------------------------------------------------------------------ |
| **Modified** | `packages/connector/src/http/admin-api.ts`                               |
| **Modified** | `packages/connector/src/http/admin-api-channels.test.ts`                 |
| **Modified** | `packages/connector/test/integration/admin-channels-integration.test.ts` |
| **Modified** | `docs/stories/21.2.story.md`                                             |

### Debug Log References

None — no blocking issues encountered.

## QA Results

### Review Date: 2026-02-08

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Strong implementation.** The deposit and close endpoints follow established patterns from Story 21.1 closely and correctly. The cooperative-close-with-unilateral-fallback logic mirrors the reference implementation in `ChannelManager.closeIdleChannel()` (channel-manager.ts:331–396) with high fidelity. Code is well-structured, properly typed, and uses the `satisfies` pattern for compile-time response shape enforcement. Error sanitization is consistently applied — raw SDK/RPC errors are logged via Pino but never leaked to callers.

Key strengths:

- Chain routing (EVM/XRP/Aptos) is clean and consistent across both endpoints
- `validateDepositRequest()` is exported and unit-tested independently (good separation)
- `returnNotImplemented()` helper correctly DRYs the Aptos 501 pattern, also refactored existing Story 21.1 usage
- Balance proof construction uses identical pattern to `closeIdleChannel` reference — nonce increment, zero locked amount, null locks root, placeholder signatures
- Metadata mutation (status, lastActivityAt) correctly performed after SDK success and before response

### Refactoring Performed

None required — implementation is clean and follows established patterns.

### Compliance Check

- Coding Standards: ✓ — No `any` types in source (pre-existing `as any` in test mock logger from Story 21.1, annotated with eslint-disable), Pino logger used throughout, proper async error handling with try-catch
- Project Structure: ✓ — All changes within `packages/connector/`, test co-located with source, integration test in `test/integration/`
- Testing Strategy: ✓ — AAA pattern, fresh mocks in `beforeEach()`, cleanup in `afterEach()`, `supertest` for HTTP-level testing, descriptive test names
- All ACs Met: ✓ — See trace below

### AC Traceability

| AC  | Description                                             | Validating Tests                                                                                                              | Status |
| --- | ------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------- | ------ |
| 1   | EVM deposit calls `paymentChannelSDK.deposit()`         | "should call paymentChannelSDK.deposit() with correct args", "should return newDeposit from getChannelState after deposit"    | ✓      |
| 2   | XRP deposit calls `fundChannel()`                       | "should call xrpChannelLifecycleManager.fundChannel() with peerId and amount", "should return deposited amount as newDeposit" | ✓      |
| 2a  | Aptos deposit → 501                                     | "should return 501 Not Implemented for Aptos channel deposit"                                                                 | ✓      |
| 3   | Deposit amount validated as positive integer string     | `validateDepositRequest` unit tests (6), HTTP-level tests for missing/invalid/zero/negative amount                            | ✓      |
| 4   | 404 for unknown channelId                               | "should return 404 for unknown channelId" (both deposit and close)                                                            | ✓      |
| 5   | 400 if channel not in open state                        | Tests for opening, closing, closed states → 400                                                                               | ✓      |
| 6   | Default cooperative close                               | "should attempt cooperative close by default (no body)", "cooperative: true"                                                  | ✓      |
| 7   | Falls back to unilateral if cooperative fails           | "should fall back to unilateral close when cooperative fails"                                                                 | ✓      |
| 8   | Close returns immediately with "closing" status         | "should return status closing", unilateral close tests                                                                        | ✓      |
| 9   | `cooperative: false` forces unilateral                  | "should skip cooperative and use unilateral when cooperative: false"                                                          | ✓      |
| 10  | Unit tests for deposit validation, close mode selection | 42 new tests in Story 21.2 describe block                                                                                     | ✓      |
| 11  | Integration test: deposit, close, verify                | 2 integration tests (deposit-verify, close-verify)                                                                            | ✓      |

### Improvements Checklist

- [x] All 11 ACs have corresponding test coverage
- [x] Error sanitization applied consistently (no raw errors in responses)
- [x] BigInt serialization handled via `.toString()`
- [x] `returnNotImplemented()` helper reduces duplication
- [x] Metadata status mutation follows reference pattern
- [ ] Consider adding a test for `settling` status rejection on deposit endpoint (currently tests `opening`, `closing`, `closed` but not `settling`)
- [ ] Consider adding EVM SDK unavailable (503) test for close endpoint (only tested for deposit path)
- [ ] XRP close error scenario not tested (e.g., `xrpChannelLifecycleManager.closeChannel` throws) — low risk since error is caught by outer try-catch
- [ ] Integration tests use conditional assertions (`if (res.status === 201)`) which silently skip validation when contracts aren't deployed — acceptable for infra-gated tests but worth noting

### Security Review

No security concerns found. The endpoints:

- Respect API key middleware when configured (tested for both deposit and close)
- Sanitize all error messages before returning to caller
- Are documented as internal-only (Docker Compose network access)
- No user-controlled data used in `BigInt()` construction without prior validation via `isValidNonNegativeIntegerString()`

### Performance Considerations

No performance issues. Deposit is synchronous (blocks on chain confirmation), which is the documented design. Close returns immediately for unilateral path. No N+1 query patterns introduced.

### Files Modified During Review

None — no refactoring was performed.

### Gate Status

Gate: PASS → docs/qa/gates/21.2-channel-lifecycle-endpoints.yml

### Recommended Status

✓ Ready for Done — All acceptance criteria met, 88 tests passing (42 new for Story 21.2), TypeScript/ESLint/Prettier clean. The unchecked items above are minor improvements that can be addressed in a follow-up story.
(Story owner decides final status)

### Change Log

- Added `DepositRequest`, `DepositResponse`, `CloseChannelRequest`, `CloseChannelResponse` interfaces
- Added `validateDepositRequest()` exported function
- Added `returnNotImplemented()` private helper (also refactored existing Aptos 501 in POST /admin/channels)
- Added `POST /admin/channels/:channelId/deposit` endpoint (EVM, XRP, Aptos 501)
- Added `POST /admin/channels/:channelId/close` endpoint (EVM cooperative+unilateral, XRP, Aptos 501)
- Extended unit tests with 41 new tests covering deposit validation, chain routing, close mode selection, auth
- Extended integration tests with deposit-verify and close-verify scenarios
