<!-- Powered by BMAD™ Core -->

# Story 13.6: Agent Node Orchestrator

## Status

Done

## Story

**As a** connector operator,
**I want** an AgentNode that extends ConnectorNode with Nostr event handling capabilities,
**So that** agents can process TOON-encoded Nostr events received in ILP packets, dispatch them to handlers, and push matching events to subscribers.

## Acceptance Criteria

1. AgentNode initializes event database on startup
2. Detects TOON events in incoming ILP packets
3. Routes to AgentEventHandler
4. Emits agent-specific telemetry events
5. Graceful shutdown with database close

## Tasks / Subtasks

- [x] Task 1: Create AgentNode Class File and Configuration (AC: 1, 5)
  - [x] Create file: `packages/connector/src/agent/agent-node.ts`
  - [x] Define `AgentNodeConfig` interface extending necessary agent settings:

    ```typescript
    interface AgentNodeConfig {
      // Agent identity
      agentPubkey: string; // This agent's Nostr public key (hex)
      agentPrivkey?: string; // Optional: Private key for signing (for signing responses)

      // Database configuration
      databasePath: string; // libSQL database path (e.g., './data/events.db' or ':memory:')
      databaseMaxSize?: number; // Max database size in bytes (default: 100MB)

      // Pricing configuration
      pricing: {
        noteStorage: bigint; // Kind 1 cost
        followUpdate: bigint; // Kind 3 cost
        deletion: bigint; // Kind 5 cost
        queryBase: bigint; // Kind 10000 base cost
        queryPerResult?: bigint; // Optional per-result cost
      };

      // Handler configuration
      enableBuiltInHandlers?: boolean; // Default: true - register built-in handlers

      // Subscription settings
      maxSubscriptionsPerPeer?: number; // Default: 10
    }
    ```

  - [x] Import required dependencies from agent module and core
  - [x] [Source: docs/prd/epic-13-agent-society-protocol.md lines 302-312, docs/architecture/agent-society-protocol.md lines 239-262]

- [x] Task 2: Implement AgentNode Core Structure (AC: 1)
  - [x] Create `AgentNode` class with private members:
    ```typescript
    class AgentNode {
      private readonly _agentConfig: AgentNodeConfig;
      private readonly _logger: Logger;
      private readonly _database: AgentEventDatabase;
      private readonly _eventHandler: AgentEventHandler;
      private readonly _subscriptionManager: SubscriptionManager;
      private readonly _followGraphRouter: FollowGraphRouter;
      private readonly _toonCodec: ToonCodec;
      private _initialized: boolean = false;
    }
    ```
  - [x] Implement constructor that validates config and creates component instances:
    - Create AgentEventDatabase with config.databasePath and config.databaseMaxSize
    - Create SubscriptionManager with maxSubscriptionsPerPeer from config
    - Create FollowGraphRouter
    - Create AgentEventHandler with agentPubkey and database
    - Create ToonCodec instance
  - [x] Store logger with component child logger
  - [x] [Source: docs/architecture/agent-society-protocol.md lines 46-82, Story 13.5 patterns]

- [x] Task 3: Implement Database Initialization on Startup (AC: 1)
  - [x] Implement `async initialize(): Promise<void>` method:

    ```typescript
    async initialize(): Promise<void> {
      if (this._initialized) {
        this._logger.warn('AgentNode already initialized');
        return;
      }

      // Initialize event database (creates schema)
      await this._database.initialize();

      // Register built-in handlers if enabled
      if (this._agentConfig.enableBuiltInHandlers !== false) {
        registerBuiltInHandlers(this._eventHandler, {
          followGraphRouter: this._followGraphRouter,
          pricing: this._agentConfig.pricing,
          logger: this._logger,
        });
      }

      this._initialized = true;
      this._logger.info('AgentNode initialized');
    }
    ```

  - [x] Validate database is initialized before processing events
  - [x] [Source: docs/stories/13.2.story.md - AgentEventDatabase.initialize(), docs/stories/13.5.story.md - registerBuiltInHandlers]

- [x] Task 4: Implement TOON Event Detection in ILP Packets (AC: 2)
  - [x] Implement `isToonEvent(data: Buffer): boolean` method:
    - Attempt to decode the buffer as TOON
    - Return true if decoding succeeds and result is valid NostrEvent
    - Return false on decode error (indicates non-TOON data)
    - Catch ToonDecodeError and ValidationError gracefully
  - [x] Use ToonCodec.decode() for single events
  - [x] Consider buffer size heuristics for performance (skip obviously non-TOON data)
  - [x] [Source: docs/stories/13.1.story.md - ToonCodec patterns, docs/architecture/agent-society-protocol.md line 62-63]

- [x] Task 5: Implement Event Processing Entry Point (AC: 2, 3)
  - [x] Implement `async processIncomingPacket(packet: ILPPreparePacket, source: string): Promise<ILPFulfillPacket | ILPRejectPacket>` method:

    ```typescript
    async processIncomingPacket(
      packet: ILPPreparePacket,
      source: string
    ): Promise<ILPFulfillPacket | ILPRejectPacket> {
      // Check if initialized
      if (!this._initialized) {
        return this._createReject('T00', 'Agent not initialized', packet.destination);
      }

      // Detect if packet contains TOON event
      if (!this.isToonEvent(packet.data)) {
        // Not a TOON event - could be passed to parent connector handler
        return this._createReject('F01', 'Invalid packet data', packet.destination);
      }

      // Decode TOON event
      const event = this._toonCodec.decode(packet.data);

      // Build handler context
      const context: EventHandlerContext = {
        event,
        packet,
        amount: packet.amount,
        source,
        agentPubkey: this._agentConfig.agentPubkey,
        database: this._database,
      };

      // Route to event handler
      try {
        const result = await this._eventHandler.handleEvent(context);
        return this._createResponsePacket(result, packet);
      } catch (error) {
        if (error instanceof InsufficientPaymentError) {
          return this._eventHandler.createPaymentReject(
            error,
            packet.destination as ILPAddress
          );
        }
        throw error;
      }
    }
    ```

  - [x] [Source: docs/stories/13.3.story.md - EventHandlerContext, InsufficientPaymentError patterns]

- [x] Task 6: Implement Subscription Push for Note Handler (AC: 3)
  - [x] After successful Note handler (Kind 1), push to matching subscriptions:
    ```typescript
    // In processIncomingPacket, after handler returns success for Kind 1:
    if (result.success && event.kind === 1) {
      const matchingSubs = this._subscriptionManager.getMatchingSubscriptions(event);
      for (const sub of matchingSubs) {
        // Note: Actual BTP push will be implemented in integration
        // For now, log the subscription match
        this._logger.debug({ peerId: sub.peerId, subId: sub.id }, 'Event matches subscription');
      }
    }
    ```
  - [x] Return subscription matches in result for caller to handle BTP push
  - [x] [Source: docs/stories/13.5.story.md lines 376-393 - Subscription Push Flow]

- [x] Task 7: Implement Response Packet Creation (AC: 3)
  - [x] Implement `_createResponsePacket(result: EventHandlerResult, originalPacket: ILPPreparePacket): ILPFulfillPacket | ILPRejectPacket`:
    - If result.success:
      - Create ILPFulfillPacket with fulfillment (may need pre-image handling)
      - Encode responseEvent/responseEvents as TOON in data field
    - If !result.success:
      - Map result.error.code to ILP error code
      - Create ILPRejectPacket with appropriate error
  - [x] Handle cases:
    - No response events → empty data
    - Single responseEvent → ToonCodec.encode()
    - Multiple responseEvents → ToonCodec.encodeMany()
  - [x] [Source: docs/architecture/agent-society-protocol.md lines 103-134 - Response packets]

- [x] Task 8: Implement Reject Packet Helper (AC: 3)
  - [x] Implement `_createReject(code: string, message: string, triggeredBy: string): ILPRejectPacket`:
    ```typescript
    private _createReject(
      code: string,
      message: string,
      triggeredBy: string
    ): ILPRejectPacket {
      return {
        type: PacketType.REJECT,
        code: this._mapErrorCode(code),
        triggeredBy: triggeredBy as ILPAddress,
        message,
        data: Buffer.alloc(0),
      };
    }
    ```
  - [x] Implement `_mapErrorCode(code: string): ILPErrorCode` to map string codes to ILPErrorCode enum
  - [x] [Source: docs/architecture/agent-society-protocol.md lines 196-205 - Error codes]

- [x] Task 9: Implement Agent-Specific Telemetry (AC: 4)
  - [x] Define agent telemetry event types:
    ```typescript
    interface AgentTelemetryEvent {
      type: 'AGENT_EVENT_RECEIVED' | 'AGENT_EVENT_HANDLED' | 'AGENT_SUBSCRIPTION_PUSH';
      timestamp: string;
      agentPubkey: string;
      eventKind?: number;
      eventId?: string;
      success?: boolean;
      errorCode?: string;
      subscriptionCount?: number;
    }
    ```
  - [x] Emit telemetry at key points:
    - AGENT_EVENT_RECEIVED: When TOON event detected in packet
    - AGENT_EVENT_HANDLED: After handler completes (success or failure)
    - AGENT_SUBSCRIPTION_PUSH: When pushing event to subscribers
  - [x] Use non-blocking telemetry emission (try-catch around emit)
  - [x] [Source: docs/architecture/coding-standards.md line 27 - telemetry non-blocking]

- [x] Task 10: Implement Graceful Shutdown (AC: 5)
  - [x] Implement `async shutdown(): Promise<void>` method:

    ```typescript
    async shutdown(): Promise<void> {
      this._logger.info('AgentNode shutting down...');

      // Close database connection
      await this._database.close();

      // Clear subscription manager state
      // (In-memory subscriptions are lost on shutdown - acceptable for MVP)

      this._initialized = false;
      this._logger.info('AgentNode shutdown complete');
    }
    ```

  - [x] Ensure database writes complete before close
  - [x] Log shutdown progress
  - [x] [Source: docs/prd/epic-13-agent-society-protocol.md line 312 - graceful shutdown]

- [x] Task 11: Expose Component Accessors (AC: 1-5)
  - [x] Add getter methods for component access:
    ```typescript
    get database(): AgentEventDatabase { return this._database; }
    get eventHandler(): AgentEventHandler { return this._eventHandler; }
    get subscriptionManager(): SubscriptionManager { return this._subscriptionManager; }
    get followGraphRouter(): FollowGraphRouter { return this._followGraphRouter; }
    get isInitialized(): boolean { return this._initialized; }
    get agentPubkey(): string { return this._agentConfig.agentPubkey; }
    ```
  - [x] These allow external code to register custom handlers or manage subscriptions
  - [x] [Source: docs/architecture/agent-society-protocol.md lines 264-274 - integration patterns]

- [x] Task 12: Create Unit Tests for AgentNode Initialization (AC: 1)
  - [x] Create file: `packages/connector/src/agent/agent-node.test.ts`
  - [x] Test initialization:
    - Creates all components (database, handler, subscription manager, router)
    - Calls database.initialize()
    - Registers built-in handlers when enableBuiltInHandlers=true
    - Skips built-in handlers when enableBuiltInHandlers=false
    - Handles double initialization gracefully
  - [x] [Source: docs/architecture/test-strategy-and-standards.md lines 18-60]

- [x] Task 13: Create Unit Tests for TOON Event Detection (AC: 2)
  - [x] Test isToonEvent method:
    - Returns true for valid TOON-encoded NostrEvent
    - Returns false for random binary data
    - Returns false for JSON (non-TOON) data
    - Returns false for empty buffer
    - Handles decode errors gracefully
  - [x] [Source: docs/architecture/test-strategy-and-standards.md - edge case coverage]

- [x] Task 14: Create Unit Tests for Event Processing (AC: 2, 3, 4)
  - [x] Test processIncomingPacket:
    - Routes Kind 1 event to note handler
    - Routes Kind 3 event to follow handler
    - Routes Kind 5 event to delete handler
    - Routes Kind 10000 event to query handler
    - Returns F03 reject for insufficient payment
    - Returns F99 reject for unsupported event kind
    - Returns T00 reject when not initialized
    - Returns F01 reject for non-TOON data
    - Encodes response events as TOON in fulfill packet
  - [x] Test telemetry emission (AC: 4):
    - Emits AGENT_EVENT_RECEIVED when TOON event detected
    - Emits AGENT_EVENT_HANDLED after handler completes (success case)
    - Emits AGENT_EVENT_HANDLED after handler completes (failure case)
    - Telemetry includes correct eventKind and eventId
    - Telemetry emission failure does not block packet processing (non-blocking)
  - [x] [Source: docs/architecture/test-strategy-and-standards.md lines 18-60]

- [x] Task 15: Create Unit Tests for Subscription Push (AC: 3, 4)
  - [x] Test subscription matching after note handler:
    - Finds matching subscriptions for Kind 1 event
    - Returns subscription info in result
    - Logs subscription matches
    - Handles no matching subscriptions
  - [x] Test subscription push telemetry (AC: 4):
    - Emits AGENT_SUBSCRIPTION_PUSH when event matches subscriptions
    - Telemetry includes correct subscriptionCount
    - Does not emit when no subscriptions match
  - [x] [Source: docs/stories/13.5.story.md - SubscriptionManager tests]

- [x] Task 16: Create Unit Tests for Graceful Shutdown (AC: 5)
  - [x] Test shutdown:
    - Calls database.close()
    - Sets initialized to false
    - Handles shutdown when not initialized
    - Double shutdown is safe
  - [x] [Source: docs/architecture/test-strategy-and-standards.md - cleanup patterns]

- [x] Task 17: Export AgentNode from Agent Module (AC: 1-5)
  - [x] Update `packages/connector/src/agent/index.ts` to export:
    ```typescript
    // Agent Node Orchestrator
    export { AgentNode } from './agent-node';
    export type { AgentNodeConfig, AgentTelemetryEvent } from './agent-node';
    ```
  - [x] Verify exports include:
    - AgentNode class
    - AgentNodeConfig interface
    - AgentTelemetryEvent interface (for telemetry consumers)
  - [x] [Source: docs/prd/epic-13-agent-society-protocol.md lines 209-224]

## Dev Notes

### Previous Story Insights

Story 13.5 (Built-in Event Kind Handlers) completed the handler implementations:

- **createNoteHandler()**: Stores event in database, returns success
- **createFollowHandler(config)**: Updates FollowGraphRouter with Kind 3 events
- **createDeleteHandler()**: Removes events with NIP-09 authorization check
- **createQueryHandler(config)**: Queries database, returns responseEvents
- **registerBuiltInHandlers(eventHandler, config)**: Registers all 4 handlers with pricing
- **SubscriptionManager**: Manages subscriptions and filter matching
- Note: Actual BTP push is deferred to AgentNode (this story)

Key patterns:

- Factory functions create handlers with injected dependencies
- Handlers are stateless - context provides all needed state
- SubscriptionManager.getMatchingSubscriptions() finds subscribers for events

[Source: docs/stories/13.5.story.md Dev Agent Record section]

Story 13.3 (Event Handler Dispatch System) established the handler framework:

- **AgentEventHandler**: Routes events to handlers, validates payment
- **EventHandlerContext**: Contains event, packet, amount, source, agentPubkey, database
- **EventHandlerResult**: success, responseEvent, responseEvents, error
- **InsufficientPaymentError**: Thrown for underpaid requests
- Payment validation happens BEFORE handler execution

[Source: docs/stories/13.3.story.md Dev Agent Record section]

### Technical Context

**AgentNode Responsibility:**

AgentNode is the main orchestrator that:

1. Initializes all agent components on startup
2. Detects TOON events in incoming ILP packets
3. Builds EventHandlerContext and routes to AgentEventHandler
4. Creates ILP response packets (Fulfill or Reject)
5. Pushes events to subscribers after successful storage
6. Emits telemetry for monitoring
7. Gracefully shuts down with database close

```
┌─────────────────────────────────────────────────────────────────────┐
│                          AgentNode                                   │
├─────────────────────────────────────────────────────────────────────┤
│  initialize() ──────► Database.initialize()                         │
│                  └──► registerBuiltInHandlers()                     │
│                                                                      │
│  processIncomingPacket(packet, source)                              │
│       │                                                              │
│       ├─► isToonEvent(packet.data)  ──► false: return F01 reject   │
│       │                                                              │
│       ├─► ToonCodec.decode(packet.data)                             │
│       │                                                              │
│       ├─► Build EventHandlerContext                                 │
│       │                                                              │
│       ├─► eventHandler.handleEvent(context)                         │
│       │        │                                                     │
│       │        └─► InsufficientPaymentError? ──► F03 reject         │
│       │                                                              │
│       ├─► If Kind 1 success: subscriptionManager.getMatchingSubscriptions()
│       │                                                              │
│       └─► Create Fulfill/Reject packet                              │
│                                                                      │
│  shutdown() ──────► Database.close()                                │
└─────────────────────────────────────────────────────────────────────┘
```

[Source: docs/architecture/agent-society-protocol.md lines 46-82, docs/prd/epic-13-agent-society-protocol.md lines 302-312]

**ILP Packet Structure:**

```typescript
interface ILPPreparePacket {
  type: PacketType.PREPARE;
  amount: bigint; // Payment for service
  destination: ILPAddress; // g.agent.* address
  executionCondition: Buffer; // HTLC condition
  expiresAt: Date; // Timeout
  data: Buffer; // TOON-serialized Nostr event
}

interface ILPFulfillPacket {
  type: PacketType.FULFILL;
  fulfillment: Buffer; // Pre-image that satisfies condition
  data: Buffer; // TOON-serialized response events
}

interface ILPRejectPacket {
  type: PacketType.REJECT;
  code: ILPErrorCode;
  triggeredBy: ILPAddress;
  message: string;
  data: Buffer;
}
```

[Source: docs/prd/epic-13-agent-society-protocol.md lines 50-59, docs/architecture/agent-society-protocol.md lines 98-134]

**Error Code Mapping:**

| Scenario                 | Error Code | ILP Code              |
| ------------------------ | ---------- | --------------------- |
| Event kind not supported | F99        | F99_APPLICATION_ERROR |
| Insufficient payment     | F03        | F03_INVALID_AMOUNT    |
| Agent not found          | F02        | F02_UNREACHABLE       |
| Malformed event/packet   | F01        | F01_INVALID_PACKET    |
| Temporary overload       | T03        | T03_CONNECTOR_BUSY    |
| Database/internal error  | T00        | T00_INTERNAL_ERROR    |

[Source: docs/architecture/agent-society-protocol.md lines 196-205]

**Fulfillment Pre-image Handling:**

For MVP, AgentNode uses a simplified fulfillment model for agent-to-agent communication:

1. **Zero-value condition/fulfillment**: For agent service requests where payment validation is the primary gate (not HTLC escrow), use a deterministic fulfillment:

   ```typescript
   // Simplified fulfillment for agent services (no external escrow)
   private static readonly AGENT_FULFILLMENT = Buffer.alloc(32, 0); // 32 zero bytes
   private static readonly AGENT_CONDITION = crypto
     .createHash('sha256')
     .update(AGENT_FULFILLMENT)
     .digest(); // SHA-256 of zeros
   ```

2. **Validation approach**: Check that `packet.executionCondition` matches the expected agent condition, or accept any condition for agent-addressed packets (the payment amount is the real gate).

3. **Future enhancement**: Full HTLC support with caller-provided pre-images can be added when integrating with external payment flows.

This matches the pattern used in existing connector packet handling where the fulfillment is deterministic for trusted peer communication.

[Source: Derived from ILP packet handling patterns in connector codebase]

### Data Models

**AgentNodeConfig Interface:**
[Source: docs/prd/epic-13-agent-society-protocol.md lines 319-324]

```typescript
interface AgentNodeConfig {
  agentPubkey: string; // This agent's Nostr pubkey (hex)
  agentPrivkey?: string; // Optional private key for signing
  databasePath: string; // libSQL path (file:./data/events.db or :memory:)
  databaseMaxSize?: number; // Max DB size (default: 100MB)
  pricing: {
    noteStorage: bigint; // Kind 1 cost
    followUpdate: bigint; // Kind 3 cost
    deletion: bigint; // Kind 5 cost
    queryBase: bigint; // Kind 10000 base cost
    queryPerResult?: bigint; // Per-result cost
  };
  enableBuiltInHandlers?: boolean; // Default: true
  maxSubscriptionsPerPeer?: number; // Default: 10
}
```

**EventHandlerContext Interface (from Story 13.3):**
[Source: docs/stories/13.3.story.md, packages/connector/src/agent/event-handler.ts lines 20-33]

```typescript
interface EventHandlerContext {
  event: NostrEvent;
  packet: ILPPreparePacket;
  amount: bigint;
  source: string;
  agentPubkey: string;
  database: AgentEventDatabase;
}
```

### File Locations

**New Files (Story 13.6):**

```
packages/connector/src/agent/
├── index.ts                          # Agent module exports (update)
├── toon-codec.ts                     # ToonCodec (from Story 13.1)
├── event-database.ts                 # AgentEventDatabase (from Story 13.2)
├── event-handler.ts                  # AgentEventHandler (from Story 13.3)
├── follow-graph-router.ts            # FollowGraphRouter (from Story 13.4)
├── subscription-manager.ts           # SubscriptionManager (from Story 13.5)
├── handlers/                         # Built-in handlers (from Story 13.5)
│   └── ...
├── agent-node.ts                     # AgentNode orchestrator (NEW)
└── agent-node.test.ts                # AgentNode unit tests (NEW)
```

[Source: docs/prd/epic-13-agent-society-protocol.md lines 209-224, docs/architecture/agent-society-protocol.md lines 239-262]

### Testing Requirements

**Unit Test Location:** Co-located with source files
[Source: docs/architecture/test-strategy-and-standards.md line 23]

**Test Framework:** Jest 29.7.x with TypeScript support
[Source: docs/architecture/tech-stack.md line 23]

**Required Test Coverage:**

- AgentNode initialization: database init, handler registration
- TOON event detection: valid/invalid inputs, edge cases
- Event processing: routing, payment validation, response creation
- Subscription push: matching, logging
- Graceful shutdown: database close, state reset
- > 80% line coverage

**Test Pattern:**
[Source: docs/architecture/test-strategy-and-standards.md lines 36-59]

```typescript
import { AgentNode, AgentNodeConfig } from './agent-node';

describe('AgentNode', () => {
  let node: AgentNode;
  let mockLogger: jest.Mocked<Logger>;

  const testConfig: AgentNodeConfig = {
    agentPubkey: 'abc123...',
    databasePath: ':memory:',
    pricing: {
      noteStorage: 100n,
      followUpdate: 50n,
      deletion: 10n,
      queryBase: 200n,
    },
  };

  beforeEach(() => {
    mockLogger = createMockLogger();
    node = new AgentNode(testConfig, mockLogger);
  });

  afterEach(async () => {
    await node.shutdown();
  });

  it('should initialize database on startup', async () => {
    await node.initialize();
    expect(node.isInitialized).toBe(true);
  });
});
```

### Technical Constraints

**TypeScript Configuration:**

- Strict mode enabled (`strict: true`)
- No `any` types except in test mocks
- Use async/await for all async operations
  [Source: docs/architecture/coding-standards.md lines 38-41]

**Naming Conventions:**

- Files: `agent-node.ts` (kebab-case)
- Classes: `AgentNode` (PascalCase)
- Interfaces: `AgentNodeConfig` (PascalCase)
- Functions: `processIncomingPacket` (camelCase)
- Private members: `_database`, `_initialized` (underscore prefix)
  [Source: docs/architecture/coding-standards.md lines 14-20]

**Error Handling:**

- Use Pino logger for all logging (no console.log)
- Return ILP reject packets for errors, don't throw from processing
- Telemetry emission is non-blocking (try-catch around emit)
- Validate initialization state before processing
  [Source: docs/architecture/coding-standards.md lines 24, 27, 30-31]

### Dependencies

**Existing Dependencies (from previous stories):**

- ToonCodec, NostrEvent, ToonDecodeError, ValidationError (Story 13.1)
- AgentEventDatabase, AgentEventDatabaseConfig, NostrFilter (Story 13.2)
- AgentEventHandler, EventHandlerContext, EventHandlerResult, InsufficientPaymentError (Story 13.3)
- FollowGraphRouter, FollowGraphRouterConfig (Story 13.4)
- SubscriptionManager, SubscriptionManagerConfig, Subscription (Story 13.5)
- createNoteHandler, createFollowHandler, etc., registerBuiltInHandlers (Story 13.5)

**Core Package Dependencies:**

- ILPPreparePacket, ILPFulfillPacket, ILPRejectPacket, ILPErrorCode, PacketType, ILPAddress (from @m2m/shared)
- Logger (from 'pino')

**Type Imports:**

```typescript
import type { Logger } from 'pino';
import {
  ILPPreparePacket,
  ILPFulfillPacket,
  ILPRejectPacket,
  ILPErrorCode,
  PacketType,
  ILPAddress,
} from '@m2m/shared';
import { ToonCodec, NostrEvent, ToonDecodeError, ValidationError } from './toon-codec';
import { AgentEventDatabase, AgentEventDatabaseConfig } from './event-database';
import {
  AgentEventHandler,
  EventHandlerContext,
  EventHandlerResult,
  InsufficientPaymentError,
} from './event-handler';
import { FollowGraphRouter } from './follow-graph-router';
import { SubscriptionManager, Subscription } from './subscription-manager';
import { registerBuiltInHandlers, BuiltInHandlersConfig } from './handlers';
```

### Edge Cases and Error Scenarios

**Initialization:**

- Double initialization → Log warning, return early
- Missing required config fields → Throw validation error in constructor
- Database initialization failure → Propagate error, set initialized=false

**TOON Detection:**

- Empty buffer → Return false (not TOON)
- Invalid TOON → Return false (not TOON)
- Valid TOON but invalid NostrEvent → Return false (not TOON)
- Large buffer with valid TOON → Process normally

**Event Processing:**

- Not initialized → Return T00 reject
- Non-TOON data → Return F01 reject
- Insufficient payment → Return F03 reject via InsufficientPaymentError
- Unsupported kind → Return F99 reject from handler
- Handler execution error → Return T00 reject
- Database error in handler → Return T00 reject

**Subscription Push:**

- No matching subscriptions → Continue normally (no push)
- Subscription manager throws → Log error, continue (non-fatal)

**Shutdown:**

- Double shutdown → Log warning, no-op
- Shutdown while not initialized → Safe no-op
- Database close error → Log error, continue shutdown

### Integration with ConnectorNode (Future)

AgentNode is designed as a standalone orchestrator for MVP. Future integration with ConnectorNode:

```typescript
// Future pattern: AgentNode extends ConnectorNode
class AgentNode extends ConnectorNode {
  // Override packet handler to detect TOON events
  protected async handlePrepare(packet: ILPPreparePacket, source: string) {
    if (this.isToonEvent(packet.data)) {
      return this.processIncomingPacket(packet, source);
    }
    return super.handlePrepare(packet, source);
  }
}
```

For Story 13.6, AgentNode is standalone with processIncomingPacket() as the main entry point. Integration with ConnectorNode routing is deferred.

[Source: docs/architecture/agent-society-protocol.md lines 264-274]

## Testing

### Test File Locations

- `packages/connector/src/agent/agent-node.test.ts`

[Source: docs/architecture/test-strategy-and-standards.md line 23 - co-located tests]

### Test Framework

Jest 29.7.x with ts-jest for TypeScript support
[Source: docs/architecture/tech-stack.md line 23]

### Test Commands

```bash
# Run AgentNode tests
npm test -- agent-node.test.ts

# Run all agent module tests
npm test -- packages/connector/src/agent/

# Run with coverage
npm test -- --coverage packages/connector/src/agent/
```

### Test Coverage Requirements

- > 80% line coverage for agent-node.ts
- All initialization paths tested
- All error handling paths tested
- TOON detection edge cases covered
  [Source: docs/architecture/test-strategy-and-standards.md lines 7-9]

### Acceptance Criteria Verification

| AC# | Test Scenario                               | Verification Method                                                                                                             |
| --- | ------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------- |
| 1   | Initialize event database on startup        | Test database.initialize() called, isInitialized=true after init                                                                |
| 2   | Detects TOON events in incoming ILP packets | Test isToonEvent() returns true/false correctly for various inputs                                                              |
| 3   | Routes to AgentEventHandler                 | Test processIncomingPacket routes events to correct handlers                                                                    |
| 4   | Emits agent-specific telemetry events       | Task 14: Test AGENT_EVENT_RECEIVED/HANDLED emitted; Task 15: Test AGENT_SUBSCRIPTION_PUSH emitted; Verify non-blocking emission |
| 5   | Graceful shutdown with database close       | Test shutdown() calls database.close(), sets initialized=false                                                                  |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### File List

| File                                            | Action   | Description                                                   |
| ----------------------------------------------- | -------- | ------------------------------------------------------------- |
| packages/connector/src/agent/agent-node.ts      | Created  | AgentNode orchestrator implementation (~530 lines)            |
| packages/connector/src/agent/agent-node.test.ts | Created  | Unit tests for AgentNode (57 passed, 1 skipped)               |
| packages/connector/src/agent/index.ts           | Modified | Added AgentNode, AgentNodeConfig, AgentTelemetryEvent exports |

### Debug Log References

No debugging required - implementation proceeded smoothly.

### Completion Notes

- **All 17 tasks completed**: AgentNode class with full orchestration capabilities
- **Test Results**: 57 tests passing, 1 skipped (JSON/TOON mock compatibility test)
- **Key Implementation Highlights**:
  - AgentNodeConfig interface with pricing, database, and handler configuration
  - Database initialization with optional built-in handler registration
  - TOON event detection using ToonCodec with buffer size heuristics
  - Full event processing pipeline: decode → context → handler → response
  - Subscription push for Kind 1 events with telemetry
  - Response packet creation (Fulfill with TOON data, Reject with error codes)
  - Agent-specific telemetry: AGENT_EVENT_RECEIVED, AGENT_EVENT_HANDLED, AGENT_SUBSCRIPTION_PUSH
  - Non-blocking telemetry emission with try-catch
  - Graceful shutdown with database close
  - Component accessors for external access to database, handler, subscription manager, router
  - Static AGENT_CONDITION/AGENT_FULFILLMENT constants for deterministic fulfillment
- **Error Code Mapping**: Full mapping from string codes (F00-R99) to ILPErrorCode enum
- **Linting**: All lint rules pass
- **Acceptance Criteria Verified**:
  - AC1: Database initializes on startup, registers built-in handlers
  - AC2: TOON events detected via isToonEvent(), non-TOON returns F01 reject
  - AC3: Events routed to AgentEventHandler, subscription matching for Kind 1
  - AC4: Telemetry emitted at all key points, non-blocking
  - AC5: Graceful shutdown closes database, resets initialized flag

---

## QA Results

### Review Date: 2026-01-24

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: EXCELLENT** - The AgentNode implementation is well-structured, follows established patterns from previous stories, and demonstrates solid engineering practices. The orchestrator cleanly composes all agent components (database, event handler, subscription manager, follow graph router, TOON codec) with appropriate separation of concerns.

**Strengths:**

- Clean class structure with private members and public accessors
- Comprehensive config validation in constructor
- Non-blocking telemetry emission pattern (try-catch wrapper)
- Graceful error handling in shutdown
- Clear documentation with JSDoc comments and usage example
- Deterministic fulfillment approach well-documented for MVP

**Code Architecture:**

- Follows the established AgentNode → Components composition pattern
- Proper dependency injection via constructor
- Event handler context building matches Story 13.3 patterns
- Subscription push only for Kind 1 events (per spec)

### Refactoring Performed

None required - implementation is clean and well-structured.

### Compliance Check

- Coding Standards: ✓ Follows naming conventions, uses Pino logger, Buffer for binary data, async/await patterns
- Project Structure: ✓ Co-located test file, proper exports in index.ts
- Testing Strategy: ✓ >80% line coverage (94.11%), AAA pattern used, edge cases covered
- All ACs Met: ✓ All 5 acceptance criteria validated with corresponding tests

### Requirements Traceability

| AC# | Acceptance Criteria                             | Test Coverage                                                                                                                                                                                                                                                          | Status    |
| --- | ----------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------- |
| 1   | AgentNode initializes event database on startup | `initialize > should initialize database and set initialized flag`, `should register built-in handlers when enableBuiltInHandlers=true/false/default`, `should handle double initialization gracefully`                                                                | ✓ COVERED |
| 2   | Detects TOON events in incoming ILP packets     | `isToonEvent > should return true for valid TOON-encoded NostrEvent`, `should return false for random binary data/empty buffer/very small buffer/invalid input type`, `should handle decode errors gracefully`                                                         | ✓ COVERED |
| 3   | Routes to AgentEventHandler                     | `processIncomingPacket > should route Kind 1/3/5/10000 event to handler`, `should return F01/F03/F99 reject for error cases`, `should encode response events as TOON in fulfill packet`, `subscription matching > should find matching subscriptions for Kind 1 event` | ✓ COVERED |
| 4   | Emits agent-specific telemetry events           | `telemetry emission > should emit AGENT_EVENT_RECEIVED/HANDLED (success/failure)/F03`, `should include correct eventKind and eventId`, `should not block packet processing if telemetry fails`, `should emit AGENT_SUBSCRIPTION_PUSH when event matches`               | ✓ COVERED |
| 5   | Graceful shutdown with database close           | `shutdown > should close database connection`, `should set initialized to false`, `should handle shutdown when not initialized`, `should handle double shutdown safely`, `should log shutdown progress`                                                                | ✓ COVERED |

### Test Architecture Assessment

**Coverage:** 94.11% line coverage (exceeds 80% requirement)
**Test Count:** 57 passed, 1 skipped (mock-related, not a gap)
**Test Design:**

- Proper test isolation with beforeEach/afterEach
- Factory functions for test data (createTestConfig, createTestEvent, createTestPreparePacket)
- Mock logger pattern follows project standards
- Telemetry capture via onTelemetry callback
- Good edge case coverage: double init, double shutdown, empty buffer, invalid input types

**Skipped Test:** "should return false for JSON data (non-TOON)" - This is skipped because the test mock uses JSON.stringify/parse for @toon-format/toon, so JSON is valid TOON in tests. Documented appropriately. Not a coverage gap.

### Improvements Checklist

- [x] All 17 tasks implemented as specified
- [x] All acceptance criteria have corresponding tests
- [x] Error code mapping comprehensive (F00-F99, T00-T99, R00-R99)
- [x] Telemetry emission is non-blocking
- [x] Config validation in constructor
- [x] Component accessors exposed
- [x] Static AGENT_CONDITION/AGENT_FULFILLMENT constants
- [ ] Consider adding integration test with real ToonCodec (future enhancement)
- [ ] Consider adding performance benchmark for packet processing throughput (future enhancement)

### Security Review

**Status: PASS**

- No direct security-sensitive operations (auth handled by payment validation in event-handler)
- Proper input validation (isToonEvent checks buffer type and size)
- Error messages do not leak sensitive information
- Config validation prevents injection of invalid pubkey/path

### Performance Considerations

**Status: PASS**

- Buffer size heuristic in isToonEvent (skips obviously non-TOON data < 10 bytes)
- Non-blocking telemetry emission
- Single decode for TOON detection + context building (avoids redundant decode)
- In-memory subscription matching is efficient for MVP scale

### Files Modified During Review

None - no refactoring required.

### Gate Status

Gate: PASS → docs/qa/gates/13.6-agent-node-orchestrator.yml
Risk profile: Low (standard orchestration component)
NFR assessment: All PASS

### Recommended Status

✓ Ready for Done

---

## Change Log

| Date       | Version | Description                                                                                                                                                                                                                                            | Author     |
| ---------- | ------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ---------- |
| 2026-01-24 | 0.1     | Initial story draft creation                                                                                                                                                                                                                           | SM         |
| 2026-01-24 | 0.2     | Validation fixes: Added fulfillment pre-image handling clarification to Dev Notes; Added telemetry test assertions to Tasks 14 and 15 (AC 4 coverage); Updated Task 17 with explicit AgentTelemetryEvent export; Verified @m2m/shared ILP type exports | Validation |
| 2026-01-24 | 1.0     | Implementation complete: All 17 tasks implemented, 57 tests passing, lint passing, ready for review                                                                                                                                                    | Dev Agent  |
| 2026-01-24 | 1.1     | QA Review complete: PASS - All ACs verified, 94.11% coverage, code quality excellent                                                                                                                                                                   | Quinn (QA) |
