# Story 23.3: Deploy Script `--unified` Flag and Bootstrap Verification

**Epic:** 23 - Unified Deployment Infrastructure
**Story Number:** 23.3
**Status:** Done

## Story

**As a** developer,
**I want** a `--unified` flag on the deploy script that starts the full 3-layer stack and verifies bootstrap,
**so that** I can deploy and validate the unified network with a single command.

## Acceptance Criteria

1. `./scripts/deploy-5-peer-multihop.sh --unified` starts all 16 services
2. Script builds all 3 required Docker images (connector, middleware, agent-society)
3. `AGENT_SOCIETY_PATH` env var configurable (default `../agent-society`)
4. Nostr keypair generation works if `.env.peers` lacks NOSTR keys
5. Phased startup respects dependency chain (no connector before middleware is healthy)
6. Bootstrap verification detects failed handshakes and reports them
7. Channel verification queries Admin API and reports channel status
8. End-to-end test packet sends via `POST /ilp/send` and verifies FULFILL
9. Script prints clear pass/fail status for each verification phase
10. `--unified` flag coexists with existing flags (`--with-agent`, etc.) without conflict
11. Cleanup on `Ctrl+C` (SIGINT trap) tears down unified compose stack

## Dev Notes

### Previous Story Insights (Story 23.1 + 23.2)

- **Story 23.1** created `docker-compose-unified.yml` with all 16 services (1 TigerBeetle + 5 agent-society + 5 agent-runtime + 5 peer connectors) on a single `agent-network` bridge
- Dependency chain: `tigerbeetle (service_started) → agent-society-{N} (service_healthy) → agent-runtime-{N} (service_healthy) → peer{N}`
- Port mappings: BTP 3000-3004, Health 9080-9084, Admin 8181-8185, BLS 3110-3114, Relay 7110-7114, Middleware 3200-3204
- `.env.peers` extended with Nostr keypair placeholders (`PEER{N}_NOSTR_SECRET_KEY`, `PEER{N}_NOSTR_PUBKEY`) and contract addresses (`AGENT_TOKEN_ADDRESS`, `TOKEN_NETWORK_ADDRESS`)
- `docker compose -f docker-compose-unified.yml config` validates successfully
- **Three Docker images** required: `agent-runtime` (connector, from root Dockerfile), `agent-runtime-core` (middleware, from `packages/agent-runtime/Dockerfile`), `agent-society` (from external agent-society repo)
- agent-society-1 is the bootstrap node (`SPSP_MIN_PRICE=0`, `KNOWN_PEERS=[]`); peers 2-5 have `KNOWN_PEERS` pointing to agent-society-1's relay
- BTP auth tokens use `test-token` for local dev
- Agent-society healthcheck uses `node -e "fetch('http://localhost:3100/health')..."`, connectors use `wget`
- **Story 23.2** created 12 K8s manifests for `k8s/agent-society/` and updated `k8s/connector/base/configmap.yaml` with `LOCAL_DELIVERY_ENABLED` and `LOCAL_DELIVERY_URL`
- Runtime prerequisite noted: connector `service.yaml` needs port 8081 (Admin API) exposed for agent-society egress — outside this story's scope
- No code changes in 23.1 or 23.2 — infrastructure config only. **This story also has no TypeScript code changes — it modifies the bash deploy script only.**

### Existing Deploy Script Structure

[Source: `scripts/deploy-5-peer-multihop.sh`]

The existing script (~1405 lines) has the following structure that the `--unified` flag must integrate with:

**Current flags:**

- `--with-agent` — starts agent-runtime + business-logic containers, runs agent runtime tests
- `--agent-only` — skips standard network deployment, runs agent tests against existing network
- `--with-nostr-spsp` — generates Nostr keypairs, builds agent-society image, starts agent-society containers, runs bootstrap verification

**Existing helper functions (reusable):**

- `resolve_network_urls()` — loads `.env` for blockchain RPC URLs
- `initialize_tigerbeetle()` — creates `/tmp/m2m-tigerbeetle` dir, formats TigerBeetle cluster if needed
- `generate_nostr_keypairs()` — generates Nostr keypairs via `nostr-tools` or falls back to `openssl rand -hex 32`
- `wait_for_nostr_bootstrap()` — polls BLS health on ports 3110-3114 with 30-attempt retry at 2s intervals
- `verify_bootstrap_routes()` — checks peers 2-5 have routes to peer1 via `GET /admin/routes` on Admin API
- `cleanup_tigerbeetle()` — removes TigerBeetle volume

**Key variables:**

- `COMPOSE_FILE="${PROJECT_ROOT}/docker-compose-5-peer-multihop.yml"` — standard compose file
- `COMPOSE_FILE_AGENT` — agent-runtime compose file
- `COMPOSE_FILE_NOSTR_SPSP` — Nostr SPSP compose file
- `AGENT_SOCIETY_DIR="${PROJECT_ROOT}/../agent-society"` — agent-society repo path

**Script flow:**

1. Parse args → `[0/7]` Resolve network URLs → `[1/7]` Check prerequisites (Docker, images, .env) → `[2/7]` Initialize TigerBeetle → `[3/7]` Start network → `[4/7]` Fund peers → `[5/7]` Display topology → `[6/10]` Send test packet → `[7/10]` Verify routing → `[8/10]` Verify fees → `[9/10]` Test REJECT → Agent Runtime section (if `--with-agent`) → Nostr SPSP section (if `--with-nostr-spsp`) → `[10/10]` Final summary

**Color codes (reuse):**

```bash
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'
```

**Exit codes (extend):**

- 0 = all tests passed
- 1 = multi-hop forwarding failed
- 2 = reject tests had failures
- 3 = agent runtime tests had failures
- (New) 4 = unified deployment/verification failed

### API Specifications

**No API endpoint changes** — this story uses existing endpoints to verify the unified deployment:

- **Agent-society BLS health**: `GET /health` on ports 3110-3114 [Source: docker-compose-unified.yml]
- **Agent-society Nostr relay**: WebSocket on ports 7110-7114 [Source: docker-compose-unified.yml]
- **Agent-runtime middleware health**: `GET /health` on ports 3200-3204 [Source: docker-compose-unified.yml]
- **Connector health**: `GET /health` on ports 9080-9084 (internal 8080) [Source: docker-compose-unified.yml]
- **Connector Admin API**: ports 8181-8185 (internal 8081)
  - `GET /admin/peers` — list peered connectors [Source: packages/connector/src/http/admin-api.ts]
  - `GET /admin/routes` — list routing table entries [Source: packages/connector/src/http/admin-api.ts]
  - `GET /admin/channels` — list payment channels [Source: packages/connector/src/http/admin-api.ts]
- **Agent-runtime outbound send**: `POST /ilp/send` on port 3200 (agent-runtime-1) — for end-to-end test packet; requires JSON body with `destination` (ILP address string), `amount` (non-negative integer string), `data` (base64 string, required) [Source: packages/agent-runtime/src/types/index.ts `IlpSendRequest`]

### Docker Image Build Commands

[Source: docs/stories/23.1.story.md#Docker Image Build Prerequisites]

| Image Name           | Build Command                                                                                   | Role                                     |
| -------------------- | ----------------------------------------------------------------------------------------------- | ---------------------------------------- |
| `agent-runtime`      | `docker build -t agent-runtime .` (from project root)                                           | ILP connector (peer{1..5})               |
| `agent-runtime-core` | `docker build -t agent-runtime-core -f packages/agent-runtime/Dockerfile .` (from project root) | Middleware (agent-runtime-{1..5})        |
| `agent-society`      | `docker build -t agent-society <AGENT_SOCIETY_PATH>`                                            | BLS + Nostr relay (agent-society-{1..5}) |

The `agent-society` image path is configurable via `AGENT_SOCIETY_PATH` env var (default: `../agent-society`). The existing script uses `AGENT_SOCIETY_DIR="${PROJECT_ROOT}/../agent-society"` and checks `docker/Dockerfile` inside that directory.

### Phased Startup Verification (7 Phases)

[Source: docs/prd/epic-23-unified-deployment-infrastructure.md#Story 23.3]

| Phase | Action                                       | Verification                                                                                                                       | Ports/Endpoints         |
| ----- | -------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------- | ----------------------- |
| 1     | Start TigerBeetle + agent-society containers | BLS `/health` healthy on 3110-3114, relay WebSocket listening on 7110-7114                                                         | 3110-3114, 7110-7114    |
| 2     | Start agent-runtime middleware               | `/health` healthy on 3200-3204                                                                                                     | 3200-3204               |
| 3     | Start connectors                             | `/health` healthy on 9080-9084, Admin API ready on 8181-8185                                                                       | 9080-9084, 8181-8185    |
| 4     | Bootstrap verification                       | Verify kind:10032 published, peers registered via `GET /admin/peers`, SPSP handshakes completed                                    | 8182-8185 (Admin), logs |
| 5     | Verify payment channels                      | `GET /admin/channels` on each connector returns at least 1 channel                                                                 | 8181-8185               |
| 6     | Verify routing tables                        | `GET /admin/routes` on peer1 should list routes for peers 2-5                                                                      | 8181                    |
| 7     | End-to-end test                              | `POST /ilp/send` on agent-runtime-1 (port 3200) with `{"destination":"g.peer5","amount":"1000","data":"SGVsbG8="}`, verify FULFILL | 3200                    |

**Note:** Docker Compose `depends_on` with `service_healthy` handles the dependency chain automatically during `docker compose up`. The phased startup in the deploy script is for **verification** — the script should wait for each layer to be healthy before proceeding to verify the next layer. This is different from the `--with-nostr-spsp` approach which starts separate compose files sequentially; the unified compose file starts everything at once with Docker managing dependency ordering.

### Nostr Keypair Generation

[Source: `generate_nostr_keypairs()` function in `scripts/deploy-5-peer-multihop.sh`]

The existing `generate_nostr_keypairs()` function generates keys using `nostr-tools` with an `openssl` fallback. For the `--unified` flag:

1. Check if `.env.peers` already has real (non-placeholder) `PEER{N}_NOSTR_SECRET_KEY` values
2. If keys are placeholder zeros (`0000...000{N}`), generate real keys using `generate_nostr_keypairs()`
3. Write generated keys back to `.env.peers` (replacing placeholders)
4. Export keys to the shell environment for Docker Compose interpolation

**Detection of placeholder keys:** Check if `PEER1_NOSTR_SECRET_KEY` matches the pattern `^0{60}[0-9a-f]{4}$` (60+ leading zeros with a short trailing value). The actual placeholders in `.env.peers` are 64-char hex strings like `000...0001` through `000...0005`.

### SIGINT Trap / Cleanup

[Source: docs/prd/epic-23-unified-deployment-infrastructure.md#Story 23.3, AC 11]

The script must register a SIGINT trap that tears down the unified compose stack on `Ctrl+C`:

```bash
COMPOSE_FILE_UNIFIED="${PROJECT_ROOT}/docker-compose-unified.yml"

cleanup_unified() {
  echo -e "\n${YELLOW}Caught interrupt. Tearing down unified stack...${NC}"
  docker compose -f "${COMPOSE_FILE_UNIFIED}" --env-file "${PROJECT_ROOT}/.env.peers" down
  exit 1
}

# Set trap when --unified is active
trap cleanup_unified SIGINT SIGTERM
```

### File Locations

| File                                | Action     | Description                                   |
| ----------------------------------- | ---------- | --------------------------------------------- |
| `scripts/deploy-5-peer-multihop.sh` | **Modify** | Add `--unified` flag with phased verification |

### Technical Constraints

- **Bash script only** — no TypeScript code changes in this story [Source: docs/prd/epic-23-unified-deployment-infrastructure.md#Story 23.3]
- **Existing flags preserved** — `--with-agent`, `--agent-only`, `--with-nostr-spsp` must continue to work unchanged [Source: docs/prd/epic-23-unified-deployment-infrastructure.md#Compatibility Requirements]
- **Flag mutual exclusivity** — `--unified` should be mutually exclusive with `--with-nostr-spsp` (unified mode includes BLS/relay already) and `--with-agent` (unified mode includes middleware already). Print an error if conflicting flags are provided.
- **Docker Compose `--env-file`** — the unified compose file reads from `.env.peers` for Nostr keypairs and contract addresses, so `docker compose` commands must include `--env-file .env.peers`
- **120-second timeout per phase** — each verification phase should have a configurable timeout (default 120s) with clear failure reporting [Source: docs/prd/epic-23-unified-deployment-infrastructure.md#Risk Mitigation]
- **Agent-society repo check** — script must verify `AGENT_SOCIETY_PATH` exists before attempting to build the image; provide clear error message if missing [Source: docs/prd/epic-23-unified-deployment-infrastructure.md#Risk Mitigation]
- **TigerBeetle initialization** — reuse existing `initialize_tigerbeetle()` function [Source: `initialize_tigerbeetle()` in `scripts/deploy-5-peer-multihop.sh`]
- **Health check patterns** — use `curl -s` for HTTP health checks (consistent with existing Nostr SPSP section), not `docker compose exec wget` (which is used in the standard section)
- **End-to-end test via HTTP** — use `curl -s -X POST http://localhost:3200/ilp/send` with JSON body (not the `tools/send-packet` WebSocket tool), because the unified stack routes through agent-runtime middleware, not directly to connector BTP

### Testing Requirements

**No automated tests** — this is an infrastructure/scripting story. Verification is manual:

1. `./scripts/deploy-5-peer-multihop.sh --unified` completes successfully with exit code 0
2. Conflicting flags (`--unified --with-agent`) produce a clear error message
3. `--unified` without agent-society repo produces a clear error and exits
4. Nostr keypair generation replaces placeholder values in `.env.peers`
5. All 7 verification phases print pass/fail status
6. `Ctrl+C` during deployment tears down the unified compose stack
7. Existing flags (`--with-agent`, `--with-nostr-spsp`, `--agent-only`) continue to work unchanged

[Source: docs/architecture/test-strategy-and-standards.md — infrastructure changes verified via manual inspection, not unit tests]

## Tasks / Subtasks

> **Execution Order:** Task 1 adds the flag parsing and prerequisites. Task 2 implements phased startup and verification. Task 3 adds cleanup, reporting, and integration with existing summary. Recommended order: **1 → 2 → 3**.

### 1. Add `--unified` Flag Parsing, Prerequisites, and Image Building (AC: 2, 3, 4, 10, 11)

- [x] Add `--unified` flag to the argument parser (in the `while [[ $# -gt 0 ]]` / `case $1 in` block)
  - [x] Add `WITH_UNIFIED=false` variable
  - [x] Add `--unified)` case that sets `WITH_UNIFIED=true`
  - [x] Add `COMPOSE_FILE_UNIFIED="${PROJECT_ROOT}/docker-compose-unified.yml"` variable
  - [x] Add `AGENT_SOCIETY_PATH="${AGENT_SOCIETY_PATH:-${PROJECT_ROOT}/../agent-society}"` variable (AC: 3)
- [x] Add flag conflict detection after argument parsing:
  - [x] If `--unified` combined with `--with-agent` or `--with-nostr-spsp`, print error and exit: "Error: --unified is mutually exclusive with --with-agent and --with-nostr-spsp (unified mode includes all layers)" (AC: 10)
  - [x] If `--unified` combined with `--agent-only`, print error and exit (AC: 10)
- [x] Register SIGINT/SIGTERM trap when `--unified` is active (AC: 11):
  - [x] Create `cleanup_unified()` function that runs `docker compose -f "${COMPOSE_FILE_UNIFIED}" --env-file "${PROJECT_ROOT}/.env.peers" down`
  - [x] `trap cleanup_unified SIGINT SIGTERM` (only when `WITH_UNIFIED=true`)
- [x] Add unified prerequisite checks (in the existing Step 1 prerequisites section):
  - [x] Check agent-society repo exists at `AGENT_SOCIETY_PATH`; if not, print error: "agent-society repo not found at ${AGENT_SOCIETY_PATH}. Set AGENT_SOCIETY_PATH env var." and exit 1 (AC: 3)
  - [x] Check/build `agent-runtime` image (connector): `docker build -t agent-runtime .` (AC: 2)
  - [x] Check/build `agent-runtime-core` image (middleware): `docker build -t agent-runtime-core -f packages/agent-runtime/Dockerfile .` (AC: 2)
  - [x] Check/build `agent-society` image: `docker build -t agent-society "${AGENT_SOCIETY_PATH}"` (AC: 2)
- [x] Add Nostr keypair generation/validation (AC: 4):
  - [x] Source `.env.peers` file
  - [x] Check if `PEER1_NOSTR_SECRET_KEY` matches placeholder pattern (`^0{60}` — 60+ leading zeros, as actual placeholders are `000...0001` through `000...0005`)
  - [x] If placeholder, call `generate_nostr_keypairs()` and write real keys back to `.env.peers`
  - [x] Export all `PEER{N}_NOSTR_SECRET_KEY` and `PEER{N}_NOSTR_PUBKEY` to environment
- [x] Update usage line in the script header comment to include `--unified`

### 2. Implement Phased Startup and Verification (AC: 1, 5, 6, 7, 8, 9)

- [x] Add `if [ "${WITH_UNIFIED}" = true ]; then` block after the prerequisites section (before standard deployment) that contains all unified-mode logic
- [x] **Phase 0: Initialize TigerBeetle** (reuse `initialize_tigerbeetle()`)
  - [x] Stop any existing unified deployment: `docker compose -f "${COMPOSE_FILE_UNIFIED}" --env-file "${PROJECT_ROOT}/.env.peers" down 2>/dev/null || true`
  - [x] Call `initialize_tigerbeetle`
- [x] **Phase 1: Start all services via Docker Compose** (AC: 1, 5)
  - [x] Run `docker compose -f "${COMPOSE_FILE_UNIFIED}" --env-file "${PROJECT_ROOT}/.env.peers" up -d`
  - [x] Wait for agent-society containers (BLS health on ports 3110-3114): poll `curl -s http://localhost:311{N-1}/health` with 60 attempts × 2s (120s timeout)
  - [x] Check relay WebSocket ports (7110-7114) are listening: `curl -s -o /dev/null -w "%{http_code}" http://localhost:711{N-1}/`
  - [x] Print phase 1 status table
- [x] **Phase 2: Wait for agent-runtime middleware** (AC: 5)
  - [x] Poll `curl -s http://localhost:320{N-1}/health` for ports 3200-3204, 60 attempts × 2s
  - [x] Print phase 2 status
- [x] **Phase 3: Wait for connectors** (AC: 5)
  - [x] Poll `curl -s http://localhost:908{N-1}/health` for ports 9080-9084, 60 attempts × 2s
  - [x] Verify Admin API ready: `curl -s http://localhost:818{N-1}/admin/peers` returns 200
  - [x] Print phase 3 status
- [x] **Phase 4: Bootstrap verification** (AC: 6)
  - [x] Check agent-society logs for bootstrap events: `docker compose -f "${COMPOSE_FILE_UNIFIED}" --env-file "${PROJECT_ROOT}/.env.peers" logs agent-society-1 2>&1 | grep -i "bootstrap\|kind:10032\|published"`
  - [x] Verify peers 2-5 registered peer1: `curl -s http://localhost:818{N}/admin/peers` (ports 8182-8185) should list peer1
  - [x] Report handshake status per peer (AC: 6)
  - [x] Print phase 4 status
- [x] **Phase 5: Verify payment channels** (AC: 7)
  - [x] Query `curl -s http://localhost:818{N-1}/admin/channels` for each connector (ports 8181-8185)
  - [x] Report channel count per peer
  - [x] Print phase 5 status (pass if at least 1 channel per peer, warn if none)
- [x] **Phase 6: Verify routing tables** (AC: 9)
  - [x] Query `curl -s http://localhost:8181/admin/routes` (peer1) and check routes for `g.peer2` through `g.peer5` are listed (consistent with existing `verify_bootstrap_routes()` which uses `/admin/routes`)
  - [x] Print routing table summary
  - [x] Print phase 6 status
- [x] **Phase 7: End-to-end test packet** (AC: 8)
  - [x] Send test via middleware: `curl -s -X POST -H "Content-Type: application/json" -d '{"destination":"g.peer5","amount":"1000","data":"SGVsbG8="}' http://localhost:3200/ilp/send` (note: `data` field is required by the `IlpSendRequest` interface — `SGVsbG8=` is base64 for "Hello")
  - [x] Check response for FULFILL (success) vs REJECT (failure)
  - [x] Print phase 7 status with pass/fail result

### 3. Add Status Reporting and Summary Integration (AC: 9, 10)

- [x] Create `print_unified_status_table()` function that prints health status of all 16 services in a table format:
  ```
  ┌───────────────────┬──────────┬──────────────────┐
  │ Service           │ Status   │ Port             │
  ├───────────────────┼──────────┼──────────────────┤
  │ tigerbeetle       │ ✓ Up     │ (internal)       │
  │ agent-society-1   │ ✓ Healthy│ BLS:3110 WS:7110 │
  │ agent-runtime-1   │ ✓ Healthy│ 3200             │
  │ peer1             │ ✓ Healthy│ BTP:3000 H:9080  │
  │ ...               │          │                  │
  └───────────────────┴──────────┴──────────────────┘
  ```
- [x] Create `print_phase_result()` helper function that takes phase number, name, and pass/fail:
  ```
  [Phase 1/7] Agent-Society Bootstrap .............. ✓ PASS
  [Phase 2/7] Agent-Runtime Middleware .............. ✓ PASS
  ```
- [x] Track unified verification results in variables:
  - `UNIFIED_PHASE1_PASS=true/false`
  - `UNIFIED_PHASE2_PASS=true/false`
  - ... through `UNIFIED_PHASE7_PASS=true/false`
- [x] Print unified deployment summary after all phases complete:
  ```
  ======================================
    Unified Deployment Verification
  ======================================
  [Phase 1/7] Agent-Society Health ............ ✓ PASS
  [Phase 2/7] Agent-Runtime Health ............ ✓ PASS
  [Phase 3/7] Connector Health ................ ✓ PASS
  [Phase 4/7] Bootstrap Verification .......... ✓ PASS
  [Phase 5/7] Payment Channels ................ ⚠ WARN (0 channels)
  [Phase 6/7] Routing Tables .................. ✓ PASS
  [Phase 7/7] End-to-End Test ................. ✓ PASS
  ```
- [x] Print useful commands section for unified mode:
  - View logs: `docker compose -f docker-compose-unified.yml --env-file .env.peers logs -f`
  - View specific service: `docker compose -f docker-compose-unified.yml logs -f agent-society-1`
  - Check health: `curl http://localhost:3110/health` (BLS), `curl http://localhost:3200/health` (middleware), `curl http://localhost:9080/health` (connector)
  - Admin API: `curl http://localhost:8181/admin/peers`, `curl http://localhost:8181/admin/channels`
  - Stop: `docker compose -f docker-compose-unified.yml --env-file .env.peers down`
- [x] Add exit code 4 for unified verification failure
- [x] Ensure unified mode skips standard deployment steps (Step 2-9) and goes directly to unified-specific logic, then joins the final summary
- [x] Update header comment with `--unified` flag documentation and usage example

## Estimated Complexity

**Size: Large (L)** — This is a substantial bash script modification (~400-600 lines of new code) with 7 verification phases, health polling loops, status reporting, and integration with the existing 1400-line script. The complexity is in correctly orchestrating the phased verification, handling timeouts/failures gracefully, and integrating with the existing script flow without breaking existing flags.

## Project Structure Notes

- `scripts/deploy-5-peer-multihop.sh` is the only file modified — it already contains the patterns for all the helper functions needed [Source: docs/architecture/source-tree.md]
- Docker Compose file `docker-compose-unified.yml` already exists (created in Story 23.1) — this story only **uses** it via `docker compose` commands
- `.env.peers` already has Nostr keypair placeholders (from Story 23.1) — this story may **update** placeholders with generated real keys
- No new files created

### Files Changed Summary

| File                                | Action | Lines Changed (est.) |
| ----------------------------------- | ------ | -------------------- |
| `scripts/deploy-5-peer-multihop.sh` | Modify | ~400-600 lines added |

## Change Log

| Date       | Version | Description                                                                                                                                                                                                                                                                               | Author               |
| ---------- | ------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------- |
| 2026-02-09 | 1.0     | Initial story draft created from Epic 23                                                                                                                                                                                                                                                  | Claude Opus 4.6 (SM) |
| 2026-02-09 | 1.1     | Validation fixes: add required `data` field to `/ilp/send` curl, fix Phase 6 to use `/admin/routes` (not `/admin/peers`), improve placeholder detection regex, replace brittle line-number refs with function-name refs, add missing QA Results section, add `/admin/routes` to API specs | Claude Opus 4.6 (QA) |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6

### Debug Log References

- No debug log entries — bash-only story with no TypeScript code changes

### Completion Notes List

- Added `--unified` flag to deploy script argument parser with mutual exclusivity against `--with-agent`, `--agent-only`, `--with-nostr-spsp`
- Added `COMPOSE_FILE_UNIFIED` and `AGENT_SOCIETY_PATH` (configurable via env var) variables
- Added `cleanup_unified()` SIGINT/SIGTERM trap for graceful teardown
- Added prerequisite checks: agent-society repo existence, builds for all 3 Docker images (agent-runtime, agent-runtime-core, agent-society)
- Added Nostr keypair placeholder detection and generation with write-back to `.env.peers`
- Implemented 7-phase verification: agent-society health, middleware health, connector health, bootstrap verification, payment channels, routing tables, end-to-end test
- Added `print_phase_result()` helper with PASS/WARN/FAIL formatting and dot-leader alignment
- Added `print_unified_status_table()` showing all 16 services with health status and ports
- Added unified deployment summary, useful commands section, and exit code 4
- Unified mode exits before standard deployment path — existing flags remain untouched
- ~584 lines of new bash code added to the deploy script

### File List

| File                                | Action   | Description                                           |
| ----------------------------------- | -------- | ----------------------------------------------------- |
| `scripts/deploy-5-peer-multihop.sh` | Modified | Added `--unified` flag with full 7-phase verification |
| `docs/stories/23.3.story.md`        | Modified | Updated task checkboxes and Dev Agent Record          |

## QA Results

### Review Date: 2026-02-09

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Solid implementation of ~584 lines of bash scripting that integrates cleanly with the existing 1400-line deploy script. The unified mode correctly exits before standard deployment, preserves all existing flags, and implements all 7 verification phases with clear pass/fail reporting. The phased verification approach is well-structured with configurable timeouts. Code reuses existing helpers (`initialize_tigerbeetle`, `generate_nostr_keypairs`) appropriately. The `print_phase_result()` and `print_unified_status_table()` helpers are clean and consistent with existing script style.

### Refactoring Performed

No refactoring performed. This is a bash-only infrastructure story and the implementation follows existing patterns. The one code quality concern identified (Phase 3 health check leniency) is minor and does not warrant a refactoring intervention during review.

### Compliance Check

- Coding Standards: ✓ N/A — bash script, not TypeScript; follows existing script conventions
- Project Structure: ✓ Single file modified (`scripts/deploy-5-peer-multihop.sh`) as specified
- Testing Strategy: ✓ Infrastructure story verified via manual execution per test-strategy-and-standards.md
- All ACs Met: ✓ All 11 acceptance criteria verified (see detailed trace below)

### Improvements Checklist

- [x] All 11 ACs implemented and verified in code
- [x] Flag parsing with mutual exclusivity (AC 10)
- [x] SIGINT/SIGTERM trap for cleanup (AC 11)
- [x] 3 Docker image builds (AC 2)
- [x] AGENT_SOCIETY_PATH configurable via env var (AC 3)
- [x] Nostr keypair placeholder detection and generation (AC 4)
- [x] 7-phase verification with status reporting (AC 1, 5, 6, 7, 8, 9)
- [x] Exit code 4 for unified failure
- [x] Unified mode skips standard deployment path
- [ ] Phase 3 health check (`[ -n "${HEALTH_OK}" ]` on line 676) is more lenient than Phases 1-2 which use `grep -q "healthy"` — consider tightening to `echo "${HEALTH_OK}" | grep -q "healthy\|ok"` for consistency
- [ ] `docker-compose-unified.yml` line 38 uses deprecated `version: '3.8'` key — Docker Compose v2+ ignores this, but removing it would silence deprecation warnings (outside this story's scope — created in 23.1)

### Security Review

No security concerns. The script:

- Uses `eval "export PEER${i}_NOSTR_SECRET_KEY"` only with developer-controlled `.env.peers` values (no user input injection)
- `sed -i.bak` keypair write-back is properly cross-platform (macOS/Linux compatible)
- BTP auth tokens use `test-token` for local dev only (documented in compose file)
- No secrets are logged or exposed in console output (pubkeys truncated to 16 chars in existing Nostr SPSP section)

### Performance Considerations

No performance issues. Timeout defaults (120s per phase, 2s polling interval) are appropriate for Docker container startup. The `UNIFIED_TIMEOUT` env var allows override for slower environments. Docker image builds redirect stdout to `/dev/null` to keep output clean.

### Files Modified During Review

None — no refactoring was performed.

### Gate Status

Gate: PASS → docs/qa/gates/23.3-deploy-script-unified-flag-and-bootstrap-verification.yml

### Recommended Status

[✓ Ready for Done] — All 11 acceptance criteria are met. Two minor improvement suggestions are documented above but are non-blocking: the Phase 3 health check leniency is a cosmetic consistency issue (the connector health endpoint will return a proper response or nothing), and the deprecated `version` key is in a different story's file (23.1).
