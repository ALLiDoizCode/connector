# Development Docker Compose configuration for M2M project
# Includes local blockchain nodes (Anvil, rippled) for Epic 7-9 development
# DO NOT use for production - see docker-compose-production.yml instead
#
# This configuration provides a complete development environment with:
# - Local blockchain forks (Anvil for Base L2, rippled for XRP Ledger)
# - Settlement infrastructure (TigerBeetle)
# - ILP connectors
# - Dashboard for visualization
#
# Usage:
#   Start all services:      docker-compose -f docker-compose-dev.yml up -d
#   Start specific service:  docker-compose -f docker-compose-dev.yml up -d anvil
#   View logs:               docker-compose -f docker-compose-dev.yml logs -f
#   Stop services:           docker-compose -f docker-compose-dev.yml down
#
# Differences from production compose files:
# - Development: Local blockchain forks, hot-reload volumes, optional services via profiles
# - Production: Public RPC endpoints, no code mounts, all services required

version: '3.8'

services:
  # ===== Local Blockchain Nodes =====

  # Anvil - Local Base L2 fork for smart contract development
  #
  # Anvil provides a local Ethereum node that forks Base Sepolia testnet state,
  # enabling fast development and testing of payment channel smart contracts without
  # testnet rate limits or network delays.
  #
  # Configuration:
  #   - Forks Base Sepolia testnet from configurable RPC endpoint
  #   - Pins to specific block number for consistent state across developer machines
  #   - Chain ID: 84532 (Base Sepolia)
  #   - OP Stack compatibility enabled (--optimism flag required for Base L2)
  #
  # Pre-funded Test Accounts:
  #   Anvil automatically funds 10 test accounts with 10000 ETH each (deterministic):
  #   - Account #0: 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266
  #     Private Key: 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
  #   - Account #1: 0x70997970C51812dc3A010C7d01b50e0d17dc79C8
  #     Private Key: 0x59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d
  #   - Account #2: 0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC
  #     Private Key: 0x5de4111afa1a4b94908f83103eb1f1706367c2e68ca870fc3fb9a804cdab365a
  #   - (7 more accounts with deterministic addresses)
  #   These accounts are consistent across all Anvil instances for testing.
  #
  # Network Access:
  #   - JSON-RPC endpoint: http://localhost:8545 (from host)
  #   - JSON-RPC endpoint: http://anvil:8545 (from Docker containers)
  #   - Standard Ethereum RPC methods supported (eth_*, net_*, web3_*)
  #
  # Health Check:
  #   - Calls eth_blockNumber RPC method to verify Anvil is serving requests
  #   - Start period allows time for fork download (~30-60 seconds)
  #
  # Development Notes:
  #   - Fork download time depends on internet speed and RPC endpoint rate limits
  #   - Update FORK_BLOCK_NUMBER in .env.dev periodically to get recent testnet state
  #   - Use alternative RPC endpoints (Alchemy, Tenderly, Infura) if rate limited
  anvil:
    image: ghcr.io/foundry-rs/foundry:latest
    container_name: anvil_base_local
    command:
      - anvil
      - --host
      - "0.0.0.0"  # Listen on all interfaces (required for Docker container access)
      - --port
      - "8545"  # Standard Ethereum JSON-RPC port
      - --fork-url
      - "${BASE_SEPOLIA_RPC_URL:-https://sepolia.base.org}"  # Download Base Sepolia state from public RPC endpoint
      - --fork-block-number
      - "${FORK_BLOCK_NUMBER:-20702367}"  # Pin to specific block for consistent state across developer machines
      - --chain-id
      - "84532"  # Match Base Sepolia chain ID for compatibility with Base L2 tools
      - --optimism  # Enable OP Stack opcodes and gas calculations (required for Base L2)
    ports:
      - "8545:8545"  # Expose JSON-RPC endpoint (http://localhost:8545 from host, http://anvil:8545 from containers)
    networks:
      - m2m_dev_network
    environment:
      # Base L2 fork configuration - override in .env.dev for custom RPC endpoint or block number
      BASE_SEPOLIA_RPC_URL: ${BASE_SEPOLIA_RPC_URL:-https://sepolia.base.org}
      FORK_BLOCK_NUMBER: ${FORK_BLOCK_NUMBER:-20702367}
    healthcheck:
      # Call eth_blockNumber RPC method to verify Anvil is serving requests
      test: ["CMD-SHELL", "curl -f http://localhost:8545 -X POST -H 'Content-Type: application/json' --data '{\"jsonrpc\":\"2.0\",\"method\":\"eth_blockNumber\",\"params\":[],\"id\":1}' || exit 1"]
      interval: 10s  # Check every 10 seconds
      timeout: 5s  # RPC call should respond within 5 seconds
      retries: 5  # 5 attempts before marking unhealthy
      start_period: 10s  # Allow time for fork download before health checks start (fork download ~30-60s)
    restart: unless-stopped

  # rippled - Local XRP Ledger node in standalone mode for payment channel development
  #
  # rippled provides a local XRP Ledger in standalone mode (offline, no consensus network).
  # Standalone mode runs rippled without network peers, requiring manual ledger advancement
  # after each transaction. This enables fast, offline development and testing of XRP payment
  # channels without testnet dependencies or network delays.
  #
  # Configuration:
  #   - Standalone mode flag (-a) runs rippled offline without consensus
  #   - Ledgers must be manually advanced after transactions using ledger_accept RPC method
  #   - No transaction fees in standalone mode
  #   - Master key can be used for all operations (insecure in production, convenient for dev)
  #
  # Ledger Advancement (CRITICAL):
  #   Standalone mode does NOT automatically close ledgers. Transactions submitted to rippled
  #   stay PENDING until ledger_accept called. Use one of these methods:
  #   - Manual: ./scripts/rippled-advance-ledger.sh
  #   - Automatic: Start with --profile auto-ledger flag (advances every 5 seconds)
  #
  # Network Access:
  #   - JSON-RPC endpoint: http://localhost:5005 (from host)
  #   - JSON-RPC endpoint: http://rippled:5005 (from Docker containers)
  #   - WebSocket endpoint: ws://localhost:6006 (from host)
  #   - WebSocket endpoint: ws://rippled:6006 (from Docker containers)
  #   - Standard XRP Ledger RPC methods supported (server_info, wallet_propose, submit, etc.)
  #
  # Health Check:
  #   - Calls server_info RPC method to verify rippled is serving requests
  #   - Start period allows time for rippled initialization (~10-15 seconds)
  #
  # Data Persistence:
  #   - Ledger data stored in Docker volume: rippled_data
  #   - Volume persists across container restarts (preserves ledger state)
  #   - Reset ledger state: ./scripts/rippled-reset.sh
  #
  # Helper Scripts:
  #   - Create account: ./scripts/rippled-create-account.sh
  #   - Fund account: ./scripts/rippled-fund-account.sh <address> [amount]
  #   - Advance ledger: ./scripts/rippled-advance-ledger.sh
  #   - Reset state: ./scripts/rippled-reset.sh
  #
  # Development Notes:
  #   - Standalone mode is for development only, not for production use
  #   - Use XRPL Testnet for production-like testing before mainnet deployment
  #   - Ledger state is ephemeral - reset frequently during development
  rippled:
    image: xrpllabsofficial/xrpld:latest
    container_name: rippled_standalone
    command:
      - "-a"  # Standalone mode flag: enables offline mode with manual ledger advancement
    ports:
      - "5005:5005"  # JSON-RPC endpoint (http://localhost:5005 from host, http://rippled:5005 from containers)
      - "6006:6006"  # WebSocket endpoint (ws://localhost:6006 from host, ws://rippled:6006 from containers)
    networks:
      - m2m_dev_network
    volumes:
      - rippled_data:/var/lib/rippled  # Persist ledger state across container restarts
    healthcheck:
      # Call server_info RPC method to verify rippled is serving requests
      test: ["CMD-SHELL", "curl -f http://localhost:5005 -X POST -H 'Content-Type: application/json' --data '{\"method\":\"server_info\",\"params\":[]}' || exit 1"]
      interval: 10s  # Check every 10 seconds
      timeout: 5s  # RPC call should respond within 5 seconds
      retries: 5  # 5 attempts before marking unhealthy
      start_period: 15s  # Allow time for rippled initialization before health checks start
    restart: unless-stopped

  # rippled_ledger_advancer - Automated ledger advancement service (optional)
  #
  # This service automatically advances rippled ledgers every 5 seconds by calling the
  # ledger_accept RPC method. This simulates realistic blockchain behavior (XRPL mainnet
  # closes ledgers every 3-5 seconds) and eliminates the need for manual ledger advancement
  # during development and testing.
  #
  # Configuration:
  #   - Uses lightweight curl image to send periodic RPC requests
  #   - Infinite loop: sleep 5 seconds -> call ledger_accept -> repeat
  #   - Only starts after rippled health check passes (depends_on with service_healthy)
  #   - Uses Docker Compose profile "auto-ledger" for optional startup
  #
  # Usage:
  #   - Start with auto-ledger: docker-compose -f docker-compose-dev.yml --profile auto-ledger up -d
  #   - Without profile: Ledgers must be advanced manually using ./scripts/rippled-advance-ledger.sh
  #
  # When to Use:
  #   - Integration testing: Auto-ledger simulates realistic block production
  #   - Continuous development: Eliminates manual ledger advancement
  #   - Multi-step workflows: Transactions confirm automatically without intervention
  #
  # When to Use Manual Advancement Instead:
  #   - Debugging: Precise control over ledger advancement timing
  #   - Testing edge cases: Control exact ledger state between steps
  #   - Performance testing: Measure transaction processing without auto-advancement
  #
  # Development Notes:
  #   - 5-second interval balances realism with development speed
  #   - Uses "|| true" to prevent exit on curl failure (tolerates rippled restarts)
  #   - Restart policy: unless-stopped (continues running if rippled restarts)
  rippled_ledger_advancer:
    image: curlimages/curl:latest
    container_name: rippled_ledger_advancer
    depends_on:
      rippled:
        condition: service_healthy  # Only start after rippled health check passes
    networks:
      - m2m_dev_network
    command:
      - /bin/sh
      - -c
      - |
        # Infinite loop: advance rippled ledger every 5 seconds
        while true; do
          sleep 5
          curl -X POST http://rippled:5005 -H 'Content-Type: application/json' --data '{"method":"ledger_accept","params":[]}' || true
        done
    restart: unless-stopped
    profiles:
      - auto-ledger  # Optional service - start with: docker-compose -f docker-compose-dev.yml --profile auto-ledger up -d

  # ===== Settlement Infrastructure =====

  # TigerBeetle - Distributed accounting database for settlement layer
  #
  # TigerBeetle provides high-performance, ACID-compliant accounting for tracking
  # settlement balances between ILP connector peers. It uses double-entry bookkeeping
  # with microsecond-level latency for recording transfers and querying balances.
  #
  # Architecture:
  #   - Single-node deployment for development (1 replica)
  #   - Multi-replica configuration (3-5 replicas) recommended for production
  #   - Quorum-based consensus requires majority of replicas healthy
  #
  # Data Persistence:
  #   - Data stored in Docker volume: tigerbeetle-data
  #   - Volume persists across container restarts
  #   - Cluster ID is immutable after initialization
  #
  # Network Access:
  #   - Internal port: 3000 (binary TCP protocol)
  #   - NOT exposed to host (Docker network access only)
  #   - Connectors access via hostname: tigerbeetle:3000
  #
  # Health Check:
  #   - TCP socket check (TigerBeetle has no HTTP endpoint)
  #   - Uses netcat to verify port 3000 is accepting connections
  #
  # Security:
  #   - Requires --security-opt seccomp=unconfined for I/O operations
  #   - Network isolation via Docker bridge network
  #   - No authentication (relies on network-level access control)
  tigerbeetle:
    image: ghcr.io/tigerbeetle/tigerbeetle:latest
    container_name: tigerbeetle
    security_opt:
      - seccomp=unconfined  # Required for TigerBeetle I/O operations
    environment:
      TIGERBEETLE_CLUSTER_ID: ${TIGERBEETLE_CLUSTER_ID:-0}
      TIGERBEETLE_REPLICA_COUNT: ${TIGERBEETLE_REPLICA_COUNT:-1}
      TIGERBEETLE_DATA_DIR: ${TIGERBEETLE_DATA_DIR:-/data}
    volumes:
      - tigerbeetle-data:/data
      - ./scripts/init-tigerbeetle.sh:/init-tigerbeetle.sh:ro
    # Note: Port 3000 is internal-only, not exposed to host for security
    # Connectors access TigerBeetle via Docker network: tigerbeetle:3000
    networks:
      - m2m_dev_network
    restart: unless-stopped
    # TigerBeetle uses custom binary protocol over TCP, no HTTP endpoint available
    # Health check uses netcat to verify TCP port 3000 accepts connections
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 3000 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    entrypoint: ["/init-tigerbeetle.sh"]

  # ===== Connectors =====

  # Connector Alice - ILP connector node for development and testing
  #
  # Alice is a test ILP connector instance that routes payment packets between peers.
  # In development mode, the connector uses hot-reload with volume mounts to automatically
  # restart when source code changes are detected (via nodemon and ts-node).
  #
  # Configuration:
  #   - NODE_ID: Unique identifier for this connector instance
  #   - BTP_SERVER_PORT: Port for BTP server (must be unique per connector)
  #   - Blockchain URLs: Connect to local Anvil and rippled nodes
  #   - TigerBeetle: Connect to local settlement accounting database
  #   - Dashboard: Send telemetry to dashboard (optional)
  #
  # Dependencies:
  #   - Waits for anvil, rippled, and tigerbeetle to become healthy before starting
  #   - Ensures blockchain nodes and settlement infrastructure are ready
  #
  # Hot-Reload Volumes:
  #   - ./packages/connector/src:/app/packages/connector/src (connector source)
  #   - ./packages/shared/src:/app/packages/shared/src (shared types)
  #   - Code changes reflect immediately without container rebuild
  #
  # Health Check:
  #   - Calls HTTP health endpoint on port 8080
  #   - Start period allows time for dependencies + connector initialization
  #
  # Network Access:
  #   - BTP server: ws://localhost:3001 (from host), ws://connector-alice:3001 (from containers)
  #   - HTTP health: http://localhost:8081 (from host), http://connector-alice:8080 (from containers)
  connector-alice:
    build:
      context: .
      dockerfile: packages/connector/Dockerfile.dev
    container_name: connector_alice_dev
    environment:
      # Connector identity
      NODE_ID: alice

      # BTP configuration (must be unique per connector)
      BTP_SERVER_PORT: 3001

      # Blockchain RPC URLs (use Docker service names)
      BASE_RPC_URL: http://anvil:8545
      XRPL_RPC_URL: http://rippled:5005

      # Settlement configuration
      TIGERBEETLE_URL: tigerbeetle:3000

      # Telemetry configuration
      DASHBOARD_TELEMETRY_URL: http://dashboard:8080/telemetry

      # Development configuration
      LOG_LEVEL: ${LOG_LEVEL:-info}
      NODE_ENV: development
      ENVIRONMENT: development
    ports:
      - "3001:3001"  # BTP server for peer connections
      - "8081:8080"  # Health check and admin API
    depends_on:
      anvil:
        condition: service_healthy
      rippled:
        condition: service_healthy
      tigerbeetle:
        condition: service_healthy
    networks:
      - m2m_dev_network
    volumes:
      # Hot-reload volumes: code changes reflect immediately without rebuild
      - ./packages/connector/src:/app/packages/connector/src
      - ./packages/shared/src:/app/packages/shared/src
    healthcheck:
      # Call HTTP health endpoint to verify connector is ready
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s  # Allow time for dependencies + initialization
    restart: unless-stopped

  # Connector Bob - ILP connector node for development and testing
  #
  # Bob is a second test ILP connector instance that routes payment packets between peers.
  # Configuration matches Alice with different NODE_ID and port mappings.
  connector-bob:
    build:
      context: .
      dockerfile: packages/connector/Dockerfile.dev
    container_name: connector_bob_dev
    environment:
      # Connector identity
      NODE_ID: bob

      # BTP configuration (must be unique per connector)
      BTP_SERVER_PORT: 3002

      # Blockchain RPC URLs (use Docker service names)
      BASE_RPC_URL: http://anvil:8545
      XRPL_RPC_URL: http://rippled:5005

      # Settlement configuration
      TIGERBEETLE_URL: tigerbeetle:3000

      # Telemetry configuration
      DASHBOARD_TELEMETRY_URL: http://dashboard:8080/telemetry

      # Development configuration
      LOG_LEVEL: ${LOG_LEVEL:-info}
      NODE_ENV: development
      ENVIRONMENT: development
    ports:
      - "3002:3002"  # BTP server for peer connections
      - "8082:8080"  # Health check and admin API
    depends_on:
      anvil:
        condition: service_healthy
      rippled:
        condition: service_healthy
      tigerbeetle:
        condition: service_healthy
    networks:
      - m2m_dev_network
    volumes:
      # Hot-reload volumes: code changes reflect immediately without rebuild
      - ./packages/connector/src:/app/packages/connector/src
      - ./packages/shared/src:/app/packages/shared/src
    healthcheck:
      # Call HTTP health endpoint to verify connector is ready
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s  # Allow time for dependencies + initialization
    restart: unless-stopped

  # ===== Dashboard =====

  # Dashboard - Network visualization UI and telemetry server
  dashboard:
    build:
      context: .
      dockerfile: packages/dashboard/Dockerfile
    container_name: ilp-dashboard
    environment:
      TELEMETRY_WS_PORT: 9000
      LOG_LEVEL: info
    ports:
      - "8080:8080"  # Dashboard HTTP port
      - "9000:9000"  # Telemetry WebSocket port
    networks:
      - m2m_dev_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    profiles:
      - dashboard  # Optional service - start with: docker-compose -f docker-compose-dev.yml --profile dashboard up -d

networks:
  # Development network for inter-service communication
  # All development services (Anvil, rippled, TigerBeetle, connectors, dashboard) use this network
  m2m_dev_network:
    driver: bridge

# Named volumes for persistent data
volumes:
  # TigerBeetle data volume for settlement accounting database
  # Persists cluster data across container restarts
  # WARNING: Do not delete this volume or cluster data will be lost
  tigerbeetle-data:
    driver: local

  # rippled data volume for XRP Ledger state
  # Persists ledger data across container restarts
  # Reset with: ./scripts/rippled-reset.sh
  rippled_data:
    driver: local
