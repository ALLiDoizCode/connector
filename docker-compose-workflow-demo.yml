# Docker Compose configuration for ILP Workflow Demo
#
# Multi-hop image processing workflow demonstration:
#   Client → Facilitator → Connector1 → Connector2 → Workflow Peer
#
# Usage:
#   ./scripts/run-workflow-demo.sh
#
#   # View logs
#   docker compose -f docker-compose-workflow-demo.yml logs -f
#
#   # Stop and cleanup
#   docker compose -f docker-compose-workflow-demo.yml down -v
#
# Service URLs:
#   Client UI:         http://localhost:3000
#   Facilitator API:   http://localhost:3001
#   Facilitator UI:    http://localhost:9200
#   Connector 1 UI:    http://localhost:9201
#   Connector 2 UI:    http://localhost:9202
#   Workflow Peer UI:  http://localhost:9203

services:
  # Local Aptos testnet node for settlement (optional)
  anvil:
    image: aptoslabs/tools:devnet
    container_name: workflow_anvil
    command: ["aptos", "node", "run-local-testnet", "--with-faucet"]
    ports:
      - "8545:8080"  # Node RPC
      - "8081:8081"  # Faucet
    networks:
      - workflow_network
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8080/v1 || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 20s

  # Workflow Peer - Executes image processing
  workflow-peer:
    build:
      context: .
      dockerfile: packages/connector/Dockerfile.workflow-peer
    container_name: workflow_peer
    environment:
      AGENT_ID: workflow-peer
      AGENT_HTTP_PORT: 8080
      AGENT_BTP_PORT: 3000
      AGENT_EXPLORER_PORT: 9000
      AGENT_DATABASE_PATH: ":memory:"
      AGENT_EXPLORER_DB_PATH: ":memory:"
      LOG_LEVEL: ${LOG_LEVEL:-info}
      NETWORK_MODE: local

      # Workflow configuration
      WORKFLOW_ENABLED: "true"
      WORKFLOW_ADDRESS_PREFIX: g.workflow
      IMAGE_PROCESSOR_ENABLED: "true"
      MAX_IMAGE_SIZE: 10485760  # 10MB

      # Settlement (local Aptos)
      APTOS_ENABLED: "true"
      APTOS_NODE_URL: http://anvil:8080/v1
      APTOS_FAUCET_URL: http://anvil:8081
    ports:
      - "8203:8080"  # HTTP API
      - "3203:3000"  # BTP WebSocket
      - "9203:9000"  # Explorer UI
    networks:
      - workflow_network
    depends_on:
      anvil:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/health || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 15s
    restart: unless-stopped

  # Connector 2 - Second routing hop (closer to workflow peer)
  connector-2:
    build:
      context: .
      dockerfile: packages/connector/Dockerfile.agent
    container_name: workflow_connector_2
    environment:
      AGENT_ID: connector-2
      AGENT_HTTP_PORT: 8080
      AGENT_BTP_PORT: 3000
      AGENT_EXPLORER_PORT: 9000
      AGENT_DATABASE_PATH: ":memory:"
      AGENT_EXPLORER_DB_PATH: ":memory:"
      LOG_LEVEL: ${LOG_LEVEL:-info}
      NETWORK_MODE: local

      # Settlement
      APTOS_ENABLED: "true"
      APTOS_NODE_URL: http://anvil:8080/v1
      APTOS_FAUCET_URL: http://anvil:8081
    ports:
      - "8202:8080"
      - "3202:3000"
      - "9202:9000"
    networks:
      - workflow_network
    depends_on:
      anvil:
        condition: service_healthy
      workflow-peer:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/health || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 15s
    restart: unless-stopped

  # Connector 1 - First routing hop (after facilitator)
  connector-1:
    build:
      context: .
      dockerfile: packages/connector/Dockerfile.agent
    container_name: workflow_connector_1
    environment:
      AGENT_ID: connector-1
      AGENT_HTTP_PORT: 8080
      AGENT_BTP_PORT: 3000
      AGENT_EXPLORER_PORT: 9000
      AGENT_DATABASE_PATH: ":memory:"
      AGENT_EXPLORER_DB_PATH: ":memory:"
      LOG_LEVEL: ${LOG_LEVEL:-info}
      NETWORK_MODE: local

      # Settlement
      APTOS_ENABLED: "true"
      APTOS_NODE_URL: http://anvil:8080/v1
      APTOS_FAUCET_URL: http://anvil:8081
    ports:
      - "8201:8080"
      - "3201:3000"
      - "9201:9000"
    networks:
      - workflow_network
    depends_on:
      anvil:
        condition: service_healthy
      connector-2:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/health || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 15s
    restart: unless-stopped

  # Facilitator - X402 Gateway (SPSP + BTP + HTTP API)
  facilitator:
    build:
      context: .
      dockerfile: packages/connector/Dockerfile.facilitator
    container_name: workflow_facilitator
    environment:
      AGENT_ID: facilitator
      AGENT_HTTP_PORT: 8080
      AGENT_BTP_PORT: 3000
      AGENT_EXPLORER_PORT: 9000
      AGENT_DATABASE_PATH: ":memory:"
      AGENT_EXPLORER_DB_PATH: ":memory:"
      LOG_LEVEL: ${LOG_LEVEL:-info}
      NETWORK_MODE: local

      # Facilitator-specific
      FACILITATOR_ENABLED: "true"
      FACILITATOR_API_PORT: 3001

      # Settlement
      APTOS_ENABLED: "true"
      APTOS_NODE_URL: http://anvil:8080/v1
      APTOS_FAUCET_URL: http://anvil:8081
    ports:
      - "8200:8080"   # Internal HTTP API
      - "3200:3000"   # BTP WebSocket
      - "9200:9000"   # Explorer UI
      - "3001:3001"   # Facilitator API (external)
    networks:
      - workflow_network
    depends_on:
      anvil:
        condition: service_healthy
      connector-1:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/health || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 15s
    restart: unless-stopped

  # Client UI - React frontend
  client-ui:
    build:
      context: .
      dockerfile: packages/connector/Dockerfile.client-ui
    container_name: workflow_client_ui
    environment:
      VITE_FACILITATOR_URL: http://localhost:3001
    ports:
      - "3000:3000"
    networks:
      - workflow_network
    depends_on:
      facilitator:
        condition: service_healthy
    restart: unless-stopped

networks:
  workflow_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
