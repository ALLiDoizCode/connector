# =============================================================================
# M2M ILP Connector - Staging Docker Compose Stack (Public Testnets)
# =============================================================================
#
# Deployment targeting public testnet infrastructure:
#   - Base Sepolia (Chain ID 84532) for EVM payment channels
#   - XRPL Testnet for XRP payment channels
#   - TigerBeetle for settlement accounting
#   - Prometheus + Grafana for monitoring
#   - Jaeger for distributed tracing (optional)
#
# Unlike development (local Anvil/rippled), this stack connects to real
# public testnet nodes - no local blockchain containers needed.
#
# Prerequisites:
#   1. Build connector image: docker build -t agent-runtime/connector:latest .
#   2. Initialize TigerBeetle (one-time):
#      docker run --rm -v tigerbeetle-staging-data:/data tigerbeetle/tigerbeetle \
#        format --cluster=0 --replica=0 --replica-count=1 /data/0_0.tigerbeetle
#   3. Create .env from template: cp .env.staging.example .env
#   4. Fund wallets with testnet tokens (see .env.staging.example for faucets)
#   5. Configure .env with your wallet keys and addresses
#
# Usage:
#   Start all services:  docker compose -f docker-compose-staging.yml up -d
#   View logs:           docker compose -f docker-compose-staging.yml logs -f
#   Stop all services:   docker compose -f docker-compose-staging.yml down
#   Stop with cleanup:   docker compose -f docker-compose-staging.yml down -v
#
# Service Endpoints:
#   - Connector BTP:     ws://localhost:4000
#   - Connector Health:  http://localhost:8080/health
#   - Explorer UI:       http://localhost:3001
#   - Prometheus:        http://localhost:9090
#   - Grafana:           http://localhost:3002 (admin/admin)
#   - Jaeger UI:         http://localhost:16686 (if enabled)
#
# =============================================================================

version: '3.8'

services:
  # ===========================================================================
  # TigerBeetle - High-Performance Accounting Database
  # ===========================================================================
  tigerbeetle:
    image: tigerbeetle/tigerbeetle:latest
    container_name: m2m-staging-tigerbeetle
    command: start --addresses=0.0.0.0:3000 /data/0_0.tigerbeetle
    volumes:
      - tigerbeetle-staging-data:/data
    networks:
      - ilp-staging-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 3000 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ===========================================================================
  # M2M ILP Connector - Core Payment Processing (Staging / Testnets)
  # ===========================================================================
  connector:
    image: agent-runtime/connector:latest
    build:
      context: .
      dockerfile: Dockerfile
    container_name: m2m-staging-connector
    environment:
      # --- Environment ---
      ENVIRONMENT: staging

      # --- Core Configuration ---
      NODE_ID: ${NODE_ID:-m2m-staging-connector}
      CONFIG_FILE: /app/config.yaml
      LOG_LEVEL: ${LOG_LEVEL:-info}

      # --- Network Ports ---
      BTP_SERVER_PORT: 4000
      HEALTH_CHECK_PORT: 8080

      # --- Settlement ---
      SETTLEMENT_PREFERENCE: ${SETTLEMENT_PREFERENCE:-both}
      INITIAL_DEPOSIT_MULTIPLIER: ${INITIAL_DEPOSIT_MULTIPLIER:-1}
      SETTLEMENT_POLLING_INTERVAL: ${SETTLEMENT_POLLING_INTERVAL:-30000}

      # --- Operational Timeouts ---
      TIGERBEETLE_OPERATION_TIMEOUT: ${TIGERBEETLE_OPERATION_TIMEOUT:-15000}
      BTP_SEND_TIMEOUT_MS: ${BTP_SEND_TIMEOUT_MS:-10000}

      # --- Base Sepolia (EVM) ---
      BASE_ENABLED: "true"
      BASE_RPC_URL: ${BASE_RPC_URL:-https://sepolia.base.org}
      BASE_CHAIN_ID: "84532"
      BASE_REGISTRY_ADDRESS: ${BASE_REGISTRY_ADDRESS:-0xCbf6f43A17034e733744cBCc130FfcCA3CF3252C}

      # --- XRPL Testnet ---
      XRPL_ENABLED: "true"
      XRPL_RPC_URL: ${XRPL_RPC_URL:-https://s.altnet.rippletest.net:51234}
      XRPL_NETWORK: testnet

      # --- Wallet Addresses ---
      EVM_ADDRESS: ${EVM_ADDRESS:-}
      XRP_ADDRESS: ${XRP_ADDRESS:-}

      # --- Key Management ---
      KEY_BACKEND: ${KEY_BACKEND:-env}
      EVM_PRIVATE_KEY: ${EVM_PRIVATE_KEY:-}
      XRP_SEED: ${XRP_SEED:-}

      # --- AWS KMS (if KEY_BACKEND=aws-kms) ---
      AWS_REGION: ${AWS_REGION:-}
      AWS_KMS_EVM_KEY_ID: ${AWS_KMS_EVM_KEY_ID:-}
      AWS_KMS_XRP_KEY_ID: ${AWS_KMS_XRP_KEY_ID:-}

      # --- GCP KMS (if KEY_BACKEND=gcp-kms) ---
      GCP_PROJECT_ID: ${GCP_PROJECT_ID:-}
      GCP_LOCATION_ID: ${GCP_LOCATION_ID:-}
      GCP_KEY_RING_ID: ${GCP_KEY_RING_ID:-}
      GCP_KMS_EVM_KEY_ID: ${GCP_KMS_EVM_KEY_ID:-}
      GCP_KMS_XRP_KEY_ID: ${GCP_KMS_XRP_KEY_ID:-}

      # --- Azure Key Vault (if KEY_BACKEND=azure-kv) ---
      AZURE_VAULT_URL: ${AZURE_VAULT_URL:-}
      AZURE_EVM_KEY_NAME: ${AZURE_EVM_KEY_NAME:-}
      AZURE_XRP_KEY_NAME: ${AZURE_XRP_KEY_NAME:-}

      # --- TigerBeetle ---
      TIGERBEETLE_CLUSTER_ID: "0"
      TIGERBEETLE_REPLICAS: tigerbeetle:3000

      # --- Monitoring ---
      PROMETHEUS_ENABLED: ${PROMETHEUS_ENABLED:-true}
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-http://jaeger:4318}
    volumes:
      - ./examples/production-single-node.yaml:/app/config.yaml:ro
      - connector-staging-data:/app/data
      - connector-staging-logs:/app/logs
    ports:
      - "${BTP_PORT:-4000}:4000"
      - "${HEALTH_CHECK_PORT:-8080}:8080"
      - "3001:3001"  # Explorer UI
    networks:
      - ilp-staging-network
    depends_on:
      tigerbeetle:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ===========================================================================
  # Prometheus - Metrics Collection
  # ===========================================================================
  prometheus:
    image: prom/prometheus:v2.47.0
    container_name: m2m-staging-prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
      - '--web.enable-admin-api'
      - '--storage.tsdb.retention.time=15d'
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./monitoring/prometheus/alerts:/etc/prometheus/alerts:ro
      - prometheus-staging-data:/prometheus
    ports:
      - "9090:9090"
    networks:
      - ilp-staging-network
    depends_on:
      connector:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # Grafana - Metrics Visualization
  # ===========================================================================
  grafana:
    image: grafana/grafana:10.2.0
    container_name: m2m-staging-grafana
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_INSTALL_PLUGINS=grafana-piechart-panel
      - GF_AUTH_ANONYMOUS_ENABLED=${GF_AUTH_ANONYMOUS_ENABLED:-true}
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
    volumes:
      - ./monitoring/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
      - ./monitoring/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
      - grafana-staging-data:/var/lib/grafana
    ports:
      - "3002:3000"
    networks:
      - ilp-staging-network
    depends_on:
      - prometheus
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # Jaeger - Distributed Tracing (Optional)
  # ===========================================================================
  jaeger:
    image: jaegertracing/all-in-one:1.51
    container_name: m2m-staging-jaeger
    profiles:
      - tracing
    environment:
      - COLLECTOR_OTLP_ENABLED=true
      - SPAN_STORAGE_TYPE=memory
      - MEMORY_MAX_TRACES=100000
    ports:
      - "16686:16686"  # Jaeger UI
      - "4318:4318"    # OTLP HTTP receiver
    networks:
      - ilp-staging-network
    restart: unless-stopped

# =============================================================================
# Volumes
# =============================================================================
volumes:
  tigerbeetle-staging-data:
    driver: local
  connector-staging-data:
    driver: local
  connector-staging-logs:
    driver: local
  prometheus-staging-data:
    driver: local
  grafana-staging-data:
    driver: local

# =============================================================================
# Networks
# =============================================================================
networks:
  ilp-staging-network:
    driver: bridge
    name: m2m-ilp-staging-network
